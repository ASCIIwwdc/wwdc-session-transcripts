WEBVTT

00:00:19.496 --> 00:00:20.056 A:middle
&gt;&gt; Hi everyone.

00:00:24.186 --> 00:00:26.896 A:middle
Hi, and welcome to finding bugs

00:00:27.086 --> 00:00:29.146 A:middle
using Xcode Runtime tools.

00:00:29.896 --> 00:00:31.736 A:middle
My name is Kuba, I am an

00:00:31.736 --> 00:00:33.256 A:middle
engineer on the program, another

00:00:33.256 --> 00:00:35.016 A:middle
system inside developer tools.

00:00:35.596 --> 00:00:37.236 A:middle
And today we will be talking

00:00:37.236 --> 00:00:39.106 A:middle
about finding bugs at the

00:00:39.176 --> 00:00:41.246 A:middle
program runtime and the tools

00:00:41.246 --> 00:00:41.966 A:middle
for that.

00:00:42.166 --> 00:00:44.536 A:middle
So, let's jump in.

00:00:44.736 --> 00:00:46.846 A:middle
Xcode already has several ways

00:00:46.846 --> 00:00:47.936 A:middle
of telling you that you have

00:00:47.936 --> 00:00:49.036 A:middle
some bug in your program.

00:00:49.326 --> 00:00:50.936 A:middle
For example, with compiler

00:00:50.936 --> 00:00:51.556 A:middle
errors.

00:00:52.066 --> 00:00:52.976 A:middle
Compiler warnings.

00:00:53.696 --> 00:00:54.656 A:middle
Analyzer warnings.

00:00:55.296 --> 00:00:56.046 A:middle
Or test failures.

00:00:57.196 --> 00:00:59.006 A:middle
Last year in Xcode 8 we have

00:00:59.046 --> 00:01:00.416 A:middle
added a whole new category

00:01:01.046 --> 00:01:02.336 A:middle
called Runtime Issues.

00:01:03.436 --> 00:01:05.246 A:middle
Those issues are found at the

00:01:05.246 --> 00:01:07.386 A:middle
program runtime by several

00:01:08.006 --> 00:01:09.116 A:middle
different tools.

00:01:09.296 --> 00:01:10.496 A:middle
When you run and debug your

00:01:10.496 --> 00:01:12.276 A:middle
applications as you are used to,

00:01:12.446 --> 00:01:14.626 A:middle
these tools find and detect bugs

00:01:14.626 --> 00:01:16.376 A:middle
at runtime and they display them

00:01:16.876 --> 00:01:18.326 A:middle
in the Runtime Issues Navigator

00:01:18.376 --> 00:01:19.136 A:middle
in Xcode.

00:01:20.316 --> 00:01:22.486 A:middle
If you are not actively watching

00:01:22.566 --> 00:01:24.926 A:middle
this navigator, Xcode also

00:01:24.926 --> 00:01:26.296 A:middle
indicates that it found some

00:01:26.296 --> 00:01:28.516 A:middle
runtime issue by showing this

00:01:28.516 --> 00:01:30.636 A:middle
purple warning icon.

00:01:31.246 --> 00:01:34.446 A:middle
You can click any of these

00:01:34.446 --> 00:01:36.816 A:middle
issues in the Navigator and the

00:01:36.956 --> 00:01:38.816 A:middle
editor will tell you which line

00:01:38.816 --> 00:01:40.746 A:middle
of code contains the bug.

00:01:42.066 --> 00:01:43.836 A:middle
The source of this bug can vary

00:01:43.836 --> 00:01:45.276 A:middle
because different tools report

00:01:45.276 --> 00:01:47.406 A:middle
different types of bugs but all

00:01:47.406 --> 00:01:48.346 A:middle
these tools that we're going to

00:01:48.346 --> 00:01:50.296 A:middle
talk today in this session, you

00:01:50.296 --> 00:01:51.846 A:middle
can find in the diagnostic step

00:01:51.976 --> 00:01:52.806 A:middle
in the scheme editor.

00:01:53.516 --> 00:01:55.486 A:middle
And in Xcode 9, it now contains

00:01:55.486 --> 00:01:56.196 A:middle
some new features.

00:01:56.786 --> 00:01:58.496 A:middle
So, you'll see that it now has

00:01:58.636 --> 00:02:00.086 A:middle
address sanitizer, threat

00:02:00.086 --> 00:02:02.586 A:middle
sanitizer, undefined behavior

00:02:02.586 --> 00:02:04.686 A:middle
sanitizer and also main thread

00:02:04.686 --> 00:02:05.046 A:middle
checker.

00:02:05.736 --> 00:02:07.756 A:middle
So, these tools, which all find

00:02:07.756 --> 00:02:09.786 A:middle
bugs at program runtime, are

00:02:10.126 --> 00:02:11.456 A:middle
what we're going to talk today

00:02:11.636 --> 00:02:12.336 A:middle
in this session.

00:02:13.096 --> 00:02:14.896 A:middle
So, first I will introduce main

00:02:14.896 --> 00:02:16.296 A:middle
thread checker, a completely new

00:02:16.296 --> 00:02:17.436 A:middle
tool in Xcode 9.

00:02:18.756 --> 00:02:20.576 A:middle
Then I will talk about address

00:02:20.576 --> 00:02:22.166 A:middle
sanitizer and thread sanitizer

00:02:22.336 --> 00:02:23.716 A:middle
and the improvement that we have

00:02:23.716 --> 00:02:25.356 A:middle
made to these tools this year.

00:02:26.536 --> 00:02:27.936 A:middle
We will introduce another

00:02:27.936 --> 00:02:29.606 A:middle
completely new tool, undefined

00:02:29.606 --> 00:02:30.706 A:middle
behavior sanitizer.

00:02:30.706 --> 00:02:33.276 A:middle
And finally we will provide tips

00:02:33.316 --> 00:02:35.386 A:middle
and best practices, how you

00:02:35.386 --> 00:02:36.386 A:middle
should be using those tools

00:02:36.386 --> 00:02:36.986 A:middle
effectively.

00:02:37.856 --> 00:02:39.556 A:middle
So, let's jump in.

00:02:40.636 --> 00:02:42.736 A:middle
The main thread checker is a

00:02:42.736 --> 00:02:44.426 A:middle
completely new tool in Xcode 9

00:02:44.496 --> 00:02:46.496 A:middle
and it detects violations of

00:02:46.496 --> 00:02:47.736 A:middle
some commonly used APIs.

00:02:47.736 --> 00:02:50.836 A:middle
And specifically it focuses on

00:02:50.836 --> 00:02:52.596 A:middle
UI updates and multithreading.

00:02:53.756 --> 00:02:56.336 A:middle
Some APIs require that you only

00:02:56.336 --> 00:02:58.166 A:middle
use them from the main thread.

00:02:58.756 --> 00:03:00.586 A:middle
For example, that's the case for

00:03:00.586 --> 00:03:02.266 A:middle
many APIs from the AppKit and

00:03:02.266 --> 00:03:03.256 A:middle
UIKit frameworks.

00:03:04.086 --> 00:03:05.276 A:middle
And they are used by most

00:03:05.276 --> 00:03:06.736 A:middle
graphical macOS and iOS

00:03:06.736 --> 00:03:07.426 A:middle
applications.

00:03:07.746 --> 00:03:08.866 A:middle
And I assume that if you are

00:03:08.866 --> 00:03:10.626 A:middle
using those frameworks, you

00:03:10.626 --> 00:03:11.686 A:middle
already know about this

00:03:11.686 --> 00:03:13.196 A:middle
restriction that you have to

00:03:13.196 --> 00:03:14.526 A:middle
call those APIs from the main

00:03:14.526 --> 00:03:14.736 A:middle
thread.

00:03:14.736 --> 00:03:16.826 A:middle
And that's easy to do.

00:03:16.896 --> 00:03:18.126 A:middle
We just make sure that we will

00:03:18.186 --> 00:03:19.516 A:middle
call those APIs on the main

00:03:19.516 --> 00:03:20.036 A:middle
thread only.

00:03:21.516 --> 00:03:23.156 A:middle
But there are tasks that you

00:03:23.156 --> 00:03:24.616 A:middle
don't want to be executed on the

00:03:24.616 --> 00:03:26.516 A:middle
main thread, like file downloads

00:03:26.516 --> 00:03:27.716 A:middle
where you need to wait for some

00:03:27.716 --> 00:03:29.756 A:middle
data or image processing, which

00:03:29.916 --> 00:03:31.066 A:middle
usually involves some, like,

00:03:31.066 --> 00:03:32.126 A:middle
heavy computations.

00:03:33.256 --> 00:03:34.976 A:middle
So, these tasks need to be moved

00:03:35.146 --> 00:03:36.746 A:middle
off the main thread so that the

00:03:36.746 --> 00:03:39.406 A:middle
UI is still responsive and your

00:03:39.406 --> 00:03:40.656 A:middle
user interaction is not blocked

00:03:40.656 --> 00:03:41.136 A:middle
in your app.

00:03:42.056 --> 00:03:44.126 A:middle
However, these tasks also need

00:03:44.126 --> 00:03:45.676 A:middle
to trigger UI updates.

00:03:46.756 --> 00:03:48.826 A:middle
And if those UI updates involve

00:03:48.826 --> 00:03:50.936 A:middle
calling AppKit or UI kit APIs,

00:03:51.356 --> 00:03:52.896 A:middle
that update needs to happen from

00:03:52.896 --> 00:03:53.376 A:middle
the main thread.

00:03:53.566 --> 00:03:55.026 A:middle
And it's very easy to make a

00:03:55.026 --> 00:03:56.616 A:middle
mistake, to accidently call this

00:03:56.616 --> 00:03:58.246 A:middle
UI update from the wrong thread.

00:03:59.146 --> 00:04:00.056 A:middle
And it can have serious

00:04:00.056 --> 00:04:01.986 A:middle
consequences such as missed UI

00:04:01.986 --> 00:04:03.696 A:middle
updates where the UI just does

00:04:03.696 --> 00:04:05.616 A:middle
not update at all or other

00:04:05.616 --> 00:04:06.336 A:middle
visual defects.

00:04:06.916 --> 00:04:08.006 A:middle
But even more serious things

00:04:08.006 --> 00:04:09.286 A:middle
like data corruptions or

00:04:09.286 --> 00:04:09.656 A:middle
crashes.

00:04:10.086 --> 00:04:12.206 A:middle
So, to avoid this problem we

00:04:12.206 --> 00:04:13.356 A:middle
need to make sure that this UI

00:04:13.356 --> 00:04:15.036 A:middle
update only happens from the

00:04:15.036 --> 00:04:15.436 A:middle
main thread.

00:04:16.626 --> 00:04:18.386 A:middle
So, with that, I'd like to

00:04:18.386 --> 00:04:19.476 A:middle
introduce Main Thread Checker

00:04:19.476 --> 00:04:21.000 A:middle
and show it to you right now.

00:04:30.436 --> 00:04:31.956 A:middle
So, what I have here is a very

00:04:31.956 --> 00:04:33.126 A:middle
simple application which

00:04:33.126 --> 00:04:34.386 A:middle
downloads some data from the

00:04:34.386 --> 00:04:34.816 A:middle
internet.

00:04:35.386 --> 00:04:36.736 A:middle
It's actually downloading a file

00:04:36.736 --> 00:04:38.866 A:middle
from this long URL which is

00:04:38.906 --> 00:04:39.446 A:middle
present on the

00:04:39.446 --> 00:04:40.856 A:middle
developer.apple.com website.

00:04:41.296 --> 00:04:42.736 A:middle
It's some sample code that Apple

00:04:42.736 --> 00:04:44.496 A:middle
has published in 2013.

00:04:45.036 --> 00:04:46.176 A:middle
And it's a zip file.

00:04:46.176 --> 00:04:48.356 A:middle
It's several megabytes large and

00:04:48.356 --> 00:04:49.696 A:middle
it will serve as an example file

00:04:49.696 --> 00:04:50.516 A:middle
if you want to download.

00:04:51.706 --> 00:04:53.216 A:middle
To download this file, I'm using

00:04:53.216 --> 00:04:56.036 A:middle
a class called URLSession that's

00:04:56.036 --> 00:04:57.496 A:middle
provided by Foundation and it's

00:04:57.496 --> 00:04:58.586 A:middle
a very convenient way of

00:04:58.616 --> 00:04:59.396 A:middle
downloading files.

00:05:01.776 --> 00:05:03.736 A:middle
The UI of my application is very

00:05:03.736 --> 00:05:04.446 A:middle
simple.

00:05:05.276 --> 00:05:05.946 A:middle
Let's take a look.

00:05:05.946 --> 00:05:07.806 A:middle
It contains a single button and

00:05:07.806 --> 00:05:08.596 A:middle
a progress bar.

00:05:08.596 --> 00:05:10.576 A:middle
So, I have actually implemented

00:05:10.576 --> 00:05:12.086 A:middle
the progress callback of

00:05:12.086 --> 00:05:12.776 A:middle
URLSession.

00:05:12.776 --> 00:05:14.116 A:middle
And from this callback I am

00:05:14.116 --> 00:05:15.386 A:middle
updating the value on this

00:05:15.426 --> 00:05:16.026 A:middle
progress bar.

00:05:16.366 --> 00:05:17.876 A:middle
So, let's run the application

00:05:18.156 --> 00:05:20.506 A:middle
and see if it shows the progress

00:05:20.506 --> 00:05:22.206 A:middle
of the download as it's supposed

00:05:22.206 --> 00:05:22.416 A:middle
to.

00:05:22.896 --> 00:05:24.706 A:middle
Let me now click the button to

00:05:24.706 --> 00:05:25.736 A:middle
start the download.

00:05:26.126 --> 00:05:26.976 A:middle
And you might see that

00:05:27.006 --> 00:05:28.296 A:middle
something's not quite right,

00:05:28.446 --> 00:05:30.036 A:middle
because the progress bar is just

00:05:30.036 --> 00:05:31.076 A:middle
stuck at the beginning.

00:05:31.616 --> 00:05:33.596 A:middle
And now it has for some reason

00:05:33.596 --> 00:05:34.786 A:middle
jumped straight to the end.

00:05:35.956 --> 00:05:37.366 A:middle
So, now I might be wondering

00:05:37.366 --> 00:05:38.576 A:middle
that there's some bug in my

00:05:38.576 --> 00:05:40.486 A:middle
application or URLSession may

00:05:40.486 --> 00:05:41.666 A:middle
not be working correctly.

00:05:42.546 --> 00:05:43.416 A:middle
So, the best thing about this

00:05:43.416 --> 00:05:44.496 A:middle
feature is that I don't need to

00:05:44.496 --> 00:05:46.476 A:middle
guess what wrong - Xcode has

00:05:46.476 --> 00:05:47.496 A:middle
already found the problem.

00:05:48.196 --> 00:05:49.806 A:middle
If we take a look back into

00:05:49.806 --> 00:05:51.166 A:middle
Xcode, we'll see that it's

00:05:51.166 --> 00:05:53.826 A:middle
informing us that it has found a

00:05:53.826 --> 00:05:54.516 A:middle
Runtime issue.

00:05:55.596 --> 00:05:57.096 A:middle
Let me click this Runtime issue

00:05:57.226 --> 00:05:58.706 A:middle
to get some details, and you'll

00:05:58.706 --> 00:05:59.846 A:middle
see that the navigator has now

00:05:59.936 --> 00:06:01.466 A:middle
switched to the Runtime Issues

00:06:01.466 --> 00:06:02.076 A:middle
navigator.

00:06:02.616 --> 00:06:04.406 A:middle
And it's informing me that I'm

00:06:04.406 --> 00:06:06.656 A:middle
calling some UI API from a

00:06:06.656 --> 00:06:07.286 A:middle
background thread.

00:06:08.756 --> 00:06:11.086 A:middle
I'll click this issue to go to

00:06:11.176 --> 00:06:12.656 A:middle
the code which contains the

00:06:12.656 --> 00:06:13.786 A:middle
invalid API code.

00:06:14.436 --> 00:06:16.356 A:middle
And in this case we can see that

00:06:16.356 --> 00:06:18.116 A:middle
we are actually setting a new

00:06:18.116 --> 00:06:19.996 A:middle
value on the progress indicator

00:06:20.256 --> 00:06:21.796 A:middle
from a background thread and

00:06:21.796 --> 00:06:23.706 A:middle
that has to be done only from

00:06:23.706 --> 00:06:25.646 A:middle
the main thread.

00:06:25.776 --> 00:06:26.916 A:middle
So, that's a bit unexpected

00:06:26.916 --> 00:06:28.456 A:middle
because I'm not trying to run

00:06:28.456 --> 00:06:29.726 A:middle
this code on a background

00:06:29.726 --> 00:06:29.926 A:middle
thread.

00:06:30.316 --> 00:06:31.306 A:middle
I'm actually not doing any

00:06:31.306 --> 00:06:32.726 A:middle
threading in my code at all.

00:06:32.726 --> 00:06:35.636 A:middle
So, the real problem is that I

00:06:35.636 --> 00:06:36.866 A:middle
actually made a mistake when I

00:06:36.866 --> 00:06:39.216 A:middle
was grading my URLSession class,

00:06:39.456 --> 00:06:40.076 A:middle
sorry, object.

00:06:40.656 --> 00:06:42.306 A:middle
On this line, where I'm creating

00:06:42.306 --> 00:06:44.476 A:middle
the URLSession, I'm supposed to

00:06:44.476 --> 00:06:46.776 A:middle
specify which view should be

00:06:46.776 --> 00:06:48.466 A:middle
used for the callbacks for both

00:06:48.466 --> 00:06:49.766 A:middle
the progress and download

00:06:49.766 --> 00:06:50.906 A:middle
finished callback.

00:06:51.086 --> 00:06:52.656 A:middle
Instead of providing a queue, I

00:06:52.916 --> 00:06:53.906 A:middle
just said nil.

00:06:53.906 --> 00:06:54.896 A:middle
That means I don't care.

00:06:54.896 --> 00:06:56.856 A:middle
And URLSession will probably

00:06:57.286 --> 00:06:59.506 A:middle
involve those callbacks from a

00:06:59.896 --> 00:07:01.566 A:middle
background queue.

00:07:01.736 --> 00:07:04.066 A:middle
So, now we know why these

00:07:04.066 --> 00:07:05.216 A:middle
callbacks are called from a

00:07:05.216 --> 00:07:05.826 A:middle
background thread.

00:07:06.346 --> 00:07:08.226 A:middle
To fix this, I could either use

00:07:08.306 --> 00:07:10.626 A:middle
GCD and dispatch the UIUpdates

00:07:10.626 --> 00:07:11.466 A:middle
back to the main thread.

00:07:12.156 --> 00:07:13.926 A:middle
Or in this simple case I could

00:07:13.926 --> 00:07:15.946 A:middle
just ask URLSession to directly

00:07:16.316 --> 00:07:17.786 A:middle
call my callbacks on the main

00:07:17.786 --> 00:07:18.026 A:middle
queue.

00:07:18.026 --> 00:07:19.146 A:middle
So, let's do that instead.

00:07:20.516 --> 00:07:23.086 A:middle
I'll just ask it to call my

00:07:23.086 --> 00:07:24.756 A:middle
callbacks on the main queue and

00:07:25.036 --> 00:07:26.246 A:middle
let's run the application one

00:07:26.246 --> 00:07:27.786 A:middle
more time to see if that fixed

00:07:27.786 --> 00:07:28.376 A:middle
our problem.

00:07:29.596 --> 00:07:31.166 A:middle
If I click the button this time,

00:07:31.546 --> 00:07:32.756 A:middle
we'll see that the progress bar

00:07:32.756 --> 00:07:33.916 A:middle
now animates smoothly and it

00:07:34.156 --> 00:07:35.406 A:middle
indicates the progress of our

00:07:35.406 --> 00:07:35.846 A:middle
download.

00:07:39.516 --> 00:07:43.046 A:middle
[ Applause ]

00:07:43.546 --> 00:07:44.466 A:middle
Sorry, I need to switch back to

00:07:44.466 --> 00:07:44.886 A:middle
my slide.

00:07:45.246 --> 00:07:49.496 A:middle
There we go.

00:07:51.596 --> 00:07:55.026 A:middle
So, we've seen an example of how

00:07:55.026 --> 00:07:56.256 A:middle
Main Thread Checker helps us

00:07:56.446 --> 00:07:58.536 A:middle
find and fix a bug where we're

00:07:58.536 --> 00:07:59.916 A:middle
calling some API from the wrong

00:07:59.916 --> 00:08:00.096 A:middle
thread.

00:08:00.886 --> 00:08:02.906 A:middle
Notice, that I didn't need to

00:08:02.956 --> 00:08:04.576 A:middle
turn these two on because it's

00:08:04.576 --> 00:08:06.066 A:middle
actually enabled by default

00:08:06.266 --> 00:08:07.636 A:middle
whenever you are using the Xcode

00:08:07.636 --> 00:08:08.016 A:middle
debugger.

00:08:08.726 --> 00:08:11.736 A:middle
But if you want to find this

00:08:11.736 --> 00:08:13.796 A:middle
code in Xcode, you'll see that

00:08:13.796 --> 00:08:15.706 A:middle
it's available in the diagnostic

00:08:15.706 --> 00:08:17.536 A:middle
step again and you'll notice

00:08:17.536 --> 00:08:19.696 A:middle
that now in Xcode 9 we have this

00:08:19.746 --> 00:08:21.366 A:middle
checkbox called Main Thread

00:08:21.366 --> 00:08:21.716 A:middle
Checker.

00:08:22.606 --> 00:08:23.616 A:middle
So, this is the place where you

00:08:23.616 --> 00:08:25.056 A:middle
can turn the two on or off.

00:08:26.296 --> 00:08:27.806 A:middle
If you want to make the debugger

00:08:28.066 --> 00:08:29.786 A:middle
stop on a violation of this

00:08:29.786 --> 00:08:31.726 A:middle
rule, you can use the pause on

00:08:31.726 --> 00:08:34.006 A:middle
issues checkbox and with that,

00:08:34.006 --> 00:08:35.196 A:middle
the debugger will stop when it

00:08:35.196 --> 00:08:37.046 A:middle
detects an issue and you can

00:08:37.046 --> 00:08:38.316 A:middle
inspect your current program

00:08:38.316 --> 00:08:40.096 A:middle
state and to figure out what

00:08:40.096 --> 00:08:40.546 A:middle
went wrong.

00:08:40.546 --> 00:08:44.526 A:middle
Now, let's talk about some

00:08:44.526 --> 00:08:47.056 A:middle
common mistakes that leap to the

00:08:47.056 --> 00:08:48.216 A:middle
bugs that Main Thread Checker

00:08:48.216 --> 00:08:48.626 A:middle
detects.

00:08:49.486 --> 00:08:50.646 A:middle
So, as you saw in the demo,

00:08:51.046 --> 00:08:52.356 A:middle
networking callbacks is one

00:08:52.356 --> 00:08:55.446 A:middle
place where we, is a place which

00:08:55.496 --> 00:08:56.696 A:middle
often happens from the main

00:08:56.696 --> 00:08:57.636 A:middle
threads, sorry, from the

00:08:57.636 --> 00:08:58.196 A:middle
background thread.

00:08:59.246 --> 00:09:00.266 A:middle
So, you need to be careful and

00:09:00.266 --> 00:09:01.806 A:middle
you need to dispatch your

00:09:01.806 --> 00:09:03.316 A:middle
UIUpdates back to the main

00:09:03.316 --> 00:09:03.586 A:middle
threads.

00:09:04.636 --> 00:09:05.566 A:middle
Another common place for

00:09:05.566 --> 00:09:06.396 A:middle
mistakes is when you are

00:09:06.396 --> 00:09:08.276 A:middle
creating and destroying NSView

00:09:08.276 --> 00:09:09.336 A:middle
or UIView objects.

00:09:09.336 --> 00:09:11.046 A:middle
This also needs to happen only

00:09:11.046 --> 00:09:12.426 A:middle
from the main thread.

00:09:13.296 --> 00:09:15.886 A:middle
If you are writing libraries or

00:09:15.886 --> 00:09:17.516 A:middle
frameworks and you are providing

00:09:17.576 --> 00:09:18.866 A:middle
some asynchronous API.

00:09:19.656 --> 00:09:20.816 A:middle
You should be very careful when

00:09:20.816 --> 00:09:21.846 A:middle
designing those APIs.

00:09:22.506 --> 00:09:23.376 A:middle
Let's take a look.

00:09:23.786 --> 00:09:27.196 A:middle
Let's say that we want to have

00:09:27.196 --> 00:09:29.366 A:middle
an API that performs some long

00:09:29.366 --> 00:09:30.496 A:middle
and heavy computation.

00:09:30.496 --> 00:09:31.996 A:middle
So, it does that in an

00:09:32.036 --> 00:09:33.046 A:middle
asynchronous fashion.

00:09:34.566 --> 00:09:36.146 A:middle
Here the caller of the API needs

00:09:36.146 --> 00:09:38.646 A:middle
to provide a closure to the API

00:09:38.646 --> 00:09:40.436 A:middle
and the closure will be used as

00:09:40.436 --> 00:09:41.396 A:middle
a completion handler.

00:09:41.526 --> 00:09:42.956 A:middle
So, when the task is completed,

00:09:43.626 --> 00:09:45.576 A:middle
you, the API will call the

00:09:45.576 --> 00:09:46.336 A:middle
provided closure.

00:09:47.266 --> 00:09:48.636 A:middle
However, in this code sample,

00:09:48.636 --> 00:09:50.756 A:middle
it's not obvious which queue or

00:09:50.756 --> 00:09:51.936 A:middle
thread will be used for this

00:09:51.936 --> 00:09:52.326 A:middle
closure.

00:09:53.236 --> 00:09:54.796 A:middle
And it can easily lead to a

00:09:54.796 --> 00:09:56.156 A:middle
mistake where some code is

00:09:56.156 --> 00:09:57.516 A:middle
executed from the wrong thread.

00:10:01.216 --> 00:10:03.996 A:middle
Good APIs let or even force

00:10:03.996 --> 00:10:05.986 A:middle
their users to specify which

00:10:06.086 --> 00:10:07.736 A:middle
view should be used for the

00:10:07.736 --> 00:10:08.506 A:middle
completion handle.

00:10:08.556 --> 00:10:09.836 A:middle
So, if you read this code

00:10:09.836 --> 00:10:11.936 A:middle
example, it's obvious that the

00:10:11.936 --> 00:10:13.366 A:middle
closure will be called on the

00:10:13.366 --> 00:10:14.766 A:middle
provided queue and you don't

00:10:14.766 --> 00:10:15.726 A:middle
even need to read the

00:10:15.726 --> 00:10:19.936 A:middle
documentation for the API to

00:10:20.196 --> 00:10:20.556 A:middle
learn that.

00:10:20.556 --> 00:10:21.786 A:middle
So, as I said, Main Thread

00:10:21.786 --> 00:10:23.336 A:middle
Checker detects violations of

00:10:23.336 --> 00:10:24.406 A:middle
API threading rules.

00:10:25.256 --> 00:10:27.536 A:middle
It supports AppKit, UIKit and

00:10:27.536 --> 00:10:28.986 A:middle
WebKit which are three very

00:10:28.986 --> 00:10:30.456 A:middle
commonly used frameworks and

00:10:30.456 --> 00:10:32.536 A:middle
they all have the same main

00:10:32.536 --> 00:10:34.636 A:middle
thread only requirement on a lot

00:10:34.636 --> 00:10:35.136 A:middle
of their APIs.

00:10:35.136 --> 00:10:38.506 A:middle
The tool supports both Swift and

00:10:38.566 --> 00:10:39.256 A:middle
C languages.

00:10:39.776 --> 00:10:41.086 A:middle
And in contrast to the other

00:10:41.086 --> 00:10:42.436 A:middle
tools that we are going to talk

00:10:42.436 --> 00:10:44.546 A:middle
about today, it does not require

00:10:44.546 --> 00:10:45.336 A:middle
recompilation.

00:10:46.006 --> 00:10:46.956 A:middle
So, you can even use it on

00:10:46.956 --> 00:10:47.956 A:middle
existing binaries.

00:10:48.536 --> 00:10:51.016 A:middle
The best part is that is

00:10:51.016 --> 00:10:52.576 A:middle
actually enabled by default.

00:10:52.576 --> 00:10:53.676 A:middle
So, you don't need to do

00:10:53.676 --> 00:10:54.996 A:middle
anything to start getting these

00:10:54.996 --> 00:10:55.926 A:middle
warnings from the tool.

00:10:55.926 --> 00:10:57.016 A:middle
It's actually enabled whenever

00:10:57.016 --> 00:10:58.396 A:middle
you're using the Xcode debugger.

00:10:59.656 --> 00:11:00.726 A:middle
So, that was Main Thread

00:11:00.726 --> 00:11:02.886 A:middle
Checker, a completely new tool

00:11:03.716 --> 00:11:04.716 A:middle
in Xcode 9.

00:11:06.516 --> 00:11:11.576 A:middle
[ Applause ]

00:11:12.076 --> 00:11:13.836 A:middle
Now let's talk about another

00:11:13.876 --> 00:11:15.886 A:middle
large source of problems -

00:11:16.196 --> 00:11:16.856 A:middle
memory issues.

00:11:17.286 --> 00:11:18.476 A:middle
And let's talk about Address

00:11:18.476 --> 00:11:20.386 A:middle
Sanitizer, which finds those

00:11:20.436 --> 00:11:20.806 A:middle
issues.

00:11:22.196 --> 00:11:24.106 A:middle
Address Sanitizer has been

00:11:24.106 --> 00:11:25.966 A:middle
introduced in Xcode 7, two years

00:11:25.966 --> 00:11:26.346 A:middle
ago.

00:11:26.346 --> 00:11:28.096 A:middle
And it's proven to be a great

00:11:28.096 --> 00:11:29.046 A:middle
tool because it finds

00:11:29.356 --> 00:11:30.566 A:middle
security-critical issues.

00:11:30.676 --> 00:11:32.146 A:middle
For example, use after free bugs

00:11:32.606 --> 00:11:33.466 A:middle
and buffer overflows.

00:11:34.706 --> 00:11:36.226 A:middle
It's also very helpful when

00:11:36.346 --> 00:11:37.706 A:middle
trying to diagnose hard to

00:11:37.706 --> 00:11:38.566 A:middle
reproduce crashes.

00:11:38.566 --> 00:11:39.996 A:middle
Because it often makes those

00:11:39.996 --> 00:11:42.456 A:middle
crashes deterministic and it

00:11:42.456 --> 00:11:44.216 A:middle
finds memory corruptions when

00:11:44.216 --> 00:11:45.406 A:middle
they actually happen and not

00:11:45.456 --> 00:11:46.656 A:middle
some time later when the

00:11:46.706 --> 00:11:47.676 A:middle
corruption affects some

00:11:47.676 --> 00:11:48.516 A:middle
unrelated code.

00:11:49.416 --> 00:11:51.066 A:middle
If you'd like to know about how

00:11:51.066 --> 00:11:52.756 A:middle
this tool works and which exact

00:11:52.856 --> 00:11:54.266 A:middle
bugs can it find, I recommend

00:11:54.266 --> 00:11:56.196 A:middle
that you watch a WWDC from two

00:11:56.196 --> 00:11:57.796 A:middle
years ago called advanced

00:11:57.836 --> 00:11:59.796 A:middle
debugging and Address Sanitizer.

00:12:00.666 --> 00:12:01.596 A:middle
In that session, we have

00:12:01.656 --> 00:12:02.896 A:middle
introduced the tool and we have

00:12:02.896 --> 00:12:04.656 A:middle
also talked about how it works

00:12:04.656 --> 00:12:05.806 A:middle
under the hood.

00:12:06.646 --> 00:12:08.246 A:middle
Address Sanitizer is also

00:12:08.246 --> 00:12:10.416 A:middle
integrated into Xcode UI and

00:12:10.416 --> 00:12:11.136 A:middle
into Debugger.

00:12:11.136 --> 00:12:12.446 A:middle
Let's take a look.

00:12:12.506 --> 00:12:13.816 A:middle
If you want to use Address

00:12:13.816 --> 00:12:15.356 A:middle
Sanitizer, all you have to do is

00:12:15.436 --> 00:12:16.646 A:middle
again go to the scheme editor

00:12:16.646 --> 00:12:18.146 A:middle
and you'll find that there's a

00:12:18.146 --> 00:12:19.156 A:middle
checkbox called Address

00:12:19.156 --> 00:12:20.966 A:middle
Sanitizer which can be used to

00:12:20.966 --> 00:12:21.716 A:middle
enable this tool.

00:12:22.816 --> 00:12:24.586 A:middle
In Xcode 9 we have added another

00:12:24.736 --> 00:12:26.426 A:middle
checkbox that turns on an

00:12:26.426 --> 00:12:28.556 A:middle
optional check of use of stack

00:12:28.556 --> 00:12:30.046 A:middle
after return, and I will

00:12:30.046 --> 00:12:31.046 A:middle
describe this feature later.

00:12:31.946 --> 00:12:33.686 A:middle
But you can also notice that we

00:12:33.686 --> 00:12:35.016 A:middle
have now added compatibility

00:12:35.016 --> 00:12:35.856 A:middle
with Malloc Scribble.

00:12:35.856 --> 00:12:38.146 A:middle
So, you can enable both of these

00:12:38.146 --> 00:12:41.106 A:middle
tools at the same time.

00:12:41.106 --> 00:12:42.856 A:middle
You can then run and debug your

00:12:42.856 --> 00:12:44.566 A:middle
application as you are used to.

00:12:45.166 --> 00:12:47.776 A:middle
And if your program doesn't have

00:12:47.776 --> 00:12:49.046 A:middle
any memory issues and if it's

00:12:49.046 --> 00:12:50.246 A:middle
not touching any memory that

00:12:50.246 --> 00:12:52.716 A:middle
it's not supposed to, then good.

00:12:52.716 --> 00:12:53.816 A:middle
Address Sanitizer will not

00:12:53.816 --> 00:12:55.116 A:middle
interrupt your work flow.

00:12:55.466 --> 00:12:57.606 A:middle
But if it finds a problem, it

00:12:57.606 --> 00:12:59.006 A:middle
will stop the program and it

00:12:59.006 --> 00:13:00.246 A:middle
will describe what the issue is.

00:13:00.356 --> 00:13:02.196 A:middle
So, in this case we are

00:13:02.196 --> 00:13:03.346 A:middle
accidently using some

00:13:03.346 --> 00:13:04.416 A:middle
deallocated memory.

00:13:04.456 --> 00:13:06.456 A:middle
And that's a serious bug.

00:13:07.056 --> 00:13:08.466 A:middle
And when Address Sanitizer finds

00:13:08.466 --> 00:13:10.316 A:middle
this bug, it will also display

00:13:10.616 --> 00:13:12.016 A:middle
some additional information

00:13:12.186 --> 00:13:13.336 A:middle
about that memory that we're

00:13:13.336 --> 00:13:13.866 A:middle
accessing.

00:13:14.446 --> 00:13:15.806 A:middle
And we'll get not just its

00:13:15.806 --> 00:13:17.816 A:middle
address but we'll also get some

00:13:17.816 --> 00:13:18.856 A:middle
description of it.

00:13:18.856 --> 00:13:21.236 A:middle
How large the heap region is and

00:13:21.236 --> 00:13:22.486 A:middle
which byte out of it are we

00:13:22.486 --> 00:13:23.046 A:middle
accessing.

00:13:23.696 --> 00:13:25.506 A:middle
And we also get the allocation

00:13:25.506 --> 00:13:27.586 A:middle
and deallocation backtrace of

00:13:27.586 --> 00:13:29.226 A:middle
how that memory was allocated.

00:13:29.226 --> 00:13:31.476 A:middle
So, this is super useful

00:13:31.476 --> 00:13:32.556 A:middle
information when you're dealing

00:13:32.556 --> 00:13:33.936 A:middle
with use after free bugs,

00:13:34.526 --> 00:13:35.966 A:middle
because this really helps to

00:13:35.966 --> 00:13:37.826 A:middle
diagnose them, right?

00:13:39.456 --> 00:13:41.726 A:middle
So, we've seen what Address

00:13:41.726 --> 00:13:43.026 A:middle
Sanitizer is but now let's talk

00:13:43.026 --> 00:13:44.206 A:middle
about some new features that we

00:13:44.206 --> 00:13:45.166 A:middle
have added this year.

00:13:45.546 --> 00:13:47.346 A:middle
It now detects two new classes

00:13:47.346 --> 00:13:48.156 A:middle
of bugs.

00:13:48.156 --> 00:13:49.806 A:middle
Use after scope and use after

00:13:49.806 --> 00:13:50.236 A:middle
return.

00:13:50.236 --> 00:13:51.946 A:middle
And it's also now compatible

00:13:51.946 --> 00:13:52.726 A:middle
with Malloc Scribble.

00:13:52.956 --> 00:13:53.736 A:middle
Let's take a look at some

00:13:53.736 --> 00:13:54.256 A:middle
examples.

00:13:54.916 --> 00:13:58.916 A:middle
In this code sample, let's say

00:13:58.916 --> 00:14:00.486 A:middle
we have a variable that is

00:14:00.606 --> 00:14:02.386 A:middle
defined inside the body of an if

00:14:02.386 --> 00:14:02.856 A:middle
statement.

00:14:04.476 --> 00:14:06.466 A:middle
We take a pointer to this

00:14:06.466 --> 00:14:09.576 A:middle
variable and then later outside

00:14:09.776 --> 00:14:11.806 A:middle
that if statement, we are using

00:14:11.806 --> 00:14:12.956 A:middle
that pointer to save a new

00:14:12.956 --> 00:14:13.456 A:middle
value.

00:14:14.226 --> 00:14:15.386 A:middle
So, this is any value because we

00:14:15.386 --> 00:14:16.796 A:middle
are, the pointer is no longer

00:14:16.796 --> 00:14:17.376 A:middle
valid here.

00:14:17.666 --> 00:14:19.036 A:middle
And address sanitizer is now

00:14:19.036 --> 00:14:20.696 A:middle
able to detect and describe the

00:14:20.696 --> 00:14:21.306 A:middle
issue for you.

00:14:21.786 --> 00:14:26.546 A:middle
Another type of bug happens when

00:14:26.546 --> 00:14:28.536 A:middle
you're returning, when you're

00:14:28.536 --> 00:14:30.476 A:middle
using a pointer out, after

00:14:30.476 --> 00:14:31.836 A:middle
returning from a function.

00:14:31.836 --> 00:14:33.476 A:middle
So, in this case the function

00:14:33.476 --> 00:14:34.986 A:middle
returns a pointer to its local

00:14:34.986 --> 00:14:37.446 A:middle
variable which means that once

00:14:37.446 --> 00:14:38.966 A:middle
the function returns, that

00:14:38.966 --> 00:14:40.216 A:middle
pointer is no longer valid.

00:14:40.216 --> 00:14:42.696 A:middle
And if we try to use it, we are

00:14:42.696 --> 00:14:44.046 A:middle
again accessing garbage memory

00:14:44.046 --> 00:14:45.426 A:middle
and the Address Sanitizer is

00:14:45.426 --> 00:14:47.306 A:middle
able to detect that and describe

00:14:47.306 --> 00:14:48.136 A:middle
that issue for you.

00:14:48.796 --> 00:14:50.546 A:middle
However, this check is not

00:14:50.546 --> 00:14:52.386 A:middle
enabled by default and because

00:14:52.386 --> 00:14:53.676 A:middle
it has some extra overhead and

00:14:53.676 --> 00:14:54.596 A:middle
you have to opt into it.

00:14:55.006 --> 00:14:56.746 A:middle
To do so, you can use that extra

00:14:56.746 --> 00:14:58.226 A:middle
checkbox in the scheme editor

00:14:58.286 --> 00:14:59.496 A:middle
that I mentioned and showed

00:14:59.496 --> 00:14:59.846 A:middle
earlier.

00:15:04.026 --> 00:15:05.936 A:middle
Now, if your projects are

00:15:05.936 --> 00:15:07.846 A:middle
written in Swift, you might be

00:15:07.846 --> 00:15:09.606 A:middle
wondering why should I care

00:15:09.606 --> 00:15:10.686 A:middle
about Address Sanitizer?

00:15:11.286 --> 00:15:13.726 A:middle
Swift is a much safer language

00:15:13.806 --> 00:15:15.136 A:middle
but the reality is that a lot of

00:15:15.136 --> 00:15:16.556 A:middle
projects are still mixed and

00:15:16.556 --> 00:15:18.136 A:middle
they have bugs written in C and

00:15:18.136 --> 00:15:18.786 A:middle
Objective C.

00:15:19.036 --> 00:15:20.756 A:middle
And for those parts that are

00:15:20.756 --> 00:15:21.956 A:middle
written in C and Objective C,

00:15:22.266 --> 00:15:23.506 A:middle
address sanitizer is still a

00:15:23.506 --> 00:15:24.866 A:middle
very effective tool and it will

00:15:24.866 --> 00:15:26.426 A:middle
find memory issues in that, in

00:15:26.426 --> 00:15:29.026 A:middle
these parts of your project.

00:15:29.096 --> 00:15:30.646 A:middle
Some of you might also be using

00:15:30.646 --> 00:15:32.906 A:middle
unsafe pointer types which, as

00:15:32.906 --> 00:15:35.226 A:middle
their name suggests, are not

00:15:35.226 --> 00:15:36.286 A:middle
memory safe and you have to be

00:15:36.346 --> 00:15:37.386 A:middle
careful when using those.

00:15:37.726 --> 00:15:38.516 A:middle
So, let's take code as an

00:15:38.516 --> 00:15:39.006 A:middle
example.

00:15:40.446 --> 00:15:42.416 A:middle
In this code, I have a string,

00:15:42.416 --> 00:15:43.156 A:middle
Hello, World.

00:15:43.156 --> 00:15:45.126 A:middle
And I am trying to convert it

00:15:45.156 --> 00:15:47.886 A:middle
into a C-style string using

00:15:47.886 --> 00:15:48.536 A:middle
unsafe windows.

00:15:49.896 --> 00:15:51.276 A:middle
So what I'll do is that I will

00:15:51.276 --> 00:15:53.246 A:middle
call this API called with C

00:15:53.316 --> 00:15:55.276 A:middle
string and it will create an

00:15:55.276 --> 00:15:56.286 A:middle
unsafe pointer for me.

00:15:56.836 --> 00:15:59.016 A:middle
And this will provide this

00:15:59.016 --> 00:16:00.416 A:middle
unsafe pointer to me in this

00:16:00.476 --> 00:16:01.826 A:middle
closure that I am passing

00:16:01.826 --> 00:16:02.086 A:middle
through it.

00:16:03.306 --> 00:16:05.536 A:middle
If I store this pointer outside

00:16:05.536 --> 00:16:07.596 A:middle
of the closure, I am violating

00:16:07.596 --> 00:16:08.776 A:middle
the rules of the C string.

00:16:08.776 --> 00:16:10.366 A:middle
And that means that when I try

00:16:10.366 --> 00:16:13.006 A:middle
to use this leak unsafe pointer

00:16:13.406 --> 00:16:15.106 A:middle
later, I am again accessing

00:16:15.106 --> 00:16:15.856 A:middle
invalid memory.

00:16:15.986 --> 00:16:17.696 A:middle
And Address Sanitizer is able to

00:16:17.696 --> 00:16:19.386 A:middle
detect invalid uses of unsafe

00:16:19.386 --> 00:16:20.616 A:middle
pointers like this, even in

00:16:20.616 --> 00:16:21.116 A:middle
Swift code.

00:16:24.776 --> 00:16:26.346 A:middle
To fix this, we need to make

00:16:26.346 --> 00:16:27.656 A:middle
sure that we only use that

00:16:27.756 --> 00:16:30.086 A:middle
provided unsafe pointer within

00:16:30.086 --> 00:16:31.316 A:middle
the closure that we are passing

00:16:31.406 --> 00:16:32.076 A:middle
with C string.

00:16:32.116 --> 00:16:34.286 A:middle
So, if we move the code into the

00:16:34.286 --> 00:16:35.896 A:middle
closure like this, that fixes

00:16:35.896 --> 00:16:36.516 A:middle
the problem.

00:16:36.516 --> 00:16:38.226 A:middle
And in this case, we can

00:16:38.286 --> 00:16:39.796 A:middle
simplify the code even further

00:16:39.796 --> 00:16:41.136 A:middle
and just remove that local

00:16:41.136 --> 00:16:42.086 A:middle
variable completely.

00:16:42.566 --> 00:16:44.126 A:middle
It is generally a good idea

00:16:44.736 --> 00:16:46.486 A:middle
never to store unsafe pointers

00:16:46.486 --> 00:16:47.786 A:middle
into local variables or

00:16:47.786 --> 00:16:48.486 A:middle
properties.

00:16:49.886 --> 00:16:51.476 A:middle
So, if you are using unsafe

00:16:51.476 --> 00:16:52.906 A:middle
pointers in your Swift projects,

00:16:53.366 --> 00:16:54.626 A:middle
I definitely will recommend that

00:16:54.626 --> 00:16:56.096 A:middle
you turn Address Sanitizer on in

00:16:56.096 --> 00:16:57.616 A:middle
your projects just to make sure

00:16:57.616 --> 00:16:58.676 A:middle
that you are not accidently

00:16:58.676 --> 00:16:59.996 A:middle
using unsafe pointers wrong.

00:17:03.116 --> 00:17:05.156 A:middle
So we've seen how Address

00:17:05.156 --> 00:17:07.626 A:middle
Sanitizer helps you find and fix

00:17:07.626 --> 00:17:07.936 A:middle
bugs.

00:17:07.936 --> 00:17:09.566 A:middle
But it can also be a very

00:17:09.566 --> 00:17:11.026 A:middle
helpful tool for general

00:17:11.026 --> 00:17:12.186 A:middle
debugging as well.

00:17:13.206 --> 00:17:15.226 A:middle
Because have, if you, when you

00:17:15.226 --> 00:17:16.466 A:middle
are debugging your projects,

00:17:16.466 --> 00:17:18.986 A:middle
have you ever wondered where was

00:17:18.986 --> 00:17:20.056 A:middle
this memory allocated?

00:17:20.866 --> 00:17:21.856 A:middle
Well, I have some good news for

00:17:21.856 --> 00:17:22.196 A:middle
you.

00:17:22.406 --> 00:17:23.476 A:middle
If you are running with Address

00:17:23.476 --> 00:17:26.216 A:middle
Sanitizer, it's actually enabled

00:17:26.216 --> 00:17:27.546 A:middle
to tell you the allocation

00:17:27.586 --> 00:17:28.756 A:middle
backtraces of any memory that

00:17:28.756 --> 00:17:29.236 A:middle
you ask it.

00:17:30.126 --> 00:17:31.256 A:middle
And it can also provide the

00:17:31.256 --> 00:17:32.766 A:middle
deallocation backtraces for

00:17:32.766 --> 00:17:33.766 A:middle
memory that's already

00:17:33.766 --> 00:17:34.356 A:middle
deallocated.

00:17:35.246 --> 00:17:36.436 A:middle
And furthermore, it can show you

00:17:36.436 --> 00:17:38.076 A:middle
which bytes of memory are valid

00:17:38.076 --> 00:17:38.686 A:middle
and invalid.

00:17:38.746 --> 00:17:40.946 A:middle
So, let's take a look.

00:17:41.326 --> 00:17:43.146 A:middle
This time we are not

00:17:43.146 --> 00:17:44.246 A:middle
investigating a crash.

00:17:44.496 --> 00:17:46.476 A:middle
This is just a regular debugging

00:17:46.526 --> 00:17:48.216 A:middle
session where I'm stepping over

00:17:48.216 --> 00:17:49.276 A:middle
the lines in a function.

00:17:49.846 --> 00:17:52.826 A:middle
I can control click any variable

00:17:52.826 --> 00:17:53.696 A:middle
in the variable view.

00:17:53.696 --> 00:17:55.596 A:middle
And if that variable is a

00:17:55.596 --> 00:17:58.226 A:middle
pointer, I can select view

00:17:58.226 --> 00:17:59.526 A:middle
memory of.

00:18:00.816 --> 00:18:02.536 A:middle
Normally this would just give me

00:18:02.536 --> 00:18:04.866 A:middle
the view of, into the bytes of

00:18:04.866 --> 00:18:05.646 A:middle
that memory object.

00:18:06.676 --> 00:18:07.506 A:middle
But if you are running with

00:18:07.506 --> 00:18:09.206 A:middle
Address Sanitizer enabled, you

00:18:09.206 --> 00:18:11.336 A:middle
can expand the memory item in

00:18:11.336 --> 00:18:13.146 A:middle
that navigator and it will

00:18:13.146 --> 00:18:14.216 A:middle
display the allocation and

00:18:14.216 --> 00:18:15.606 A:middle
deallocation backtrace for that

00:18:15.606 --> 00:18:15.996 A:middle
memory.

00:18:16.586 --> 00:18:19.756 A:middle
You can also notice that some of

00:18:19.756 --> 00:18:21.246 A:middle
the bytes in this memory view

00:18:21.246 --> 00:18:22.976 A:middle
are grey and some are displayed

00:18:22.976 --> 00:18:23.836 A:middle
in black.

00:18:24.596 --> 00:18:26.316 A:middle
The greyed-out bytes indicate

00:18:26.456 --> 00:18:28.206 A:middle
invalid memory and, or as we

00:18:28.206 --> 00:18:29.656 A:middle
say, poisoned memory.

00:18:30.086 --> 00:18:30.846 A:middle
Which means that your

00:18:30.846 --> 00:18:31.926 A:middle
application must not be

00:18:31.926 --> 00:18:33.456 A:middle
accessing those bytes and if it

00:18:33.456 --> 00:18:34.656 A:middle
does so, that is a bug.

00:18:34.656 --> 00:18:36.206 A:middle
And Address Sanitizer will find

00:18:36.206 --> 00:18:37.486 A:middle
it and detect it.

00:18:38.876 --> 00:18:40.826 A:middle
You can also access the

00:18:40.826 --> 00:18:42.316 A:middle
information about the allocation

00:18:42.316 --> 00:18:43.596 A:middle
and deallocation of memory

00:18:43.596 --> 00:18:45.136 A:middle
objects in the [inaudible] text

00:18:45.136 --> 00:18:45.666 A:middle
console.

00:18:45.936 --> 00:18:47.266 A:middle
We can use this command called

00:18:47.266 --> 00:18:49.466 A:middle
memory history and pass it any

00:18:49.466 --> 00:18:50.816 A:middle
expression that evaluates to a

00:18:50.816 --> 00:18:51.236 A:middle
pointer.

00:18:52.636 --> 00:18:54.346 A:middle
So, let's use the pointer value

00:18:54.346 --> 00:18:56.066 A:middle
directly in this example and the

00:18:56.066 --> 00:18:57.996 A:middle
text console will print out to

00:18:57.996 --> 00:18:59.276 A:middle
allocation and deallocation

00:18:59.336 --> 00:19:00.516 A:middle
backtraces in text output.

00:19:00.516 --> 00:19:05.316 A:middle
So, I hope that I have convinced

00:19:05.366 --> 00:19:06.516 A:middle
you that Address Sanitizer is

00:19:06.516 --> 00:19:08.586 A:middle
great tool and that it's useful

00:19:08.586 --> 00:19:10.366 A:middle
for both C languages and also

00:19:10.366 --> 00:19:10.706 A:middle
Swift.

00:19:10.706 --> 00:19:12.596 A:middle
And that it helps with memory

00:19:12.596 --> 00:19:13.596 A:middle
corruptions and crashes.

00:19:14.246 --> 00:19:15.856 A:middle
But also that it's a very useful

00:19:15.856 --> 00:19:17.216 A:middle
tool for general debugging as

00:19:17.216 --> 00:19:17.716 A:middle
well.

00:19:18.636 --> 00:19:19.996 A:middle
But now let's talk, let's take a

00:19:19.996 --> 00:19:22.616 A:middle
look at another large source of

00:19:22.616 --> 00:19:24.226 A:middle
crashes and mysterious memory

00:19:24.226 --> 00:19:25.196 A:middle
corruptions, which is

00:19:25.196 --> 00:19:25.796 A:middle
multithreading.

00:19:26.456 --> 00:19:27.866 A:middle
And let's talk about Thread

00:19:27.866 --> 00:19:29.226 A:middle
Sanitizer which detects those

00:19:29.266 --> 00:19:29.646 A:middle
issues.

00:19:30.126 --> 00:19:33.586 A:middle
So, as I said, Thread Sanitizer

00:19:33.586 --> 00:19:35.506 A:middle
is able to find multithreading

00:19:35.506 --> 00:19:35.856 A:middle
issues.

00:19:35.956 --> 00:19:37.336 A:middle
For example, data races.

00:19:38.606 --> 00:19:39.996 A:middle
However, these issues,

00:19:39.996 --> 00:19:41.826 A:middle
multithreading issues, are

00:19:42.266 --> 00:19:43.556 A:middle
usually very sensitive to

00:19:43.556 --> 00:19:44.106 A:middle
timing.

00:19:44.616 --> 00:19:46.846 A:middle
Which means that they are very

00:19:46.846 --> 00:19:47.826 A:middle
hard to reproduce.

00:19:48.326 --> 00:19:50.716 A:middle
So, Thread Sanitizer is not only

00:19:50.716 --> 00:19:52.676 A:middle
able to find races where the two

00:19:52.676 --> 00:19:53.776 A:middle
memory accesses actually

00:19:53.776 --> 00:19:55.416 A:middle
collide, but it can also find

00:19:55.416 --> 00:19:57.846 A:middle
races that did not manifest

00:19:57.846 --> 00:19:59.336 A:middle
during that particular program

00:19:59.336 --> 00:19:59.546 A:middle
run.

00:20:00.106 --> 00:20:02.986 A:middle
Even if the racing memory

00:20:02.986 --> 00:20:04.546 A:middle
accesses happened at different

00:20:04.546 --> 00:20:05.716 A:middle
times but there's no

00:20:05.716 --> 00:20:06.966 A:middle
synchronization between them,

00:20:07.346 --> 00:20:08.406 A:middle
that is still a race.

00:20:08.576 --> 00:20:10.056 A:middle
And Thread Sanitizer is able to

00:20:10.056 --> 00:20:10.476 A:middle
find it.

00:20:11.496 --> 00:20:13.446 A:middle
That's because the next time you

00:20:13.446 --> 00:20:15.806 A:middle
run your application, the timing

00:20:15.806 --> 00:20:17.276 A:middle
will be different and it might

00:20:17.276 --> 00:20:18.826 A:middle
be just right to trigger a

00:20:18.826 --> 00:20:19.586 A:middle
memory corruption.

00:20:20.196 --> 00:20:21.386 A:middle
So, Thread Sanitizer is able to

00:20:21.386 --> 00:20:22.756 A:middle
find races even when they do not

00:20:22.756 --> 00:20:23.206 A:middle
manifest.

00:20:23.756 --> 00:20:27.666 A:middle
The tool works on 64-bit macOS

00:20:27.666 --> 00:20:29.086 A:middle
and 64-bit simulators.

00:20:29.086 --> 00:20:30.356 A:middle
And if you want to learn more

00:20:30.356 --> 00:20:31.756 A:middle
about the underlying technology,

00:20:31.756 --> 00:20:34.066 A:middle
I recommend that you watch a

00:20:34.066 --> 00:20:36.296 A:middle
WWDC from last year called

00:20:36.296 --> 00:20:37.546 A:middle
Thread Sanitizer and static

00:20:37.546 --> 00:20:38.026 A:middle
analysis.

00:20:40.816 --> 00:20:42.346 A:middle
So, I mentioned data races.

00:20:42.906 --> 00:20:43.896 A:middle
But let's see what they are.

00:20:45.796 --> 00:20:48.426 A:middle
Any shared data, any mutable

00:20:48.426 --> 00:20:49.646 A:middle
data that is shared between

00:20:49.646 --> 00:20:51.386 A:middle
multiple threads needs access

00:20:51.386 --> 00:20:52.076 A:middle
synchronization.

00:20:52.856 --> 00:20:53.546 A:middle
If you are missing

00:20:53.546 --> 00:20:54.926 A:middle
synchronization on your shared

00:20:55.076 --> 00:20:57.016 A:middle
mutable variables, that means

00:20:57.016 --> 00:20:57.766 A:middle
you have data races.

00:20:57.996 --> 00:20:59.366 A:middle
And data races are undefined

00:20:59.366 --> 00:20:59.866 A:middle
behavior.

00:21:01.326 --> 00:21:02.916 A:middle
And in presence of data races,

00:21:02.916 --> 00:21:04.156 A:middle
our programs can have memory

00:21:04.156 --> 00:21:05.956 A:middle
corruptions and crashes and all

00:21:05.956 --> 00:21:07.416 A:middle
of these problems apply to C

00:21:07.416 --> 00:21:08.956 A:middle
languages but also to SWF code

00:21:08.956 --> 00:21:09.356 A:middle
as well.

00:21:09.356 --> 00:21:10.856 A:middle
So, let's take a look at an

00:21:10.856 --> 00:21:13.916 A:middle
example in Swift.

00:21:14.066 --> 00:21:16.046 A:middle
So, in this case we have a class

00:21:16.046 --> 00:21:18.456 A:middle
called event log which just has

00:21:18.456 --> 00:21:20.946 A:middle
a simple function called log

00:21:21.316 --> 00:21:22.466 A:middle
that prints out some text

00:21:22.466 --> 00:21:23.596 A:middle
message to the output.

00:21:24.496 --> 00:21:27.066 A:middle
But it also tracks which was the

00:21:27.066 --> 00:21:28.666 A:middle
last event source that called

00:21:28.666 --> 00:21:29.346 A:middle
that log.

00:21:30.036 --> 00:21:31.446 A:middle
And it saves that information

00:21:31.696 --> 00:21:33.556 A:middle
into a stored property called

00:21:33.556 --> 00:21:35.896 A:middle
last event stores which is an

00:21:35.896 --> 00:21:38.476 A:middle
optional and at the beginning

00:21:38.476 --> 00:21:39.976 A:middle
it's nil but as soon as someone

00:21:39.976 --> 00:21:42.606 A:middle
calls log, it will be perfectly

00:21:42.606 --> 00:21:43.936 A:middle
will be populated with that

00:21:43.936 --> 00:21:45.136 A:middle
particular log source.

00:21:45.996 --> 00:21:46.866 A:middle
And now let's say that we have

00:21:46.946 --> 00:21:48.556 A:middle
two threads which are both

00:21:48.626 --> 00:21:50.476 A:middle
trying to call that log at the

00:21:50.536 --> 00:21:51.046 A:middle
same time.

00:21:51.376 --> 00:21:53.216 A:middle
Let's say that thread one is our

00:21:53.216 --> 00:21:54.526 A:middle
networking subsystem and it's

00:21:54.526 --> 00:21:55.656 A:middle
logging that some download has

00:21:55.716 --> 00:21:56.046 A:middle
finished.

00:21:56.736 --> 00:21:58.376 A:middle
While the second thread, which

00:21:58.376 --> 00:21:59.416 A:middle
represents our database

00:21:59.416 --> 00:22:01.276 A:middle
subsystem, is logging that query

00:22:01.276 --> 00:22:01.886 A:middle
is completed.

00:22:03.276 --> 00:22:04.316 A:middle
That is a data race.

00:22:05.366 --> 00:22:06.816 A:middle
Because we're accessing the same

00:22:06.816 --> 00:22:08.366 A:middle
memory location at the same

00:22:08.366 --> 00:22:08.676 A:middle
time.

00:22:09.966 --> 00:22:11.596 A:middle
And Thread Sanitizer will warn

00:22:12.316 --> 00:22:13.326 A:middle
about this.

00:22:13.526 --> 00:22:15.676 A:middle
So, to fix this we need to

00:22:15.886 --> 00:22:17.326 A:middle
introduce synchronization.

00:22:17.506 --> 00:22:18.696 A:middle
And the easiest way to do that

00:22:19.146 --> 00:22:20.766 A:middle
is by using a serial dispatch

00:22:20.796 --> 00:22:21.006 A:middle
queue.

00:22:21.816 --> 00:22:22.886 A:middle
Now, because this queue is

00:22:23.136 --> 00:22:25.526 A:middle
serial, it will only execute one

00:22:25.526 --> 00:22:26.836 A:middle
work item at a time.

00:22:27.936 --> 00:22:31.056 A:middle
So, if we wrap the body of the

00:22:31.056 --> 00:22:33.276 A:middle
log function into queue.asynch,

00:22:34.276 --> 00:22:35.296 A:middle
this will provide the correct

00:22:35.296 --> 00:22:36.046 A:middle
synchronization.

00:22:36.416 --> 00:22:38.166 A:middle
And note that I am using asynch

00:22:38.166 --> 00:22:39.756 A:middle
here because we don't need to

00:22:39.756 --> 00:22:41.306 A:middle
wait for the result of this

00:22:41.306 --> 00:22:42.196 A:middle
function to complete.

00:22:42.196 --> 00:22:43.986 A:middle
Because this function does not

00:22:43.986 --> 00:22:45.136 A:middle
provide any results so it

00:22:45.136 --> 00:22:46.146 A:middle
doesn't make sense to wait for

00:22:46.146 --> 00:22:46.216 A:middle
it.

00:22:46.756 --> 00:22:48.276 A:middle
So, this not only fixes that

00:22:48.276 --> 00:22:49.776 A:middle
race but it also improves

00:22:50.886 --> 00:22:52.036 A:middle
[inaudible] because now whoever

00:22:52.036 --> 00:22:54.146 A:middle
calls log will no longer need to

00:22:54.146 --> 00:22:55.336 A:middle
wait for this printing to

00:22:55.336 --> 00:22:55.756 A:middle
finish.

00:22:56.296 --> 00:22:59.856 A:middle
And this way this whole class is

00:22:59.856 --> 00:23:01.186 A:middle
now thread safe and we can use,

00:23:01.386 --> 00:23:02.966 A:middle
we can call log from multiple

00:23:04.996 --> 00:23:05.516 A:middle
threads.

00:23:05.516 --> 00:23:06.546 A:middle
Dispatch queues, which are

00:23:06.546 --> 00:23:08.156 A:middle
provided by Grand Central

00:23:08.156 --> 00:23:10.896 A:middle
Dispatch or GCD for short, are

00:23:10.896 --> 00:23:12.136 A:middle
readily available in Swift and

00:23:12.136 --> 00:23:13.326 A:middle
they should be your first choice

00:23:13.326 --> 00:23:14.186 A:middle
of synchronization.

00:23:14.836 --> 00:23:16.096 A:middle
Even though there's other

00:23:16.096 --> 00:23:17.656 A:middle
mechanisms of providing

00:23:17.686 --> 00:23:19.436 A:middle
synchronization, GCD is very

00:23:19.436 --> 00:23:20.986 A:middle
lightweight and it's very easy

00:23:20.986 --> 00:23:21.766 A:middle
to use from Swift.

00:23:22.786 --> 00:23:24.416 A:middle
A good idea is to associate your

00:23:24.416 --> 00:23:26.236 A:middle
data with serial dispatch

00:23:26.276 --> 00:23:26.616 A:middle
queues.

00:23:26.966 --> 00:23:28.506 A:middle
And only accessing the data from

00:23:28.506 --> 00:23:30.206 A:middle
those queues, which will

00:23:30.206 --> 00:23:32.136 A:middle
guarantee that you're only using

00:23:32.166 --> 00:23:33.806 A:middle
your data in a synchronized way.

00:23:34.336 --> 00:23:35.706 A:middle
And if you'd like to learn more

00:23:35.706 --> 00:23:37.626 A:middle
about how to use concurrency

00:23:37.626 --> 00:23:39.786 A:middle
with GCD, I recommend that you

00:23:39.786 --> 00:23:41.816 A:middle
watch another WWDC from last

00:23:41.816 --> 00:23:42.806 A:middle
year called concurrent

00:23:42.846 --> 00:23:44.206 A:middle
programming with GCD and Swift

00:23:44.266 --> 00:23:44.506 A:middle
3.

00:23:45.046 --> 00:23:48.046 A:middle
But now let's take a look at

00:23:48.046 --> 00:23:49.146 A:middle
some new features that we have

00:23:49.146 --> 00:23:50.796 A:middle
added to Thread Sanitizer in

00:23:50.826 --> 00:23:51.476 A:middle
Xcode 9.

00:23:52.146 --> 00:23:53.886 A:middle
It's now able to detect races on

00:23:53.886 --> 00:23:57.586 A:middle
collections and also a whole new

00:23:57.586 --> 00:23:59.706 A:middle
class of bugs that is specific

00:23:59.796 --> 00:24:02.206 A:middle
to Swift code.

00:24:02.406 --> 00:24:04.336 A:middle
Previously Thread Sanitizer was

00:24:04.416 --> 00:24:06.476 A:middle
only able to find races on the

00:24:06.476 --> 00:24:08.346 A:middle
raw memory accesses like we saw

00:24:08.346 --> 00:24:09.606 A:middle
in the previous example where we

00:24:09.606 --> 00:24:10.826 A:middle
were just directly accessing

00:24:11.076 --> 00:24:12.146 A:middle
some stored property.

00:24:13.436 --> 00:24:14.616 A:middle
But synchronization is often

00:24:14.616 --> 00:24:15.976 A:middle
needed even for larger data

00:24:16.036 --> 00:24:16.466 A:middle
structures.

00:24:16.466 --> 00:24:17.506 A:middle
For example, collections.

00:24:18.236 --> 00:24:19.996 A:middle
Consider this code example where

00:24:20.666 --> 00:24:22.256 A:middle
in Objective C we are using an

00:24:22.256 --> 00:24:23.886 A:middle
instance of an NS mutable

00:24:23.886 --> 00:24:24.346 A:middle
dictionary.

00:24:25.066 --> 00:24:26.526 A:middle
And two threads are using the

00:24:26.526 --> 00:24:27.226 A:middle
same instance.

00:24:27.296 --> 00:24:28.986 A:middle
Let's say thread one is looking

00:24:28.986 --> 00:24:30.316 A:middle
up a value in the dictionary

00:24:30.596 --> 00:24:31.636 A:middle
while the second thread is

00:24:31.676 --> 00:24:32.816 A:middle
trying to write into it.

00:24:33.706 --> 00:24:35.426 A:middle
So, it is a problem and newly in

00:24:35.426 --> 00:24:36.896 A:middle
Xcode 9 we are now able to

00:24:36.896 --> 00:24:38.146 A:middle
detect this race.

00:24:41.196 --> 00:24:42.986 A:middle
Races in collection are a very

00:24:42.986 --> 00:24:43.736 A:middle
common mistake.

00:24:44.896 --> 00:24:46.866 A:middle
So, in Xcode 9 we are now able

00:24:46.866 --> 00:24:48.516 A:middle
to detect them in both Objective

00:24:48.616 --> 00:24:49.686 A:middle
C and Swift.

00:24:50.306 --> 00:24:51.696 A:middle
Note that this requires that you

00:24:51.696 --> 00:24:53.506 A:middle
are using macOS, High Sierra and

00:24:53.506 --> 00:24:54.166 A:middle
iOS 11.

00:24:54.456 --> 00:24:55.806 A:middle
But we are able to detect races

00:24:55.806 --> 00:24:57.466 A:middle
on NS mutable array and NS

00:24:57.506 --> 00:24:59.286 A:middle
mutable dictionary and also on

00:24:59.286 --> 00:25:00.156 A:middle
Swift array and Swift

00:25:00.156 --> 00:25:00.636 A:middle
dictionary.

00:25:01.666 --> 00:25:02.966 A:middle
And with that, I'd like to show

00:25:02.966 --> 00:25:05.000 A:middle
you how this works in practice.

00:25:20.176 --> 00:25:22.326 A:middle
So, I was able to get the source

00:25:22.386 --> 00:25:25.246 A:middle
code of a very old version of

00:25:25.246 --> 00:25:27.636 A:middle
the WWDC app before it adopted

00:25:27.716 --> 00:25:28.266 A:middle
Swift code.

00:25:28.396 --> 00:25:30.376 A:middle
So, this version that I have is

00:25:30.376 --> 00:25:31.416 A:middle
still completely written in

00:25:31.416 --> 00:25:33.066 A:middle
Objective C, as you can tell

00:25:33.066 --> 00:25:34.686 A:middle
from this copyright header.

00:25:34.686 --> 00:25:38.316 A:middle
It was mostly written in 2011.

00:25:38.396 --> 00:25:39.556 A:middle
So, because it was written

00:25:40.386 --> 00:25:41.776 A:middle
several years ago, it's using

00:25:41.816 --> 00:25:43.486 A:middle
some outdated concepts like an

00:25:43.486 --> 00:25:44.596 A:middle
explicit threat for

00:25:44.596 --> 00:25:46.126 A:middle
synchronization instead of GCD.

00:25:46.436 --> 00:25:47.346 A:middle
But I'd like to show you that

00:25:47.696 --> 00:25:49.236 A:middle
thread sanitizer works just fine

00:25:49.236 --> 00:25:50.806 A:middle
even with other synchronization

00:25:50.806 --> 00:25:51.356 A:middle
mechanisms.

00:25:52.026 --> 00:25:54.946 A:middle
So, this file that I'm showing

00:25:54.946 --> 00:25:56.956 A:middle
to you is implementing a class

00:25:56.956 --> 00:25:59.236 A:middle
called WWDC URLConnection, which

00:25:59.236 --> 00:26:01.206 A:middle
serves as a base class for all

00:26:01.206 --> 00:26:02.466 A:middle
networking done from this

00:26:02.466 --> 00:26:03.086 A:middle
application.

00:26:03.536 --> 00:26:04.996 A:middle
And what I did is that I have

00:26:05.336 --> 00:26:07.356 A:middle
planted a multithreading bug in

00:26:07.356 --> 00:26:07.826 A:middle
this code.

00:26:08.356 --> 00:26:09.306 A:middle
And let's see if the Thread

00:26:09.386 --> 00:26:10.816 A:middle
Sanitizer can find this bug.

00:26:12.006 --> 00:26:13.406 A:middle
So, first let me make sure that

00:26:13.406 --> 00:26:14.616 A:middle
I have Thread Sanitizer enabled

00:26:14.676 --> 00:26:17.186 A:middle
by going to product scheme, edit

00:26:17.186 --> 00:26:17.636 A:middle
scheme.

00:26:18.356 --> 00:26:20.746 A:middle
Which brings out, brings the

00:26:20.846 --> 00:26:21.446 A:middle
scheme editor.

00:26:21.566 --> 00:26:23.046 A:middle
And you'll see that I have

00:26:23.116 --> 00:26:24.166 A:middle
Thread Sanitizer enabled.

00:26:24.656 --> 00:26:26.666 A:middle
So, let's now run this app in

00:26:26.666 --> 00:26:27.326 A:middle
the simulator.

00:26:27.886 --> 00:26:31.926 A:middle
And as soon as the app launches

00:26:31.926 --> 00:26:33.056 A:middle
in the simulator, it will

00:26:33.056 --> 00:26:35.076 A:middle
already initiate several network

00:26:35.076 --> 00:26:35.586 A:middle
connections.

00:26:37.006 --> 00:26:38.596 A:middle
So, it should already exercise

00:26:38.886 --> 00:26:40.236 A:middle
this file that I'm showing you.

00:26:41.116 --> 00:26:42.826 A:middle
And you can notice that Xcode is

00:26:42.826 --> 00:26:45.666 A:middle
already reporting a race in the

00:26:45.666 --> 00:26:46.426 A:middle
issue navigator.

00:26:47.026 --> 00:26:49.306 A:middle
So, this issue is reporting that

00:26:49.306 --> 00:26:49.996 A:middle
we have a race.

00:26:49.996 --> 00:26:51.346 A:middle
So, let me click it so we can

00:26:51.346 --> 00:26:52.826 A:middle
get to the line of code that

00:26:52.886 --> 00:26:54.206 A:middle
contains this race.

00:26:54.466 --> 00:26:55.636 A:middle
So, in this case we see that we

00:26:55.636 --> 00:26:58.126 A:middle
are adding some object into a

00:26:58.126 --> 00:26:58.806 A:middle
mutable array.

00:27:00.296 --> 00:27:01.996 A:middle
The purpose of this code is to

00:27:01.996 --> 00:27:03.416 A:middle
maintain a list of active,

00:27:03.466 --> 00:27:04.696 A:middle
currently active connections.

00:27:04.696 --> 00:27:06.286 A:middle
So, we are tracking that for

00:27:06.286 --> 00:27:07.186 A:middle
debugging purposes.

00:27:08.626 --> 00:27:10.266 A:middle
So, as soon as we're creating

00:27:10.266 --> 00:27:11.886 A:middle
some new URL connection, we will

00:27:11.886 --> 00:27:12.876 A:middle
add it to this list.

00:27:14.056 --> 00:27:15.166 A:middle
But this can happen from any

00:27:15.166 --> 00:27:15.376 A:middle
thread.

00:27:15.686 --> 00:27:17.616 A:middle
Any thread can create a new URL

00:27:17.616 --> 00:27:18.116 A:middle
connection.

00:27:18.836 --> 00:27:19.806 A:middle
And if we take a look at the

00:27:19.806 --> 00:27:21.016 A:middle
details of the issue one more

00:27:21.016 --> 00:27:22.536 A:middle
time in the navigator, we will

00:27:22.606 --> 00:27:23.676 A:middle
see that that is the case.

00:27:23.726 --> 00:27:25.236 A:middle
Because there's thread three

00:27:25.486 --> 00:27:26.926 A:middle
trying to call add object.

00:27:27.496 --> 00:27:29.166 A:middle
And thread five, also trying to

00:27:29.166 --> 00:27:31.246 A:middle
call add object into the same

00:27:31.636 --> 00:27:32.306 A:middle
mutable array.

00:27:33.256 --> 00:27:34.266 A:middle
And if we take a look at the

00:27:34.336 --> 00:27:36.496 A:middle
callers of that API, we will see

00:27:36.496 --> 00:27:39.196 A:middle
that they all both point to the

00:27:39.196 --> 00:27:40.086 A:middle
same line of code.

00:27:41.076 --> 00:27:42.026 A:middle
So, that is a problem.

00:27:42.026 --> 00:27:44.076 A:middle
We are accessing this mutable

00:27:44.076 --> 00:27:45.596 A:middle
array from multiple threads

00:27:45.596 --> 00:27:46.776 A:middle
without any synchronization.

00:27:47.856 --> 00:27:49.316 A:middle
And to fix it, I can actually

00:27:49.686 --> 00:27:50.616 A:middle
fix it very easily.

00:27:50.676 --> 00:27:52.816 A:middle
Because I have noticed that the

00:27:52.866 --> 00:27:54.456 A:middle
code right after this line is

00:27:54.456 --> 00:27:55.286 A:middle
already doing some

00:27:55.286 --> 00:27:56.076 A:middle
synchronization.

00:27:56.156 --> 00:27:57.626 A:middle
It's using this API called

00:27:57.696 --> 00:27:59.756 A:middle
perform block that dispatches

00:27:59.756 --> 00:28:01.336 A:middle
some work onto a specific

00:28:01.376 --> 00:28:01.626 A:middle
thread.

00:28:01.846 --> 00:28:02.816 A:middle
In this case, it's called

00:28:03.056 --> 00:28:03.716 A:middle
connection thread.

00:28:04.366 --> 00:28:05.716 A:middle
So, which is an explicit thread

00:28:05.756 --> 00:28:06.536 A:middle
that is used for

00:28:06.536 --> 00:28:07.326 A:middle
synchronization.

00:28:07.856 --> 00:28:09.546 A:middle
And since it's a single thread,

00:28:09.596 --> 00:28:11.926 A:middle
it will provide synchronization

00:28:11.926 --> 00:28:13.416 A:middle
exactly with the work serially

00:28:13.796 --> 00:28:14.896 A:middle
simply because it's a single

00:28:14.896 --> 00:28:15.756 A:middle
thread and there's no

00:28:16.106 --> 00:28:16.586 A:middle
[inaudible] going on.

00:28:17.316 --> 00:28:18.986 A:middle
So, to fix this I can just move

00:28:19.586 --> 00:28:22.356 A:middle
this call to add object into

00:28:22.356 --> 00:28:24.016 A:middle
that synchronized block like

00:28:24.016 --> 00:28:26.006 A:middle
this and that should fix our

00:28:26.006 --> 00:28:26.286 A:middle
race.

00:28:26.286 --> 00:28:28.456 A:middle
Because now we will also only be

00:28:28.456 --> 00:28:30.006 A:middle
accessing the active connection

00:28:30.266 --> 00:28:31.926 A:middle
array within the synchronized

00:28:31.926 --> 00:28:33.626 A:middle
block which is only executed

00:28:33.626 --> 00:28:34.096 A:middle
serially.

00:28:34.316 --> 00:28:35.826 A:middle
So, now let's run the app in the

00:28:35.826 --> 00:28:37.746 A:middle
simulator one more time to see

00:28:37.746 --> 00:28:39.276 A:middle
if that fixes our race.

00:28:40.876 --> 00:28:41.866 A:middle
And again, once the app

00:28:41.866 --> 00:28:43.996 A:middle
launches, it already triggers

00:28:43.996 --> 00:28:45.206 A:middle
several network connections.

00:28:45.626 --> 00:28:47.156 A:middle
So now when it's up and running

00:28:47.756 --> 00:28:49.236 A:middle
we'll see that Xcode is no

00:28:49.236 --> 00:28:51.326 A:middle
longer reporting any Runtime

00:28:54.576 --> 00:28:54.766 A:middle
issues.

00:28:56.516 --> 00:29:01.016 A:middle
[ Applause ]

00:29:01.516 --> 00:29:03.016 A:middle
So, you've seen how Thread

00:29:03.016 --> 00:29:04.816 A:middle
Sanitizer finds a race in

00:29:04.816 --> 00:29:05.646 A:middle
Objective C code.

00:29:06.456 --> 00:29:07.056 A:middle
What about Swift?

00:29:08.476 --> 00:29:09.656 A:middle
The same detection works in

00:29:09.656 --> 00:29:10.696 A:middle
Swift code as well.

00:29:11.006 --> 00:29:12.306 A:middle
So, in this case if we have an

00:29:12.406 --> 00:29:14.626 A:middle
array of strings and we have two

00:29:14.626 --> 00:29:16.046 A:middle
threads, let's say one thread is

00:29:16.046 --> 00:29:17.246 A:middle
looking up the value from this

00:29:17.466 --> 00:29:19.496 A:middle
array while some other thread is

00:29:19.496 --> 00:29:20.056 A:middle
writing to it.

00:29:20.946 --> 00:29:22.116 A:middle
We'll detect this race and

00:29:22.116 --> 00:29:23.756 A:middle
Thread Sanitizer will find this.

00:29:25.266 --> 00:29:26.936 A:middle
Fixing this again can involve

00:29:26.976 --> 00:29:28.706 A:middle
using a serial dispatch queue

00:29:29.236 --> 00:29:30.696 A:middle
and then making sure that the

00:29:30.696 --> 00:29:33.766 A:middle
only access that array within

00:29:33.846 --> 00:29:34.746 A:middle
some synchronized blocks.

00:29:34.886 --> 00:29:36.536 A:middle
So, in this case thread one,

00:29:36.646 --> 00:29:39.886 A:middle
we'll be using queue.synch which

00:29:40.666 --> 00:29:41.836 A:middle
is necessary in this case

00:29:41.836 --> 00:29:44.516 A:middle
because we need the output value

00:29:44.516 --> 00:29:45.536 A:middle
from this computation to

00:29:45.536 --> 00:29:46.026 A:middle
continue.

00:29:46.026 --> 00:29:47.526 A:middle
We need that lookup in the

00:29:47.526 --> 00:29:49.126 A:middle
dictionary to give us an answer.

00:29:49.126 --> 00:29:50.336 A:middle
So, we need to wait for the

00:29:50.336 --> 00:29:50.716 A:middle
result.

00:29:50.786 --> 00:29:52.266 A:middle
So, I'm using queue.synch here.

00:29:52.656 --> 00:29:54.196 A:middle
But for the second thread, I can

00:29:54.196 --> 00:29:56.136 A:middle
use queue.asynch because that

00:29:56.136 --> 00:29:58.046 A:middle
block is not providing any

00:29:58.046 --> 00:29:59.516 A:middle
output so we don't need to wait

00:29:59.516 --> 00:30:01.996 A:middle
for it to finish.

00:30:03.316 --> 00:30:04.466 A:middle
So, you might have noticed that

00:30:04.466 --> 00:30:06.086 A:middle
in the previous example I did

00:30:06.086 --> 00:30:07.636 A:middle
not call the problem a data

00:30:07.636 --> 00:30:07.866 A:middle
race.

00:30:08.496 --> 00:30:10.336 A:middle
Instead, the warning said it's a

00:30:10.426 --> 00:30:11.436 A:middle
Swift access race.

00:30:13.026 --> 00:30:14.846 A:middle
Swift access races are

00:30:14.846 --> 00:30:16.286 A:middle
violations of a more general

00:30:16.286 --> 00:30:18.336 A:middle
rule which applies to all

00:30:18.336 --> 00:30:20.176 A:middle
structs, not just arrays and

00:30:20.176 --> 00:30:21.616 A:middle
dictionaries but all structs.

00:30:21.616 --> 00:30:22.836 A:middle
Even the ones that you define.

00:30:23.636 --> 00:30:24.926 A:middle
So, this is a new rule that is

00:30:25.216 --> 00:30:26.396 A:middle
now present in Swift 4.

00:30:27.256 --> 00:30:29.226 A:middle
And part of it states that

00:30:29.276 --> 00:30:31.096 A:middle
mutating methods on structs

00:30:31.636 --> 00:30:33.026 A:middle
require that you have exclusive

00:30:33.076 --> 00:30:34.276 A:middle
access to the whole struct.

00:30:35.766 --> 00:30:37.036 A:middle
This does not apply to classes

00:30:37.036 --> 00:30:38.196 A:middle
because classes don't have

00:30:38.196 --> 00:30:39.046 A:middle
mutating methods.

00:30:39.416 --> 00:30:40.996 A:middle
And any methods on a class can

00:30:41.366 --> 00:30:43.106 A:middle
change any property and it only

00:30:43.106 --> 00:30:45.536 A:middle
needs to have exclusive access

00:30:45.576 --> 00:30:47.136 A:middle
to the properties that the

00:30:47.136 --> 00:30:47.836 A:middle
method changes.

00:30:48.346 --> 00:30:51.566 A:middle
So, this new rule that's applied

00:30:51.566 --> 00:30:54.116 A:middle
to structs is now being even

00:30:54.116 --> 00:30:55.546 A:middle
enforced by the compiler, both

00:30:55.606 --> 00:30:57.196 A:middle
statically at compile time and

00:30:57.196 --> 00:30:58.506 A:middle
dynamically at run time.

00:30:59.656 --> 00:31:00.926 A:middle
But this enforcement mostly

00:31:00.926 --> 00:31:02.016 A:middle
applies to single-threaded

00:31:02.016 --> 00:31:02.656 A:middle
violations.

00:31:02.996 --> 00:31:04.256 A:middle
And Thread Sanitizer is here to

00:31:04.256 --> 00:31:05.556 A:middle
help you with the multithreaded

00:31:05.556 --> 00:31:05.946 A:middle
cases.

00:31:06.256 --> 00:31:07.656 A:middle
And if you'd like to learn more

00:31:07.656 --> 00:31:08.866 A:middle
about these new rules in Swift

00:31:08.976 --> 00:31:10.446 A:middle
4, I recommend that you watch

00:31:10.876 --> 00:31:12.286 A:middle
the What's New in Swift session.

00:31:13.236 --> 00:31:15.376 A:middle
And explicitly a session that

00:31:15.376 --> 00:31:16.696 A:middle
was called Exclusive Access to

00:31:16.696 --> 00:31:18.056 A:middle
Memory which describes what the

00:31:18.056 --> 00:31:18.926 A:middle
new rules are.

00:31:18.926 --> 00:31:21.086 A:middle
And it also talks about what is

00:31:21.086 --> 00:31:21.586 A:middle
enforced.

00:31:22.716 --> 00:31:23.706 A:middle
But let's take a look at one

00:31:23.706 --> 00:31:24.346 A:middle
more example.

00:31:25.626 --> 00:31:26.836 A:middle
Let's say that a friend has

00:31:26.836 --> 00:31:28.746 A:middle
asked me to write some software

00:31:28.746 --> 00:31:29.576 A:middle
for his spaceship.

00:31:30.616 --> 00:31:32.016 A:middle
So, we'll have this struct which

00:31:32.066 --> 00:31:33.286 A:middle
describes the location of this

00:31:33.356 --> 00:31:33.866 A:middle
spaceship.

00:31:34.396 --> 00:31:35.446 A:middle
So, it will have some stored

00:31:35.446 --> 00:31:36.896 A:middle
properties to describe the

00:31:36.896 --> 00:31:39.116 A:middle
coordinates in both space and

00:31:39.146 --> 00:31:39.926 A:middle
time of course.

00:31:40.736 --> 00:31:41.916 A:middle
And will have some methods on

00:31:41.916 --> 00:31:43.396 A:middle
this struct as well.

00:31:43.886 --> 00:31:45.106 A:middle
Because the spaceship can

00:31:45.106 --> 00:31:46.376 A:middle
teleport to a different planet.

00:31:46.656 --> 00:31:47.986 A:middle
It can also fly to a different

00:31:47.986 --> 00:31:48.966 A:middle
city on the same planet.

00:31:49.696 --> 00:31:51.656 A:middle
And of course it can travel in

00:31:52.796 --> 00:31:52.916 A:middle
time.

00:31:53.126 --> 00:31:54.416 A:middle
And since these methods are

00:31:54.416 --> 00:31:56.006 A:middle
changing the coordinates, they

00:31:56.006 --> 00:31:57.246 A:middle
need to be mutating methods.

00:31:57.756 --> 00:31:58.676 A:middle
And that also means that the

00:31:58.676 --> 00:31:59.856 A:middle
rules that I just mentioned

00:31:59.856 --> 00:32:00.826 A:middle
apply to these methods.

00:32:01.486 --> 00:32:02.586 A:middle
So, if you have two threads,

00:32:02.586 --> 00:32:04.946 A:middle
which are both trying to change

00:32:04.946 --> 00:32:06.246 A:middle
the location of our spaceship.

00:32:06.246 --> 00:32:07.436 A:middle
Let's say thread one is trying

00:32:07.436 --> 00:32:09.216 A:middle
to teleport it to a different

00:32:09.216 --> 00:32:11.196 A:middle
planet while the second thread

00:32:11.196 --> 00:32:12.546 A:middle
is trying to move it in time.

00:32:13.226 --> 00:32:15.686 A:middle
That is a Swift access race.

00:32:16.286 --> 00:32:18.626 A:middle
And notice that it doesn't

00:32:18.626 --> 00:32:20.496 A:middle
matter which stored properties

00:32:20.546 --> 00:32:22.556 A:middle
are these functions, these

00:32:22.556 --> 00:32:24.596 A:middle
methods accessing or changing.

00:32:25.246 --> 00:32:27.176 A:middle
Even if teleport only changes X,

00:32:27.176 --> 00:32:29.226 A:middle
Y and Z while the other method

00:32:29.226 --> 00:32:31.756 A:middle
only changes time, it's still a

00:32:31.756 --> 00:32:32.586 A:middle
Swift access race.

00:32:33.236 --> 00:32:35.066 A:middle
The rules simply state that you

00:32:35.066 --> 00:32:36.896 A:middle
need to have exclusive access to

00:32:36.896 --> 00:32:38.026 A:middle
the whole object when you are

00:32:38.026 --> 00:32:39.496 A:middle
calling a mutating function,

00:32:39.496 --> 00:32:41.066 A:middle
sorry, to the whole struct.

00:32:42.906 --> 00:32:44.076 A:middle
It's also important to

00:32:44.076 --> 00:32:46.106 A:middle
understand that if we try to fix

00:32:46.106 --> 00:32:48.426 A:middle
this problem by introducing some

00:32:48.426 --> 00:32:50.076 A:middle
synchronization into that

00:32:50.176 --> 00:32:50.466 A:middle
struct.

00:32:50.746 --> 00:32:51.846 A:middle
Let's say that we will try to

00:32:52.266 --> 00:32:53.586 A:middle
use a dispatch queue inside of

00:32:53.586 --> 00:32:54.836 A:middle
that struct and protecting the

00:32:54.836 --> 00:32:57.526 A:middle
bodies of the mutating functions

00:32:57.526 --> 00:32:59.546 A:middle
inside them, that's not enough.

00:32:59.976 --> 00:33:02.116 A:middle
That's not a correct fix and

00:33:02.116 --> 00:33:03.646 A:middle
it's still a violation and still

00:33:03.646 --> 00:33:04.856 A:middle
a Swift access race.

00:33:05.236 --> 00:33:06.456 A:middle
Because we need to have that

00:33:06.456 --> 00:33:07.836 A:middle
exclusive access to the struct

00:33:08.516 --> 00:33:10.056 A:middle
in order to call that mutating

00:33:10.056 --> 00:33:10.526 A:middle
function.

00:33:10.646 --> 00:33:11.816 A:middle
And it's not enough to try to

00:33:11.816 --> 00:33:13.126 A:middle
introduce the synchronization

00:33:13.216 --> 00:33:14.306 A:middle
inside that function.

00:33:14.936 --> 00:33:18.986 A:middle
The correct fix is to move the

00:33:18.986 --> 00:33:21.156 A:middle
synchronization to the caller of

00:33:21.156 --> 00:33:22.166 A:middle
those mutating methods.

00:33:23.036 --> 00:33:24.026 A:middle
So, let's say that we have a

00:33:24.086 --> 00:33:25.976 A:middle
class that describes the whole

00:33:26.036 --> 00:33:26.486 A:middle
spaceship.

00:33:27.786 --> 00:33:28.816 A:middle
And it's a good idea to use a

00:33:28.816 --> 00:33:30.646 A:middle
class here because this

00:33:30.646 --> 00:33:32.596 A:middle
spaceship has some identity.

00:33:32.596 --> 00:33:33.516 A:middle
It doesn't make sense to make

00:33:33.516 --> 00:33:34.086 A:middle
copies of it.

00:33:34.806 --> 00:33:36.466 A:middle
So, in this case the spaceship

00:33:36.466 --> 00:33:39.046 A:middle
can protect the location stored

00:33:39.076 --> 00:33:40.256 A:middle
property with a queue.

00:33:40.696 --> 00:33:42.066 A:middle
And if we make sure that the

00:33:42.066 --> 00:33:44.356 A:middle
methods are only accessing that

00:33:44.456 --> 00:33:46.156 A:middle
struct within synchronized

00:33:46.156 --> 00:33:48.146 A:middle
blocks such as queue.synch here.

00:33:48.416 --> 00:33:50.106 A:middle
That will make the whole class

00:33:50.856 --> 00:33:53.256 A:middle
thread safe.

00:33:53.456 --> 00:33:55.146 A:middle
So, we've learned that you need

00:33:55.146 --> 00:33:57.026 A:middle
to synchronize access to your

00:33:57.086 --> 00:33:58.166 A:middle
shared mutable variable.

00:33:58.656 --> 00:33:59.976 A:middle
And you can use GCD for that

00:34:00.016 --> 00:34:01.996 A:middle
task and it's often as simple as

00:34:01.996 --> 00:34:03.456 A:middle
just associating your data with

00:34:03.736 --> 00:34:05.386 A:middle
some serial queue and then only

00:34:05.386 --> 00:34:06.956 A:middle
accessing the data from that

00:34:07.006 --> 00:34:07.246 A:middle
queue.

00:34:08.506 --> 00:34:09.996 A:middle
Thread Sanitizer is an amazing

00:34:10.046 --> 00:34:11.426 A:middle
tool that helps find you the

00:34:11.426 --> 00:34:12.756 A:middle
places where you are missing the

00:34:12.756 --> 00:34:13.556 A:middle
synchronization.

00:34:14.166 --> 00:34:15.646 A:middle
Which is, you know, a problem

00:34:15.646 --> 00:34:18.406 A:middle
that is very easy to make.

00:34:18.616 --> 00:34:20.336 A:middle
And with that, I'm very excited

00:34:20.336 --> 00:34:21.826 A:middle
to tell you that we're, this

00:34:21.826 --> 00:34:22.956 A:middle
year, introducing another

00:34:22.956 --> 00:34:24.746 A:middle
sanitizer to help you catch even

00:34:24.746 --> 00:34:25.636 A:middle
more types of bugs.

00:34:25.736 --> 00:34:27.116 A:middle
And here's Verdant to tell you

00:34:27.116 --> 00:34:28.346 A:middle
about it.

00:34:29.516 --> 00:34:32.976 A:middle
[ Applause ]

00:34:33.476 --> 00:34:34.000 A:middle
It's all yours.

00:34:37.376 --> 00:34:38.236 A:middle
&gt;&gt; All right.

00:34:39.016 --> 00:34:41.016 A:middle
Hello. My name is Verdant and I

00:34:41.016 --> 00:34:42.096 A:middle
work on compilers.

00:34:42.096 --> 00:34:43.676 A:middle
And I'm really happy to tell you

00:34:44.066 --> 00:34:45.986 A:middle
that this year in Xcode 9 we're

00:34:45.986 --> 00:34:48.086 A:middle
releasing a new tool, Undefined

00:34:48.086 --> 00:34:49.196 A:middle
Behavior Sanitizer.

00:34:49.406 --> 00:34:50.826 A:middle
And I'm sure it's going to help

00:34:50.826 --> 00:34:54.266 A:middle
you catch lots more bugs.

00:34:55.526 --> 00:34:57.156 A:middle
Okay. What is Undefined Behavior

00:34:57.156 --> 00:34:57.816 A:middle
Sanitizer?

00:34:58.626 --> 00:34:59.916 A:middle
Well, just like the other

00:34:59.916 --> 00:35:01.386 A:middle
Runtime tools you've seen so far

00:35:01.386 --> 00:35:03.126 A:middle
in this talk, it's a Runtime bug

00:35:03.126 --> 00:35:03.766 A:middle
finder.

00:35:04.396 --> 00:35:06.656 A:middle
Now, as the name suggests,

00:35:06.686 --> 00:35:08.366 A:middle
Undefined Behavior Sanitizer

00:35:08.366 --> 00:35:10.436 A:middle
detects undefined behavior for

00:35:10.436 --> 00:35:10.736 A:middle
you.

00:35:11.366 --> 00:35:13.436 A:middle
But so does Address Sanitizer

00:35:13.676 --> 00:35:15.896 A:middle
and so does a Thread Sanitizer.

00:35:17.136 --> 00:35:18.746 A:middle
What's special about Undefined

00:35:18.746 --> 00:35:20.526 A:middle
Behavior Sanitizer is that it

00:35:20.526 --> 00:35:22.556 A:middle
specializes in checking unsafe

00:35:22.556 --> 00:35:24.036 A:middle
constructs in the C language

00:35:24.036 --> 00:35:24.526 A:middle
family.

00:35:25.116 --> 00:35:27.506 A:middle
It's compatible with other

00:35:27.506 --> 00:35:28.366 A:middle
Runtime tools.

00:35:28.476 --> 00:35:29.926 A:middle
It works on all of our devices

00:35:29.926 --> 00:35:30.666 A:middle
and platforms.

00:35:31.326 --> 00:35:32.706 A:middle
And if you're interested in

00:35:32.706 --> 00:35:34.186 A:middle
learning more about undefined

00:35:34.186 --> 00:35:36.066 A:middle
behavior, I highly recommend

00:35:36.206 --> 00:35:37.326 A:middle
that you check out tomorrow

00:35:37.326 --> 00:35:38.786 A:middle
morning's talk about

00:35:38.876 --> 00:35:40.256 A:middle
understanding undefined

00:35:40.256 --> 00:35:42.216 A:middle
behavior, 9 am.

00:35:42.546 --> 00:35:44.156 A:middle
That talk will go over what

00:35:44.156 --> 00:35:45.816 A:middle
undefined behavior is.

00:35:46.626 --> 00:35:47.716 A:middle
Why it exists.

00:35:47.716 --> 00:35:48.696 A:middle
And how it can affect your

00:35:48.696 --> 00:35:49.546 A:middle
applications.

00:35:49.606 --> 00:35:54.186 A:middle
Now, I've got some good news for

00:35:57.276 --> 00:35:57.386 A:middle
you.

00:35:57.596 --> 00:35:59.296 A:middle
Undefined Behavior Sanitizer can

00:35:59.296 --> 00:36:01.746 A:middle
detect over 15 different kinds

00:36:01.746 --> 00:36:02.546 A:middle
of new issues.

00:36:03.476 --> 00:36:05.356 A:middle
Now, this is going to be great

00:36:05.356 --> 00:36:07.046 A:middle
for productivity but for this

00:36:07.046 --> 00:36:08.826 A:middle
talk, just to give you a taste

00:36:08.876 --> 00:36:09.996 A:middle
for what Undefined Behavior

00:36:09.996 --> 00:36:12.426 A:middle
Sanitizer can actually catch and

00:36:12.426 --> 00:36:13.576 A:middle
how it works, we're just going

00:36:13.576 --> 00:36:15.026 A:middle
to focus on three issues.

00:36:15.336 --> 00:36:17.086 A:middle
Integer overflow, alignment

00:36:17.086 --> 00:36:19.076 A:middle
violations and the nonnull

00:36:19.076 --> 00:36:20.346 A:middle
return value violation.

00:36:20.886 --> 00:36:23.406 A:middle
Let's start with integer

00:36:23.406 --> 00:36:23.876 A:middle
overflow.

00:36:25.626 --> 00:36:27.336 A:middle
Integer overflow occurs when

00:36:27.336 --> 00:36:28.266 A:middle
you've got an arithmetic

00:36:28.266 --> 00:36:30.506 A:middle
expression and its result is too

00:36:30.506 --> 00:36:32.036 A:middle
big to fit in a variable.

00:36:32.956 --> 00:36:34.916 A:middle
Now, if this sort of bug occurs

00:36:34.916 --> 00:36:36.986 A:middle
in an indexing expression, such

00:36:36.986 --> 00:36:38.336 A:middle
as, like, if you're indexing

00:36:38.336 --> 00:36:40.226 A:middle
into a buffer or in an

00:36:40.226 --> 00:36:41.556 A:middle
expression used to compute the

00:36:41.556 --> 00:36:43.246 A:middle
size of the buffer, it can

00:36:43.246 --> 00:36:45.166 A:middle
actually be a serious security

00:36:45.166 --> 00:36:46.776 A:middle
hole and it can be exploited.

00:36:48.316 --> 00:36:50.206 A:middle
Integer overflow can also just

00:36:50.206 --> 00:36:51.356 A:middle
sometimes lead to surprising

00:36:51.356 --> 00:36:51.976 A:middle
results.

00:36:52.316 --> 00:36:53.676 A:middle
Like, for example there

00:36:54.506 --> 00:36:56.856 A:middle
additions you can perform that,

00:36:57.566 --> 00:36:58.696 A:middle
well, take a look.

00:36:59.196 --> 00:37:00.696 A:middle
If you've got int max and you

00:37:00.696 --> 00:37:02.876 A:middle
add 1 to it, you actually don't

00:37:02.926 --> 00:37:04.966 A:middle
get a number that's bigger than

00:37:04.966 --> 00:37:06.026 A:middle
what you started out with, which

00:37:06.026 --> 00:37:06.966 A:middle
can be really confusing.

00:37:07.486 --> 00:37:10.446 A:middle
Now, not all kinds of integer

00:37:10.446 --> 00:37:12.336 A:middle
overflow are undefined behavior.

00:37:12.336 --> 00:37:14.506 A:middle
In fact, some kinds of overflow

00:37:14.506 --> 00:37:16.286 A:middle
actually have defined semantics,

00:37:16.286 --> 00:37:17.826 A:middle
which is unsigned integer

00:37:17.826 --> 00:37:18.366 A:middle
overflow.

00:37:19.466 --> 00:37:21.346 A:middle
However, unsigned integer

00:37:21.346 --> 00:37:22.626 A:middle
overflow can still be really

00:37:22.626 --> 00:37:23.306 A:middle
surprising.

00:37:23.396 --> 00:37:25.116 A:middle
So, we really recommend that you

00:37:25.156 --> 00:37:27.196 A:middle
opt into this check.

00:37:27.386 --> 00:37:28.366 A:middle
I'll show you how to do that at

00:37:28.366 --> 00:37:31.126 A:middle
the tail end of this topic.

00:37:31.276 --> 00:37:33.456 A:middle
But with that, let's go ahead

00:37:33.456 --> 00:37:34.446 A:middle
and jump into a demo.

00:37:35.186 --> 00:37:37.216 A:middle
All right, now what I've got up

00:37:37.216 --> 00:37:38.766 A:middle
here is a function that all of

00:37:38.766 --> 00:37:40.006 A:middle
us have probably written really

00:37:40.006 --> 00:37:40.736 A:middle
often.

00:37:40.776 --> 00:37:41.886 A:middle
It's an average function.

00:37:42.276 --> 00:37:43.986 A:middle
So, it takes in an array of

00:37:43.986 --> 00:37:45.426 A:middle
integers and a length.

00:37:45.846 --> 00:37:47.016 A:middle
It sets up an accumulator.

00:37:47.296 --> 00:37:48.796 A:middle
It iterates through your array,

00:37:49.196 --> 00:37:50.556 A:middle
adds everything up and divides.

00:37:50.986 --> 00:37:51.816 A:middle
So, it should give you an

00:37:51.816 --> 00:37:52.276 A:middle
average.

00:37:53.216 --> 00:37:54.226 A:middle
Now, we're interested in writing

00:37:54.226 --> 00:37:55.916 A:middle
a test for this so that we know

00:37:55.916 --> 00:37:57.076 A:middle
that it behaves correctly.

00:37:58.126 --> 00:37:58.946 A:middle
So, here we go.

00:37:59.066 --> 00:37:59.966 A:middle
Let's take a look at the test

00:37:59.966 --> 00:38:00.446 A:middle
that we've got.

00:38:01.366 --> 00:38:03.046 A:middle
Test nonnegative average.

00:38:04.206 --> 00:38:05.076 A:middle
The test is really simple.

00:38:05.306 --> 00:38:06.576 A:middle
So, we're going to create an

00:38:06.576 --> 00:38:08.236 A:middle
array of 10,000 integers.

00:38:09.056 --> 00:38:10.186 A:middle
We're going to populate the

00:38:10.186 --> 00:38:11.946 A:middle
array with pseudo random

00:38:12.016 --> 00:38:14.156 A:middle
nonnegative integers and just

00:38:14.156 --> 00:38:15.976 A:middle
check, just do a simple sanity

00:38:15.976 --> 00:38:16.166 A:middle
check.

00:38:16.706 --> 00:38:18.056 A:middle
Just check that the average that

00:38:18.056 --> 00:38:19.896 A:middle
we get back is also nonnegative.

00:38:20.136 --> 00:38:21.546 A:middle
That's this assertion right

00:38:21.676 --> 00:38:21.856 A:middle
here.

00:38:23.266 --> 00:38:24.996 A:middle
All right, so let's go ahead and

00:38:24.996 --> 00:38:25.566 A:middle
run our test.

00:38:25.936 --> 00:38:27.936 A:middle
Let's go up to here.

00:38:28.026 --> 00:38:30.296 A:middle
Hit play. Build succeeded.

00:38:31.586 --> 00:38:33.686 A:middle
And nothing really happened.

00:38:33.686 --> 00:38:34.536 A:middle
We just finished running our

00:38:34.536 --> 00:38:36.106 A:middle
program, the assertion passed.

00:38:36.346 --> 00:38:37.316 A:middle
Everything seems great.

00:38:38.356 --> 00:38:40.566 A:middle
Now, let's just change one small

00:38:40.646 --> 00:38:41.036 A:middle
thing.

00:38:41.326 --> 00:38:42.766 A:middle
And this is going to illustrate

00:38:42.766 --> 00:38:43.956 A:middle
why undefined behavior and

00:38:43.956 --> 00:38:45.166 A:middle
integer overflow in particular

00:38:45.166 --> 00:38:45.966 A:middle
can be really tricky.

00:38:46.406 --> 00:38:47.776 A:middle
Let's change the array length

00:38:48.126 --> 00:38:50.636 A:middle
from 10,000 to 10,0001.

00:38:51.256 --> 00:38:53.526 A:middle
Save it. Go back.

00:38:54.936 --> 00:38:55.936 A:middle
And run our program.

00:38:56.806 --> 00:39:00.636 A:middle
Uh oh. Insertion5 failure.

00:39:01.296 --> 00:39:03.976 A:middle
Now, this is really confusing.

00:39:03.976 --> 00:39:04.996 A:middle
So, you know, I've got

00:39:04.996 --> 00:39:06.306 A:middle
non-negative integers.

00:39:06.816 --> 00:39:08.596 A:middle
I wrote a really sort of

00:39:08.596 --> 00:39:10.316 A:middle
straightforward function that

00:39:10.676 --> 00:39:11.666 A:middle
sums them up.

00:39:11.786 --> 00:39:13.116 A:middle
But all of a sudden I'm getting

00:39:13.116 --> 00:39:14.516 A:middle
this weird failure, this really

00:39:14.586 --> 00:39:15.716 A:middle
basic test that it isn't

00:39:15.716 --> 00:39:16.166 A:middle
passing.

00:39:17.416 --> 00:39:19.116 A:middle
Undefined Behavior Sanitizer can

00:39:19.116 --> 00:39:20.036 A:middle
be really useful in these

00:39:20.036 --> 00:39:21.546 A:middle
situations and clarify what the

00:39:21.546 --> 00:39:22.506 A:middle
actual issue is.

00:39:22.506 --> 00:39:24.216 A:middle
So, we're going to turn it on

00:39:24.396 --> 00:39:25.426 A:middle
just like Kuba has shown you.

00:39:25.676 --> 00:39:27.596 A:middle
We go into the scheme editor

00:39:27.596 --> 00:39:29.286 A:middle
next to it, the diagnostics tab.

00:39:30.936 --> 00:39:32.126 A:middle
Click the right check box.

00:39:32.666 --> 00:39:34.136 A:middle
And we're good to go.

00:39:35.206 --> 00:39:37.516 A:middle
We can hit run again, rebuild

00:39:37.516 --> 00:39:39.006 A:middle
but Undefined Behavior Sanitizer

00:39:39.006 --> 00:39:39.626 A:middle
turned on.

00:39:40.176 --> 00:39:41.586 A:middle
And here we are.

00:39:42.596 --> 00:39:45.246 A:middle
So, Undefined Behavior Sanitizer

00:39:45.346 --> 00:39:47.576 A:middle
has zoomed in on the exact cause

00:39:47.576 --> 00:39:49.256 A:middle
of the issue for us and it's

00:39:49.286 --> 00:39:50.386 A:middle
done so in a relatively

00:39:50.386 --> 00:39:51.026 A:middle
drama-free way.

00:39:51.326 --> 00:39:53.206 A:middle
It tells us what happened.

00:39:53.576 --> 00:39:54.726 A:middle
Assigned integer overflow.

00:39:55.126 --> 00:39:56.296 A:middle
And it tells us the values

00:39:56.296 --> 00:39:57.456 A:middle
involved in the overflow.

00:39:57.596 --> 00:39:59.776 A:middle
As we can see, they're gigantic.

00:39:59.836 --> 00:40:01.246 A:middle
There's no way that these two

00:40:01.246 --> 00:40:02.926 A:middle
values or the sum of them can

00:40:02.926 --> 00:40:04.666 A:middle
fit inside of a 32-bit integer.

00:40:04.666 --> 00:40:06.656 A:middle
And what ended up happening was

00:40:06.656 --> 00:40:08.146 A:middle
that whatever garbled result we

00:40:08.146 --> 00:40:11.166 A:middle
got ended up being, you know, in

00:40:11.166 --> 00:40:12.816 A:middle
two complement representation a

00:40:12.816 --> 00:40:13.756 A:middle
negative number.

00:40:15.176 --> 00:40:17.506 A:middle
So, you can fix this problem in

00:40:17.506 --> 00:40:18.236 A:middle
a couple different ways.

00:40:18.746 --> 00:40:21.156 A:middle
The two I would recommend is to

00:40:21.226 --> 00:40:22.646 A:middle
either use a different algorithm

00:40:22.646 --> 00:40:24.416 A:middle
for computing your average or if

00:40:24.416 --> 00:40:25.246 A:middle
you're in a pinch, just

00:40:25.336 --> 00:40:26.966 A:middle
constrain the set of inputs into

00:40:26.966 --> 00:40:28.856 A:middle
your average function so that

00:40:28.856 --> 00:40:30.446 A:middle
you don't end up with this

00:40:31.336 --> 00:40:31.586 A:middle
problem.

00:40:31.656 --> 00:40:31.956 A:middle
All right.

00:40:32.476 --> 00:40:35.076 A:middle
So, with that said, let's go

00:40:35.076 --> 00:40:35.996 A:middle
back to the slides.

00:40:36.046 --> 00:40:37.856 A:middle
I hope that you've seen that

00:40:37.856 --> 00:40:39.396 A:middle
Undefined Behavior Sanitizer can

00:40:39.396 --> 00:40:41.746 A:middle
make it really easy for you to

00:40:41.746 --> 00:40:44.386 A:middle
find the source of tricky issues

00:40:44.386 --> 00:40:45.716 A:middle
that cause weird failures at

00:40:45.716 --> 00:40:46.066 A:middle
Runtime.

00:40:46.136 --> 00:40:46.746 A:middle
All right.

00:40:47.416 --> 00:40:51.406 A:middle
With that out of the way, let's

00:40:51.406 --> 00:40:52.696 A:middle
talk about the second kind of

00:40:52.726 --> 00:40:54.966 A:middle
issue that we're going to focus

00:40:54.966 --> 00:40:55.186 A:middle
on.

00:40:55.186 --> 00:40:56.666 A:middle
And those are memory alignment

00:40:56.666 --> 00:40:57.586 A:middle
violations.

00:40:58.896 --> 00:41:01.756 A:middle
Now, every type in C has a size

00:41:01.966 --> 00:41:03.316 A:middle
but it also has a required

00:41:03.496 --> 00:41:04.076 A:middle
alignment.

00:41:05.356 --> 00:41:07.146 A:middle
A memory alignment violation

00:41:07.146 --> 00:41:08.606 A:middle
occurs in your program when

00:41:08.606 --> 00:41:10.406 A:middle
there is an unaligned load or

00:41:10.406 --> 00:41:12.746 A:middle
store to a piece of memory.

00:41:14.036 --> 00:41:15.436 A:middle
Now, this can actually be a

00:41:15.436 --> 00:41:18.376 A:middle
really subtle bug to find.

00:41:18.526 --> 00:41:21.976 A:middle
And there's a good chance that

00:41:21.976 --> 00:41:23.706 A:middle
you may never even see it during

00:41:23.706 --> 00:41:24.816 A:middle
your day to day development.

00:41:25.086 --> 00:41:27.106 A:middle
I'm assuming most of you develop

00:41:27.106 --> 00:41:28.726 A:middle
your apps in frameworks and the

00:41:28.726 --> 00:41:30.466 A:middle
debug configuration in Xcode.

00:41:30.996 --> 00:41:32.266 A:middle
And when you're ready to finally

00:41:32.266 --> 00:41:33.956 A:middle
ship your app, you'll, you know,

00:41:33.956 --> 00:41:34.676 A:middle
ship it in the release

00:41:34.676 --> 00:41:35.456 A:middle
configuration.

00:41:35.976 --> 00:41:37.446 A:middle
The problem is because the

00:41:37.446 --> 00:41:39.726 A:middle
compiler really expects you to

00:41:39.966 --> 00:41:41.716 A:middle
not violate alignment

00:41:41.716 --> 00:41:44.326 A:middle
assumptions, the optimizer can

00:41:44.446 --> 00:41:46.526 A:middle
often do things with your code

00:41:46.716 --> 00:41:48.086 A:middle
which cause your program to

00:41:48.196 --> 00:41:50.106 A:middle
crash at Runtime in the release

00:41:50.106 --> 00:41:51.266 A:middle
configuration when these

00:41:51.266 --> 00:41:52.486 A:middle
optimizations are enabled.

00:41:54.046 --> 00:41:55.616 A:middle
Undefined Behavior Sanitizer can

00:41:55.616 --> 00:41:57.476 A:middle
help you catch these issues even

00:41:57.476 --> 00:41:59.256 A:middle
in the debug configuration ahead

00:41:59.256 --> 00:42:00.686 A:middle
of time so you don't end up with

00:42:00.686 --> 00:42:02.426 A:middle
hard to debug failures later

00:42:02.606 --> 00:42:03.056 A:middle
down the road.

00:42:04.416 --> 00:42:05.926 A:middle
Now, this type of failure is

00:42:05.926 --> 00:42:07.506 A:middle
especially common in code that

00:42:07.506 --> 00:42:09.086 A:middle
deals with serializing or

00:42:09.206 --> 00:42:10.406 A:middle
deserializing data from

00:42:10.406 --> 00:42:11.626 A:middle
persistent storage.

00:42:12.196 --> 00:42:14.546 A:middle
So, let's take a closer look at

00:42:14.546 --> 00:42:15.966 A:middle
an example that does exactly

00:42:16.726 --> 00:42:16.826 A:middle
that.

00:42:18.706 --> 00:42:21.286 A:middle
Okay, so in this example, I'm

00:42:21.286 --> 00:42:23.506 A:middle
interested in writing a custom

00:42:23.506 --> 00:42:24.786 A:middle
network protocol for a chat

00:42:24.786 --> 00:42:26.066 A:middle
application that I'm developing.

00:42:26.586 --> 00:42:28.856 A:middle
And one really basic thing that

00:42:28.856 --> 00:42:30.466 A:middle
I've got in my network protocol

00:42:30.726 --> 00:42:32.416 A:middle
is a definition of a packet

00:42:32.416 --> 00:42:32.956 A:middle
structure.

00:42:34.206 --> 00:42:35.406 A:middle
The packet structure contains

00:42:35.406 --> 00:42:36.206 A:middle
three things.

00:42:36.846 --> 00:42:38.636 A:middle
A magic field to identify the

00:42:38.636 --> 00:42:39.886 A:middle
protocol that we're speaking in.

00:42:41.286 --> 00:42:43.746 A:middle
A payload length that tells you

00:42:43.746 --> 00:42:45.156 A:middle
how long the message inside of

00:42:45.156 --> 00:42:45.986 A:middle
the packet is.

00:42:46.556 --> 00:42:48.176 A:middle
And the payload itself.

00:42:48.886 --> 00:42:50.226 A:middle
For the purposes of this

00:42:50.226 --> 00:42:51.286 A:middle
example, I'm just going to

00:42:51.286 --> 00:42:53.116 A:middle
assume that int is a four-byte

00:42:53.226 --> 00:42:53.586 A:middle
integer.

00:42:54.156 --> 00:42:55.506 A:middle
Okay, now with that out of the

00:42:55.506 --> 00:42:58.036 A:middle
way, we've got two things that

00:42:58.036 --> 00:42:59.346 A:middle
we need to focus on in order to

00:42:59.346 --> 00:43:01.566 A:middle
make custom network protocol

00:43:01.566 --> 00:43:02.296 A:middle
work for us.

00:43:02.606 --> 00:43:04.196 A:middle
Sender and a receiver.

00:43:04.536 --> 00:43:06.406 A:middle
We'll get to the sender first.

00:43:07.166 --> 00:43:08.716 A:middle
Now, the sender's got a network

00:43:08.786 --> 00:43:09.206 A:middle
buffer.

00:43:09.416 --> 00:43:10.556 A:middle
This is where it's going to

00:43:10.556 --> 00:43:13.076 A:middle
assemble its packets, get them

00:43:13.076 --> 00:43:13.556 A:middle
all ready.

00:43:13.836 --> 00:43:14.816 A:middle
Get your payload ready.

00:43:15.296 --> 00:43:16.626 A:middle
And then shoot them down the

00:43:16.626 --> 00:43:18.066 A:middle
network so that the receiver can

00:43:18.066 --> 00:43:18.316 A:middle
get it.

00:43:19.216 --> 00:43:22.006 A:middle
Now, for illustrative purposes,

00:43:22.446 --> 00:43:24.466 A:middle
I've broken up the memory inside

00:43:24.466 --> 00:43:25.556 A:middle
of our network buffer into

00:43:25.556 --> 00:43:27.426 A:middle
four-byte chunks and hopefully

00:43:27.546 --> 00:43:29.686 A:middle
you'll see why soon.

00:43:29.886 --> 00:43:31.876 A:middle
Okay, now I really miss Kuba

00:43:31.876 --> 00:43:34.186 A:middle
already just because, you know,

00:43:34.186 --> 00:43:36.086 A:middle
he's been offstage for so long.

00:43:36.646 --> 00:43:37.836 A:middle
So, the first message that I

00:43:37.836 --> 00:43:39.636 A:middle
want to send to Kuba is Hey

00:43:39.636 --> 00:43:39.886 A:middle
Kuba.

00:43:40.756 --> 00:43:42.016 A:middle
So, in order to do that I'm

00:43:42.016 --> 00:43:43.526 A:middle
going to start with a magic

00:43:43.526 --> 00:43:43.886 A:middle
value.

00:43:44.386 --> 00:43:48.206 A:middle
Next I'm going to specify the

00:43:48.206 --> 00:43:49.306 A:middle
length of my message.

00:43:49.496 --> 00:43:50.706 A:middle
It's got nine characters in it.

00:43:51.156 --> 00:43:54.026 A:middle
So, there we go.

00:43:54.226 --> 00:43:56.736 A:middle
Finally I'm going to specify my

00:43:56.736 --> 00:43:58.756 A:middle
message itself which is Hey

00:43:58.756 --> 00:43:59.016 A:middle
Kuba.

00:44:00.496 --> 00:44:02.006 A:middle
Now we're ready to take a look

00:44:02.006 --> 00:44:03.486 A:middle
at what the receiver does.

00:44:04.036 --> 00:44:07.356 A:middle
It's going to take a pointer to

00:44:07.356 --> 00:44:08.826 A:middle
the network byte stream's buffer

00:44:09.376 --> 00:44:11.356 A:middle
and cast it to a pointer to a

00:44:11.436 --> 00:44:12.266 A:middle
packet structure.

00:44:13.856 --> 00:44:16.766 A:middle
Then it's going to look inside

00:44:16.766 --> 00:44:18.696 A:middle
the packet, figure out what the

00:44:18.696 --> 00:44:20.436 A:middle
magic field is, make sure it's

00:44:20.436 --> 00:44:21.666 A:middle
the correct values so that we're

00:44:21.666 --> 00:44:22.806 A:middle
speaking the right protocol.

00:44:23.346 --> 00:44:24.996 A:middle
And then look at the payload.

00:44:25.056 --> 00:44:27.386 A:middle
All right, so that's the first

00:44:27.386 --> 00:44:27.976 A:middle
packet out of the way.

00:44:28.256 --> 00:44:29.226 A:middle
No issues so far.

00:44:30.276 --> 00:44:31.006 A:middle
Let's send another.

00:44:32.336 --> 00:44:33.746 A:middle
The second message is going to

00:44:33.746 --> 00:44:35.516 A:middle
be how's it going?

00:44:36.036 --> 00:44:38.856 A:middle
So, we'll do the same thing.

00:44:39.076 --> 00:44:40.836 A:middle
Toss in a magic value, the same

00:44:40.836 --> 00:44:41.446 A:middle
one as before.

00:44:42.696 --> 00:44:44.166 A:middle
Toss down the length of the

00:44:44.166 --> 00:44:46.976 A:middle
message, 15 characters, and then

00:44:46.976 --> 00:44:47.996 A:middle
the message itself.

00:44:49.296 --> 00:44:50.686 A:middle
Switching back over to the

00:44:50.686 --> 00:44:52.486 A:middle
receiver end, we're going to see

00:44:52.746 --> 00:44:54.136 A:middle
that the problem manifests here.

00:44:54.966 --> 00:44:57.586 A:middle
This time we're looking at index

00:44:57.586 --> 00:44:59.676 A:middle
17 into the network byte stream.

00:45:00.536 --> 00:45:03.136 A:middle
And as soon as we look at the

00:45:03.136 --> 00:45:04.506 A:middle
magic value inside of that

00:45:04.606 --> 00:45:06.976 A:middle
packet structure, we get a

00:45:06.976 --> 00:45:08.406 A:middle
memory alignment violation.

00:45:08.866 --> 00:45:12.676 A:middle
Now, as you can see here, the

00:45:12.796 --> 00:45:14.796 A:middle
magic field of the second packet

00:45:14.996 --> 00:45:16.436 A:middle
isn't aligned to a four-byte

00:45:16.476 --> 00:45:17.016 A:middle
boundary.

00:45:17.436 --> 00:45:19.546 A:middle
So, dereferencing it directly

00:45:19.546 --> 00:45:20.866 A:middle
from the network byte stream is

00:45:20.866 --> 00:45:21.996 A:middle
an alignment violation,

00:45:22.286 --> 00:45:23.316 A:middle
something that undefined

00:45:23.316 --> 00:45:25.016 A:middle
behavior sanitizer can very

00:45:25.016 --> 00:45:26.416 A:middle
precisely diagnose for you.

00:45:30.376 --> 00:45:31.596 A:middle
How do you fix this?

00:45:31.966 --> 00:45:32.876 A:middle
Well, we're going to talk about

00:45:32.876 --> 00:45:34.166 A:middle
two different ways to do it.

00:45:34.396 --> 00:45:36.026 A:middle
The first is to use the packed

00:45:36.306 --> 00:45:38.326 A:middle
attribute in your network packet

00:45:38.326 --> 00:45:39.926 A:middle
structure definition or any

00:45:39.926 --> 00:45:40.916 A:middle
structure that you've got that

00:45:40.916 --> 00:45:41.666 A:middle
you're serializing.

00:45:42.696 --> 00:45:43.646 A:middle
Okay, so let's take a look at

00:45:43.646 --> 00:45:44.276 A:middle
how this works.

00:45:44.776 --> 00:45:47.476 A:middle
You add the packed attribute and

00:45:47.476 --> 00:45:49.286 A:middle
that changes all of the field

00:45:49.286 --> 00:45:50.186 A:middle
alignments inside of your

00:45:50.186 --> 00:45:51.716 A:middle
structure from whatever they

00:45:51.716 --> 00:45:53.476 A:middle
were originally to one byte

00:45:53.476 --> 00:45:53.856 A:middle
aligned.

00:45:54.486 --> 00:45:55.916 A:middle
That's the lowest possible

00:45:55.916 --> 00:45:57.376 A:middle
alignment that you can have

00:45:57.376 --> 00:45:59.006 A:middle
which means that any subsequent

00:45:59.006 --> 00:46:01.656 A:middle
load or store from that field is

00:46:01.656 --> 00:46:02.716 A:middle
always going to be aligned.

00:46:03.586 --> 00:46:04.866 A:middle
Aha, so you may be thinking to

00:46:04.866 --> 00:46:06.146 A:middle
yourself this sounds super

00:46:06.146 --> 00:46:06.626 A:middle
convenient.

00:46:06.626 --> 00:46:07.966 A:middle
I'm just going to toss packed on

00:46:07.966 --> 00:46:08.536 A:middle
everything.

00:46:09.176 --> 00:46:10.606 A:middle
Well, you've got to be careful.

00:46:11.076 --> 00:46:12.706 A:middle
So, using the packed attribute

00:46:12.746 --> 00:46:14.116 A:middle
can actually change the layout

00:46:14.116 --> 00:46:14.916 A:middle
of your structure.

00:46:15.396 --> 00:46:17.436 A:middle
In many cases, it can remove

00:46:17.496 --> 00:46:18.766 A:middle
padding that the compiler has

00:46:18.766 --> 00:46:20.216 A:middle
automatically inserted into your

00:46:20.216 --> 00:46:22.716 A:middle
structure and it can also

00:46:22.716 --> 00:46:24.486 A:middle
degrade your app's performance.

00:46:25.446 --> 00:46:28.016 A:middle
Now, if you find that you're not

00:46:28.016 --> 00:46:29.766 A:middle
in a situation where packed

00:46:29.766 --> 00:46:30.986 A:middle
attribute would work for you,

00:46:31.366 --> 00:46:32.406 A:middle
there is another option.

00:46:33.046 --> 00:46:36.846 A:middle
You can use the mem copy

00:46:36.846 --> 00:46:39.506 A:middle
function to perform an unaligned

00:46:39.506 --> 00:46:41.606 A:middle
copy from the network byte

00:46:41.606 --> 00:46:42.926 A:middle
stream or wherever you're

00:46:42.926 --> 00:46:43.966 A:middle
deserializing from.

00:46:44.856 --> 00:46:47.796 A:middle
Into a aligned variable which

00:46:47.796 --> 00:46:48.886 A:middle
can either be in the stack or

00:46:48.886 --> 00:46:49.236 A:middle
the heap.

00:46:49.996 --> 00:46:52.546 A:middle
This mem copy is safe and the

00:46:52.546 --> 00:46:54.316 A:middle
compiler in many instances can

00:46:54.656 --> 00:46:57.096 A:middle
optimize it so that it's just as

00:46:57.096 --> 00:46:58.966 A:middle
fast as the unaligned access,

00:46:59.426 --> 00:47:00.676 A:middle
the original unaligned access

00:47:00.676 --> 00:47:01.156 A:middle
would've been.

00:47:01.746 --> 00:47:05.116 A:middle
So, that's alignment violation

00:47:05.116 --> 00:47:06.366 A:middle
detection with Undefined

00:47:06.366 --> 00:47:07.296 A:middle
Behavior Sanitizer.

00:47:07.826 --> 00:47:11.316 A:middle
Let's move on and talk about the

00:47:11.316 --> 00:47:12.916 A:middle
third kind of bug.

00:47:13.146 --> 00:47:14.586 A:middle
The nonnull return value

00:47:14.586 --> 00:47:15.266 A:middle
violation.

00:47:15.766 --> 00:47:19.196 A:middle
This kind of issue occurs when

00:47:19.196 --> 00:47:20.436 A:middle
you've got a function whose

00:47:20.436 --> 00:47:22.236 A:middle
return value is annotated with

00:47:22.236 --> 00:47:23.496 A:middle
the nonnull attribute.

00:47:24.526 --> 00:47:25.686 A:middle
Annotation, excuse me.

00:47:26.876 --> 00:47:30.496 A:middle
However, the function breaks the

00:47:30.496 --> 00:47:32.896 A:middle
contract imposed by the nonnull

00:47:32.896 --> 00:47:34.686 A:middle
annotation and returns a nil

00:47:34.686 --> 00:47:35.896 A:middle
value anyway.

00:47:36.656 --> 00:47:38.706 A:middle
Now, this can cause crashes if

00:47:38.706 --> 00:47:40.496 A:middle
you're using Objective C APIs

00:47:40.496 --> 00:47:41.916 A:middle
which, you know, violate the

00:47:41.916 --> 00:47:44.356 A:middle
return value annotation from SWF

00:47:44.356 --> 00:47:44.746 A:middle
code.

00:47:45.476 --> 00:47:46.916 A:middle
And it can also cause other

00:47:46.916 --> 00:47:47.986 A:middle
problems if you're using

00:47:47.986 --> 00:47:50.236 A:middle
Objective C APIs which rely on

00:47:50.236 --> 00:47:51.316 A:middle
nullability connection

00:47:51.576 --> 00:47:55.236 A:middle
correctness more stringently.

00:47:56.566 --> 00:47:57.746 A:middle
That's why we recommend that you

00:47:57.746 --> 00:47:59.206 A:middle
opt into this check if your

00:47:59.206 --> 00:48:00.396 A:middle
application makes use of

00:48:00.436 --> 00:48:01.736 A:middle
nullability annotations.

00:48:03.296 --> 00:48:04.636 A:middle
Let's take a look at an example

00:48:05.176 --> 00:48:08.106 A:middle
of the return value, the nonnull

00:48:08.106 --> 00:48:09.156 A:middle
return value violation.

00:48:10.476 --> 00:48:13.286 A:middle
Okay, so in this example I'm a

00:48:13.286 --> 00:48:15.026 A:middle
budding astronomer and I've got

00:48:15.026 --> 00:48:16.346 A:middle
a model of the solar system.

00:48:16.796 --> 00:48:18.366 A:middle
The first thing that I'm

00:48:18.366 --> 00:48:20.546 A:middle
interested in modelling are the

00:48:20.646 --> 00:48:22.006 A:middle
moons in my solar system.

00:48:22.006 --> 00:48:23.076 A:middle
So, here we go.

00:48:23.076 --> 00:48:25.746 A:middle
We've got planet earth and the

00:48:25.746 --> 00:48:26.826 A:middle
biggest moon on earth is the

00:48:26.826 --> 00:48:28.196 A:middle
moon so let's stick that in.

00:48:28.196 --> 00:48:30.776 A:middle
We've got Mars and we're going

00:48:30.776 --> 00:48:32.766 A:middle
to sort these lists by diameter

00:48:32.866 --> 00:48:33.806 A:middle
in decreasing order.

00:48:33.806 --> 00:48:35.746 A:middle
So, Phobos is the largest moon

00:48:35.746 --> 00:48:36.406 A:middle
of Mars.

00:48:36.406 --> 00:48:37.726 A:middle
Amos is the second largest.

00:48:37.726 --> 00:48:40.116 A:middle
Great, but, uh oh.

00:48:41.336 --> 00:48:42.856 A:middle
It looks like we've got an entry

00:48:42.856 --> 00:48:44.246 A:middle
that snuck in here which

00:48:44.246 --> 00:48:45.406 A:middle
shouldn't be around anymore.

00:48:47.026 --> 00:48:49.246 A:middle
So, this is embarrassing.

00:48:49.646 --> 00:48:50.956 A:middle
Better get rid of it.

00:48:50.956 --> 00:48:52.276 A:middle
All right, that's a lot better.

00:48:52.776 --> 00:48:55.176 A:middle
Okay. So, I got rid of some

00:48:55.176 --> 00:48:56.476 A:middle
legacy code from my example.

00:48:56.596 --> 00:48:59.146 A:middle
Now my list is looking better.

00:49:00.556 --> 00:49:01.106 A:middle
Let's move on.

00:49:01.106 --> 00:49:01.646 A:middle
Let's move on.

00:49:02.006 --> 00:49:05.156 A:middle
Okay, so what I'm really

00:49:05.156 --> 00:49:07.296 A:middle
interested in figuring out are,

00:49:07.446 --> 00:49:09.566 A:middle
is, I want a list of the biggest

00:49:09.566 --> 00:49:10.776 A:middle
moons for all of the planets in

00:49:10.776 --> 00:49:11.516 A:middle
the solar system.

00:49:11.726 --> 00:49:14.316 A:middle
So, I'm going to do that by

00:49:14.836 --> 00:49:16.766 A:middle
constructing an NS mutable array

00:49:17.676 --> 00:49:19.776 A:middle
and then adding the biggest

00:49:19.776 --> 00:49:21.056 A:middle
moons for each planet that I've

00:49:21.096 --> 00:49:21.476 A:middle
looked up.

00:49:22.296 --> 00:49:23.746 A:middle
Now, the problem here is that

00:49:23.746 --> 00:49:25.126 A:middle
I've looked up the biggest moons

00:49:25.126 --> 00:49:27.596 A:middle
for Pluto and that's not an

00:49:27.596 --> 00:49:29.326 A:middle
entry in the NS dictionary I set

00:49:29.326 --> 00:49:29.466 A:middle
up.

00:49:29.566 --> 00:49:30.506 A:middle
So, I get back nil.

00:49:31.366 --> 00:49:33.886 A:middle
Undefined Behavior Sanitizer can

00:49:33.886 --> 00:49:35.046 A:middle
diagnose this issue for you.

00:49:35.576 --> 00:49:40.096 A:middle
Okay, so that's a look at what

00:49:40.236 --> 00:49:41.546 A:middle
kinds of issues Undefined

00:49:41.546 --> 00:49:43.106 A:middle
Behavior Sanitizer can find for

00:49:43.106 --> 00:49:44.816 A:middle
you and how the tool works.

00:49:45.576 --> 00:49:46.966 A:middle
I want to wrap up the section of

00:49:46.966 --> 00:49:48.676 A:middle
the talk by showing you how you

00:49:48.676 --> 00:49:50.436 A:middle
can enable the opt-in check set

00:49:50.436 --> 00:49:50.946 A:middle
I mentioned.

00:49:51.946 --> 00:49:52.856 A:middle
This is the project build

00:49:52.856 --> 00:49:53.566 A:middle
settings editor.

00:49:54.216 --> 00:49:55.686 A:middle
Here's where you can go to turn

00:49:55.686 --> 00:49:57.296 A:middle
on unsigned integer overflow

00:49:57.296 --> 00:49:59.626 A:middle
detection and also your

00:49:59.626 --> 00:50:01.086 A:middle
nullability annotation checks.

00:50:01.706 --> 00:50:03.846 A:middle
So, that's Undefined Behavior

00:50:03.846 --> 00:50:07.576 A:middle
Sanitizer, new in Xcode 9.

00:50:08.516 --> 00:50:13.500 A:middle
[ Applause ]

00:50:16.646 --> 00:50:18.016 A:middle
We've taken a look at a lot of

00:50:18.096 --> 00:50:19.156 A:middle
different Runtime tools in

00:50:19.206 --> 00:50:21.176 A:middle
Xcode, some new, some improved.

00:50:21.336 --> 00:50:22.566 A:middle
But it's worth taking a step

00:50:22.566 --> 00:50:24.686 A:middle
back and thinking about software

00:50:24.686 --> 00:50:25.656 A:middle
quality itself.

00:50:25.886 --> 00:50:27.256 A:middle
How do you use these Runtime

00:50:27.256 --> 00:50:28.466 A:middle
tools effectively?

00:50:28.976 --> 00:50:32.486 A:middle
There's two main parts to it.

00:50:33.516 --> 00:50:35.536 A:middle
You've got to exercise more code

00:50:35.536 --> 00:50:36.706 A:middle
with these tools turned on and

00:50:37.436 --> 00:50:38.566 A:middle
you've got to use these tools

00:50:38.566 --> 00:50:38.946 A:middle
together.

00:50:40.146 --> 00:50:44.166 A:middle
Let's take a look.

00:50:44.426 --> 00:50:46.936 A:middle
Runtime tools can only catch

00:50:47.196 --> 00:50:49.166 A:middle
bugs for you when you run the

00:50:49.166 --> 00:50:50.766 A:middle
code that contains the bugs.

00:50:51.296 --> 00:50:52.146 A:middle
Maybe the [inaudible] is not the

00:50:52.146 --> 00:50:55.666 A:middle
best way but you've got to

00:50:55.666 --> 00:50:57.926 A:middle
actually run the line of code

00:50:57.926 --> 00:50:59.566 A:middle
that contains the issue for, in

00:50:59.566 --> 00:51:00.756 A:middle
order to get any sort of useful

00:51:00.756 --> 00:51:01.976 A:middle
diagnostic about the bug.

00:51:01.976 --> 00:51:02.636 A:middle
All right?

00:51:03.046 --> 00:51:05.396 A:middle
So, in order to exercise as much

00:51:05.396 --> 00:51:06.696 A:middle
code as possible and find as

00:51:06.696 --> 00:51:08.546 A:middle
many issues as possible, we

00:51:09.216 --> 00:51:10.766 A:middle
really recommend that you use

00:51:10.766 --> 00:51:11.876 A:middle
Runtime tools for daily

00:51:11.876 --> 00:51:12.506 A:middle
development.

00:51:13.576 --> 00:51:14.826 A:middle
We also recommend that you turn

00:51:14.826 --> 00:51:16.346 A:middle
these tools on at least once

00:51:16.376 --> 00:51:18.426 A:middle
before every software release so

00:51:18.426 --> 00:51:19.486 A:middle
that you can avoid spreading

00:51:19.486 --> 00:51:21.186 A:middle
bugs and possibly security

00:51:21.186 --> 00:51:25.256 A:middle
vulnerabilities to your users.

00:51:25.396 --> 00:51:27.396 A:middle
Using continuous integration can

00:51:27.396 --> 00:51:29.276 A:middle
make using Runtime tools much

00:51:29.306 --> 00:51:31.506 A:middle
easier and it can also really

00:51:31.506 --> 00:51:33.126 A:middle
simplify the process of

00:51:33.126 --> 00:51:34.326 A:middle
exercising as much code as

00:51:34.326 --> 00:51:35.536 A:middle
possible with these tools turned

00:51:35.536 --> 00:51:35.846 A:middle
on.

00:51:37.006 --> 00:51:38.526 A:middle
It can ensure that these bugs,

00:51:38.876 --> 00:51:39.986 A:middle
that bugs in your program are

00:51:39.986 --> 00:51:41.576 A:middle
caught as quickly as possible as

00:51:41.576 --> 00:51:42.646 A:middle
soon as you check in code.

00:51:42.746 --> 00:51:45.256 A:middle
And it can also help you track

00:51:45.316 --> 00:51:46.106 A:middle
code coverage in your

00:51:46.106 --> 00:51:47.406 A:middle
application so you can see

00:51:47.406 --> 00:51:48.876 A:middle
exactly how much code is being

00:51:48.876 --> 00:51:51.496 A:middle
exercised every time your CI

00:51:51.606 --> 00:51:52.136 A:middle
runs.

00:51:53.116 --> 00:51:54.296 A:middle
If you'd like to learn more

00:51:54.386 --> 00:51:55.836 A:middle
about how continuous integration

00:51:55.836 --> 00:51:57.506 A:middle
and code coverage work in Xcode,

00:51:57.506 --> 00:51:59.106 A:middle
I recommend that you check out

00:51:59.106 --> 00:52:03.686 A:middle
the WWDC 2015 talk about that.

00:52:05.516 --> 00:52:07.266 A:middle
The second component to using

00:52:07.266 --> 00:52:08.756 A:middle
Runtime tools effectively is to

00:52:08.926 --> 00:52:09.776 A:middle
use them together.

00:52:10.506 --> 00:52:11.626 A:middle
The more of these tools you turn

00:52:11.626 --> 00:52:13.536 A:middle
on, the more issues you can

00:52:14.566 --> 00:52:14.746 A:middle
find.

00:52:14.926 --> 00:52:15.766 A:middle
There's one exception.

00:52:15.766 --> 00:52:17.636 A:middle
So, Address Sanitizer and Thread

00:52:17.636 --> 00:52:19.056 A:middle
Sanitizer are not mutually

00:52:19.056 --> 00:52:19.696 A:middle
compatible.

00:52:19.806 --> 00:52:20.996 A:middle
You won't be able to turn these

00:52:20.996 --> 00:52:22.696 A:middle
two on together but the rest of

00:52:22.696 --> 00:52:23.306 A:middle
the tools you can.

00:52:24.476 --> 00:52:26.486 A:middle
And as we've seen already, all

00:52:26.486 --> 00:52:27.916 A:middle
of these tools can be turned on

00:52:27.966 --> 00:52:30.166 A:middle
by going into the scheme editor

00:52:30.166 --> 00:52:31.686 A:middle
in Xcode and clicking at the

00:52:31.686 --> 00:52:32.396 A:middle
diagnostics tab.

00:52:33.876 --> 00:52:35.536 A:middle
Now, you may be wondering, This

00:52:35.536 --> 00:52:36.736 A:middle
sounds like a lot of overhead,

00:52:36.736 --> 00:52:36.986 A:middle
right?

00:52:37.626 --> 00:52:40.256 A:middle
I'm here to tell you that that's

00:52:40.486 --> 00:52:42.186 A:middle
not really true, in my

00:52:42.186 --> 00:52:42.996 A:middle
experience at least.

00:52:42.996 --> 00:52:45.446 A:middle
So, we've got some numbers for

00:52:45.446 --> 00:52:46.496 A:middle
you about the execution and

00:52:46.496 --> 00:52:47.936 A:middle
memory overheads of these tools.

00:52:48.816 --> 00:52:49.926 A:middle
And what I've found that, at

00:52:49.926 --> 00:52:52.336 A:middle
least in my own experience, I'm

00:52:52.336 --> 00:52:53.726 A:middle
able to turn multiple Runtime

00:52:53.726 --> 00:52:55.476 A:middle
tools on simultaneously while

00:52:55.476 --> 00:52:57.196 A:middle
debugging the entire Xcode app

00:52:57.196 --> 00:52:58.786 A:middle
and the UI still feels

00:52:58.786 --> 00:52:59.956 A:middle
responsive.

00:53:00.226 --> 00:53:01.786 A:middle
Hopefully this information can

00:53:01.786 --> 00:53:03.186 A:middle
help you make the best decisions

00:53:03.186 --> 00:53:04.826 A:middle
about which tools to turn on in

00:53:04.826 --> 00:53:06.146 A:middle
your local setups versus in

00:53:06.146 --> 00:53:07.186 A:middle
continuous integration.

00:53:07.976 --> 00:53:09.866 A:middle
But I hope that the takeaway

00:53:09.866 --> 00:53:11.726 A:middle
here for you is that all of

00:53:11.726 --> 00:53:13.106 A:middle
these tools re incredibly

00:53:13.106 --> 00:53:13.686 A:middle
valuable.

00:53:13.946 --> 00:53:15.576 A:middle
They all catch different sets of

00:53:15.576 --> 00:53:17.596 A:middle
bugs for you and they're all

00:53:17.596 --> 00:53:19.226 A:middle
really worth turning on in some

00:53:19.226 --> 00:53:22.996 A:middle
form or the other.

00:53:23.226 --> 00:53:24.356 A:middle
So, to wrap it up.

00:53:24.606 --> 00:53:26.106 A:middle
Xcode 9 is going to help you

00:53:26.106 --> 00:53:27.966 A:middle
catch more critical bugs in your

00:53:27.966 --> 00:53:29.096 A:middle
apps and programs than ever

00:53:29.096 --> 00:53:31.226 A:middle
before with new and improved

00:53:31.226 --> 00:53:31.796 A:middle
Runtime Tools.

00:53:32.736 --> 00:53:34.426 A:middle
I really hope that you use them

00:53:34.426 --> 00:53:36.376 A:middle
early and often to save time

00:53:36.376 --> 00:53:38.006 A:middle
while debugging and to keep your

00:53:38.006 --> 00:53:38.686 A:middle
users safe.

00:53:38.846 --> 00:53:40.476 A:middle
And with that, I hope that you

00:53:40.476 --> 00:53:41.646 A:middle
go out and squash some bugs.

00:53:41.756 --> 00:53:43.016 A:middle
If you want to find some more

00:53:43.016 --> 00:53:44.156 A:middle
information about this talk,

00:53:44.636 --> 00:53:46.106 A:middle
we've got a website set up for

00:53:46.106 --> 00:53:47.556 A:middle
you with a lot of helpful links.

00:53:48.346 --> 00:53:49.366 A:middle
There are also some related

00:53:49.366 --> 00:53:50.226 A:middle
sessions coming up.

00:53:50.576 --> 00:53:51.796 A:middle
So, what's new in SWF.

00:53:52.136 --> 00:53:53.496 A:middle
Debugging with Xcode 9.

00:53:54.066 --> 00:53:57.216 A:middle
There's a talk about DCD.

00:53:57.566 --> 00:53:59.716 A:middle
And there's also a talk about

00:53:59.716 --> 00:54:01.226 A:middle
what's new in LDM for those of

00:54:01.286 --> 00:54:02.226 A:middle
you who are interested in the

00:54:02.226 --> 00:54:03.996 A:middle
underlying sanitizer technology

00:54:04.416 --> 00:54:06.846 A:middle
that powers Runtime tools.

00:54:07.986 --> 00:54:10.176 A:middle
So, with that, thank you for

00:54:10.176 --> 00:54:10.536 A:middle
coming.

00:54:10.926 --> 00:54:12.026 A:middle
I hope you have a great

00:54:12.026 --> 00:54:12.976 A:middle
conference.

00:54:13.516 --> 00:54:17.506 A:middle
[ Applause ]