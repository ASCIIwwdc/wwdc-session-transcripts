WEBVTT

00:00:07.016 --> 00:00:15.500 A:middle
[ Music ]

00:00:21.416 --> 00:00:21.976 A:middle
&gt;&gt; Good afternoon, everyone.

00:00:22.516 --> 00:00:27.406 A:middle
[ Applause ]

00:00:27.906 --> 00:00:29.096 A:middle
Welcome to Core Data Best

00:00:29.096 --> 00:00:29.806 A:middle
Practices.

00:00:29.926 --> 00:00:30.886 A:middle
My name is Scott Perry.

00:00:30.886 --> 00:00:32.016 A:middle
I work on Core Data.

00:00:32.466 --> 00:00:33.776 A:middle
And we'll be joined later by my

00:00:33.776 --> 00:00:35.016 A:middle
teammate, Nick Gillett.

00:00:36.516 --> 00:00:39.286 A:middle
The plan for today, first, we'll

00:00:39.286 --> 00:00:40.886 A:middle
talk a bit about how the process

00:00:40.886 --> 00:00:41.866 A:middle
of getting started with Core

00:00:41.866 --> 00:00:43.216 A:middle
Data has evolved over time.

00:00:43.956 --> 00:00:45.946 A:middle
Then, we will cover ways we can

00:00:45.946 --> 00:00:47.346 A:middle
evolve our application more

00:00:47.346 --> 00:00:48.706 A:middle
easily by taking advantage of

00:00:48.706 --> 00:00:49.886 A:middle
extension points in the

00:00:49.886 --> 00:00:50.836 A:middle
persistent container.

00:00:51.486 --> 00:00:53.556 A:middle
We'll follow that with how we

00:00:53.556 --> 00:00:55.026 A:middle
can evolve our model as our apps

00:00:55.026 --> 00:00:56.676 A:middle
requirements change and our data

00:00:56.676 --> 00:00:57.236 A:middle
grows.

00:00:59.106 --> 00:01:00.666 A:middle
Then, Nick is going to talk

00:00:59.106 --> 00:01:00.666 A:middle
Then, Nick is going to talk

00:01:00.666 --> 00:01:01.946 A:middle
about a few ways our app can

00:01:01.946 --> 00:01:03.226 A:middle
maintain its performance, even

00:01:03.226 --> 00:01:04.726 A:middle
as it scales beyond our wildest

00:01:04.726 --> 00:01:07.666 A:middle
dreams, and we'll wrap up with

00:01:08.406 --> 00:01:09.196 A:middle
some good stuff about

00:01:09.196 --> 00:01:10.646 A:middle
transformers, debugging, and

00:01:10.646 --> 00:01:11.046 A:middle
testing.

00:01:11.586 --> 00:01:15.976 A:middle
But first, let's build an app.

00:01:15.976 --> 00:01:17.716 A:middle
I like to take photos, so we're

00:01:17.716 --> 00:01:18.416 A:middle
going to build something that

00:01:18.416 --> 00:01:19.486 A:middle
allows me to share photos with

00:01:19.486 --> 00:01:21.746 A:middle
friends and get comments from

00:01:21.746 --> 00:01:22.946 A:middle
them, even if it's just Nick

00:01:22.946 --> 00:01:25.316 A:middle
asking how my slides are going.

00:01:26.236 --> 00:01:28.026 A:middle
Where should we keep our app's

00:01:28.026 --> 00:01:28.406 A:middle
data?

00:01:28.586 --> 00:01:30.016 A:middle
Well, we could keep it all

00:01:30.016 --> 00:01:31.456 A:middle
online, but I usually take

00:01:31.456 --> 00:01:32.776 A:middle
photos when I'm traveling, and

00:01:32.776 --> 00:01:33.696 A:middle
the connection can be kind of

00:01:33.696 --> 00:01:35.756 A:middle
spotty, so we should keep it

00:01:35.756 --> 00:01:37.046 A:middle
locally, organized into some

00:01:37.046 --> 00:01:37.736 A:middle
kind of store.

00:01:40.296 --> 00:01:42.596 A:middle
So, we have posts and comments

00:01:42.596 --> 00:01:44.006 A:middle
and their instances and the

00:01:44.006 --> 00:01:45.606 A:middle
relationships between them form

00:01:45.606 --> 00:01:47.386 A:middle
an object graph and we've

00:01:47.386 --> 00:01:48.846 A:middle
decided we need to persist these

00:01:48.846 --> 00:01:52.316 A:middle
things on disk, so that's what

00:01:52.316 --> 00:01:53.096 A:middle
Core Data is for.

00:01:56.006 --> 00:01:57.236 A:middle
So, we'll use that and we'll

00:01:57.236 --> 00:01:59.166 A:middle
start by translating our mock

00:01:59.216 --> 00:02:01.006 A:middle
here into something a store can

00:01:59.216 --> 00:02:01.006 A:middle
here into something a store can

00:02:01.006 --> 00:02:02.306 A:middle
understand, a managed object

00:02:02.306 --> 00:02:02.606 A:middle
model.

00:02:03.616 --> 00:02:04.276 A:middle
We'll need fields for

00:02:04.276 --> 00:02:05.816 A:middle
everything, with attributes for

00:02:05.816 --> 00:02:07.406 A:middle
things like the image's data as

00:02:07.406 --> 00:02:08.606 A:middle
well as the time it was posted,

00:02:09.076 --> 00:02:11.266 A:middle
and we'll need relationships for

00:02:11.266 --> 00:02:12.236 A:middle
posts and comments.

00:02:12.596 --> 00:02:14.066 A:middle
We've also defined a need for a

00:02:14.066 --> 00:02:15.446 A:middle
store, but there's a lot

00:02:15.446 --> 00:02:17.366 A:middle
involved in maintaining data on

00:02:17.366 --> 00:02:18.156 A:middle
disk over time.

00:02:19.056 --> 00:02:20.386 A:middle
Luckily, Core Data provides a

00:02:20.386 --> 00:02:21.956 A:middle
persistent store coordinator to

00:02:21.956 --> 00:02:22.546 A:middle
manage that.

00:02:22.986 --> 00:02:24.836 A:middle
The coordinator can do things

00:02:24.836 --> 00:02:26.246 A:middle
like compare the app's model

00:02:26.246 --> 00:02:27.806 A:middle
with the store's version and

00:02:27.806 --> 00:02:29.276 A:middle
automatically migrate it forward

00:02:29.276 --> 00:02:30.306 A:middle
as our app evolves.

00:02:30.786 --> 00:02:32.916 A:middle
Finally, managed object context

00:02:32.916 --> 00:02:34.436 A:middle
provide safe, fast, and

00:02:34.436 --> 00:02:35.936 A:middle
predictable access to our data,

00:02:36.616 --> 00:02:37.826 A:middle
even when we're using many at

00:02:37.826 --> 00:02:39.426 A:middle
the same time through features

00:02:39.426 --> 00:02:40.636 A:middle
like query generations,

00:02:40.716 --> 00:02:41.896 A:middle
connection pooling, and history

00:02:41.896 --> 00:02:42.376 A:middle
tracking.

00:02:44.236 --> 00:02:46.486 A:middle
Setting this all up requires

00:02:46.566 --> 00:02:47.736 A:middle
finding the model and loading it

00:02:47.736 --> 00:02:49.236 A:middle
and deciding where to keep the

00:02:49.236 --> 00:02:51.186 A:middle
store, but a lot of these error

00:02:51.186 --> 00:02:53.026 A:middle
paths can't actually fail once

00:02:53.026 --> 00:02:54.816 A:middle
you've shipped your app, so Core

00:02:54.816 --> 00:02:56.246 A:middle
Data provides a container type

00:02:56.576 --> 00:02:57.716 A:middle
that dramatically reduces the

00:02:57.716 --> 00:02:58.946 A:middle
amount of boilerplate required

00:02:58.946 --> 00:03:00.736 A:middle
to set up your stack, just refer

00:02:58.946 --> 00:03:00.736 A:middle
to set up your stack, just refer

00:03:00.736 --> 00:03:02.056 A:middle
to the model by name, and the

00:03:02.056 --> 00:03:03.486 A:middle
persistent container will load

00:03:03.486 --> 00:03:05.046 A:middle
it out of the main bundle and

00:03:05.046 --> 00:03:06.276 A:middle
keep a stored in a consistent

00:03:06.276 --> 00:03:06.766 A:middle
location.

00:03:07.306 --> 00:03:10.386 A:middle
This persistent container type

00:03:10.386 --> 00:03:11.926 A:middle
encapsulates a whole stack and

00:03:11.926 --> 00:03:13.526 A:middle
includes conveniences for a

00:03:13.526 --> 00:03:15.256 A:middle
shared main queue view context

00:03:15.806 --> 00:03:17.926 A:middle
as well as factory methods for

00:03:18.246 --> 00:03:20.286 A:middle
generating background contexts

00:03:20.286 --> 00:03:21.396 A:middle
as well as performing background

00:03:21.396 --> 00:03:21.676 A:middle
work.

00:03:22.426 --> 00:03:23.796 A:middle
It's also designed to be easy to

00:03:23.796 --> 00:03:25.366 A:middle
work with as our app grows.

00:03:25.776 --> 00:03:27.706 A:middle
For example, let's say we want

00:03:27.706 --> 00:03:29.176 A:middle
to factor our model layer into

00:03:29.176 --> 00:03:29.956 A:middle
its own framework.

00:03:30.836 --> 00:03:31.856 A:middle
We can do that by creating a new

00:03:31.856 --> 00:03:33.166 A:middle
framework target in Xcode and

00:03:33.166 --> 00:03:34.116 A:middle
moving our code into it.

00:03:34.446 --> 00:03:36.166 A:middle
It's all super easy, but when we

00:03:36.166 --> 00:03:37.116 A:middle
move our model into the new

00:03:37.116 --> 00:03:38.836 A:middle
target, in the built product,

00:03:38.836 --> 00:03:40.836 A:middle
targets move from the app into

00:03:40.836 --> 00:03:42.736 A:middle
the new framework, which is

00:03:42.736 --> 00:03:43.806 A:middle
what's supposed to happen, but

00:03:43.806 --> 00:03:45.246 A:middle
now NSPersistentContainer

00:03:45.436 --> 00:03:46.196 A:middle
doesn't know where to find our

00:03:46.196 --> 00:03:46.896 A:middle
model anymore.

00:03:47.476 --> 00:03:48.566 A:middle
This is because it only checks

00:03:48.566 --> 00:03:49.846 A:middle
the main bundle by default.

00:03:50.416 --> 00:03:51.056 A:middle
Why stop there?

00:03:51.806 --> 00:03:53.296 A:middle
Well, searching all of the app's

00:03:53.296 --> 00:03:54.826 A:middle
bundles could get really slow

00:03:54.826 --> 00:03:56.526 A:middle
for a complicated app and it's

00:03:56.526 --> 00:03:57.816 A:middle
not a cost you want to pay every

00:03:57.816 --> 00:03:58.866 A:middle
time you spin up a stack.

00:04:00.206 --> 00:04:01.506 A:middle
How do we fix this?

00:04:02.666 --> 00:04:03.926 A:middle
Well, we could resuscitate the

00:04:03.926 --> 00:04:05.206 A:middle
model out of the framework

00:04:05.206 --> 00:04:06.766 A:middle
bundle ourselves and use one of

00:04:06.766 --> 00:04:07.456 A:middle
the container's other

00:04:07.456 --> 00:04:08.666 A:middle
initializers, like one that

00:04:08.736 --> 00:04:10.606 A:middle
takes an explicit managed object

00:04:10.606 --> 00:04:12.986 A:middle
model, but NSPersistentContainer

00:04:12.986 --> 00:04:14.486 A:middle
actually has a way for you to

00:04:14.486 --> 00:04:16.036 A:middle
change which bundle it searches.

00:04:17.856 --> 00:04:19.856 A:middle
See, NSPersistentContainer knows

00:04:19.856 --> 00:04:21.086 A:middle
when it's been subclassed and

00:04:21.086 --> 00:04:21.906 A:middle
will use the type of the

00:04:21.906 --> 00:04:24.106 A:middle
subclass as a hint when it looks

00:04:24.106 --> 00:04:24.666 A:middle
for the model.

00:04:25.156 --> 00:04:26.256 A:middle
All we need to do to take

00:04:26.256 --> 00:04:27.566 A:middle
advantage of this is to create a

00:04:27.566 --> 00:04:28.236 A:middle
subclass.

00:04:28.756 --> 00:04:29.826 A:middle
It doesn't even need to have

00:04:29.826 --> 00:04:30.466 A:middle
anything in it.

00:04:31.916 --> 00:04:33.026 A:middle
Then, any code setting up

00:04:33.026 --> 00:04:33.976 A:middle
through the container that wants

00:04:33.976 --> 00:04:35.816 A:middle
to use our model can just adopt

00:04:35.816 --> 00:04:37.466 A:middle
that subclass and the persistent

00:04:37.466 --> 00:04:38.646 A:middle
container will check in our

00:04:38.646 --> 00:04:40.106 A:middle
frameworks bundle for our model

00:04:40.106 --> 00:04:40.586 A:middle
instead.

00:04:41.196 --> 00:04:45.126 A:middle
So, that's fun, but since we're

00:04:45.126 --> 00:04:45.856 A:middle
going through the effort of

00:04:45.856 --> 00:04:47.286 A:middle
factoring our app's resources,

00:04:47.436 --> 00:04:48.486 A:middle
wouldn't it be nice if we also

00:04:48.486 --> 00:04:49.696 A:middle
improved the organization of our

00:04:49.696 --> 00:04:50.426 A:middle
data on disk?

00:04:51.146 --> 00:04:53.306 A:middle
By default, new persistent

00:04:53.306 --> 00:04:54.276 A:middle
containers come with a store

00:04:54.276 --> 00:04:55.986 A:middle
description for an SQLite store

00:04:56.116 --> 00:04:58.136 A:middle
with automatic migration that on

00:04:58.136 --> 00:04:59.926 A:middle
iOS lives in our app's documents

00:04:59.926 --> 00:05:00.366 A:middle
directory.

00:04:59.926 --> 00:05:00.366 A:middle
directory.

00:05:00.796 --> 00:05:02.056 A:middle
That was great when our model

00:05:02.056 --> 00:05:04.066 A:middle
code was part of the app, but we

00:05:04.066 --> 00:05:04.876 A:middle
should try to keep our new

00:05:04.876 --> 00:05:06.116 A:middle
frameworks files from mingling

00:05:06.116 --> 00:05:07.286 A:middle
too much with the apps.

00:05:08.376 --> 00:05:09.566 A:middle
Since we already subclassed

00:05:09.566 --> 00:05:10.976 A:middle
NSPersistentContainer to make

00:05:10.976 --> 00:05:12.706 A:middle
finding the model easier, let's

00:05:12.706 --> 00:05:14.086 A:middle
build on that to improve this.

00:05:16.476 --> 00:05:18.456 A:middle
The brute force way to change a

00:05:18.456 --> 00:05:20.786 A:middle
store's location is to directly

00:05:20.786 --> 00:05:22.156 A:middle
modify the URL in the

00:05:22.156 --> 00:05:23.446 A:middle
persistentStoreDescription

00:05:23.446 --> 00:05:24.586 A:middle
before loading the store.

00:05:25.556 --> 00:05:26.716 A:middle
Sometimes that's what you want

00:05:26.716 --> 00:05:27.826 A:middle
and we could use that pattern

00:05:27.826 --> 00:05:29.406 A:middle
here, but we don't have to

00:05:29.716 --> 00:05:31.516 A:middle
because NSPersistentContainer

00:05:31.516 --> 00:05:33.996 A:middle
calls its own default directory

00:05:33.996 --> 00:05:35.816 A:middle
URL method when creating

00:05:35.816 --> 00:05:37.086 A:middle
persistent store descriptions.

00:05:37.286 --> 00:05:38.626 A:middle
And it's made to be overridden.

00:05:39.166 --> 00:05:40.516 A:middle
In this case, we can just append

00:05:40.516 --> 00:05:42.066 A:middle
a path component, but this is

00:05:42.066 --> 00:05:43.076 A:middle
also a good way to set up

00:05:43.076 --> 00:05:45.776 A:middle
containers for caches or other

00:05:45.776 --> 00:05:46.826 A:middle
kinds of stacks that need to

00:05:46.826 --> 00:05:47.926 A:middle
keep their stores in different

00:05:47.926 --> 00:05:49.756 A:middle
locations, like your tasks.

00:05:50.306 --> 00:05:53.046 A:middle
So, now that we've got our Core

00:05:53.046 --> 00:05:54.256 A:middle
Data stock all figured out,

00:05:54.386 --> 00:05:55.686 A:middle
let's have a look at our app and

00:05:55.686 --> 00:05:57.116 A:middle
some of the view controllers

00:05:57.116 --> 00:05:57.706 A:middle
that we've written.

00:05:58.376 --> 00:05:59.926 A:middle
It looks like we've got some

00:05:59.926 --> 00:06:00.896 A:middle
pretty specialized view

00:05:59.926 --> 00:06:00.896 A:middle
pretty specialized view

00:06:00.896 --> 00:06:01.606 A:middle
controllers here.

00:06:02.296 --> 00:06:03.386 A:middle
Here's one that shows all of my

00:06:03.386 --> 00:06:04.826 A:middle
posts as well as another that

00:06:04.826 --> 00:06:06.746 A:middle
shows all posts by all authors.

00:06:07.226 --> 00:06:08.226 A:middle
Even the detail views are

00:06:08.346 --> 00:06:09.166 A:middle
duplicated.

00:06:09.306 --> 00:06:10.796 A:middle
It feels a lot like we could

00:06:10.796 --> 00:06:13.386 A:middle
have written half the code.

00:06:13.776 --> 00:06:15.656 A:middle
All we should really need is one

00:06:15.656 --> 00:06:16.916 A:middle
view controller for displaying a

00:06:16.916 --> 00:06:18.556 A:middle
list of posts and another for

00:06:18.556 --> 00:06:19.926 A:middle
displaying a single post.

00:06:20.626 --> 00:06:21.656 A:middle
We can accomplish this by

00:06:21.656 --> 00:06:23.526 A:middle
defining good boundaries in

00:06:23.526 --> 00:06:25.516 A:middle
between our view controllers in

00:06:25.516 --> 00:06:26.916 A:middle
the form of interfaces that take

00:06:26.916 --> 00:06:27.786 A:middle
model objects.

00:06:29.286 --> 00:06:30.576 A:middle
Each controller gets configured

00:06:30.576 --> 00:06:33.026 A:middle
by its model parameters and then

00:06:33.026 --> 00:06:34.136 A:middle
they can customize their views

00:06:34.136 --> 00:06:35.306 A:middle
in cells based on whether

00:06:35.306 --> 00:06:36.626 A:middle
they're showing my posts or

00:06:36.626 --> 00:06:37.386 A:middle
someone else's.

00:06:37.906 --> 00:06:40.936 A:middle
When drafting view controllers

00:06:40.936 --> 00:06:42.566 A:middle
using Core Data, list views

00:06:42.566 --> 00:06:44.016 A:middle
should get fetch requests and

00:06:44.016 --> 00:06:45.406 A:middle
detail views should get managed

00:06:45.406 --> 00:06:46.096 A:middle
objects.

00:06:47.506 --> 00:06:48.776 A:middle
View controllers also need a

00:06:48.776 --> 00:06:50.446 A:middle
managed object context, either

00:06:50.446 --> 00:06:52.076 A:middle
the container's view context or

00:06:52.076 --> 00:06:53.886 A:middle
some other main queue context.

00:06:54.046 --> 00:06:55.536 A:middle
And this pattern for

00:06:55.536 --> 00:06:56.806 A:middle
generalizing view controllers

00:06:56.806 --> 00:06:58.176 A:middle
with Core Data isn't just for

00:06:58.176 --> 00:06:59.596 A:middle
UIs; it works really well for

00:06:59.596 --> 00:07:00.836 A:middle
utility types as well.

00:06:59.596 --> 00:07:00.836 A:middle
utility types as well.

00:07:01.806 --> 00:07:02.926 A:middle
Instead of passing Core Data

00:07:02.926 --> 00:07:05.006 A:middle
types for presentation, we can

00:07:05.006 --> 00:07:06.446 A:middle
pass things like URLs or

00:07:06.446 --> 00:07:08.106 A:middle
serialized data into background

00:07:08.106 --> 00:07:10.496 A:middle
work controllers and turn those

00:07:10.496 --> 00:07:11.896 A:middle
into new and updated managed

00:07:11.896 --> 00:07:13.446 A:middle
objects using a background

00:07:13.506 --> 00:07:14.876 A:middle
context instead of a view

00:07:14.876 --> 00:07:16.476 A:middle
context to do our work.

00:07:18.016 --> 00:07:19.136 A:middle
Adopting this kind of interface

00:07:19.136 --> 00:07:20.616 A:middle
and utility type is super easy

00:07:20.616 --> 00:07:22.146 A:middle
since we own the initializer, so

00:07:22.146 --> 00:07:22.956 A:middle
we can just require the

00:07:22.956 --> 00:07:23.936 A:middle
parameters to create the

00:07:23.936 --> 00:07:24.466 A:middle
controller.

00:07:24.566 --> 00:07:26.316 A:middle
But how do we get our boundary

00:07:26.316 --> 00:07:27.416 A:middle
variables into our view

00:07:27.416 --> 00:07:28.086 A:middle
controllers?

00:07:28.676 --> 00:07:31.946 A:middle
Well, if we're using segues, we

00:07:31.946 --> 00:07:33.226 A:middle
can override the prepare method

00:07:34.636 --> 00:07:35.706 A:middle
and get a reference to the

00:07:35.706 --> 00:07:37.086 A:middle
destinationViewController and

00:07:37.086 --> 00:07:38.186 A:middle
then configure it there.

00:07:38.806 --> 00:07:40.636 A:middle
If we're using storyboards or

00:07:40.636 --> 00:07:42.656 A:middle
nibs, then we already have code

00:07:42.656 --> 00:07:43.576 A:middle
that has to cons up a

00:07:43.576 --> 00:07:45.676 A:middle
destinationViewController, so

00:07:45.676 --> 00:07:46.516 A:middle
all we need to do is set the

00:07:46.516 --> 00:07:47.976 A:middle
properties before presentation.

00:07:48.506 --> 00:07:50.586 A:middle
And, if we're driving stick, we

00:07:50.586 --> 00:07:51.676 A:middle
can just write an initializer

00:07:51.676 --> 00:07:52.826 A:middle
that explicitly defines the

00:07:52.826 --> 00:07:54.256 A:middle
boundary conditions, just like

00:07:54.256 --> 00:07:55.676 A:middle
we do with our utility types.

00:07:56.276 --> 00:07:59.656 A:middle
OK. So, now we've got a fetch

00:07:59.656 --> 00:08:01.056 A:middle
request and a context for our

00:07:59.656 --> 00:08:01.056 A:middle
request and a context for our

00:08:01.056 --> 00:08:02.656 A:middle
view controller, but before we

00:08:02.656 --> 00:08:04.136 A:middle
smash them together to get our

00:08:04.136 --> 00:08:05.486 A:middle
results, we should configure the

00:08:05.486 --> 00:08:06.746 A:middle
fetch request a little bit more

00:08:06.746 --> 00:08:07.986 A:middle
to make sure that our controller

00:08:07.986 --> 00:08:09.136 A:middle
will have great performance.

00:08:10.856 --> 00:08:12.276 A:middle
Sometimes it makes sense to set

00:08:12.276 --> 00:08:13.806 A:middle
a fetch limit, but in the case

00:08:13.806 --> 00:08:15.036 A:middle
of our list view, batching makes

00:08:15.036 --> 00:08:16.036 A:middle
more sense because we want to

00:08:16.036 --> 00:08:18.596 A:middle
show all the data and we know

00:08:18.596 --> 00:08:20.126 A:middle
exactly how many cells our view

00:08:20.126 --> 00:08:21.296 A:middle
controller can fit on the screen

00:08:21.296 --> 00:08:21.806 A:middle
at once.

00:08:22.546 --> 00:08:24.306 A:middle
In general, at least one of

00:08:24.306 --> 00:08:25.886 A:middle
these options should always be

00:08:25.886 --> 00:08:27.156 A:middle
set for fetch requests that

00:08:27.156 --> 00:08:28.586 A:middle
might return an unbounded number

00:08:28.586 --> 00:08:29.276 A:middle
of results.

00:08:29.956 --> 00:08:32.346 A:middle
So, at this point, we could turn

00:08:32.346 --> 00:08:33.676 A:middle
our fetch request into objects

00:08:33.676 --> 00:08:35.025 A:middle
and populate a list view with

00:08:35.056 --> 00:08:37.196 A:middle
the results, but what if we want

00:08:37.196 --> 00:08:39.155 A:middle
to keep the UI up to date with

00:08:39.155 --> 00:08:40.366 A:middle
changes as they happen?

00:08:41.666 --> 00:08:42.846 A:middle
Core Data has us covered here as

00:08:42.846 --> 00:08:43.756 A:middle
well with the fetched results

00:08:43.756 --> 00:08:44.246 A:middle
controller.

00:08:44.726 --> 00:08:46.356 A:middle
Available on all platforms since

00:08:46.356 --> 00:08:47.976 A:middle
Sierra, adopting the fetched

00:08:47.976 --> 00:08:49.366 A:middle
results controller just requires

00:08:49.366 --> 00:08:50.556 A:middle
writing an adaptor between the

00:08:50.556 --> 00:08:51.886 A:middle
delegate protocol and the view

00:08:51.886 --> 00:08:52.536 A:middle
it's driving.

00:08:53.136 --> 00:08:54.556 A:middle
And to create one, all we need

00:08:54.556 --> 00:08:55.296 A:middle
is a fetch request and a

00:08:55.296 --> 00:08:55.836 A:middle
context.

00:08:57.176 --> 00:08:58.136 A:middle
The fetched results controller

00:08:58.136 --> 00:08:59.276 A:middle
even supports driving more

00:08:59.276 --> 00:09:01.316 A:middle
advanced list view concepts such

00:08:59.276 --> 00:09:01.316 A:middle
advanced list view concepts such

00:09:01.316 --> 00:09:02.026 A:middle
as sections.

00:09:03.066 --> 00:09:05.066 A:middle
If we wanted to group posts into

00:09:05.066 --> 00:09:06.206 A:middle
sections by the day they were

00:09:06.206 --> 00:09:07.596 A:middle
posted, we could do it by

00:09:07.596 --> 00:09:09.046 A:middle
extending the post type that's

00:09:09.046 --> 00:09:10.696 A:middle
generated by Xcode with the

00:09:10.696 --> 00:09:12.436 A:middle
computed property and passing

00:09:12.436 --> 00:09:13.686 A:middle
the name of it to the fetched

00:09:13.686 --> 00:09:14.436 A:middle
results controller's

00:09:14.436 --> 00:09:15.076 A:middle
initializer.

00:09:16.336 --> 00:09:18.156 A:middle
This works well, but what if we

00:09:18.156 --> 00:09:19.226 A:middle
have a view controller more

00:09:19.226 --> 00:09:20.596 A:middle
complicated than just a list of

00:09:20.596 --> 00:09:21.656 A:middle
our objects?

00:09:21.806 --> 00:09:22.786 A:middle
What if we want to show

00:09:22.786 --> 00:09:24.686 A:middle
something like a chart of the

00:09:24.686 --> 00:09:25.966 A:middle
posts per day on our app?

00:09:27.556 --> 00:09:28.776 A:middle
Well, the first thing we should

00:09:28.776 --> 00:09:29.976 A:middle
do is not underestimate the

00:09:29.976 --> 00:09:31.266 A:middle
power of fetched requests.

00:09:31.816 --> 00:09:33.126 A:middle
I'm just one person, so in the

00:09:33.126 --> 00:09:34.326 A:middle
last month, I haven't managed to

00:09:34.326 --> 00:09:36.576 A:middle
post more than 40 pictures per

00:09:36.576 --> 00:09:36.926 A:middle
day.

00:09:37.706 --> 00:09:39.196 A:middle
Over the course of 30 days,

00:09:39.336 --> 00:09:40.646 A:middle
that's still a fairly reasonable

00:09:40.646 --> 00:09:41.706 A:middle
amount of data to pull out of

00:09:41.706 --> 00:09:42.566 A:middle
the store at once.

00:09:43.446 --> 00:09:45.466 A:middle
If the day property that we

00:09:45.466 --> 00:09:46.856 A:middle
defined earlier was actually

00:09:46.856 --> 00:09:48.236 A:middle
part of the entity in the model,

00:09:48.646 --> 00:09:49.386 A:middle
then we could write a fetch

00:09:49.386 --> 00:09:50.506 A:middle
request that counts up the

00:09:50.506 --> 00:09:52.046 A:middle
number of posts grouped by the

00:09:52.046 --> 00:09:52.916 A:middle
day they were posted.

00:09:53.456 --> 00:09:54.696 A:middle
There's three parts to this

00:09:54.696 --> 00:09:55.236 A:middle
request.

00:09:55.616 --> 00:09:56.986 A:middle
The first one is just setting

00:09:56.986 --> 00:09:57.426 A:middle
the range.

00:09:57.596 --> 00:09:58.966 A:middle
We want the last 30 days of

00:09:58.966 --> 00:09:59.316 A:middle
data.

00:09:59.316 --> 00:10:02.316 A:middle
Next, we want to group together

00:09:59.316 --> 00:10:02.316 A:middle
Next, we want to group together

00:10:02.316 --> 00:10:04.536 A:middle
all results whose day attributes

00:10:04.536 --> 00:10:05.716 A:middle
share the same value.

00:10:06.316 --> 00:10:07.076 A:middle
Since we're now fetching

00:10:07.076 --> 00:10:08.566 A:middle
aggregates instead of individual

00:10:08.566 --> 00:10:09.796 A:middle
objects, we have to change the

00:10:09.796 --> 00:10:10.876 A:middle
result type to something more

00:10:10.876 --> 00:10:12.576 A:middle
sensible as well, in this case,

00:10:12.576 --> 00:10:13.066 A:middle
a dictionary.

00:10:14.726 --> 00:10:16.266 A:middle
Finally, we define an expression

00:10:16.266 --> 00:10:17.346 A:middle
that represents the number of

00:10:17.346 --> 00:10:19.316 A:middle
objects in each group and tell

00:10:19.316 --> 00:10:20.976 A:middle
the fetch requests to return

00:10:20.976 --> 00:10:22.936 A:middle
that count along with the day it

00:10:22.936 --> 00:10:23.616 A:middle
represents.

00:10:24.926 --> 00:10:26.996 A:middle
This fetch request returns 30

00:10:26.996 --> 00:10:28.416 A:middle
results, each of which is one

00:10:28.416 --> 00:10:29.876 A:middle
point on our chart.

00:10:31.216 --> 00:10:34.466 A:middle
If you're into databases, this

00:10:34.466 --> 00:10:35.546 A:middle
is the SQLite query that Core

00:10:35.546 --> 00:10:36.686 A:middle
Data generates from that fetch

00:10:36.686 --> 00:10:37.186 A:middle
request.

00:10:37.646 --> 00:10:38.846 A:middle
It's exactly what you do if

00:10:38.846 --> 00:10:39.516 A:middle
you're writing the query

00:10:39.516 --> 00:10:40.046 A:middle
yourself.

00:10:40.496 --> 00:10:41.816 A:middle
Core Data understands how to

00:10:41.816 --> 00:10:43.226 A:middle
convert many expression

00:10:43.226 --> 00:10:44.716 A:middle
functions into optimal database

00:10:44.716 --> 00:10:45.196 A:middle
queries.

00:10:45.776 --> 00:10:46.856 A:middle
A group by query can use

00:10:46.856 --> 00:10:48.066 A:middle
aggregate functions such as

00:10:48.066 --> 00:10:50.076 A:middle
average and sum and scalar

00:10:50.076 --> 00:10:51.736 A:middle
queries, like a normal fetch

00:10:51.736 --> 00:10:53.336 A:middle
request, can use scalar math and

00:10:53.336 --> 00:10:54.926 A:middle
date functions, like abs for the

00:10:54.926 --> 00:10:56.416 A:middle
absolute value and now for the

00:10:56.416 --> 00:10:57.026 A:middle
current time.

00:10:57.156 --> 00:10:59.366 A:middle
If you want to know more about

00:10:59.366 --> 00:11:00.236 A:middle
what you can do with

00:10:59.366 --> 00:11:00.236 A:middle
what you can do with

00:11:00.266 --> 00:11:01.306 A:middle
NSExpression, check out the

00:11:01.306 --> 00:11:02.626 A:middle
documentation for its list of

00:11:02.626 --> 00:11:03.286 A:middle
functions.

00:11:03.356 --> 00:11:04.366 A:middle
Many of them are supported by

00:11:04.366 --> 00:11:07.336 A:middle
fetch requests in Core Data.

00:11:08.366 --> 00:11:10.586 A:middle
OK. So, fetch requests can

00:11:10.586 --> 00:11:12.566 A:middle
accomplish a lot through the use

00:11:12.566 --> 00:11:14.606 A:middle
of expressions, but SQLite still

00:11:14.606 --> 00:11:16.286 A:middle
reads every one of our posts

00:11:16.286 --> 00:11:17.406 A:middle
through memory when computing

00:11:17.406 --> 00:11:18.636 A:middle
the counts for our graph here.

00:11:19.126 --> 00:11:20.976 A:middle
That works fine for charts

00:11:20.976 --> 00:11:23.566 A:middle
showing the amount of posts

00:11:23.566 --> 00:11:24.586 A:middle
generated by one human in a

00:11:24.586 --> 00:11:25.796 A:middle
month, but what if we want to

00:11:25.796 --> 00:11:26.746 A:middle
chart something bigger?

00:11:27.086 --> 00:11:28.676 A:middle
What if we want to show a whole

00:11:28.676 --> 00:11:30.536 A:middle
year or what if our little app

00:11:30.536 --> 00:11:32.136 A:middle
starts handling orders of

00:11:32.136 --> 00:11:33.386 A:middle
magnitude more data?

00:11:34.706 --> 00:11:35.686 A:middle
Now the fetch request would be

00:11:35.686 --> 00:11:37.566 A:middle
counting at least 50,000 posts

00:11:37.566 --> 00:11:39.226 A:middle
one by one just to show 30 data

00:11:39.226 --> 00:11:41.226 A:middle
points and that's not going to

00:11:41.226 --> 00:11:41.956 A:middle
be fast enough.

00:11:42.436 --> 00:11:44.076 A:middle
The mismatch between our views

00:11:44.076 --> 00:11:45.436 A:middle
and our model has gotten to the

00:11:45.436 --> 00:11:46.316 A:middle
point where we need to start

00:11:46.316 --> 00:11:47.596 A:middle
doing some denormalization.

00:11:50.226 --> 00:11:52.266 A:middle
Denormalization is when we add

00:11:52.266 --> 00:11:53.596 A:middle
redundant copies of data or

00:11:53.596 --> 00:11:55.266 A:middle
metadata to improve read

00:11:55.266 --> 00:11:56.556 A:middle
performance at the expense of

00:11:56.556 --> 00:11:57.576 A:middle
some additional bookkeeping.

00:11:58.156 --> 00:11:59.546 A:middle
Database indexes are a good

00:11:59.546 --> 00:12:00.466 A:middle
example of this.

00:11:59.546 --> 00:12:00.466 A:middle
example of this.

00:12:01.396 --> 00:12:02.766 A:middle
Adding count metadata to our

00:12:02.766 --> 00:12:04.526 A:middle
store is exactly the kind of

00:12:04.526 --> 00:12:06.476 A:middle
compromise we need to get our

00:12:06.546 --> 00:12:07.866 A:middle
chart's performance again.

00:12:08.666 --> 00:12:10.676 A:middle
So, let's look at how our model

00:12:10.676 --> 00:12:12.366 A:middle
can group posts into counts by

00:12:12.366 --> 00:12:12.736 A:middle
day.

00:12:13.626 --> 00:12:15.556 A:middle
We'll need a new entity with two

00:12:15.556 --> 00:12:17.246 A:middle
attributes, plus a bit of extra

00:12:17.246 --> 00:12:17.896 A:middle
maintenance to keep them

00:12:17.896 --> 00:12:18.316 A:middle
accurate.

00:12:19.186 --> 00:12:20.796 A:middle
Grouping by day improves our

00:12:20.796 --> 00:12:22.396 A:middle
fetch request so much that it

00:12:22.396 --> 00:12:23.756 A:middle
guarantees good performance for

00:12:23.756 --> 00:12:25.386 A:middle
charts covering years of data,

00:12:25.766 --> 00:12:26.776 A:middle
so we only have to create this

00:12:26.776 --> 00:12:29.376 A:middle
one level of denormalization and

00:12:29.376 --> 00:12:30.516 A:middle
the fetch request that we passed

00:12:30.516 --> 00:12:31.496 A:middle
to the chart view controller?

00:12:32.386 --> 00:12:33.446 A:middle
It's super simple.

00:12:34.416 --> 00:12:35.256 A:middle
It's really not that much

00:12:35.256 --> 00:12:36.336 A:middle
different than the fetch request

00:12:36.336 --> 00:12:37.576 A:middle
that we'd pass off to any other

00:12:37.576 --> 00:12:39.386 A:middle
list view, which is actually

00:12:39.506 --> 00:12:40.636 A:middle
kind of sort of what a chart

00:12:40.636 --> 00:12:41.826 A:middle
view is if you squint hard

00:12:41.826 --> 00:12:42.176 A:middle
enough.

00:12:43.766 --> 00:12:44.866 A:middle
But what about that extra

00:12:44.866 --> 00:12:45.396 A:middle
maintenance?

00:12:46.186 --> 00:12:47.656 A:middle
We've got to increment the count

00:12:47.656 --> 00:12:48.986 A:middle
whenever a post gets published

00:12:48.986 --> 00:12:50.236 A:middle
and decrement it whenever a post

00:12:50.236 --> 00:12:50.846 A:middle
is removed.

00:12:51.556 --> 00:12:53.016 A:middle
We could do this in the methods

00:12:53.016 --> 00:12:54.296 A:middle
that change the post object's

00:12:54.296 --> 00:12:55.836 A:middle
relevant state, but a more

00:12:55.836 --> 00:12:56.886 A:middle
foolproof solution is to update

00:12:56.886 --> 00:12:58.046 A:middle
our counts in response to the

00:12:58.046 --> 00:12:58.796 A:middle
context saving.

00:12:59.356 --> 00:13:04.546 A:middle
We could just register for the

00:12:59.356 --> 00:13:04.546 A:middle
We could just register for the

00:13:04.976 --> 00:13:07.156 A:middle
managed object contextWillSave

00:13:07.156 --> 00:13:08.866 A:middle
notification with a function

00:13:09.296 --> 00:13:10.286 A:middle
that goes through all of the

00:13:10.286 --> 00:13:11.406 A:middle
posts that have been inserted,

00:13:11.696 --> 00:13:13.136 A:middle
incrementing the count for each

00:13:13.136 --> 00:13:15.626 A:middle
day that's relevant, and another

00:13:16.066 --> 00:13:16.946 A:middle
loop going through all of the

00:13:16.946 --> 00:13:18.186 A:middle
deleted objects, decrementing

00:13:18.186 --> 00:13:18.956 A:middle
the count for each day.

00:13:19.646 --> 00:13:20.656 A:middle
And that affects the state of

00:13:20.656 --> 00:13:22.106 A:middle
the context before it commits to

00:13:22.106 --> 00:13:23.516 A:middle
the database, so it all winds up

00:13:23.516 --> 00:13:25.166 A:middle
happening in one transaction, so

00:13:25.166 --> 00:13:27.236 A:middle
this scales really well, which

00:13:27.236 --> 00:13:28.916 A:middle
is useful because my teammate

00:13:28.916 --> 00:13:30.366 A:middle
Nick Gillett is here to talk

00:13:30.366 --> 00:13:31.676 A:middle
about how Core Data can help us

00:13:31.676 --> 00:13:33.296 A:middle
as our little app scales beyond

00:13:33.296 --> 00:13:34.186 A:middle
our wildest dreams.

00:13:34.846 --> 00:13:34.976 A:middle
Nick.

00:13:35.271 --> 00:13:37.271 A:middle
[ Applause ]

00:13:37.526 --> 00:13:37.976 A:middle
&gt;&gt; Thanks, Scott.

00:13:38.416 --> 00:13:40.416 A:middle
[ Applause ]

00:13:40.816 --> 00:13:42.296 A:middle
So, as Scott said, as your

00:13:42.296 --> 00:13:43.876 A:middle
applications grow, they get more

00:13:43.876 --> 00:13:46.606 A:middle
and more complex and at Core

00:13:46.606 --> 00:13:48.196 A:middle
Data it's really important to us

00:13:48.196 --> 00:13:50.656 A:middle
that your applications do grow.

00:13:50.656 --> 00:13:51.746 A:middle
In fact, we want this.

00:13:51.746 --> 00:13:53.336 A:middle
That's the whole reason we exist

00:13:53.426 --> 00:13:54.626 A:middle
is to help you manage this

00:13:54.626 --> 00:13:56.166 A:middle
growth, make it efficient for

00:13:56.166 --> 00:13:58.026 A:middle
you to work with, and help you

00:13:58.026 --> 00:13:59.106 A:middle
give more value to your

00:13:59.106 --> 00:13:59.656 A:middle
customers.

00:14:00.306 --> 00:14:03.046 A:middle
But this happens in ways that

00:14:03.046 --> 00:14:04.216 A:middle
are very specific to your

00:14:04.216 --> 00:14:04.936 A:middle
application.

00:14:05.416 --> 00:14:06.976 A:middle
It's also highly aligned with

00:14:06.976 --> 00:14:08.696 A:middle
your customer experience or the

00:14:08.696 --> 00:14:09.936 A:middle
way that you want them to

00:14:09.936 --> 00:14:11.266 A:middle
experience your application.

00:14:12.056 --> 00:14:13.816 A:middle
Unfortunately, like all complex

00:14:13.816 --> 00:14:15.696 A:middle
systems, as it grows and becomes

00:14:15.696 --> 00:14:17.646 A:middle
more complex, it also tends

00:14:17.646 --> 00:14:18.516 A:middle
toward chaos.

00:14:19.376 --> 00:14:20.716 A:middle
So, today we're going to talk

00:14:20.716 --> 00:14:22.136 A:middle
about ways that Core Data can

00:14:22.136 --> 00:14:23.876 A:middle
help you manage this chaos and

00:14:23.876 --> 00:14:24.896 A:middle
give it some structure.

00:14:25.466 --> 00:14:26.536 A:middle
We'll talk about building

00:14:26.536 --> 00:14:28.996 A:middle
predictable behaviors and

00:14:28.996 --> 00:14:30.436 A:middle
helping you build tunable

00:14:30.436 --> 00:14:31.826 A:middle
containers that you can align

00:14:31.826 --> 00:14:32.976 A:middle
with your experience metrics.

00:14:36.236 --> 00:14:37.346 A:middle
What does that mean?

00:14:38.246 --> 00:14:39.996 A:middle
Well, when we think of metrics,

00:14:39.996 --> 00:14:40.996 A:middle
there's a couple of different

00:14:40.996 --> 00:14:42.646 A:middle
ways that we can think about

00:14:42.646 --> 00:14:42.946 A:middle
them.

00:14:43.396 --> 00:14:44.906 A:middle
The first is in alignment with

00:14:44.906 --> 00:14:45.696 A:middle
our customers.

00:14:46.326 --> 00:14:48.586 A:middle
And usually we define these as

00:14:48.586 --> 00:14:49.836 A:middle
things that they experience,

00:14:49.836 --> 00:14:51.176 A:middle
like having a consistent user

00:14:51.176 --> 00:14:53.536 A:middle
interface or a responsive scroll

00:14:53.536 --> 00:14:57.786 A:middle
view, and also as delight.

00:14:58.486 --> 00:15:01.106 A:middle
But those are really hard for us

00:14:58.486 --> 00:15:01.106 A:middle
But those are really hard for us

00:15:01.106 --> 00:15:02.476 A:middle
to capture as engineers.

00:15:03.256 --> 00:15:04.326 A:middle
So, we translate them into

00:15:04.326 --> 00:15:06.186 A:middle
engineering metrics, things like

00:15:06.296 --> 00:15:08.276 A:middle
peak memory consumption, how

00:15:08.276 --> 00:15:09.836 A:middle
much battery drains during a

00:15:09.836 --> 00:15:12.056 A:middle
given task or how much CPU time

00:15:12.436 --> 00:15:13.896 A:middle
is burned during a given task.

00:15:14.316 --> 00:15:16.206 A:middle
And, finally, how much IO we do

00:15:16.816 --> 00:15:17.906 A:middle
during a given task.

00:15:18.806 --> 00:15:19.656 A:middle
To make this a little more

00:15:19.656 --> 00:15:20.886 A:middle
concrete, we'll use this

00:15:20.886 --> 00:15:21.626 A:middle
application.

00:15:22.286 --> 00:15:23.236 A:middle
Some of you may remember the

00:15:23.236 --> 00:15:24.736 A:middle
history demo application that

00:15:24.836 --> 00:15:26.886 A:middle
was introduced last year at WWDC

00:15:27.306 --> 00:15:28.536 A:middle
and I've modified it for the

00:15:28.536 --> 00:15:29.676 A:middle
purposes of this talk.

00:15:30.506 --> 00:15:32.156 A:middle
There are a few actions here

00:15:32.156 --> 00:15:33.466 A:middle
that a customer can take while

00:15:33.466 --> 00:15:34.526 A:middle
using our application.

00:15:35.036 --> 00:15:36.676 A:middle
The first is they can add a

00:15:36.676 --> 00:15:38.826 A:middle
single post to our database by

00:15:38.826 --> 00:15:39.746 A:middle
hitting the + button.

00:15:40.786 --> 00:15:42.256 A:middle
They can also download any

00:15:42.256 --> 00:15:44.546 A:middle
pending data from the server by

00:15:44.546 --> 00:15:45.406 A:middle
tapping Download.

00:15:50.716 --> 00:15:52.796 A:middle
And, finally, for anything that

00:15:52.796 --> 00:15:53.966 A:middle
hasn't yet been uploaded to a

00:15:53.966 --> 00:15:55.636 A:middle
server, they can tap Post All.

00:15:56.596 --> 00:15:58.466 A:middle
Now, this application has a

00:15:58.466 --> 00:16:00.416 A:middle
fairly small set of interactions

00:15:58.466 --> 00:16:00.416 A:middle
fairly small set of interactions

00:16:00.416 --> 00:16:02.366 A:middle
that a customer can take, and

00:16:02.366 --> 00:16:04.156 A:middle
yet, as these happen

00:16:04.156 --> 00:16:06.936 A:middle
concurrently, it tends towards

00:16:06.936 --> 00:16:07.516 A:middle
chaos.

00:16:08.306 --> 00:16:11.536 A:middle
So, we can see that even with

00:16:11.536 --> 00:16:12.936 A:middle
this small set of actions,

00:16:13.596 --> 00:16:14.806 A:middle
things that go on concurrently

00:16:14.806 --> 00:16:15.676 A:middle
could cause a number of

00:16:15.676 --> 00:16:16.756 A:middle
different state changes in the

00:16:16.756 --> 00:16:18.776 A:middle
application and the worst thing

00:16:18.776 --> 00:16:20.436 A:middle
for us is to end up with a user

00:16:20.436 --> 00:16:21.826 A:middle
experience that looks like this.

00:16:22.696 --> 00:16:23.666 A:middle
This notion of partial

00:16:23.666 --> 00:16:25.336 A:middle
completeness doesn't make sense

00:16:25.336 --> 00:16:26.196 A:middle
to our customers.

00:16:26.196 --> 00:16:27.466 A:middle
In fact, it doesn't make sense

00:16:27.466 --> 00:16:28.156 A:middle
to us either.

00:16:29.816 --> 00:16:30.836 A:middle
Core Data is here to help with

00:16:30.886 --> 00:16:32.676 A:middle
that with query generations.

00:16:33.066 --> 00:16:33.946 A:middle
Query generations were

00:16:33.946 --> 00:16:36.556 A:middle
introduced in 2016 in our What's

00:16:36.556 --> 00:16:37.656 A:middle
New in Core Data session.

00:16:38.116 --> 00:16:39.076 A:middle
So, if you're not yet familiar

00:16:39.076 --> 00:16:40.286 A:middle
with them, I highly recommend

00:16:40.286 --> 00:16:41.516 A:middle
that you check out that session

00:16:41.516 --> 00:16:42.806 A:middle
for more information about how

00:16:42.806 --> 00:16:43.356 A:middle
they work.

00:16:43.996 --> 00:16:45.626 A:middle
What you do need to know is that

00:16:45.886 --> 00:16:47.506 A:middle
they require wall journal mode

00:16:47.606 --> 00:16:48.786 A:middle
and only work with SQLite.

00:16:49.906 --> 00:16:51.746 A:middle
The goal of query generations is

00:16:51.746 --> 00:16:53.186 A:middle
to isolate your managed object

00:16:53.186 --> 00:16:54.896 A:middle
contexts from competing work.

00:16:55.346 --> 00:16:56.406 A:middle
This could be rights to the

00:16:56.406 --> 00:16:58.566 A:middle
background or actions that the

00:16:58.566 --> 00:17:00.176 A:middle
user is taking that you're not

00:16:58.566 --> 00:17:00.176 A:middle
user is taking that you're not

00:17:00.176 --> 00:17:02.326 A:middle
yet ready to manifest in a given

00:17:02.326 --> 00:17:03.006 A:middle
context.

00:17:04.026 --> 00:17:05.286 A:middle
Query generations provide a

00:17:05.286 --> 00:17:07.026 A:middle
consistent, durable view of the

00:17:07.026 --> 00:17:08.806 A:middle
database that will return the

00:17:08.806 --> 00:17:10.435 A:middle
same results for fetches

00:17:10.435 --> 00:17:11.606 A:middle
regardless of what other

00:17:11.606 --> 00:17:12.806 A:middle
contexts are writing to the

00:17:12.806 --> 00:17:14.165 A:middle
database at a given time.

00:17:17.415 --> 00:17:19.695 A:middle
The best part is we can adopt

00:17:19.695 --> 00:17:20.816 A:middle
them in one line of code.

00:17:21.715 --> 00:17:23.116 A:middle
This is a typical change for

00:17:23.116 --> 00:17:24.256 A:middle
reloading a table view.

00:17:24.675 --> 00:17:26.626 A:middle
We would just have to insert a

00:17:26.626 --> 00:17:28.496 A:middle
call to NSManagedObjectContext

00:17:28.496 --> 00:17:30.256 A:middle
setQueryGenerationFrom token

00:17:30.336 --> 00:17:31.276 A:middle
with the current query

00:17:31.276 --> 00:17:31.966 A:middle
generation.

00:17:33.456 --> 00:17:34.746 A:middle
And when it comes time to update

00:17:34.746 --> 00:17:37.206 A:middle
them, we can update them as we

00:17:37.206 --> 00:17:38.296 A:middle
normally do by using

00:17:38.366 --> 00:17:40.056 A:middle
NSMangedObjectContextDidSave

00:17:40.056 --> 00:17:40.766 A:middle
notification.

00:17:41.236 --> 00:17:44.226 A:middle
And this allows us to manifest

00:17:44.226 --> 00:17:45.806 A:middle
changes to the application's

00:17:45.806 --> 00:17:47.866 A:middle
data in the UI at the right

00:17:48.786 --> 00:17:48.876 A:middle
time.

00:17:52.096 --> 00:17:53.536 A:middle
But what if the data that we're

00:17:53.536 --> 00:17:54.986 A:middle
writing isn't related to the UI,

00:17:55.676 --> 00:17:56.716 A:middle
such as downloading some

00:17:56.716 --> 00:17:57.986 A:middle
comments that Scott mentioned

00:17:57.986 --> 00:17:58.466 A:middle
earlier?

00:17:59.556 --> 00:18:02.046 A:middle
In this case, we don't want that

00:17:59.556 --> 00:18:02.046 A:middle
In this case, we don't want that

00:18:02.046 --> 00:18:03.406 A:middle
data to manifest in the user

00:18:03.406 --> 00:18:05.716 A:middle
interface or cause changes to it

00:18:05.716 --> 00:18:06.776 A:middle
because none of the change will

00:18:06.776 --> 00:18:07.996 A:middle
be visible to the user.

00:18:08.526 --> 00:18:09.876 A:middle
So, we can actually filter out

00:18:09.876 --> 00:18:11.516 A:middle
these updates by using history

00:18:11.516 --> 00:18:11.976 A:middle
tracking.

00:18:12.786 --> 00:18:14.276 A:middle
Persistent history tracking was

00:18:14.276 --> 00:18:17.456 A:middle
new in iOS 11 and macOS 10.13.

00:18:18.206 --> 00:18:19.996 A:middle
We introduced it in our session,

00:18:19.996 --> 00:18:22.036 A:middle
What's New in Core Data, last

00:18:22.116 --> 00:18:23.526 A:middle
year at WWDC, and for more

00:18:23.526 --> 00:18:24.866 A:middle
information about how it works

00:18:24.866 --> 00:18:26.626 A:middle
and what the underlying features

00:18:26.626 --> 00:18:27.866 A:middle
are of it, you can use that

00:18:28.516 --> 00:18:29.566 A:middle
session as a reference.

00:18:31.966 --> 00:18:33.406 A:middle
Persistent history tracking is a

00:18:33.406 --> 00:18:35.526 A:middle
great way to get a persistent

00:18:35.526 --> 00:18:37.086 A:middle
record of each transaction that

00:18:37.086 --> 00:18:38.926 A:middle
connects to the database and

00:18:38.926 --> 00:18:40.026 A:middle
this is useful to us for a

00:18:40.026 --> 00:18:41.186 A:middle
couple of different reasons.

00:18:41.756 --> 00:18:43.506 A:middle
For the purposes of this talk,

00:18:43.506 --> 00:18:45.626 A:middle
though, we'll be considering

00:18:45.796 --> 00:18:47.926 A:middle
NSPersistentHistoryChange, which

00:18:48.576 --> 00:18:51.276 A:middle
gives us a changedObjectID and a

00:18:51.276 --> 00:18:52.546 A:middle
set of updatedProperties.

00:18:53.036 --> 00:18:53.176 A:middle
And

00:18:53.296 --> 00:18:55.036 A:middle
NSPersistentHistoryTransaction

00:18:55.686 --> 00:18:57.246 A:middle
which gives us a set of changes

00:18:57.426 --> 00:18:59.136 A:middle
and an objectIDNotification.

00:19:01.396 --> 00:19:05.176 A:middle
So, let's consider the following

00:19:05.176 --> 00:19:06.036 A:middle
set of changes.

00:19:06.776 --> 00:19:08.236 A:middle
As you can see, these are posts

00:19:08.236 --> 00:19:09.376 A:middle
that are being inserted to our

00:19:09.376 --> 00:19:12.436 A:middle
database and when this happens,

00:19:12.806 --> 00:19:14.206 A:middle
given our table view, we would

00:19:14.206 --> 00:19:17.046 A:middle
want to refresh the UI, which we

00:19:17.046 --> 00:19:18.346 A:middle
can do by using the

00:19:18.346 --> 00:19:19.726 A:middle
objectIDNotification.

00:19:20.296 --> 00:19:21.356 A:middle
These are analogous to

00:19:21.486 --> 00:19:23.316 A:middle
NSManageObjectContextDidSave

00:19:23.316 --> 00:19:25.076 A:middle
notifications and can be merged

00:19:25.076 --> 00:19:26.586 A:middle
in using the same API.

00:19:29.756 --> 00:19:31.186 A:middle
But if we downloaded a list of

00:19:31.186 --> 00:19:33.516 A:middle
comments that we don't want to

00:19:33.516 --> 00:19:35.406 A:middle
manifest in a user update for,

00:19:35.976 --> 00:19:39.936 A:middle
we can filter them.

00:19:40.146 --> 00:19:41.556 A:middle
Using this small amount of code,

00:19:41.616 --> 00:19:42.826 A:middle
we can filter out the changes

00:19:42.826 --> 00:19:44.046 A:middle
from a given transaction to

00:19:44.046 --> 00:19:45.086 A:middle
decide if any of them were

00:19:45.086 --> 00:19:47.306 A:middle
relevant to the post entity and

00:19:48.876 --> 00:19:50.916 A:middle
in that way we won't refresh the

00:19:50.916 --> 00:19:53.876 A:middle
UI and cause an unnecessary blip

00:19:53.976 --> 00:19:55.276 A:middle
or stutter to the user.

00:19:56.256 --> 00:19:57.436 A:middle
But as you can see here, we're

00:19:57.436 --> 00:19:58.906 A:middle
actually only using a small

00:19:58.906 --> 00:20:00.496 A:middle
amount of the post content.

00:19:58.906 --> 00:20:00.496 A:middle
amount of the post content.

00:20:01.246 --> 00:20:03.276 A:middle
In fact, we're only using two

00:20:03.276 --> 00:20:05.536 A:middle
properties, the image and the

00:20:05.536 --> 00:20:05.906 A:middle
title.

00:20:07.406 --> 00:20:08.606 A:middle
And so we can do better than

00:20:08.606 --> 00:20:10.126 A:middle
just filtering out by entity.

00:20:10.416 --> 00:20:12.216 A:middle
We can actually filter out by

00:20:12.216 --> 00:20:13.606 A:middle
updated properties using the

00:20:13.606 --> 00:20:15.756 A:middle
history changes and in this way

00:20:15.756 --> 00:20:17.416 A:middle
we can create highly-targeted

00:20:17.416 --> 00:20:19.026 A:middle
updates to our user experience

00:20:19.476 --> 00:20:20.666 A:middle
that align with changes that

00:20:20.666 --> 00:20:21.916 A:middle
will be visible to them.

00:20:22.546 --> 00:20:27.526 A:middle
But Core Data can also help you

00:20:28.146 --> 00:20:29.846 A:middle
support new interactions for

00:20:29.846 --> 00:20:30.446 A:middle
your users.

00:20:31.336 --> 00:20:32.446 A:middle
As your data becomes more

00:20:32.446 --> 00:20:35.216 A:middle
complex and grows in scale, some

00:20:35.216 --> 00:20:36.756 A:middle
editing operations can get more

00:20:36.756 --> 00:20:37.346 A:middle
expensive.

00:20:37.346 --> 00:20:39.546 A:middle
For example, consider a simple

00:20:39.546 --> 00:20:40.466 A:middle
photos browser.

00:20:41.206 --> 00:20:42.796 A:middle
Typically, when our applications

00:20:42.796 --> 00:20:44.386 A:middle
grow, we want to -- we want to

00:20:44.386 --> 00:20:45.976 A:middle
introduce new functionality that

00:20:45.976 --> 00:20:47.276 A:middle
makes it easier to perform

00:20:47.276 --> 00:20:49.036 A:middle
repetitive tasks, such as

00:20:49.116 --> 00:20:50.136 A:middle
multiple selection.

00:20:50.506 --> 00:20:53.236 A:middle
And Core Data can support this

00:20:53.266 --> 00:20:54.826 A:middle
by using batch operations.

00:20:55.976 --> 00:20:57.946 A:middle
In fact, in just a couple lines

00:20:57.946 --> 00:20:59.436 A:middle
of code we can mark an entire

00:20:59.436 --> 00:21:01.946 A:middle
set of photos as a favorite or

00:20:59.436 --> 00:21:01.946 A:middle
set of photos as a favorite or

00:21:02.726 --> 00:21:02.826 A:middle
not.

00:21:03.596 --> 00:21:05.376 A:middle
And in just one line of code, we

00:21:05.376 --> 00:21:07.046 A:middle
can purge or delete a set of

00:21:07.046 --> 00:21:08.416 A:middle
records from the database using

00:21:08.416 --> 00:21:09.706 A:middle
a batch delete operation.

00:21:09.976 --> 00:21:12.256 A:middle
And these operations scale in

00:21:12.256 --> 00:21:13.646 A:middle
ways that aren't possible by

00:21:13.646 --> 00:21:14.716 A:middle
faulting the objects into

00:21:14.716 --> 00:21:15.096 A:middle
memory.

00:21:15.886 --> 00:21:18.116 A:middle
For example, during a delete, a

00:21:18.116 --> 00:21:19.556 A:middle
traditional delete by calling

00:21:19.556 --> 00:21:22.306 A:middle
NSManagedObject.delete will grow

00:21:22.446 --> 00:21:23.776 A:middle
with the size of the records in

00:21:23.776 --> 00:21:24.836 A:middle
the database.

00:21:24.906 --> 00:21:26.116 A:middle
And as you delete objects and

00:21:26.116 --> 00:21:27.336 A:middle
their memory gets faulted into

00:21:27.336 --> 00:21:29.436 A:middle
the context, this gets more and

00:21:29.436 --> 00:21:31.136 A:middle
more expensive the larger your

00:21:31.136 --> 00:21:32.086 A:middle
database gets.

00:21:32.716 --> 00:21:34.036 A:middle
But with batch operations, we

00:21:34.036 --> 00:21:36.106 A:middle
can perform the same mutations

00:21:36.106 --> 00:21:37.196 A:middle
in just a fraction of the

00:21:37.196 --> 00:21:37.706 A:middle
memory.

00:21:38.276 --> 00:21:39.716 A:middle
And this has the curve that we

00:21:39.716 --> 00:21:42.756 A:middle
want as data increases, where

00:21:42.756 --> 00:21:44.626 A:middle
the larger the data set is, the

00:21:44.626 --> 00:21:46.976 A:middle
less memory we use, using up to

00:21:46.976 --> 00:21:48.696 A:middle
about 7% of the memory of a

00:21:48.696 --> 00:21:50.606 A:middle
traditional delete at 10 million

00:21:50.606 --> 00:21:51.156 A:middle
rows.

00:21:52.556 --> 00:21:54.076 A:middle
So, this is a very powerful way

00:21:54.076 --> 00:21:55.296 A:middle
to save resources on your

00:21:55.296 --> 00:21:57.066 A:middle
customer's device.

00:21:57.956 --> 00:21:59.176 A:middle
But one of the traditional

00:21:59.176 --> 00:22:00.976 A:middle
problems with batch operations

00:21:59.176 --> 00:22:00.976 A:middle
problems with batch operations

00:22:01.596 --> 00:22:02.776 A:middle
is that they were difficult to

00:22:02.776 --> 00:22:03.926 A:middle
work with because they don't

00:22:03.926 --> 00:22:05.606 A:middle
generate save notifications.

00:22:06.376 --> 00:22:07.426 A:middle
That's where history tracking

00:22:07.426 --> 00:22:08.176 A:middle
comes back in.

00:22:09.026 --> 00:22:10.016 A:middle
With persistent history

00:22:10.016 --> 00:22:11.306 A:middle
tracking, we can fetch out the

00:22:11.306 --> 00:22:12.846 A:middle
transactions from the database

00:22:13.286 --> 00:22:14.266 A:middle
that occurred as part of the

00:22:14.266 --> 00:22:17.156 A:middle
batch delete or update and we

00:22:17.156 --> 00:22:18.996 A:middle
can use the objectIDNotification

00:22:18.996 --> 00:22:20.276 A:middle
method to generate a

00:22:20.276 --> 00:22:21.676 A:middle
notification that works like a

00:22:21.676 --> 00:22:22.866 A:middle
save notification.

00:22:23.386 --> 00:22:24.786 A:middle
In this way, the fetched results

00:22:24.786 --> 00:22:26.666 A:middle
controller or any other context

00:22:26.666 --> 00:22:28.846 A:middle
in your application can update

00:22:28.846 --> 00:22:29.846 A:middle
to those notifications

00:22:29.846 --> 00:22:30.656 A:middle
incrementally.

00:22:31.226 --> 00:22:35.546 A:middle
And so those are some ways you

00:22:35.546 --> 00:22:37.016 A:middle
can manage growing data with

00:22:37.016 --> 00:22:39.456 A:middle
Core Data, but how about your

00:22:39.456 --> 00:22:40.586 A:middle
workflow itself?

00:22:40.966 --> 00:22:43.396 A:middle
What can Core Data do for you as

00:22:43.396 --> 00:22:45.426 A:middle
a developer and engineer to make

00:22:45.426 --> 00:22:46.886 A:middle
it easier to build and test your

00:22:46.886 --> 00:22:47.726 A:middle
applications?

00:22:49.166 --> 00:22:51.136 A:middle
The first thing is that we can

00:22:51.136 --> 00:22:52.286 A:middle
help future you today.

00:22:53.856 --> 00:22:55.576 A:middle
As you may know, NSKeyedArchiver

00:22:55.576 --> 00:22:56.326 A:middle
is changing.

00:22:57.056 --> 00:22:58.416 A:middle
We're adopting secure coding

00:22:58.416 --> 00:23:00.926 A:middle
across the entire platform and

00:22:58.416 --> 00:23:00.926 A:middle
across the entire platform and

00:23:01.016 --> 00:23:03.146 A:middle
the KeyedArchiver API has

00:23:03.146 --> 00:23:04.596 A:middle
changed significantly this year

00:23:04.596 --> 00:23:05.436 A:middle
in support of that.

00:23:06.496 --> 00:23:07.786 A:middle
For Core Data, this means that

00:23:07.786 --> 00:23:09.586 A:middle
value transformers are changing,

00:23:09.586 --> 00:23:11.066 A:middle
so if you have a transformable

00:23:11.066 --> 00:23:13.086 A:middle
property in your managed object

00:23:13.086 --> 00:23:14.916 A:middle
model and you're not sending a

00:23:14.916 --> 00:23:16.876 A:middle
value transformer today, you

00:23:16.876 --> 00:23:17.836 A:middle
used to be getting

00:23:18.036 --> 00:23:18.946 A:middle
NSKeyedUnarchive

00:23:18.946 --> 00:23:20.696 A:middle
FromDataTransformer as your

00:23:20.936 --> 00:23:22.316 A:middle
default value transformer.

00:23:22.916 --> 00:23:24.446 A:middle
In the future, you'll be getting

00:23:24.676 --> 00:23:25.616 A:middle
NSSecureUnarchive

00:23:25.736 --> 00:23:28.196 A:middle
FromDataTransformer and this

00:23:28.196 --> 00:23:29.496 A:middle
implements secure coding under

00:23:29.496 --> 00:23:31.016 A:middle
the covers and you should adopt

00:23:31.016 --> 00:23:31.576 A:middle
it today.

00:23:32.176 --> 00:23:33.416 A:middle
There was a great talk this

00:23:33.416 --> 00:23:35.496 A:middle
morning about exactly this topic

00:23:36.976 --> 00:23:38.216 A:middle
called the Data You Can Trust

00:23:38.636 --> 00:23:40.006 A:middle
and I highly recommend that you

00:23:40.006 --> 00:23:41.666 A:middle
view it to get more information

00:23:41.666 --> 00:23:43.496 A:middle
about secure coding and how to

00:23:43.496 --> 00:23:44.706 A:middle
make your applications more

00:23:44.706 --> 00:23:45.146 A:middle
resilient.

00:23:48.246 --> 00:23:49.356 A:middle
You can specify this in the

00:23:49.356 --> 00:23:50.266 A:middle
model editor with a

00:23:50.266 --> 00:23:52.976 A:middle
transformable property by the

00:23:52.976 --> 00:23:54.766 A:middle
value transformer name field.

00:23:55.716 --> 00:23:57.486 A:middle
And today, we want you to

00:23:57.486 --> 00:23:59.676 A:middle
implement this on your own.

00:24:00.146 --> 00:24:01.566 A:middle
This will become the default in

00:24:01.566 --> 00:24:03.506 A:middle
a future release and in a future

00:24:03.506 --> 00:24:04.986 A:middle
release Xcode will also start

00:24:04.986 --> 00:24:06.266 A:middle
emitting a warning for anyone

00:24:06.266 --> 00:24:07.886 A:middle
that's using the default value

00:24:07.886 --> 00:24:08.706 A:middle
transformer name.

00:24:10.036 --> 00:24:10.956 A:middle
If you're building your models

00:24:10.956 --> 00:24:13.056 A:middle
in code, you can set it by using

00:24:13.056 --> 00:24:14.146 A:middle
the valueTransformerName

00:24:14.146 --> 00:24:15.996 A:middle
property on NSAttribute

00:24:15.996 --> 00:24:16.416 A:middle
description.

00:24:17.726 --> 00:24:19.046 A:middle
This should be transparent for

00:24:19.046 --> 00:24:21.176 A:middle
you if you're not encoding

00:24:21.176 --> 00:24:22.256 A:middle
custom class types.

00:24:22.296 --> 00:24:23.926 A:middle
So, for plist types, this is a

00:24:23.926 --> 00:24:24.306 A:middle
no op.

00:24:24.756 --> 00:24:25.806 A:middle
You simply change the value

00:24:25.806 --> 00:24:27.336 A:middle
transformer name and you'll get

00:24:27.336 --> 00:24:28.726 A:middle
the new secure coding behavior.

00:24:29.286 --> 00:24:30.856 A:middle
However, if you are implementing

00:24:30.856 --> 00:24:32.456 A:middle
custom classes, those classes

00:24:32.456 --> 00:24:34.786 A:middle
need to adopt secure coding and

00:24:34.846 --> 00:24:36.276 A:middle
you can come see us in the labs

00:24:36.276 --> 00:24:37.616 A:middle
for help with that.

00:24:38.296 --> 00:24:40.486 A:middle
But we can help you more.

00:24:41.286 --> 00:24:42.866 A:middle
At Core Data, we've spent time

00:24:43.066 --> 00:24:44.726 A:middle
building in new debugging tools

00:24:45.026 --> 00:24:46.566 A:middle
over the years that can help you

00:24:46.566 --> 00:24:47.796 A:middle
understand what's going on under

00:24:47.796 --> 00:24:48.236 A:middle
the stack.

00:24:49.026 --> 00:24:50.216 A:middle
So, this is a picture of our

00:24:50.216 --> 00:24:51.666 A:middle
preferred default scheme

00:24:51.666 --> 00:24:52.536 A:middle
configuration.

00:24:52.866 --> 00:24:54.686 A:middle
We have a couple of process

00:24:54.686 --> 00:24:56.396 A:middle
arguments that we have that can

00:24:56.396 --> 00:24:57.386 A:middle
help you get more debugging

00:24:57.386 --> 00:24:59.416 A:middle
information about SQLite, but

00:24:59.416 --> 00:25:00.746 A:middle
the big one you should always

00:24:59.416 --> 00:25:00.746 A:middle
the big one you should always

00:25:00.746 --> 00:25:02.566 A:middle
run with is com.apple.Core

00:25:02.566 --> 00:25:04.066 A:middle
Data.ConcurrencyDebug.

00:25:04.616 --> 00:25:06.266 A:middle
And this will catch any queue

00:25:06.266 --> 00:25:07.746 A:middle
exceptions in your applications,

00:25:07.746 --> 00:25:09.396 A:middle
so areas that you may be

00:25:09.396 --> 00:25:10.766 A:middle
transferring objects between

00:25:10.766 --> 00:25:11.926 A:middle
main and background queue

00:25:11.926 --> 00:25:14.066 A:middle
contexts or areas that you may

00:25:14.066 --> 00:25:15.566 A:middle
not be obeying a managed

00:25:15.566 --> 00:25:18.666 A:middle
object's actual context.

00:25:18.746 --> 00:25:20.466 A:middle
SQLite also has a number of

00:25:20.466 --> 00:25:21.506 A:middle
interesting environment

00:25:21.506 --> 00:25:23.206 A:middle
variables, so their threading

00:25:23.206 --> 00:25:24.756 A:middle
and file assertions are a great

00:25:24.756 --> 00:25:25.836 A:middle
way to ensure you have

00:25:25.836 --> 00:25:27.286 A:middle
correctness in your application

00:25:27.286 --> 00:25:29.016 A:middle
around their API as well as the

00:25:29.016 --> 00:25:29.746 A:middle
file system.

00:25:30.576 --> 00:25:32.386 A:middle
And auto tracing is a great way

00:25:32.386 --> 00:25:33.496 A:middle
for you to see what's going on

00:25:33.496 --> 00:25:34.826 A:middle
under the covers, an additional

00:25:34.826 --> 00:25:36.046 A:middle
tour on debug logging.

00:25:36.856 --> 00:25:39.646 A:middle
com.apple.Core Data.SQLDebug has

00:25:39.646 --> 00:25:40.676 A:middle
four levels.

00:25:41.106 --> 00:25:43.206 A:middle
The first level is the most

00:25:43.206 --> 00:25:44.636 A:middle
interesting and the least of a

00:25:44.636 --> 00:25:45.466 A:middle
performance hit.

00:25:45.466 --> 00:25:47.826 A:middle
The fourth level is the most

00:25:47.826 --> 00:25:49.126 A:middle
verbose, but does cause

00:25:49.126 --> 00:25:51.006 A:middle
significant performance hit when

00:25:51.006 --> 00:25:53.726 A:middle
you run with it.

00:25:53.996 --> 00:25:55.696 A:middle
When you enable SQL debugging

00:25:55.806 --> 00:25:57.146 A:middle
and our multi-threading

00:25:57.146 --> 00:25:58.476 A:middle
assertions, you'll see a couple

00:25:58.506 --> 00:26:00.456 A:middle
of logs in the console and these

00:25:58.506 --> 00:26:00.456 A:middle
of logs in the console and these

00:26:00.456 --> 00:26:01.356 A:middle
are the indication that the

00:26:01.356 --> 00:26:02.526 A:middle
assertions are enabled and

00:26:02.526 --> 00:26:03.366 A:middle
running correctly.

00:26:04.636 --> 00:26:06.076 A:middle
With our SQL debugging on,

00:26:06.076 --> 00:26:07.456 A:middle
you'll be able to see things

00:26:07.456 --> 00:26:08.656 A:middle
like select statements for our

00:26:08.656 --> 00:26:10.156 A:middle
fetch requests as well as how

00:26:10.156 --> 00:26:10.866 A:middle
long they took.

00:26:11.706 --> 00:26:13.016 A:middle
And, if you're set to level

00:26:13.016 --> 00:26:14.766 A:middle
four, you'll even get explain,

00:26:15.026 --> 00:26:16.056 A:middle
which will show you the query

00:26:16.056 --> 00:26:17.836 A:middle
plan for a given select

00:26:18.186 --> 00:26:19.016 A:middle
statement.

00:26:19.586 --> 00:26:20.936 A:middle
And here we can see that our

00:26:20.936 --> 00:26:23.786 A:middle
table view is selected via table

00:26:23.786 --> 00:26:25.856 A:middle
scan and then using a temporary

00:26:25.856 --> 00:26:27.866 A:middle
B-tree in memory for the order

00:26:27.866 --> 00:26:29.646 A:middle
by, which is on the timestamp.

00:26:30.536 --> 00:26:31.876 A:middle
This is a potential performance

00:26:31.876 --> 00:26:33.766 A:middle
problem and as you're running

00:26:33.766 --> 00:26:35.006 A:middle
your application you can use

00:26:35.006 --> 00:26:37.116 A:middle
messages like this to see where

00:26:37.116 --> 00:26:38.506 A:middle
you may be doing more work than

00:26:38.506 --> 00:26:39.086 A:middle
you need to.

00:26:40.346 --> 00:26:41.496 A:middle
So, how would we fix this?

00:26:42.946 --> 00:26:45.816 A:middle
Well, turns out SQLite 3 can

00:26:45.816 --> 00:26:46.776 A:middle
actually tell us.

00:26:47.476 --> 00:26:49.166 A:middle
If we open a database and hand

00:26:49.166 --> 00:26:50.696 A:middle
it the select query from our SQL

00:26:50.696 --> 00:26:52.926 A:middle
logs, we can enable a mode

00:26:52.926 --> 00:26:54.616 A:middle
called Expert, which will

00:26:54.616 --> 00:26:56.396 A:middle
analyze the query and give us

00:26:56.436 --> 00:26:58.616 A:middle
the ideal solution of optimizing

00:26:58.616 --> 00:27:00.366 A:middle
it by creating a covering index.

00:26:58.616 --> 00:27:00.366 A:middle
it by creating a covering index.

00:27:01.366 --> 00:27:02.606 A:middle
And we can do this in the model

00:27:02.606 --> 00:27:05.256 A:middle
editor by adding a fetch index

00:27:05.576 --> 00:27:06.416 A:middle
to our post entity.

00:27:07.066 --> 00:27:08.416 A:middle
Here I've configured it to run

00:27:08.416 --> 00:27:10.216 A:middle
on the timestamp and fetch them

00:27:10.216 --> 00:27:12.676 A:middle
out in descending order because

00:27:12.676 --> 00:27:13.786 A:middle
we're showing the most recent

00:27:13.786 --> 00:27:15.306 A:middle
posts at the top of the table

00:27:15.306 --> 00:27:15.526 A:middle
view.

00:27:17.676 --> 00:27:19.106 A:middle
When we run the application

00:27:19.106 --> 00:27:20.586 A:middle
again, we see the same select

00:27:20.586 --> 00:27:20.976 A:middle
logs.

00:27:24.386 --> 00:27:26.546 A:middle
Except that this time we see

00:27:26.546 --> 00:27:27.876 A:middle
that the select query hits the

00:27:27.876 --> 00:27:29.616 A:middle
covering index during the query.

00:27:30.126 --> 00:27:31.726 A:middle
Explain shows us that the query

00:27:31.726 --> 00:27:33.746 A:middle
will use the covering index for

00:27:33.746 --> 00:27:38.296 A:middle
its order by.

00:27:38.536 --> 00:27:39.966 A:middle
Core Data supports many types of

00:27:39.966 --> 00:27:41.696 A:middle
indexing, including compound

00:27:41.696 --> 00:27:43.356 A:middle
indexes using R-trees.

00:27:43.906 --> 00:27:45.646 A:middle
And these are great for creating

00:27:45.646 --> 00:27:47.346 A:middle
any kind of query or optimizing

00:27:47.346 --> 00:27:49.806 A:middle
a query that uses a bounding box

00:27:50.406 --> 00:27:51.536 A:middle
in its select statement.

00:27:52.196 --> 00:27:53.386 A:middle
This is most commonly done with

00:27:53.426 --> 00:27:55.216 A:middle
locations and we can set this up

00:27:55.216 --> 00:27:57.396 A:middle
by adding another index to our

00:27:57.396 --> 00:27:58.876 A:middle
post entity, which works in the

00:27:58.876 --> 00:28:00.396 A:middle
latitude and longitude property

00:27:58.876 --> 00:28:00.396 A:middle
latitude and longitude property

00:28:00.396 --> 00:28:02.046 A:middle
that I added for the purposes of

00:28:02.046 --> 00:28:02.536 A:middle
this slide.

00:28:04.816 --> 00:28:06.836 A:middle
We change the query type in this

00:28:06.836 --> 00:28:08.246 A:middle
box by selecting R-tree.

00:28:08.796 --> 00:28:10.836 A:middle
And then we can set up our

00:28:10.836 --> 00:28:12.556 A:middle
predicate on the fetch request

00:28:13.206 --> 00:28:14.906 A:middle
to say get all of the posts that

00:28:14.906 --> 00:28:16.136 A:middle
happen inside of continental

00:28:16.136 --> 00:28:16.516 A:middle
China.

00:28:18.406 --> 00:28:20.186 A:middle
This predicate is a little more

00:28:20.186 --> 00:28:21.656 A:middle
advanced because it uses

00:28:21.716 --> 00:28:24.306 A:middle
functions inside the actual

00:28:24.306 --> 00:28:26.256 A:middle
select statement to hit the

00:28:26.256 --> 00:28:27.676 A:middle
index that we created in the

00:28:27.676 --> 00:28:28.676 A:middle
managed object model.

00:28:31.556 --> 00:28:33.266 A:middle
When we run our application

00:28:33.266 --> 00:28:35.016 A:middle
without this predicate and

00:28:35.016 --> 00:28:36.596 A:middle
without this index, we see the

00:28:36.596 --> 00:28:38.266 A:middle
same results that we saw before

00:28:38.726 --> 00:28:40.696 A:middle
where we're hitting only the

00:28:40.696 --> 00:28:41.826 A:middle
timestamp index.

00:28:42.366 --> 00:28:44.956 A:middle
But when we run it with our new

00:28:44.956 --> 00:28:47.196 A:middle
index and predicate, we see that

00:28:47.196 --> 00:28:48.956 A:middle
SQLite is using the index to

00:28:48.956 --> 00:28:51.626 A:middle
generate faster results for both

00:28:51.626 --> 00:28:53.056 A:middle
of the between statements.

00:28:55.026 --> 00:28:56.806 A:middle
Unfortunately, because our

00:28:56.806 --> 00:28:58.446 A:middle
timestamp index doesn't have any

00:28:58.446 --> 00:28:59.656 A:middle
bounding predicates on it,

00:28:59.976 --> 00:29:01.566 A:middle
SQLite can't use it for the

00:28:59.976 --> 00:29:01.566 A:middle
SQLite can't use it for the

00:29:01.566 --> 00:29:02.006 A:middle
sort.

00:29:02.556 --> 00:29:04.776 A:middle
So, the optimization that we've

00:29:04.776 --> 00:29:07.216 A:middle
chosen here is to use a compound

00:29:07.216 --> 00:29:08.636 A:middle
index to first filter out the

00:29:08.636 --> 00:29:10.166 A:middle
result set to a smaller set of

00:29:10.166 --> 00:29:11.676 A:middle
objects and then we'll do an

00:29:11.676 --> 00:29:13.276 A:middle
in-memory B-tree sort for the

00:29:13.276 --> 00:29:13.736 A:middle
order by.

00:29:14.336 --> 00:29:18.536 A:middle
As you can see, this index

00:29:18.536 --> 00:29:20.186 A:middle
increases the performance of our

00:29:20.186 --> 00:29:22.286 A:middle
fetch by about 25%.

00:29:23.986 --> 00:29:25.256 A:middle
In this case, my performance

00:29:25.256 --> 00:29:27.066 A:middle
test was run over a size of

00:29:27.066 --> 00:29:29.726 A:middle
about 100,000 rows and we saw

00:29:29.726 --> 00:29:31.616 A:middle
around 130 milliseconds of

00:29:31.616 --> 00:29:33.036 A:middle
improvement for just the fetch.

00:29:34.476 --> 00:29:35.876 A:middle
Which brings me to my next topic

00:29:36.196 --> 00:29:37.466 A:middle
of testing with Core Data.

00:29:38.646 --> 00:29:40.716 A:middle
As you may know, we really like

00:29:40.716 --> 00:29:41.086 A:middle
tests.

00:29:41.656 --> 00:29:42.476 A:middle
Tests are awesome.

00:29:43.026 --> 00:29:45.156 A:middle
And, at Core Data, we use them

00:29:45.156 --> 00:29:46.686 A:middle
internally for both correctness

00:29:46.686 --> 00:29:48.476 A:middle
as well as learning.

00:29:48.906 --> 00:29:49.826 A:middle
They're a great way to learn

00:29:49.826 --> 00:29:51.026 A:middle
about the functionality of Core

00:29:51.026 --> 00:29:52.846 A:middle
Data and how our API behaves

00:29:52.846 --> 00:29:54.406 A:middle
under a given set of conditions.

00:29:55.316 --> 00:29:56.326 A:middle
They're also a great way to

00:29:56.326 --> 00:29:58.876 A:middle
verify your assumptions about

00:29:58.986 --> 00:30:00.806 A:middle
how Core Data works and how it's

00:29:58.986 --> 00:30:00.806 A:middle
how Core Data works and how it's

00:30:00.806 --> 00:30:01.856 A:middle
going to help your customers

00:30:01.856 --> 00:30:02.916 A:middle
have a better experience with

00:30:02.916 --> 00:30:03.716 A:middle
your application.

00:30:04.266 --> 00:30:05.316 A:middle
As you saw in the previous

00:30:05.316 --> 00:30:06.916 A:middle
example, we can verify that our

00:30:06.916 --> 00:30:08.966 A:middle
R-tree index actually does give

00:30:08.966 --> 00:30:10.456 A:middle
us a performance benefit even

00:30:10.456 --> 00:30:11.466 A:middle
though it's using an in-memory

00:30:11.466 --> 00:30:12.186 A:middle
B-tree sort.

00:30:14.276 --> 00:30:16.136 A:middle
They also capture your product

00:30:16.136 --> 00:30:17.686 A:middle
requirements, and this is really

00:30:17.686 --> 00:30:19.456 A:middle
important to us at Core Data

00:30:19.456 --> 00:30:20.896 A:middle
because it helps us communicate

00:30:20.896 --> 00:30:22.296 A:middle
around your expectations.

00:30:22.786 --> 00:30:24.026 A:middle
With tests, we can see what

00:30:24.026 --> 00:30:25.566 A:middle
you're doing in code and how you

00:30:25.566 --> 00:30:27.296 A:middle
expect those lines of code to

00:30:27.296 --> 00:30:28.546 A:middle
behave for your customers.

00:30:29.686 --> 00:30:30.816 A:middle
There are some important things

00:30:30.816 --> 00:30:31.976 A:middle
that you can set up to make this

00:30:31.976 --> 00:30:34.166 A:middle
easy for yourself, such as a

00:30:34.166 --> 00:30:36.196 A:middle
base class that generates a

00:30:36.196 --> 00:30:37.236 A:middle
persistent container.

00:30:38.406 --> 00:30:39.926 A:middle
This base class on the screen

00:30:39.926 --> 00:30:41.856 A:middle
happens to use a file URL of

00:30:41.856 --> 00:30:43.426 A:middle
/dev/null for the persistent

00:30:43.426 --> 00:30:45.316 A:middle
store and this is a great way of

00:30:45.316 --> 00:30:46.636 A:middle
making tests that operate on a

00:30:46.636 --> 00:30:48.506 A:middle
small set of managed objects run

00:30:48.506 --> 00:30:50.446 A:middle
very, very quickly because

00:30:50.446 --> 00:30:52.076 A:middle
they'll run entirely in memory.

00:30:52.776 --> 00:30:54.726 A:middle
When you do this, SQLite

00:30:54.726 --> 00:30:56.306 A:middle
materializes an in-memory store

00:30:56.306 --> 00:30:57.866 A:middle
for you that can be very

00:30:57.866 --> 00:30:59.596 A:middle
efficient, but because it's in

00:30:59.596 --> 00:31:00.756 A:middle
memory, if you have a lot of

00:30:59.596 --> 00:31:00.756 A:middle
memory, if you have a lot of

00:31:00.756 --> 00:31:02.186 A:middle
data, this will cause a lot of

00:31:02.186 --> 00:31:03.536 A:middle
memory growth in your test

00:31:03.976 --> 00:31:04.146 A:middle
suite.

00:31:07.616 --> 00:31:09.476 A:middle
You should have at least one

00:31:10.076 --> 00:31:11.676 A:middle
test, though, that actually

00:31:11.676 --> 00:31:13.146 A:middle
materializes your store file on

00:31:13.146 --> 00:31:13.506 A:middle
disk.

00:31:14.026 --> 00:31:15.746 A:middle
And this is because if you can't

00:31:15.746 --> 00:31:16.806 A:middle
open your store for your test

00:31:16.806 --> 00:31:18.316 A:middle
suite, it's highly likely that

00:31:18.316 --> 00:31:19.436 A:middle
your customer can't either.

00:31:21.076 --> 00:31:22.546 A:middle
If your persistent container is

00:31:22.546 --> 00:31:24.156 A:middle
in the application delegate, you

00:31:24.156 --> 00:31:25.506 A:middle
can have a test base class that

00:31:25.506 --> 00:31:26.866 A:middle
grabs the container out and

00:31:26.866 --> 00:31:28.506 A:middle
writes directly to that store.

00:31:29.296 --> 00:31:31.496 A:middle
But I must caution you to take

00:31:31.496 --> 00:31:33.086 A:middle
care when you do this, because

00:31:33.086 --> 00:31:34.106 A:middle
that means that you're writing

00:31:34.106 --> 00:31:35.566 A:middle
to the store file that's in use

00:31:35.566 --> 00:31:37.776 A:middle
by the application, so if you

00:31:37.776 --> 00:31:38.916 A:middle
run your test on a personal

00:31:38.916 --> 00:31:40.646 A:middle
device, you'll see the effects

00:31:40.646 --> 00:31:42.006 A:middle
of the unit test when you open

00:31:42.006 --> 00:31:47.316 A:middle
your application the next time.

00:31:47.536 --> 00:31:48.446 A:middle
What if I told you I could

00:31:48.446 --> 00:31:50.316 A:middle
insert 100,000 records in just

00:31:50.316 --> 00:31:51.236 A:middle
seven lines of code?

00:31:53.806 --> 00:31:55.036 A:middle
I'm cheating a little bit.

00:31:55.036 --> 00:31:56.356 A:middle
I was going to leave this as an

00:31:56.356 --> 00:31:58.556 A:middle
exercise to the reader, but this

00:31:58.556 --> 00:31:59.946 A:middle
type of scaffolding is a great

00:31:59.946 --> 00:32:01.306 A:middle
way to help you build a test

00:31:59.946 --> 00:32:01.306 A:middle
way to help you build a test

00:32:01.306 --> 00:32:02.556 A:middle
suite that evaluates your

00:32:02.556 --> 00:32:04.016 A:middle
invariance around your data.

00:32:04.976 --> 00:32:06.386 A:middle
By building these methods ahead

00:32:06.386 --> 00:32:08.496 A:middle
of time, as your data changes or

00:32:08.496 --> 00:32:09.876 A:middle
you become aware of new use

00:32:09.876 --> 00:32:11.626 A:middle
cases for your application, you

00:32:11.626 --> 00:32:13.486 A:middle
can iterate on these to build

00:32:13.486 --> 00:32:14.756 A:middle
new edge cases, build new

00:32:14.756 --> 00:32:15.826 A:middle
structures for your object

00:32:15.826 --> 00:32:17.946 A:middle
graph, or evaluate the behavior

00:32:17.946 --> 00:32:19.186 A:middle
of certain functionality under

00:32:19.186 --> 00:32:21.776 A:middle
the covers, such as performance.

00:32:22.146 --> 00:32:25.606 A:middle
This is the unit test scaffold

00:32:25.606 --> 00:32:26.566 A:middle
that I used to build a

00:32:26.566 --> 00:32:28.046 A:middle
performance test for the R-tree

00:32:28.046 --> 00:32:28.466 A:middle
query.

00:32:29.176 --> 00:32:30.496 A:middle
In just a handful of lines of

00:32:30.496 --> 00:32:32.456 A:middle
code, we get high confidence on

00:32:32.456 --> 00:32:33.886 A:middle
the performance of our fetch.

00:32:34.836 --> 00:32:36.286 A:middle
And these types of tests are

00:32:36.286 --> 00:32:37.466 A:middle
very informative when you're

00:32:37.466 --> 00:32:38.996 A:middle
trying to evaluate tradeoffs

00:32:38.996 --> 00:32:40.386 A:middle
between different features and

00:32:40.386 --> 00:32:44.896 A:middle
functionality in Core Data.

00:32:45.316 --> 00:32:46.576 A:middle
These three lines of code

00:32:46.576 --> 00:32:47.936 A:middle
generate a new managed object

00:32:47.936 --> 00:32:49.976 A:middle
context and container for us for

00:32:49.976 --> 00:32:50.946 A:middle
our test to use.

00:32:51.756 --> 00:32:54.206 A:middle
Now, this is important primarily

00:32:54.206 --> 00:32:55.606 A:middle
because the setup and teardown

00:32:55.606 --> 00:32:57.786 A:middle
logic in tests can sometimes

00:32:57.786 --> 00:32:59.066 A:middle
affect their performance.

00:32:59.696 --> 00:33:01.196 A:middle
So, you'll need to take care to

00:32:59.696 --> 00:33:01.196 A:middle
So, you'll need to take care to

00:33:01.196 --> 00:33:02.836 A:middle
analyze whether or not you're

00:33:02.836 --> 00:33:04.226 A:middle
actually testing the teardown

00:33:04.226 --> 00:33:05.256 A:middle
performance or the setup

00:33:05.256 --> 00:33:06.946 A:middle
performance or the actual

00:33:06.946 --> 00:33:08.216 A:middle
runtime performance of the

00:33:08.216 --> 00:33:09.626 A:middle
queries you're evaluating.

00:33:10.556 --> 00:33:11.546 A:middle
And after you've run these

00:33:11.546 --> 00:33:14.046 A:middle
tests, you can file good bugs.

00:33:15.526 --> 00:33:17.346 A:middle
We love bugs, especially from

00:33:17.346 --> 00:33:18.546 A:middle
you guys because we're building

00:33:18.546 --> 00:33:19.796 A:middle
a product to help you build your

00:33:19.796 --> 00:33:20.606 A:middle
applications.

00:33:21.206 --> 00:33:24.176 A:middle
But, bug reports without tests

00:33:24.176 --> 00:33:25.426 A:middle
or without a sample application

00:33:25.426 --> 00:33:26.486 A:middle
are very hard for us to

00:33:26.486 --> 00:33:28.126 A:middle
communicate around because, as I

00:33:28.126 --> 00:33:29.906 A:middle
mentioned earlier, they don't

00:33:29.906 --> 00:33:30.696 A:middle
capture your product

00:33:30.696 --> 00:33:32.196 A:middle
requirements and expectations in

00:33:32.196 --> 00:33:33.046 A:middle
the same way that

00:33:33.046 --> 00:33:34.396 A:middle
well-structured tests do.

00:33:35.206 --> 00:33:37.366 A:middle
In fact, in an application

00:33:37.956 --> 00:33:39.716 A:middle
attached to our radar that has a

00:33:39.716 --> 00:33:41.756 A:middle
test suite or even just a bare

00:33:41.756 --> 00:33:43.526 A:middle
sample application with some UI

00:33:44.086 --> 00:33:46.186 A:middle
that explains your constraints

00:33:46.406 --> 00:33:48.436 A:middle
and concerns to us, we can get

00:33:48.436 --> 00:33:50.076 A:middle
back to you much more rapidly

00:33:50.236 --> 00:33:51.886 A:middle
about what's going on and what

00:33:51.886 --> 00:33:52.706 A:middle
you should do about it.

00:33:53.596 --> 00:33:55.106 A:middle
They also help us verify the

00:33:55.106 --> 00:33:56.616 A:middle
correctness of our fixes later.

00:33:57.066 --> 00:33:58.226 A:middle
So, if you're going to file a

00:33:58.226 --> 00:34:00.806 A:middle
bug, please take some time and

00:33:58.226 --> 00:34:00.806 A:middle
bug, please take some time and

00:34:00.806 --> 00:34:02.266 A:middle
write a test for us.

00:34:04.296 --> 00:34:05.476 A:middle
That's all I have today.

00:34:05.956 --> 00:34:08.156 A:middle
Come see us at lab tomorrow.

00:34:08.335 --> 00:34:10.946 A:middle
We are here from 1:30 on in

00:34:10.946 --> 00:34:13.315 A:middle
Technology Lab 7 and I highly

00:34:13.315 --> 00:34:14.286 A:middle
recommend that you check out

00:34:14.286 --> 00:34:15.826 A:middle
Testing Tips and Tricks tomorrow

00:34:15.826 --> 00:34:17.585 A:middle
in Hall 2 at 3:20.

00:34:18.896 --> 00:34:19.906 A:middle
Thanks.

00:34:20.507 --> 00:34:22.507 A:middle
[ Applause ]
