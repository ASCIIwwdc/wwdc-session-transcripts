WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:00:00.506 --> 00:00:09.476 A:middle
[ Silence ]

00:00:09.976 --> 00:00:10.986 A:middle
&gt;&gt; Mark Hahnenberg:
Good morning everyone.

00:00:12.216 --> 00:00:15.026 A:middle
My name is Mark Hahnenberg
and I'm an engineer

00:00:15.026 --> 00:00:16.416 A:middle
on the JavaScriptCore team.

00:00:16.616 --> 00:00:19.266 A:middle
And today, I'm going to be
talking to you about how

00:00:19.326 --> 00:00:20.316 A:middle
to integrate JavaScript

00:00:20.316 --> 00:00:24.536 A:middle
into your Native Apps
on both iOS and Mac.

00:00:25.386 --> 00:00:30.236 A:middle
So, prior to today,
there has been a C API

00:00:30.236 --> 00:00:34.366 A:middle
to the JavaScriptCore
framework available on Mac.

00:00:34.366 --> 00:00:36.886 A:middle
And if you're interested
in that, there is a session

00:00:36.886 --> 00:00:40.496 A:middle
that was done on WWDC a number
of years ago about the C API.

00:00:41.516 --> 00:00:43.786 A:middle
But today, I'm going
to be talking to you

00:00:43.786 --> 00:00:47.786 A:middle
about the new Objective-C
API that we're releasing

00:00:47.786 --> 00:00:50.156 A:middle
to JavaScriptCore, and
it will be available

00:00:50.156 --> 00:00:51.566 A:middle
on both Mac and iOS.

00:00:51.806 --> 00:00:55.156 A:middle
So what were some of our goals
when developing this new API?

00:00:55.156 --> 00:00:58.956 A:middle
Well for one, we want
it to be automatic.

00:00:58.956 --> 00:01:02.836 A:middle
And what this means is that
there are certain things

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:01:02.836 --> 00:01:08.096 A:middle
that you want to do with a
framework like JavaScriptCore

00:01:08.096 --> 00:01:11.766 A:middle
and we tried to make that as
automatic and easy as possible.

00:01:12.796 --> 00:01:17.076 A:middle
The second thing is we
want the API to be safe.

00:01:17.566 --> 00:01:20.956 A:middle
So, we want you to be able
to recover from errors

00:01:20.956 --> 00:01:22.826 A:middle
if you happen to pass
something of the wrong type

00:01:22.826 --> 00:01:26.956 A:middle
across this border because
JavaScript is a dynamic language

00:01:26.956 --> 00:01:28.026 A:middle
as you know.

00:01:29.116 --> 00:01:33.656 A:middle
So you can pass various
objects around and we want it--

00:01:33.656 --> 00:01:35.306 A:middle
we want you to be able to not--

00:01:35.366 --> 00:01:38.066 A:middle
we want you to not crash
your application if you end

00:01:38.066 --> 00:01:39.786 A:middle
up doing something
a little squirrely,

00:01:39.786 --> 00:01:42.856 A:middle
so we want you to--
it to be recoverable.

00:01:43.746 --> 00:01:48.606 A:middle
And the final goal that we had
was this notion of fidelity

00:01:49.026 --> 00:01:52.036 A:middle
and what I mean by that is
whenever you're programming

00:01:52.036 --> 00:01:55.476 A:middle
in Objective-C and you're
interacting with JavaScriptCore,

00:01:56.296 --> 00:01:59.166 A:middle
we want you to feel like you're
programming in Objective-C

00:01:59.166 --> 00:02:01.806 A:middle
when you're writing Objective-C,
and we want you to feel

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:02:01.806 --> 00:02:04.366 A:middle
like you're writing JavaScript
when you're writing JavaScript.

00:02:05.706 --> 00:02:10.316 A:middle
So we don't want there to be,
you know, these crazy names

00:02:10.316 --> 00:02:13.116 A:middle
that lead with underscores
or maybe dollar signs

00:02:13.116 --> 00:02:13.886 A:middle
and they're somewhere.

00:02:14.496 --> 00:02:16.856 A:middle
We want it to look like
JavaScript and look

00:02:16.856 --> 00:02:19.006 A:middle
like Objective-C in
their respective worlds.

00:02:19.006 --> 00:02:23.286 A:middle
So what are-- what exactly
will you learn today?

00:02:24.266 --> 00:02:27.346 A:middle
First, we'll talk about how to
get your Objective-C application

00:02:27.806 --> 00:02:30.146 A:middle
to talk to JavaScript,
so to call--

00:02:30.146 --> 00:02:34.086 A:middle
to evaluate JavaScript scripts,
to call JavaScript functions,

00:02:34.086 --> 00:02:36.596 A:middle
and to create JavaScript values.

00:02:37.066 --> 00:02:40.366 A:middle
Then we're going to talk about
how to get your JavaScript code

00:02:40.366 --> 00:02:43.356 A:middle
to be able to interact with
your Objective-C objects

00:02:43.386 --> 00:02:44.456 A:middle
and call Objective-C methods.

00:02:44.456 --> 00:02:49.006 A:middle
Then we'll talk a little
bit about memory management.

00:02:49.006 --> 00:02:50.246 A:middle
Objective-C uses ARC

00:02:50.816 --> 00:02:52.736 A:middle
and JavaScript is a
garbage collective language.

00:02:52.826 --> 00:02:55.526 A:middle
So, getting these to play
nicely together requires some

00:02:55.526 --> 00:02:56.346 A:middle
extra attention.

00:02:57.916 --> 00:02:59.526 A:middle
Then we'll talk about
threading and how

00:02:59.526 --> 00:03:00.836 A:middle
that interacts with the API.

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:03:01.296 --> 00:03:05.236 A:middle
And then we'll speak to-- a
little bit about interfacing

00:03:05.236 --> 00:03:07.486 A:middle
with the C API that
already exists today.

00:03:08.706 --> 00:03:12.336 A:middle
And finally, we'll talk a little
bit about using JavaScriptCore

00:03:12.336 --> 00:03:17.226 A:middle
and the context of a
WebKit WebView on Mac.

00:03:17.226 --> 00:03:20.376 A:middle
So, to start off, I'd like
to show you just a simple

00:03:20.376 --> 00:03:23.766 A:middle
application, a simple
demo using JavaScriptCore.

00:03:24.236 --> 00:03:27.016 A:middle
So I have a simple
Cocoa app here.

00:03:27.476 --> 00:03:30.336 A:middle
It has NSTextView.

00:03:30.666 --> 00:03:32.656 A:middle
You can see there are
some words in there.

00:03:33.506 --> 00:03:39.076 A:middle
And what you're seeing is
that the words that correspond

00:03:39.076 --> 00:03:41.606 A:middle
to colors are being highlighted
with their corresponding color.

00:03:41.606 --> 00:03:43.546 A:middle
So for example, brown
is highlighted brown,

00:03:43.906 --> 00:03:44.806 A:middle
red is highlighted red.

00:03:44.806 --> 00:03:48.356 A:middle
And the logic that
implements this highlighting

00:03:48.356 --> 00:03:50.596 A:middle
that determines whether a
particular word corresponds

00:03:50.596 --> 00:03:52.226 A:middle
to a color is implemented
in JavaScript.

00:03:52.226 --> 00:03:54.206 A:middle
So I have a couple other things

00:03:54.206 --> 00:03:55.546 A:middle
that are implemented
in JavaScript here.

00:03:55.546 --> 00:03:58.046 A:middle
I have a button that's connected
to a JavaScript function

00:03:58.046 --> 00:03:59.806 A:middle
that shuffles the
colors and reassigns them

00:03:59.896 --> 00:04:03.226 A:middle
to drive yourself
a little crazy.

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:04:03.376 --> 00:04:06.276 A:middle
And if I don't want to wait
around for the random shuffle

00:04:06.336 --> 00:04:09.366 A:middle
to get back to the original
assignment, I can reset back

00:04:09.366 --> 00:04:10.176 A:middle
to the original assignment.

00:04:11.456 --> 00:04:15.106 A:middle
So I can-- as I type, it will
continue to highlight words

00:04:15.166 --> 00:04:19.526 A:middle
so you can type red,
orange, yellow,

00:04:21.036 --> 00:04:22.156 A:middle
but there's a couple bugs.

00:04:22.276 --> 00:04:26.126 A:middle
So for example, we have gray
but we don't have G-R-A-Y,

00:04:26.126 --> 00:04:27.526 A:middle
that doesn't work correctly.

00:04:28.656 --> 00:04:31.986 A:middle
And also typing capital
colors doesn't highlight

00:04:31.986 --> 00:04:32.846 A:middle
as we would expect.

00:04:32.846 --> 00:04:38.016 A:middle
And my favorite color cyan is
also not highlighted correctly.

00:04:38.796 --> 00:04:40.636 A:middle
So we can fix that
pretty easily actually.

00:04:40.636 --> 00:04:44.776 A:middle
I have the script that
implements this color mapping.

00:04:44.776 --> 00:04:49.246 A:middle
And what I'm going to do is
I'm going to edit the script

00:04:49.426 --> 00:04:52.416 A:middle
to give us a new
gray or cyan here.

00:04:52.416 --> 00:04:56.706 A:middle
You can see that this is a map
of normal JavaScript objects

00:04:57.066 --> 00:05:00.286 A:middle
that maps color names to their
corresponding red, green,

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:05:00.286 --> 00:05:02.676 A:middle
and blue value stored inside
the JavaScript objects.

00:05:03.606 --> 00:05:06.106 A:middle
And down here, here's
our callback

00:05:06.106 --> 00:05:10.786 A:middle
for determining what color
a word should be if any.

00:05:11.956 --> 00:05:16.236 A:middle
So, you can see that
if I uncomment this,

00:05:16.236 --> 00:05:22.026 A:middle
then we will take into account
words that have uppercase

00:05:22.086 --> 00:05:23.616 A:middle
in them that are still colors.

00:05:23.616 --> 00:05:27.666 A:middle
So I'm going to save this
file, go back to my application

00:05:27.666 --> 00:05:29.796 A:middle
and I have this Reload button
down in the bottom right

00:05:29.796 --> 00:05:32.156 A:middle
and then we'll reload the script

00:05:33.126 --> 00:05:37.016 A:middle
and now we correctly highlight
the colors, and I didn't have

00:05:37.016 --> 00:05:40.476 A:middle
to recompile which
is kind of neat.

00:05:40.776 --> 00:05:46.076 A:middle
So, that is a simple way to use
JavaScript in an application.

00:05:46.486 --> 00:05:50.376 A:middle
You just saw a simple
use of JavaScript

00:05:52.156 --> 00:05:54.116 A:middle
in an application,
a Cocoa application.

00:05:55.116 --> 00:05:59.566 A:middle
So let's look at how we might
implement something like this.

00:05:59.836 --> 00:06:02.756 A:middle
So, first we're going to talk
about how to get Objective-C

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:06:02.756 --> 00:06:04.036 A:middle
to talk to JavaScript.

00:06:04.356 --> 00:06:08.436 A:middle
So, here is a simple Hello
World program, Hello World.

00:06:08.436 --> 00:06:13.686 A:middle
We implement-- or we
import the framework header,

00:06:14.166 --> 00:06:18.526 A:middle
so JavaScriptCore.h. We create
something called a JSContext,

00:06:18.526 --> 00:06:20.906 A:middle
and we'll talk about
what that is in a second.

00:06:22.386 --> 00:06:27.716 A:middle
We use that context and call
evaluateScript, evaluating 2 + 2

00:06:28.106 --> 00:06:31.216 A:middle
and that will return
a result in a--

00:06:32.076 --> 00:06:37.496 A:middle
with a type of JSValue and
finally, we convert that JSValue

00:06:37.576 --> 00:06:39.556 A:middle
to an integer that we can
print out to the screen.

00:06:40.176 --> 00:06:42.936 A:middle
So let's talk about these
two core data types,

00:06:42.936 --> 00:06:44.806 A:middle
JSContext and JSValue.

00:06:46.276 --> 00:06:47.726 A:middle
First JSContext.

00:06:48.986 --> 00:06:52.366 A:middle
JSContext is a context for
evaluating JavaScript code.

00:06:52.736 --> 00:06:55.106 A:middle
It corresponds to a
single global object,

00:06:55.356 --> 00:06:58.106 A:middle
so in web parlance for you
guys coming from the web world,

00:06:58.496 --> 00:07:02.516 A:middle
it corresponds to
a window object.

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:07:02.756 --> 00:07:04.736 A:middle
There is no thing
called a window

00:07:04.796 --> 00:07:08.436 A:middle
but there is a single global
object for global variables.

00:07:10.366 --> 00:07:12.676 A:middle
And the other type is JSValue.

00:07:12.726 --> 00:07:15.266 A:middle
JSValues live inside
of a JSContext.

00:07:15.326 --> 00:07:16.276 A:middle
They can be things like--

00:07:16.596 --> 00:07:18.836 A:middle
it's just a reference
to a JavaScript value

00:07:18.876 --> 00:07:23.116 A:middle
so they can be objects,
JavaScript arrays,

00:07:23.116 --> 00:07:25.636 A:middle
JavaScript functions,
Booleans, et cetera.

00:07:26.686 --> 00:07:30.036 A:middle
And they have a strong
reference to that value.

00:07:30.036 --> 00:07:33.436 A:middle
So it's kind of a strong handle
to that JavaScript value.

00:07:33.846 --> 00:07:35.226 A:middle
So keep it alive as long

00:07:35.226 --> 00:07:36.946 A:middle
as you're interacting
with that JSValue.

00:07:36.946 --> 00:07:41.356 A:middle
And they're tied to a particular
JSContext, each JSValue is tied

00:07:41.406 --> 00:07:42.726 A:middle
to a particular JSContext.

00:07:43.686 --> 00:07:44.386 A:middle
And why is that?

00:07:44.516 --> 00:07:49.836 A:middle
Well, any JSValue might
want to evaluate code

00:07:50.516 --> 00:07:52.266 A:middle
which we need a JSContext to do.

00:07:52.376 --> 00:07:53.776 A:middle
For example a function,

00:07:53.776 --> 00:07:56.286 A:middle
a JavaScript function
needs a JSContext

00:07:56.286 --> 00:07:57.416 A:middle
in order to evaluate code.

00:07:58.246 --> 00:07:59.626 A:middle
And that is also a
strong reference,

00:07:59.626 --> 00:08:03.126 A:middle
so JSValue keeps alive
all of those things

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:08:03.126 --> 00:08:04.436 A:middle
that it needs to do its job.

00:08:05.086 --> 00:08:09.666 A:middle
So there's a variety of
ways to create JSValues.

00:08:10.186 --> 00:08:14.856 A:middle
This is the-- you can create
things using the corresponding

00:08:14.896 --> 00:08:19.056 A:middle
Objective-C primitives like
Boolean's, doubles, et cetera.

00:08:19.276 --> 00:08:22.306 A:middle
You can create the JavaScript
values null or undefined.

00:08:22.556 --> 00:08:25.576 A:middle
You can create new JavaScript
objects, new JavaScript arrays,

00:08:25.576 --> 00:08:31.516 A:middle
regular expression and errors,
hopefully not too many of those.

00:08:31.706 --> 00:08:34.836 A:middle
And you can also
create new JSValues

00:08:35.096 --> 00:08:37.986 A:middle
and pass an arbitrary
Objective-C object.

00:08:38.456 --> 00:08:41.086 A:middle
So, in this particular method,

00:08:41.086 --> 00:08:43.535 A:middle
this class method deserves
its own slide because a lot

00:08:43.535 --> 00:08:44.696 A:middle
of magic happens here.

00:08:45.476 --> 00:08:50.456 A:middle
So we will automatically
bridge your Objective-C object

00:08:51.306 --> 00:08:53.996 A:middle
to JavaScript so that
JavaScript can interact with it.

00:08:54.796 --> 00:08:56.326 A:middle
And we'll talk more
about exactly how

00:08:56.326 --> 00:08:59.346 A:middle
that works in a second.

00:08:59.346 --> 00:09:01.766 A:middle
Once you have a JSValue, if
you get it back from a call

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:09:01.766 --> 00:09:03.246 A:middle
or something, you
want to be able

00:09:03.246 --> 00:09:06.896 A:middle
to access the data that's inside
of it so we have various things

00:09:07.026 --> 00:09:10.096 A:middle
like converting to a
Boolean, to numbers,

00:09:10.416 --> 00:09:12.266 A:middle
to dates, strings, et cetera.

00:09:13.126 --> 00:09:15.716 A:middle
And when you call one
of these on a JSValue,

00:09:16.266 --> 00:09:19.916 A:middle
JavaScriptCore will do its best
effort to convert it to the type

00:09:19.966 --> 00:09:22.326 A:middle
that you asked for
using the semantics

00:09:22.326 --> 00:09:23.346 A:middle
of the JavaScript language.

00:09:24.836 --> 00:09:28.776 A:middle
You also notice at the
bottom, the two object method.

00:09:29.436 --> 00:09:33.306 A:middle
And this allows you to get-- if
you bridge an Objective-C object

00:09:33.496 --> 00:09:35.406 A:middle
to a JSValue, this
allows you to get

00:09:35.406 --> 00:09:38.006 A:middle
that Objective-C object
back out of the JSValue.

00:09:38.706 --> 00:09:42.286 A:middle
So now that we know
how to create values,

00:09:42.286 --> 00:09:45.596 A:middle
let's talk a little bit about
calling JavaScript functions.

00:09:45.646 --> 00:09:49.316 A:middle
So here's a simple factorial
function written in JavaScript,

00:09:49.636 --> 00:09:54.066 A:middle
and here's what it
looks like to call it.

00:09:54.436 --> 00:09:56.146 A:middle
So first, we load the script

00:09:56.146 --> 00:09:58.856 A:middle
from wherever it
resides on disk perhaps.

00:09:59.936 --> 00:10:03.356 A:middle
We evaluate the script using
the context like we saw earlier.

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:10:04.776 --> 00:10:07.406 A:middle
And since the script defines
a single global function,

00:10:09.056 --> 00:10:14.116 A:middle
we can use this new subscript
notation and pass the name

00:10:14.116 --> 00:10:17.706 A:middle
of the function from the
context to load that JSValue

00:10:17.886 --> 00:10:21.656 A:middle
from the global object,
from the global scope.

00:10:22.176 --> 00:10:24.026 A:middle
Once we have that
function, we can--

00:10:24.026 --> 00:10:27.606 A:middle
we simply use callWithArguments
and pass this--

00:10:27.926 --> 00:10:30.826 A:middle
and pass an NSArray
of arguments.

00:10:30.936 --> 00:10:35.186 A:middle
So this is this new
Objective-C notation

00:10:35.186 --> 00:10:36.886 A:middle
for creating array literals.

00:10:37.696 --> 00:10:40.516 A:middle
And you'll notice that
we passed an NSNumber 5

00:10:41.046 --> 00:10:44.136 A:middle
and this is significant because
JavaScript doesn't know how

00:10:44.136 --> 00:10:45.526 A:middle
to interact with NSNumber.

00:10:45.706 --> 00:10:49.556 A:middle
However, JavaScriptCore will
automatically bridge this

00:10:49.666 --> 00:10:52.616 A:middle
for you so that when
you call that function,

00:10:52.616 --> 00:10:55.996 A:middle
it gets the correct value, it
will get 5 as its argument.

00:10:56.466 --> 00:11:01.266 A:middle
And finally, we get the
result back and we print it.

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:11:01.706 --> 00:11:03.396 A:middle
It should be 120, right?

00:11:03.706 --> 00:11:07.316 A:middle
The factorial function
is correct.

00:11:07.426 --> 00:11:09.886 A:middle
So, now that we know how
to interact with JavaScript

00:11:10.086 --> 00:11:13.736 A:middle
from Objective-C,
let's recap the demo

00:11:13.736 --> 00:11:15.596 A:middle
that I showed you
previously to show

00:11:15.596 --> 00:11:17.236 A:middle
where it uses some
of these things.

00:11:17.666 --> 00:11:21.876 A:middle
Here are the callbacks for
the Shuffle and Reset button.

00:11:22.536 --> 00:11:29.196 A:middle
And what we do is we look
at the plug-in object

00:11:29.196 --> 00:11:32.066 A:middle
that we create inside
of our JavaScript file,

00:11:32.066 --> 00:11:34.316 A:middle
and we use the subscript
notation

00:11:34.316 --> 00:11:35.436 A:middle
that I showed you earlier.

00:11:35.436 --> 00:11:37.256 A:middle
You can use this, not
only on the context,

00:11:37.256 --> 00:11:39.746 A:middle
but any JavaScript
value also works

00:11:39.746 --> 00:11:42.706 A:middle
with this subscript notation
to access fields of the object.

00:11:43.866 --> 00:11:47.626 A:middle
So we load the shuffleFunction
from the plug in,

00:11:48.346 --> 00:11:51.606 A:middle
and then we call the function
with an empty set of arguments.

00:11:51.866 --> 00:11:54.216 A:middle
So, if we look at the
corresponding JavaScript code,

00:11:55.276 --> 00:11:57.536 A:middle
here's the shuffleFunction,
it's a property

00:11:57.536 --> 00:11:59.546 A:middle
on the plug-in object
named Colors

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:12:00.176 --> 00:12:02.846 A:middle
and it does some
shuffling for us.

00:12:04.996 --> 00:12:07.716 A:middle
If you look up here, when
we're loading the plug-in,

00:12:07.716 --> 00:12:13.636 A:middle
we get the path from the bundle,
we load the script from the file

00:12:14.826 --> 00:12:18.876 A:middle
and then we use evaluateScript
to get the result of loading

00:12:18.876 --> 00:12:20.216 A:middle
that plug-in and we store it.

00:12:20.216 --> 00:12:25.766 A:middle
Now that you've seen how we
use interacting with JavaScript

00:12:25.766 --> 00:12:28.666 A:middle
from Objective-C in
that simple application,

00:12:29.146 --> 00:12:31.636 A:middle
let's move on to
getting JavaScript

00:12:31.776 --> 00:12:33.646 A:middle
to talk back to Objective-C.

00:12:33.786 --> 00:12:35.526 A:middle
There are two primary
ways to interact

00:12:35.596 --> 00:12:37.026 A:middle
with Objective-C
from JavaScript.

00:12:37.886 --> 00:12:40.786 A:middle
The first is to use
blocks, Objective-C blocks.

00:12:41.796 --> 00:12:45.346 A:middle
And these will be wrapped
inside of a JS function

00:12:45.346 --> 00:12:47.406 A:middle
that is callable
from JavaScript.

00:12:48.226 --> 00:12:51.946 A:middle
So-- And that's a
really easy way

00:12:52.186 --> 00:12:57.206 A:middle
to expose just a single function
to JavaScript that you want

00:12:57.206 --> 00:12:58.996 A:middle
to be able to callback
into Objective-C.

00:12:59.706 --> 00:13:00.266 A:middle
The other way is

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:13:00.266 --> 00:13:03.026 A:middle
to use something called
the JSExport protocol

00:13:04.706 --> 00:13:11.566 A:middle
and this protocol, by using this
technique, you allow JavaScript

00:13:12.086 --> 00:13:14.116 A:middle
to interact with your
Objective-C objects

00:13:14.186 --> 00:13:16.156 A:middle
as if they were JavaScript
objects.

00:13:16.226 --> 00:13:21.896 A:middle
It's a very powerful technique
for maintaining that fidelity

00:13:21.896 --> 00:13:22.996 A:middle
that I spoke about earlier.

00:13:24.176 --> 00:13:26.806 A:middle
So let's look how
these work exactly.

00:13:27.356 --> 00:13:28.296 A:middle
First is blocks.

00:13:29.926 --> 00:13:33.956 A:middle
So, like I said before,
it's an easy way

00:13:33.956 --> 00:13:38.166 A:middle
to expose Objective-C code
to JavaScript, very easy.

00:13:38.556 --> 00:13:42.226 A:middle
And we automatically wrap
the Objective-C block inside

00:13:42.226 --> 00:13:44.156 A:middle
of a callable JavaScript
function.

00:13:45.236 --> 00:13:46.156 A:middle
So what does that look like?

00:13:46.636 --> 00:13:50.536 A:middle
We can insert a block into the
context using this subscript

00:13:50.536 --> 00:13:52.846 A:middle
notation that I talked
about earlier.

00:13:53.376 --> 00:13:55.396 A:middle
And we passed a block
as the value

00:13:55.396 --> 00:13:57.306 A:middle
that we're bridging
to JavaScript.

00:13:58.116 --> 00:14:02.536 A:middle
And you'll notice that the
block takes an NSDictionary

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:14:02.536 --> 00:14:05.526 A:middle
of RGB values as its argument.

00:14:05.526 --> 00:14:09.766 A:middle
And it returns a new
NSColor using those red,

00:14:09.766 --> 00:14:12.866 A:middle
green and blue values.

00:14:12.866 --> 00:14:15.956 A:middle
So, what this does is when
we pass this block in--

00:14:15.956 --> 00:14:17.976 A:middle
across this JavaScriptCore
barrier,

00:14:18.266 --> 00:14:21.746 A:middle
we create a makeNSColor
function,

00:14:22.436 --> 00:14:25.496 A:middle
JavaScript function
around the block.

00:14:26.276 --> 00:14:32.476 A:middle
Then, in our code,
we call MakeNSColor

00:14:32.836 --> 00:14:35.906 A:middle
and we use these
JavaScript objects

00:14:35.906 --> 00:14:37.666 A:middle
that I showed you
earlier in the color map

00:14:37.666 --> 00:14:39.526 A:middle
and they're just normal
JavaScript objects.

00:14:40.076 --> 00:14:42.826 A:middle
And the cool thing about this
is that, you notice before

00:14:42.826 --> 00:14:48.016 A:middle
that the block accepts an
NSDictionary as its argument.

00:14:48.366 --> 00:14:51.036 A:middle
JavaScriptCore will
automatically bridge JavaScript

00:14:51.036 --> 00:14:55.576 A:middle
objects to NSDictionaries when
calling out to Objective-C code.

00:14:55.906 --> 00:14:58.826 A:middle
We call this MakeNSColor,
and what happens?

00:14:58.916 --> 00:15:02.486 A:middle
Colorforword calls a function
and it forwards that call

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:15:02.486 --> 00:15:03.666 A:middle
to the Objective-C block.

00:15:04.436 --> 00:15:07.906 A:middle
It gets the resulting NSColor
and wraps it in turn inside

00:15:07.906 --> 00:15:12.526 A:middle
of a JavaScript object, and
then this colorforword function

00:15:12.526 --> 00:15:14.356 A:middle
returns that NSColor.

00:15:14.756 --> 00:15:17.966 A:middle
So although blocks are very
easy to use, there are a couple

00:15:17.966 --> 00:15:22.446 A:middle
of caveats you have to be
careful about when using them.

00:15:22.686 --> 00:15:27.856 A:middle
So, the first is you should
avoid capturing JSValues inside

00:15:27.856 --> 00:15:28.556 A:middle
of your blocks.

00:15:28.556 --> 00:15:29.896 A:middle
And the reason for this is

00:15:29.896 --> 00:15:33.396 A:middle
that JSValues maintain a strong
reference to both their context

00:15:33.396 --> 00:15:34.966 A:middle
and their corresponding
JavaScript value.

00:15:35.516 --> 00:15:37.196 A:middle
And so if they're
captured by the block,

00:15:37.456 --> 00:15:39.756 A:middle
you'll leak that memory
because you won't be able

00:15:39.756 --> 00:15:41.846 A:middle
to release that JSValue.

00:15:42.466 --> 00:15:46.636 A:middle
You should-- instead you
should prefer to pass JSValues

00:15:47.016 --> 00:15:49.266 A:middle
as arguments to your blocks.

00:15:50.276 --> 00:15:53.346 A:middle
The second caveat is
along similar lines.

00:15:53.346 --> 00:15:56.956 A:middle
You should avoid capturing
JSContext inside of your blocks.

00:15:57.496 --> 00:16:00.426 A:middle
And it's for the same reason,

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:16:00.426 --> 00:16:04.736 A:middle
the JSContext maintains a strong
reference to the global object

00:16:05.386 --> 00:16:08.646 A:middle
and it will leak all of your
memory when it's captured.

00:16:09.336 --> 00:16:12.656 A:middle
Instead, you should
use the class method

00:16:12.826 --> 00:16:16.026 A:middle
on JSContext called
currentContext inside

00:16:16.026 --> 00:16:19.416 A:middle
of the block, and that will
return to you the context

00:16:19.416 --> 00:16:22.346 A:middle
of the color whoever
invoked that block.

00:16:22.506 --> 00:16:25.416 A:middle
This is an example
of what not to do.

00:16:25.606 --> 00:16:29.896 A:middle
You create a context, you
pass a block, and you use,

00:16:29.896 --> 00:16:33.246 A:middle
you capture that context inside
of the block, this is bad.

00:16:34.296 --> 00:16:36.706 A:middle
The right way to do it
is to create the context,

00:16:36.706 --> 00:16:40.726 A:middle
insert the block and then
use JSContext currentContext

00:16:40.726 --> 00:16:42.346 A:middle
where you were capturing
it before.

00:16:42.346 --> 00:16:46.716 A:middle
So now, we talked about blocks,

00:16:46.716 --> 00:16:49.766 A:middle
let's talk about JSExport
and how that works.

00:16:51.406 --> 00:16:54.816 A:middle
JSExport is, like I said
before, it's a really easy way

00:16:54.816 --> 00:16:57.106 A:middle
for JavaScript to interact
with Objective-C objects.

00:16:58.006 --> 00:17:00.126 A:middle
So, let's take a look at
what it would look like.

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:17:00.446 --> 00:17:03.016 A:middle
So imagine that I have a
MyPoint class represents a two

00:17:03.016 --> 00:17:07.705 A:middle
dimensional point, it has an X
and a Y property, description,

00:17:08.476 --> 00:17:12.185 A:middle
instance method,
and a factory method

00:17:12.185 --> 00:17:15.526 A:middle
to create new MyPoints,
so a class method.

00:17:16.076 --> 00:17:19.776 A:middle
And what would we like this
to look like when interacting

00:17:19.776 --> 00:17:23.096 A:middle
with this-- an object of
this class in JavaScript?

00:17:24.215 --> 00:17:26.156 A:middle
Well, we'd want the
properties to look

00:17:26.156 --> 00:17:27.476 A:middle
like JavaScript properties.

00:17:27.836 --> 00:17:31.096 A:middle
So, you could get their value,
you could set their value.

00:17:31.836 --> 00:17:34.726 A:middle
We want the instance methods
to look like functions

00:17:34.726 --> 00:17:39.746 A:middle
on those objects, so dot
description in this case.

00:17:39.886 --> 00:17:45.276 A:middle
And we want class methods
to look like functions

00:17:45.276 --> 00:17:48.836 A:middle
on these global class objects,
in this case, capital MyPoint.

00:17:49.406 --> 00:17:54.166 A:middle
So, the way to get this to
work with JSExport is simply

00:17:54.166 --> 00:17:56.516 A:middle
to change its interface
into a protocol

00:17:57.306 --> 00:17:59.806 A:middle
that inherits from JSExport.

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:18:01.676 --> 00:18:05.486 A:middle
So now, we have a
MyPoint exports.

00:18:06.466 --> 00:18:09.746 A:middle
And this, by inheriting
from JSExport,

00:18:09.786 --> 00:18:14.346 A:middle
you signal to JavaScriptCore
that this is the list of methods

00:18:14.656 --> 00:18:17.966 A:middle
and properties that I want
JavaScript to be able to access

00:18:18.276 --> 00:18:19.986 A:middle
when I pass an object

00:18:19.986 --> 00:18:23.796 A:middle
that implements this
MyPoint exports protocol.

00:18:24.286 --> 00:18:30.566 A:middle
So, you'll also notice that
when you had your interface

00:18:30.566 --> 00:18:34.196 A:middle
for MyPoint now, you don't have
to re-list all of those methods

00:18:34.236 --> 00:18:37.396 A:middle
because it's a protocol so
that's how protocols work.

00:18:37.946 --> 00:18:39.986 A:middle
And that's nice because
you don't get a lot

00:18:39.986 --> 00:18:42.336 A:middle
of duplication of information.

00:18:43.776 --> 00:18:48.256 A:middle
But you can also, if you
don't list a particular method

00:18:48.256 --> 00:18:51.656 A:middle
in your JSExport protocol,

00:18:52.596 --> 00:18:54.486 A:middle
it will not be exported
to JavaScript.

00:18:54.486 --> 00:18:59.536 A:middle
So if you only want to-- it's
a purely opt-in protocol.

00:18:59.536 --> 00:19:03.456 A:middle
And then your implementation of
MyPoint will look just exactly

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:19:03.456 --> 00:19:04.606 A:middle
like Objective-C code.

00:19:05.316 --> 00:19:07.676 A:middle
This speaks to that
kind of fidelity

00:19:07.676 --> 00:19:08.746 A:middle
that we're talking
about earlier.

00:19:08.746 --> 00:19:11.576 A:middle
You don't have to register
all sorts of functions,

00:19:11.576 --> 00:19:14.366 A:middle
you don't have to do
a lot of extra stuff

00:19:14.596 --> 00:19:17.726 A:middle
like you just write your-- you
write your Objective-C class,

00:19:17.806 --> 00:19:20.266 A:middle
you write your JavaScript
code and you're done.

00:19:20.816 --> 00:19:24.176 A:middle
So like I said before, when
you inherit from JSExport,

00:19:24.176 --> 00:19:26.376 A:middle
you enumerate the methods
and properties that you want

00:19:26.376 --> 00:19:27.506 A:middle
to export to JavaScript.

00:19:28.926 --> 00:19:31.676 A:middle
Properties become
JavaScript getters and setters

00:19:32.026 --> 00:19:36.306 A:middle
on the objects as you're
interacting with them

00:19:36.306 --> 00:19:39.686 A:middle
in JavaScript so it will-- the
getter and setter will call

00:19:39.716 --> 00:19:42.666 A:middle
into Objective-C code.

00:19:42.756 --> 00:19:45.366 A:middle
Instance methods become
JavaScript functions

00:19:45.366 --> 00:19:46.186 A:middle
on these objects.

00:19:46.756 --> 00:19:50.016 A:middle
And class methods become
JavaScript functions

00:19:50.016 --> 00:19:51.716 A:middle
on the global class object,

00:19:51.716 --> 00:19:53.856 A:middle
the capital MyPoint
that we saw earlier.

00:19:55.476 --> 00:19:58.426 A:middle
So let's look at how
we would use this.

00:19:58.976 --> 00:20:00.966 A:middle
So we allocate our
context like before.

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:20:01.576 --> 00:20:07.136 A:middle
We evaluate some geometry script
which I'll show you in a second.

00:20:07.306 --> 00:20:09.916 A:middle
Then we create two of our points
just like we normally would,

00:20:10.016 --> 00:20:15.986 A:middle
alloc init with XY, and we load
the function from the context

00:20:15.986 --> 00:20:17.216 A:middle
like we saw earlier,
in this case,

00:20:17.216 --> 00:20:20.136 A:middle
it's euclideanDistance
between two points.

00:20:20.716 --> 00:20:25.986 A:middle
And then, we call with arguments
and pass the two points

00:20:25.986 --> 00:20:29.686 A:middle
and they're automatically
bridged to JavaScript.

00:20:29.686 --> 00:20:33.876 A:middle
Similarly, if we want to
expose the global class object,

00:20:33.876 --> 00:20:39.606 A:middle
capital MyPoint, we can pass
the class to the context as well

00:20:39.606 --> 00:20:41.336 A:middle
and it will automatically
be bridged

00:20:41.856 --> 00:20:43.966 A:middle
so that JavaScript
can interact with it.

00:20:46.856 --> 00:20:51.096 A:middle
Then we can load, for example,
a function name midpoint

00:20:51.096 --> 00:20:53.846 A:middle
which might want to create a
new point given two other points

00:20:54.616 --> 00:20:57.106 A:middle
and we can call it the same
way that we did before.

00:20:57.226 --> 00:21:00.206 A:middle
We get a result back in
the form of a JSValue

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:21:00.846 --> 00:21:04.446 A:middle
and we used two object to
get the new point back out.

00:21:05.076 --> 00:21:10.436 A:middle
So this is the geometry script
that I referenced earlier.

00:21:10.436 --> 00:21:13.246 A:middle
It has two functions,
euclideanDistance and midpoint.

00:21:13.466 --> 00:21:16.526 A:middle
They accept two arguments
each, point one and point two.

00:21:18.136 --> 00:21:19.876 A:middle
And I'd like to call
your attention

00:21:20.086 --> 00:21:25.286 A:middle
to how this script
uses those properties

00:21:25.316 --> 00:21:26.396 A:middle
that were defined on point.

00:21:27.426 --> 00:21:30.616 A:middle
It looks exactly like a
normal JavaScript property.

00:21:30.746 --> 00:21:32.826 A:middle
It looks like you're
programing a JavaScript here.

00:21:32.886 --> 00:21:34.406 A:middle
It's completely transparent

00:21:34.906 --> 00:21:36.696 A:middle
that these are actually
Objective-C objects

00:21:36.696 --> 00:21:36.976 A:middle
under the hood.

00:21:37.516 --> 00:21:42.196 A:middle
[ Pause ]

00:21:42.696 --> 00:21:46.546 A:middle
So, now that we've talked
about bridging the gap

00:21:46.686 --> 00:21:50.946 A:middle
between JavaScript and
Objective-C and vice versa,

00:21:51.856 --> 00:21:54.566 A:middle
let's talk about some
more advanced API topics.

00:21:55.006 --> 00:21:56.466 A:middle
First of all, memory management.

00:21:57.996 --> 00:22:00.506 A:middle
So as you all are
probably aware,

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:22:01.096 --> 00:22:03.216 A:middle
Objective-C uses ARC, yes.

00:22:03.686 --> 00:22:06.826 A:middle
And JavaScriptCore uses
garbage collection.

00:22:07.036 --> 00:22:09.126 A:middle
So what does this mean?

00:22:09.316 --> 00:22:11.506 A:middle
Well, first of all, it means
that all the references

00:22:11.506 --> 00:22:12.796 A:middle
in JavaScript are strong.

00:22:13.526 --> 00:22:15.526 A:middle
It doesn't matter if you
create reference cycles

00:22:15.526 --> 00:22:17.876 A:middle
because the garbage collector
can handle reference cycles.

00:22:18.446 --> 00:22:25.406 A:middle
So for this particular
JavaScript, the Objective-C API,

00:22:25.646 --> 00:22:27.446 A:middle
the memory management
is mostly automatic,

00:22:27.696 --> 00:22:30.826 A:middle
JSValue keeps things
alive for you as long

00:22:30.826 --> 00:22:32.116 A:middle
as you're using a JSValue

00:22:32.116 --> 00:22:34.706 A:middle
so you don't really have
to worry about that.

00:22:34.976 --> 00:22:36.366 A:middle
However, there are
two situations

00:22:36.366 --> 00:22:38.076 A:middle
that require a little
bit of extra attention:

00:22:39.096 --> 00:22:42.706 A:middle
First is storing JavaScript
values in Objective-C objects

00:22:42.706 --> 00:22:43.936 A:middle
as instance variables.

00:22:44.636 --> 00:22:48.646 A:middle
You can't just store a
JSValue inside of your object,

00:22:48.756 --> 00:22:51.796 A:middle
you will very easily create a
reference cycle and we'll talk

00:22:51.796 --> 00:22:52.946 A:middle
about how to deal
with that in a second.

00:22:54.016 --> 00:22:59.476 A:middle
The second is adding JavaScript
fields to Objective-C objects,

00:22:59.476 --> 00:23:02.736 A:middle
and what I mean by that is if
you have an Objective-C object

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:23:03.396 --> 00:23:07.866 A:middle
that you bridge to JavaScript,
if you add a field to it,

00:23:07.866 --> 00:23:10.326 A:middle
that is not one of the
properties that you listed

00:23:10.326 --> 00:23:12.696 A:middle
in your JSExport
protocol, we will--

00:23:12.696 --> 00:23:16.666 A:middle
we allow that but we'll create
a new extra JavaScript only side

00:23:16.666 --> 00:23:21.426 A:middle
field, so you have to be careful
in that case too and what--

00:23:21.426 --> 00:23:25.356 A:middle
the mechanism to
manage this correctly--

00:23:25.356 --> 00:23:27.216 A:middle
manage these two
situations correctly,

00:23:27.776 --> 00:23:30.296 A:middle
I'll talk about it in a second.

00:23:30.996 --> 00:23:34.466 A:middle
So, here's an example of how you
can create a routine cycle doing

00:23:34.466 --> 00:23:35.206 A:middle
the wrong thing.

00:23:36.276 --> 00:23:39.916 A:middle
So we have a JavaScript
constructor, ClickHandler,

00:23:39.916 --> 00:23:41.566 A:middle
looks like a function
but it's a constructor,

00:23:43.276 --> 00:23:45.816 A:middle
and it accepts a
button and a callback,

00:23:45.816 --> 00:23:48.346 A:middle
so the button is an
Objective-C object

00:23:48.346 --> 00:23:50.506 A:middle
and the callback is the
JavaScript function you want

00:23:50.506 --> 00:23:52.096 A:middle
to call whenever this
button is clicked.

00:23:52.846 --> 00:23:55.996 A:middle
So the ClickHandler makes
a reference to the button

00:23:56.796 --> 00:24:00.036 A:middle
and it also sets the buttons
onClickHandler to itself

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:24:00.036 --> 00:24:03.636 A:middle
and then it stores the
callback for use later,

00:24:04.846 --> 00:24:06.486 A:middle
pretty, pretty pedestrian.

00:24:07.736 --> 00:24:13.456 A:middle
However, you get into a little
bit of trouble if you try

00:24:13.456 --> 00:24:16.266 A:middle
to implement the
setonClickHandler setter

00:24:16.536 --> 00:24:17.106 A:middle
like this.

00:24:17.756 --> 00:24:21.786 A:middle
The onClickHandler, if you just
assign the JSValue directly

00:24:21.786 --> 00:24:24.046 A:middle
into the instance
variable of MyButton,

00:24:24.616 --> 00:24:28.766 A:middle
then you'll create a routine
cycle as you can see here.

00:24:29.526 --> 00:24:33.666 A:middle
So MyButton has a strong
reference to its onClickHandler

00:24:33.846 --> 00:24:36.006 A:middle
through its JSValue to
the ClickHandler object.

00:24:36.006 --> 00:24:38.776 A:middle
And the ClickHandler has
a strong reference back

00:24:39.006 --> 00:24:40.476 A:middle
to the button through
this.button.

00:24:41.916 --> 00:24:43.316 A:middle
And it wouldn't really work

00:24:43.316 --> 00:24:44.736 A:middle
to make this a weak
reference either

00:24:44.736 --> 00:24:47.006 A:middle
because then ClickHandler
would disappear

00:24:47.006 --> 00:24:48.976 A:middle
and we wouldn't get our
callbacks as we expected.

00:24:49.426 --> 00:24:51.016 A:middle
So we need a different
type of edge,

00:24:51.916 --> 00:24:53.266 A:middle
a different type of reference.

00:24:53.796 --> 00:24:58.556 A:middle
And the name of that
reference is JSManagedValue.

00:24:59.476 --> 00:25:03.506 A:middle
So, this is the correct
set onClickHandler.

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:25:04.616 --> 00:25:09.226 A:middle
We take the JSValue
that's passed to us

00:25:09.956 --> 00:25:13.216 A:middle
and we create what's called
a JSManagedValue using

00:25:13.216 --> 00:25:17.206 A:middle
managedValueWithValue passing
the handler there, and we assign

00:25:17.206 --> 00:25:18.896 A:middle
that to our onClickHandler
field.

00:25:19.926 --> 00:25:25.766 A:middle
Then we ask the JavaScript
virtual machine,

00:25:25.766 --> 00:25:27.396 A:middle
which has access
through the context,

00:25:27.726 --> 00:25:31.446 A:middle
to add a managed reference
between ourselves, the button,

00:25:31.886 --> 00:25:34.156 A:middle
and the onClickHandler
that we're now referencing.

00:25:34.946 --> 00:25:38.096 A:middle
Now, what exactly is this
addManagedReferenceDeal?

00:25:38.236 --> 00:25:41.776 A:middle
So you can think of
addManagedReference

00:25:41.776 --> 00:25:43.976 A:middle
as creating a garbage
collected reference,

00:25:44.086 --> 00:25:46.456 A:middle
it's not a strong reference,
it's not a weak reference,

00:25:46.456 --> 00:25:47.536 A:middle
it's a new type of reference,

00:25:47.536 --> 00:25:48.976 A:middle
it's a garbage collected
reference

00:25:49.336 --> 00:25:51.336 A:middle
as represented here
by the dashed line.

00:25:52.556 --> 00:25:54.916 A:middle
So now we have this
garbage collected reference

00:25:55.366 --> 00:25:59.636 A:middle
that tells JavaScript-- it tells
the JavaScript garbage collector

00:25:59.876 --> 00:26:02.916 A:middle
about this edge, it lets it
know that this edge exist

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:26:03.366 --> 00:26:06.116 A:middle
and that it may need to
do some special things

00:26:06.206 --> 00:26:07.786 A:middle
to keep that memory alive.

00:26:08.426 --> 00:26:13.126 A:middle
So we resolved our
reference cycle here.

00:26:13.716 --> 00:26:18.346 A:middle
So, JSManagedValue by
itself is a weak reference

00:26:18.346 --> 00:26:19.466 A:middle
to a JavaScript value.

00:26:19.916 --> 00:26:22.536 A:middle
So this is how you
create weak references.

00:26:22.766 --> 00:26:25.206 A:middle
JSValue is a strong
reference, JSManagedValue

00:26:25.206 --> 00:26:29.456 A:middle
by itself is a weak reference
to a JavaScript value,

00:26:29.696 --> 00:26:32.506 A:middle
addManagedReference:withOwner
which is the--

00:26:32.506 --> 00:26:34.806 A:middle
notifying the virtual
machine of the presence

00:26:34.806 --> 00:26:38.846 A:middle
of this JSManagedValue,
turns the JSManagedValue

00:26:38.846 --> 00:26:40.576 A:middle
into a garbage collected
reference.

00:26:41.106 --> 00:26:45.616 A:middle
And what this means is that, if
JavaScript can find the owner

00:26:45.736 --> 00:26:47.616 A:middle
where you saw the owner
parameter at the end,

00:26:47.616 --> 00:26:49.666 A:middle
with owner, if JavaScript
can find

00:26:49.666 --> 00:26:51.436 A:middle
that during its garbage
collection cycle,

00:26:51.436 --> 00:26:53.866 A:middle
it keeps the reference alive.

00:26:55.136 --> 00:26:57.136 A:middle
Otherwise, the reference
is released.

00:26:57.666 --> 00:27:02.406 A:middle
So now that we talked
about memory management,

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:27:02.986 --> 00:27:05.396 A:middle
let's talk a little
bit about threading.

00:27:05.966 --> 00:27:07.796 A:middle
But first to talk about
threading, we have to talk

00:27:07.796 --> 00:27:09.046 A:middle
about virtual machines.

00:27:09.676 --> 00:27:12.526 A:middle
In this case, JSVirtualMachine
which we used

00:27:12.526 --> 00:27:14.246 A:middle
in the previous slide
when we were

00:27:14.426 --> 00:27:16.006 A:middle
calling addManagedReference.

00:27:16.326 --> 00:27:21.986 A:middle
So, a JSVirtualMachine
is a container

00:27:21.986 --> 00:27:25.276 A:middle
that can contain
multiple JSContexts

00:27:25.766 --> 00:27:27.756 A:middle
and you can have
multiple JSVirtualMachines

00:27:27.756 --> 00:27:31.156 A:middle
in a single process that
have different context

00:27:32.156 --> 00:27:35.566 A:middle
and some JSValues live
inside of these contexts,

00:27:36.636 --> 00:27:41.126 A:middle
and you can pass
JSValues between JSContext

00:27:41.126 --> 00:27:42.576 A:middle
in the same virtual machine.

00:27:43.056 --> 00:27:45.886 A:middle
That's good.

00:27:46.706 --> 00:27:50.316 A:middle
But, you can't pass them
between JSVirtualMachines.

00:27:51.316 --> 00:27:54.286 A:middle
And the reasons for this
are a little bit technical,

00:27:54.326 --> 00:27:57.646 A:middle
but shortly,

00:27:58.286 --> 00:28:00.416 A:middle
each JSVirtualMachine
has its own heap

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:28:00.416 --> 00:28:01.806 A:middle
and its own garbage collector.

00:28:02.456 --> 00:28:05.396 A:middle
So if you pass-- if you
were to pass a JSValue

00:28:05.396 --> 00:28:07.546 A:middle
from one JSVirtualMachine
to another,

00:28:08.296 --> 00:28:11.036 A:middle
that particular garbage
collector doesn't know how

00:28:11.036 --> 00:28:12.796 A:middle
to deal with things
from a different heap.

00:28:13.486 --> 00:28:17.936 A:middle
So that's the reason that
you're not allowed to do that.

00:28:18.866 --> 00:28:21.026 A:middle
So how does JSVirtualMachine
affect threading?

00:28:22.136 --> 00:28:23.706 A:middle
Well, so the API itself,

00:28:23.706 --> 00:28:25.816 A:middle
JavaScriptCore, is
a thread safe API.

00:28:26.206 --> 00:28:33.156 A:middle
You can call into various
JSContext and evaluate code

00:28:33.556 --> 00:28:36.286 A:middle
and create values and that sort
of thing on different threads

00:28:36.736 --> 00:28:39.406 A:middle
and everything will work fine.

00:28:39.596 --> 00:28:42.616 A:middle
However, the locking
granularity is at the level

00:28:42.616 --> 00:28:44.046 A:middle
of a JSVirtualMachine.

00:28:45.346 --> 00:28:50.406 A:middle
So, this means that you
can call into JavaScript

00:28:50.406 --> 00:28:54.746 A:middle
on different threads in the
same virtual machine, however,

00:28:54.746 --> 00:28:58.186 A:middle
whenever one thread is
executing JavaScript,

00:28:58.486 --> 00:29:00.626 A:middle
no other thread can be
executing JavaScript

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:29:00.686 --> 00:29:01.996 A:middle
in that virtual machine.

00:29:02.486 --> 00:29:08.646 A:middle
So, if you want to add
concurrency or parallelism

00:29:08.976 --> 00:29:11.606 A:middle
to your JavaScript program
in your native application,

00:29:12.126 --> 00:29:15.556 A:middle
you should use separate
JSVirtualMachines

00:29:15.556 --> 00:29:17.536 A:middle
which can execute concurrently
on separate threads,

00:29:17.536 --> 00:29:19.296 A:middle
in that way you can
take advantage

00:29:19.296 --> 00:29:20.256 A:middle
of the parallelism there.

00:29:20.826 --> 00:29:22.546 A:middle
We're going to talk
about interfacing

00:29:22.546 --> 00:29:24.686 A:middle
with the JavaScriptCore C API.

00:29:24.896 --> 00:29:31.106 A:middle
The C API has its inherent
warts, but it's very easy

00:29:31.106 --> 00:29:36.146 A:middle
to start to convert over
to the new Objective-C API.

00:29:36.276 --> 00:29:39.016 A:middle
There's a one to one
correspondence between JSValues

00:29:39.016 --> 00:29:44.016 A:middle
and JSValueRefs and JSContext
and JSGlobalContextRefs.

00:29:44.486 --> 00:29:48.216 A:middle
And we make it very easy to get
one where you wanted the other

00:29:48.216 --> 00:29:50.246 A:middle
or get the other
where you have one.

00:29:50.306 --> 00:29:53.666 A:middle
So, for example, if you
have a JSGlobalContextRef,

00:29:54.326 --> 00:29:56.786 A:middle
you can call
contextWithJSGlobalContextRef

00:29:56.786 --> 00:29:58.966 A:middle
and pass that JSGlobalContextRef

00:29:58.966 --> 00:30:00.506 A:middle
and we'll give you
the appropriate--

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:30:00.506 --> 00:30:01.976 A:middle
the corresponding JSContext.

00:30:02.936 --> 00:30:04.506 A:middle
The same goes for the other way.

00:30:05.266 --> 00:30:08.126 A:middle
You can call JSGlobalContextRef
on the context that you have

00:30:08.126 --> 00:30:10.646 A:middle
and we'll give you
the C API equivalent.

00:30:11.066 --> 00:30:12.616 A:middle
Same for JSValue.

00:30:12.616 --> 00:30:15.396 A:middle
Now that we looked at all
of these advanced features

00:30:15.396 --> 00:30:20.056 A:middle
of the API such as memory
management, let's take a look

00:30:20.056 --> 00:30:22.676 A:middle
at sort of the tip
of the iceberg

00:30:22.856 --> 00:30:29.656 A:middle
of what is possible using
the new Objective-C API

00:30:29.656 --> 00:30:30.676 A:middle
in an application.

00:30:31.196 --> 00:30:35.746 A:middle
So I'm going to show you an
application called ColorMyCode.

00:30:35.746 --> 00:30:39.746 A:middle
And to give you an idea of what
this application is before I

00:30:39.746 --> 00:30:44.836 A:middle
start opening things, it's a
simple text editor similar--

00:30:44.836 --> 00:30:46.726 A:middle
along the same lines
as ColorMyWords,

00:30:46.726 --> 00:30:49.886 A:middle
but it's kind of
turned up to 11.

00:30:49.886 --> 00:30:59.266 A:middle
So it's a text editor that
can highlight code as many

00:30:59.266 --> 00:31:01.546 A:middle
of you probably use
something like that.

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:31:03.046 --> 00:31:06.486 A:middle
And it uses JavaScript
to implement sort

00:31:06.486 --> 00:31:11.676 A:middle
of plug-in system, so that it's
very easy to add new languages

00:31:11.756 --> 00:31:13.116 A:middle
that it can syntax highlight.

00:31:14.166 --> 00:31:18.256 A:middle
It also uses JavaScript
to allow the definition

00:31:18.256 --> 00:31:21.766 A:middle
of new color schemes
and uses JavaScript

00:31:22.006 --> 00:31:25.086 A:middle
to load a configuration
file that, you know,

00:31:25.226 --> 00:31:26.866 A:middle
sets all of these
different things up.

00:31:26.866 --> 00:31:27.686 A:middle
All right.

00:31:27.686 --> 00:31:28.976 A:middle
So, I'm going to open
the project here.

00:31:34.316 --> 00:31:37.126 A:middle
Build it. We open a new window.

00:31:38.286 --> 00:31:40.246 A:middle
Now, I'm going to type
some JavaScript code.

00:31:41.516 --> 00:31:46.626 A:middle
[ Pause ]

00:31:47.126 --> 00:31:50.846 A:middle
OK and let's save it.

00:31:53.076 --> 00:32:01.766 A:middle
And now that we have a file
extension, the editor detects

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:32:01.816 --> 00:32:05.776 A:middle
that this is JavaScript so
it highlights it accordingly.

00:32:07.116 --> 00:32:13.946 A:middle
So, we can also--
this particular--

00:32:14.346 --> 00:32:17.316 A:middle
I implemented two languages.

00:32:18.346 --> 00:32:23.646 A:middle
One is JavaScript of course
and the other is Scheme.

00:32:24.246 --> 00:32:29.866 A:middle
OK, I want to do some Scheme.

00:32:29.936 --> 00:32:31.096 A:middle
Let's just save that for now.

00:32:31.456 --> 00:32:34.676 A:middle
Probably you don't want
to watch me code Scheme.

00:32:35.266 --> 00:32:37.666 A:middle
So, I'm going to save
it as a Scheme file.

00:32:38.446 --> 00:32:40.836 A:middle
And now, the editor
is configured

00:32:40.836 --> 00:32:43.436 A:middle
to use a different
color scheme for Scheme.

00:32:43.836 --> 00:32:47.316 A:middle
And you can see that it
highlights different keywords.

00:32:47.886 --> 00:32:50.926 A:middle
So, if I were to type function
in here, it doesn't really work

00:32:50.926 --> 00:32:51.916 A:middle
because that's not a keyword.

00:32:51.916 --> 00:32:55.036 A:middle
It does things like comments
so I can type a comment,

00:32:55.186 --> 00:32:57.246 A:middle
"Hello, this is my comment."

00:32:57.726 --> 00:33:01.376 A:middle
It does strings, so string.

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:33:01.896 --> 00:33:05.096 A:middle
Sure, strong, why not.

00:33:05.166 --> 00:33:09.196 A:middle
[laughter] You can do
numbers, et cetera,

00:33:09.326 --> 00:33:10.406 A:middle
same goes for JavaScript.

00:33:11.046 --> 00:33:14.526 A:middle
We have comments, we
have block comments,

00:33:15.336 --> 00:33:21.016 A:middle
we have strings again,
and numbers as well.

00:33:21.016 --> 00:33:26.916 A:middle
So that is that, and if
you look at the code here,

00:33:28.096 --> 00:33:30.716 A:middle
I'll just show you very
briefly, don't be afraid.

00:33:30.976 --> 00:33:36.046 A:middle
Split up into separate
plug-ins on this for--

00:33:36.046 --> 00:33:37.786 A:middle
different ones for highlighting.

00:33:38.366 --> 00:33:43.326 A:middle
In this particular case, we pass
a token and based on the type,

00:33:43.506 --> 00:33:45.566 A:middle
if it's a keyword,
we do one color;

00:33:45.566 --> 00:33:47.596 A:middle
if it's an identifier
we do another color.

00:33:48.506 --> 00:33:50.436 A:middle
Here's the configuration
file that says,

00:33:50.436 --> 00:33:54.116 A:middle
"For a particular file, type
JavaScript, use this plug-in,

00:33:54.446 --> 00:33:57.036 A:middle
this highlighting, this
color scheme, et cetera."

00:33:57.576 --> 00:34:00.306 A:middle
So that's just a brief example

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:34:00.846 --> 00:34:04.446 A:middle
of what's possible using
the new Objective-C API

00:34:05.486 --> 00:34:07.396 A:middle
to JavaScriptCore.

00:34:07.626 --> 00:34:10.436 A:middle
And I don't want to
scare you away with kind

00:34:10.946 --> 00:34:14.786 A:middle
of the relative complexity
of that demo and it only took

00:34:14.786 --> 00:34:17.116 A:middle
about a weekend to
throw that together

00:34:17.116 --> 00:34:19.255 A:middle
and it's actually not
very much coded at all.

00:34:19.255 --> 00:34:23.146 A:middle
So, it's definitely possible
and it's very, very easy.

00:34:24.206 --> 00:34:27.545 A:middle
So, now that you've
seen that, now we talked

00:34:27.545 --> 00:34:30.936 A:middle
about native applications
outside of web content.

00:34:31.295 --> 00:34:34.076 A:middle
Let's talk a little bit about
how to use JavaScriptCore

00:34:34.326 --> 00:34:37.525 A:middle
in the context of a
WebKit WebView on Mac.

00:34:38.755 --> 00:34:40.716 A:middle
So first of all, why would
you want to use this?

00:34:40.716 --> 00:34:44.396 A:middle
Well, for example, you could
implement your own custom

00:34:44.396 --> 00:34:47.065 A:middle
console for your application
that displays web pages.

00:34:47.716 --> 00:34:50.606 A:middle
And you could log in
a very specific way

00:34:50.606 --> 00:34:53.376 A:middle
like you could log back
to the web server or,

00:34:53.585 --> 00:34:55.196 A:middle
you know, a variety of things.

00:34:55.326 --> 00:34:59.086 A:middle
You can pass your own
objects that you defined,

00:34:59.136 --> 00:35:02.476 A:middle
your own native objects and use
them inside of your web content.

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:35:02.976 --> 00:35:08.476 A:middle
So, the way to do this is to
use the WebFrameLoadDelegate,

00:35:08.986 --> 00:35:15.676 A:middle
and this is a delegate that
you set on the WebKit WebView.

00:35:16.826 --> 00:35:20.476 A:middle
And you want to-- it's
an informal protocol,

00:35:20.906 --> 00:35:23.186 A:middle
so you'll want to
override the -webView:

00:35:23.186 --> 00:35:27.066 A:middle
didCreateJavaScriptContext:
forFrame delegate callback.

00:35:27.066 --> 00:35:31.526 A:middle
And so you can install your
custom objects using the context

00:35:31.526 --> 00:35:33.816 A:middle
argument passed as
the second argument,

00:35:33.816 --> 00:35:37.046 A:middle
so it did create
JavaScript context.

00:35:37.046 --> 00:35:44.506 A:middle
And you can build your whole
native API using that context

00:35:44.506 --> 00:35:46.536 A:middle
like I showed you earlier
with the subscript notation,

00:35:46.536 --> 00:35:48.436 A:middle
you can insert things
into the global object

00:35:48.436 --> 00:35:50.006 A:middle
and all of that good stuff.

00:35:50.006 --> 00:35:53.086 A:middle
You can evaluate new
scripts, et cetera.

00:35:53.086 --> 00:35:56.316 A:middle
And if you viewed some of
the old callbacks before

00:35:57.106 --> 00:35:59.506 A:middle
like the WebScriptObject
interface

00:35:59.506 --> 00:36:01.416 A:middle
in the WebFrameLoadDelegate,

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:36:01.416 --> 00:36:03.456 A:middle
it replaces those old
callbacks gracefully,

00:36:03.846 --> 00:36:06.896 A:middle
meaning that if it's
running on--

00:36:06.896 --> 00:36:08.386 A:middle
if your application
is running on a client

00:36:08.526 --> 00:36:11.626 A:middle
that doesn't have the
new API available to it,

00:36:11.796 --> 00:36:13.296 A:middle
it will fallback gracefully

00:36:13.296 --> 00:36:16.416 A:middle
to use your old implementation
of your callbacks.

00:36:16.986 --> 00:36:21.176 A:middle
And a good example of
this is the iTunes store

00:36:21.376 --> 00:36:25.736 A:middle
on Mac uses a WebView
for its content.

00:36:25.836 --> 00:36:29.666 A:middle
The iTune store uses HTML, CSS,
JavaScript web technologies

00:36:30.446 --> 00:36:36.476 A:middle
but it uses its own custom
native objects to do things

00:36:36.476 --> 00:36:39.066 A:middle
like when you click
the Buy button, it--

00:36:39.066 --> 00:36:42.326 A:middle
the rest of iTunes already
has a lot of code set up to

00:36:42.326 --> 00:36:44.776 A:middle
like process your credit card
and all of that good stuff.

00:36:45.126 --> 00:36:47.456 A:middle
So, they just call
into that code

00:36:47.456 --> 00:36:50.446 A:middle
that they've already written
and they can take advantage

00:36:50.446 --> 00:36:51.946 A:middle
of that directly in
their web content.

00:36:52.486 --> 00:36:57.906 A:middle
So here's a simple example
using the console example

00:36:57.906 --> 00:36:59.426 A:middle
that I described earlier.

00:36:59.956 --> 00:37:03.416 A:middle
So I defined my
MyFrameLoadDelegete

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:37:03.576 --> 00:37:05.306 A:middle
and I override the callback.

00:37:05.526 --> 00:37:07.696 A:middle
You can see the second argument
is the context, that's the one

00:37:07.696 --> 00:37:08.906 A:middle
that I really care about.

00:37:09.436 --> 00:37:13.136 A:middle
And I create a new
console using alloc init.

00:37:13.546 --> 00:37:16.176 A:middle
Imagine it's like a kind of
a normal console that has

00:37:16.176 --> 00:37:17.726 A:middle
like a log that you can call.

00:37:18.206 --> 00:37:19.586 A:middle
And I insert it directly

00:37:19.586 --> 00:37:21.516 A:middle
into the global object
using the context.

00:37:21.986 --> 00:37:27.266 A:middle
And so here's the HTML that
could take advantage of this.

00:37:27.606 --> 00:37:29.996 A:middle
So you'll see I have a
normal HTML web page.

00:37:30.256 --> 00:37:33.206 A:middle
In the body there's a button
and when you click the button,

00:37:33.206 --> 00:37:34.726 A:middle
it calls this handler guy

00:37:34.796 --> 00:37:40.776 A:middle
which will then call the
myConsole.log function instance

00:37:40.776 --> 00:37:44.076 A:middle
method on that Objective-C
object that you inserted.

00:37:44.686 --> 00:37:49.516 A:middle
So in summary, we've covered
getting Objective-C to talk

00:37:49.516 --> 00:37:52.766 A:middle
to JavaScript and in
turn, getting JavaScript

00:37:52.996 --> 00:37:54.816 A:middle
to talk back to Objective-C.

00:37:55.516 --> 00:38:00.126 A:middle
We talked about interfacing
with the JavaScriptCore C API.

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:38:00.226 --> 00:38:02.606 A:middle
We talked about how to
get reference counting

00:38:02.606 --> 00:38:04.766 A:middle
and garbage collection to
play nicely together using

00:38:05.946 --> 00:38:08.986 A:middle
JSManagedValue and
addManagedReference.

00:38:10.096 --> 00:38:13.816 A:middle
We talked about threading and
how to use threads effectively

00:38:13.816 --> 00:38:17.306 A:middle
at the granular area
of JSVirtualMachine.

00:38:18.426 --> 00:38:22.226 A:middle
And we talked about using custom
objects in WebKit WebViews

00:38:23.486 --> 00:38:27.366 A:middle
and using that
WebFrameLoadDelegate callback

00:38:27.366 --> 00:38:30.776 A:middle
to insert your own native
objects into your web context.

00:38:30.976 --> 00:38:35.086 A:middle
So I have a Call to Action.

00:38:35.086 --> 00:38:38.146 A:middle
For all of you who views the
C API, I would challenge you

00:38:38.146 --> 00:38:42.246 A:middle
to convert one bit of your-- one
small segment of your old code

00:38:42.246 --> 00:38:43.526 A:middle
to use the new Objective-C API.

00:38:44.016 --> 00:38:45.626 A:middle
You'll see that it's
much more concise

00:38:46.046 --> 00:38:48.686 A:middle
where something might have
taken five lines before,

00:38:48.686 --> 00:38:50.136 A:middle
it might take only one now.

00:38:51.106 --> 00:38:55.836 A:middle
It's much less verbose
and it eliminates a lot

00:38:55.836 --> 00:38:57.816 A:middle
of the retain release bugs

00:38:57.816 --> 00:39:01.056 A:middle
that you might have experienced
using the old JavaScriptCore

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:39:01.056 --> 00:39:02.496 A:middle
C API.

00:39:03.406 --> 00:39:08.306 A:middle
And if you're new to this
whole JavaScriptCore framework,

00:39:08.786 --> 00:39:10.796 A:middle
I would challenge you
to add a small snippet

00:39:10.796 --> 00:39:12.786 A:middle
of JavaScript somewhere
in your app,

00:39:12.916 --> 00:39:15.186 A:middle
maybe to load a configuration
file

00:39:15.186 --> 00:39:16.626 A:middle
or something on those lines.

00:39:17.136 --> 00:39:18.156 A:middle
And you'll see that it's really,

00:39:18.156 --> 00:39:21.096 A:middle
really easy to do what
you were trying to do

00:39:21.096 --> 00:39:22.186 A:middle
and it's very concise.

00:39:22.546 --> 00:39:23.866 A:middle
But you-- at the same time,

00:39:23.866 --> 00:39:25.476 A:middle
you feel like you're
still programming

00:39:25.476 --> 00:39:27.886 A:middle
in either Objective-C
or JavaScript depending

00:39:27.886 --> 00:39:29.036 A:middle
on what you're currently
writing.

00:39:29.916 --> 00:39:36.436 A:middle
For more information, I--
contact John Geleynse.

00:39:36.776 --> 00:39:39.636 A:middle
He's the technology evangelist.

00:39:40.906 --> 00:39:46.026 A:middle
The documentation is not
current but it's coming.

00:39:46.026 --> 00:39:49.806 A:middle
This is the-- this
documentation on the slide is

00:39:50.366 --> 00:39:54.136 A:middle
for the current JavaScriptCore
C API

00:39:54.386 --> 00:39:56.226 A:middle
but it will be updated
in the future.

00:39:56.226 --> 00:40:00.876 A:middle
And of course you can go
the Apple Developer Forums.

WEBVTT
X-TIMESTAMP-MAP=MPEGTS:181083,LOCAL:00:00:00.000

00:40:01.146 --> 00:40:03.696 A:middle
So related sessions, this
is for the people online.

00:40:03.696 --> 00:40:05.606 A:middle
These are all the kind
of web content related

00:40:05.606 --> 00:40:07.326 A:middle
because JavaScript
is a web technology.

00:40:07.326 --> 00:40:10.756 A:middle
So if you want to know more
about web technologies,

00:40:10.756 --> 00:40:13.206 A:middle
I'd recommend you to
check out these sessions.

00:40:13.206 --> 00:40:14.356 A:middle
Most of them have
already passed.

00:40:14.826 --> 00:40:17.736 A:middle
But, yeah, thank you very much.

00:40:18.516 --> 00:40:26.510 A:middle
[ Applause ]

