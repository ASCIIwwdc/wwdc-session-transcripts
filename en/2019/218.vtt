WEBVTT

00:00:00.506 --> 00:00:05.516 A:middle
[ Music ]

00:00:06.516 --> 00:00:11.566 A:middle
[ Cheering and Applause ]

00:00:12.066 --> 00:00:12.836 A:middle
&gt;&gt; Good afternoon.

00:00:13.916 --> 00:00:15.856 A:middle
My name is Luke Spicer and today

00:00:15.926 --> 00:00:17.706 A:middle
my teammate Divya and I are very

00:00:17.706 --> 00:00:19.326 A:middle
excited to show you how

00:00:19.326 --> 00:00:20.956 A:middle
HealthKit has expanded our data

00:00:20.956 --> 00:00:22.956 A:middle
representations in iOS 13.

00:00:23.446 --> 00:00:26.636 A:middle
As many of you already know,

00:00:26.866 --> 00:00:29.166 A:middle
HealthKit provides a centralized

00:00:29.206 --> 00:00:30.336 A:middle
data store for health and

00:00:30.376 --> 00:00:31.936 A:middle
fitness data while also

00:00:31.936 --> 00:00:33.466 A:middle
providing interoperability for

00:00:33.466 --> 00:00:34.566 A:middle
health and fitness apps and

00:00:34.566 --> 00:00:35.396 A:middle
experiences.

00:00:36.296 --> 00:00:37.576 A:middle
If you're not already excited

00:00:37.646 --> 00:00:39.366 A:middle
about using HealthKit, let me

00:00:39.366 --> 00:00:40.786 A:middle
remind you that there are over

00:00:40.786 --> 00:00:42.936 A:middle
70,000 apps in the health and

00:00:42.936 --> 00:00:44.116 A:middle
fitness category on the App

00:00:44.116 --> 00:00:45.876 A:middle
Store and all of them can

00:00:45.876 --> 00:00:46.926 A:middle
benefit from the

00:00:46.926 --> 00:00:48.336 A:middle
interoperability and

00:00:48.336 --> 00:00:49.666 A:middle
functionality provided by

00:00:49.666 --> 00:00:50.126 A:middle
HealthKit.

00:00:51.526 --> 00:00:52.686 A:middle
Today, we're going to show you a

00:00:52.686 --> 00:00:54.046 A:middle
few things related to data

00:00:54.046 --> 00:00:55.256 A:middle
representations in HealthKit,

00:00:55.776 --> 00:00:57.286 A:middle
starting with a review of the

00:00:57.286 --> 00:00:58.206 A:middle
HealthKit data model.

00:00:58.986 --> 00:01:00.706 A:middle
Then I'll go into some specific

00:00:58.986 --> 00:01:00.706 A:middle
Then I'll go into some specific

00:01:00.706 --> 00:01:02.386 A:middle
APIs focused on quantity data.

00:01:03.656 --> 00:01:04.936 A:middle
Later, Divya will come out to

00:01:04.936 --> 00:01:05.866 A:middle
show you beat-to-beat

00:01:05.866 --> 00:01:07.656 A:middle
measurements, heart rate events,

00:01:08.246 --> 00:01:10.776 A:middle
and the brand new API's focused

00:01:10.776 --> 00:01:13.026 A:middle
on hearing health.

00:01:13.206 --> 00:01:15.226 A:middle
Let's jump right in and start

00:01:15.386 --> 00:01:16.376 A:middle
with the HealthKit data model.

00:01:17.026 --> 00:01:19.206 A:middle
In HealthKit, we represent our

00:01:19.206 --> 00:01:22.056 A:middle
data-- in HealthKit we represent

00:01:22.056 --> 00:01:23.986 A:middle
our data with samples, which are

00:01:23.986 --> 00:01:25.226 A:middle
measurements taken at a

00:01:25.226 --> 00:01:27.536 A:middle
particular time that span some

00:01:27.536 --> 00:01:28.146 A:middle
time interval.

00:01:29.586 --> 00:01:30.916 A:middle
Most of these measurements are

00:01:30.916 --> 00:01:33.336 A:middle
simple measurements, like the

00:01:33.336 --> 00:01:34.906 A:middle
heart rates measured with Apple

00:01:34.956 --> 00:01:38.576 A:middle
Watch or body mass measurements

00:01:38.576 --> 00:01:40.906 A:middle
taken with a connected Bluetooth

00:01:41.996 --> 00:01:42.126 A:middle
scale.

00:01:42.516 --> 00:01:43.926 A:middle
Other measurements are more rich

00:01:43.926 --> 00:01:46.106 A:middle
and complex, like workouts or

00:01:46.106 --> 00:01:47.256 A:middle
the clinical health records that

00:01:47.256 --> 00:01:48.826 A:middle
can be downloaded directly to

00:01:48.866 --> 00:01:49.330 A:middle
iPhone.

00:01:51.656 --> 00:01:54.026 A:middle
All of these rich complex data

00:01:54.396 --> 00:01:55.716 A:middle
representations share a common

00:01:55.716 --> 00:01:57.716 A:middle
structure; a top-level sample

00:01:57.716 --> 00:01:58.576 A:middle
that's backed by some

00:01:58.576 --> 00:02:00.156 A:middle
specialized data representation.

00:01:58.576 --> 00:02:00.156 A:middle
specialized data representation.

00:02:01.076 --> 00:02:04.406 A:middle
For example, a blood pressure

00:02:04.406 --> 00:02:05.776 A:middle
measurement can be represented

00:02:05.776 --> 00:02:07.616 A:middle
with a correlation sample, an

00:02:07.616 --> 00:02:09.346 A:middle
allergy resource by clinical

00:02:09.346 --> 00:02:12.886 A:middle
record, and a workout route by a

00:02:12.886 --> 00:02:13.646 A:middle
series sample.

00:02:14.146 --> 00:02:15.256 A:middle
All of these are examples of

00:02:15.256 --> 00:02:17.206 A:middle
specialized sample types that

00:02:17.206 --> 00:02:18.546 A:middle
all have their own unique

00:02:18.546 --> 00:02:19.666 A:middle
backing data format.

00:02:20.306 --> 00:02:21.906 A:middle
For example, the blood pressure

00:02:21.906 --> 00:02:23.276 A:middle
correlation is a set of blood

00:02:23.276 --> 00:02:24.066 A:middle
pressure measurements.

00:02:24.526 --> 00:02:25.786 A:middle
The allergy resource is backed

00:02:25.886 --> 00:02:28.346 A:middle
by a file resource, and the

00:02:28.346 --> 00:02:30.146 A:middle
workout route is an array of CL

00:02:30.146 --> 00:02:30.816 A:middle
location data.

00:02:31.606 --> 00:02:33.226 A:middle
And just as HealthKit provides

00:02:33.276 --> 00:02:34.166 A:middle
these specialized data

00:02:34.166 --> 00:02:35.396 A:middle
representations for these

00:02:35.396 --> 00:02:36.566 A:middle
special types of measurements,

00:02:37.196 --> 00:02:39.036 A:middle
we've also expanded our data

00:02:39.036 --> 00:02:40.416 A:middle
representations for our most

00:02:40.416 --> 00:02:41.556 A:middle
common type of measurement,

00:02:41.826 --> 00:02:42.806 A:middle
which are for quantity data.

00:02:43.416 --> 00:02:44.736 A:middle
So, let's continue by talking

00:02:44.736 --> 00:02:46.486 A:middle
about quantity data.

00:02:48.076 --> 00:02:50.616 A:middle
To quickly review, quantity data

00:02:50.616 --> 00:02:51.866 A:middle
in HealthKit applies to some

00:02:51.866 --> 00:02:53.666 A:middle
very commonly-measured concepts,

00:02:54.896 --> 00:02:56.706 A:middle
like walking distance, body

00:02:56.706 --> 00:02:58.166 A:middle
mass, and heart rate.

00:02:59.036 --> 00:03:00.546 A:middle
All of these concepts we refer

00:02:59.036 --> 00:03:00.546 A:middle
All of these concepts we refer

00:03:00.546 --> 00:03:02.976 A:middle
to as quantity types and they

00:03:02.976 --> 00:03:03.876 A:middle
have measurements that look

00:03:03.876 --> 00:03:07.056 A:middle
something like this, where each

00:03:07.056 --> 00:03:08.596 A:middle
of these measurements consists

00:03:08.596 --> 00:03:10.346 A:middle
of a quantity that is a value

00:03:10.596 --> 00:03:12.676 A:middle
and a unit as well as a date

00:03:12.676 --> 00:03:13.696 A:middle
interval that tells us the

00:03:13.696 --> 00:03:14.636 A:middle
interval over which the

00:03:14.636 --> 00:03:15.456 A:middle
measurement was taken.

00:03:16.446 --> 00:03:17.376 A:middle
We call each of these

00:03:17.376 --> 00:03:18.726 A:middle
measurements a quantity sample.

00:03:20.046 --> 00:03:21.386 A:middle
Throughout this presentation,

00:03:21.596 --> 00:03:22.536 A:middle
we're going to talk about

00:03:23.216 --> 00:03:24.546 A:middle
quantity types and quantity

00:03:24.546 --> 00:03:26.496 A:middle
samples specifically focused on

00:03:26.496 --> 00:03:27.896 A:middle
how we can efficiently represent

00:03:27.896 --> 00:03:29.706 A:middle
large numbers of quantities, but

00:03:29.706 --> 00:03:30.476 A:middle
if you'd like more of an

00:03:30.476 --> 00:03:31.836 A:middle
introduction to these concepts,

00:03:31.906 --> 00:03:33.056 A:middle
you can always refer back to our

00:03:33.056 --> 00:03:35.496 A:middle
2014 presentation, Introducing

00:03:35.496 --> 00:03:35.866 A:middle
HealthKit.

00:03:37.126 --> 00:03:38.126 A:middle
To forward our discussion of

00:03:38.126 --> 00:03:39.146 A:middle
quantity data, I'd like to

00:03:39.146 --> 00:03:40.016 A:middle
describe a scenario.

00:03:40.956 --> 00:03:42.326 A:middle
If you would, please imagine

00:03:42.436 --> 00:03:44.276 A:middle
that together we're working on a

00:03:44.276 --> 00:03:45.086 A:middle
brand-new app.

00:03:45.906 --> 00:03:47.096 A:middle
This app connects to a

00:03:47.096 --> 00:03:48.416 A:middle
never-before-seen heart rate

00:03:48.416 --> 00:03:49.916 A:middle
sensor that's been built right

00:03:49.916 --> 00:03:51.236 A:middle
into a video game controller.

00:03:51.956 --> 00:03:53.686 A:middle
Our task is to take measurements

00:03:53.686 --> 00:03:55.286 A:middle
from this heart sensor and save

00:03:55.286 --> 00:03:56.366 A:middle
them to HealthKit so that our

00:03:56.366 --> 00:03:57.586 A:middle
users can see what their heart

00:03:57.586 --> 00:03:58.956 A:middle
rate was when they play any

00:03:58.956 --> 00:03:59.726 A:middle
particular game.

00:04:00.276 --> 00:04:02.576 A:middle
The heart rates that we're

00:04:02.576 --> 00:04:03.856 A:middle
receiving from the sensor might

00:04:03.856 --> 00:04:05.276 A:middle
look something like this; a

00:04:05.276 --> 00:04:06.436 A:middle
sequence of measurements that

00:04:06.436 --> 00:04:07.956 A:middle
are coming into our app over

00:04:07.956 --> 00:04:09.206 A:middle
time while the user plays.

00:04:09.696 --> 00:04:10.746 A:middle
And we have to decide how we

00:04:10.746 --> 00:04:12.076 A:middle
want to represent this data so

00:04:12.076 --> 00:04:12.936 A:middle
that we can save it to

00:04:12.936 --> 00:04:13.346 A:middle
HealthKit.

00:04:14.656 --> 00:04:15.816 A:middle
One approach that we could take

00:04:16.005 --> 00:04:17.286 A:middle
would be to use a single

00:04:17.315 --> 00:04:19.156 A:middle
quantity sample and that might

00:04:19.156 --> 00:04:20.336 A:middle
look something like this.

00:04:21.326 --> 00:04:22.516 A:middle
This single quantity sample

00:04:22.516 --> 00:04:23.866 A:middle
spans the entire measurement

00:04:23.866 --> 00:04:25.546 A:middle
interval, that is the entire

00:04:25.646 --> 00:04:27.156 A:middle
duration of the game, and

00:04:27.156 --> 00:04:28.056 A:middle
represents all of the

00:04:28.056 --> 00:04:29.116 A:middle
measurements we received from

00:04:29.116 --> 00:04:30.246 A:middle
our sensor with a single

00:04:30.246 --> 00:04:30.606 A:middle
quantity.

00:04:30.936 --> 00:04:31.776 A:middle
Maybe an average.

00:04:32.856 --> 00:04:34.606 A:middle
This representation gives us an

00:04:34.606 --> 00:04:36.456 A:middle
object to represent the

00:04:36.456 --> 00:04:37.456 A:middle
measurement we took, which was

00:04:37.456 --> 00:04:38.546 A:middle
the heart rate during this game,

00:04:39.206 --> 00:04:40.666 A:middle
but if later we want to see

00:04:40.666 --> 00:04:41.826 A:middle
changes in heart rate over the

00:04:41.826 --> 00:04:42.846 A:middle
game, we won't have the

00:04:42.846 --> 00:04:44.166 A:middle
resolution to do that with this

00:04:44.166 --> 00:04:44.856 A:middle
representation.

00:04:46.436 --> 00:04:47.646 A:middle
Another representation we could

00:04:47.646 --> 00:04:49.506 A:middle
take is to use multiple quantity

00:04:49.506 --> 00:04:50.746 A:middle
samples and that might look

00:04:50.746 --> 00:04:52.816 A:middle
something like this, where every

00:04:52.816 --> 00:04:54.416 A:middle
measurement is represented by a

00:04:54.416 --> 00:04:55.646 A:middle
different quantity sample.

00:04:56.586 --> 00:04:57.996 A:middle
This representation will allow

00:04:57.996 --> 00:04:59.536 A:middle
us to keep the full resolution

00:04:59.536 --> 00:05:01.396 A:middle
measured by our sensor, but it

00:04:59.536 --> 00:05:01.396 A:middle
measured by our sensor, but it

00:05:01.396 --> 00:05:02.836 A:middle
is not an efficient

00:05:02.836 --> 00:05:03.996 A:middle
representation of this data

00:05:04.086 --> 00:05:05.336 A:middle
because we have redundancy.

00:05:05.976 --> 00:05:07.276 A:middle
All of these quantity samples

00:05:07.456 --> 00:05:08.786 A:middle
have identical metadata and

00:05:08.786 --> 00:05:11.536 A:middle
device information and we no

00:05:11.536 --> 00:05:12.606 A:middle
longer have that single

00:05:12.606 --> 00:05:13.596 A:middle
convenient object that

00:05:13.596 --> 00:05:14.716 A:middle
represents the measurement that

00:05:14.716 --> 00:05:15.986 A:middle
we actually took, which was the

00:05:15.986 --> 00:05:17.406 A:middle
heart rate during the game.

00:05:18.476 --> 00:05:20.186 A:middle
Thankfully, we have a third

00:05:20.186 --> 00:05:21.466 A:middle
approach that we can take that

00:05:21.466 --> 00:05:23.146 A:middle
we call quantity series.

00:05:23.926 --> 00:05:24.676 A:middle
The quantity series

00:05:24.676 --> 00:05:26.436 A:middle
representation looks something

00:05:26.436 --> 00:05:27.016 A:middle
like this.

00:05:27.976 --> 00:05:29.736 A:middle
Again, a single quantity sample

00:05:29.736 --> 00:05:30.816 A:middle
that spans our entire

00:05:30.816 --> 00:05:32.606 A:middle
measurement interval, but in

00:05:32.606 --> 00:05:33.936 A:middle
this case, instead of holding a

00:05:34.006 --> 00:05:35.206 A:middle
single quantity, it can be

00:05:35.206 --> 00:05:36.876 A:middle
backed by multiple quantities.

00:05:37.926 --> 00:05:40.026 A:middle
This representation gives us the

00:05:40.026 --> 00:05:41.236 A:middle
best of both of the previous

00:05:41.236 --> 00:05:42.946 A:middle
approaches; a single object to

00:05:42.946 --> 00:05:44.746 A:middle
represent our measurement that

00:05:44.746 --> 00:05:46.076 A:middle
keeps the full resolution

00:05:46.436 --> 00:05:47.606 A:middle
measure-- taken by our sensor.

00:05:48.626 --> 00:05:50.116 A:middle
And notice that we've moved

00:05:50.326 --> 00:05:51.396 A:middle
those redundant pieces of

00:05:51.396 --> 00:05:53.006 A:middle
information that were previously

00:05:53.006 --> 00:05:54.086 A:middle
on the individual quantity

00:05:54.086 --> 00:05:55.276 A:middle
samples, so we only store a

00:05:55.276 --> 00:05:56.896 A:middle
single copy at the quantity

00:05:56.956 --> 00:05:57.836 A:middle
series sample level.

00:05:58.626 --> 00:05:59.886 A:middle
We all want to be respectful of

00:05:59.886 --> 00:06:01.956 A:middle
our users' device storage and

00:05:59.886 --> 00:06:01.956 A:middle
our users' device storage and

00:06:01.956 --> 00:06:03.446 A:middle
device performance and this

00:06:03.446 --> 00:06:04.886 A:middle
representation allows us to do

00:06:05.526 --> 00:06:05.626 A:middle
that.

00:06:06.536 --> 00:06:08.256 A:middle
Because a quantity series sample

00:06:08.286 --> 00:06:10.316 A:middle
is a quantity sample, we need a

00:06:10.316 --> 00:06:13.016 A:middle
way to represent the sequence of

00:06:13.016 --> 00:06:14.636 A:middle
quantities with a single value

00:06:15.116 --> 00:06:16.246 A:middle
and in HealthKit we do that

00:06:16.246 --> 00:06:17.206 A:middle
through a technique called

00:06:17.206 --> 00:06:17.866 A:middle
aggregation.

00:06:19.076 --> 00:06:20.416 A:middle
We have two primary aggregation

00:06:20.416 --> 00:06:22.726 A:middle
styles; cumulative and discrete.

00:06:23.416 --> 00:06:24.826 A:middle
The cumulative aggregation style

00:06:25.026 --> 00:06:26.206 A:middle
applies to some very common

00:06:26.206 --> 00:06:27.886 A:middle
quantity types, like distances,

00:06:28.016 --> 00:06:29.146 A:middle
calories, and steps.

00:06:30.026 --> 00:06:31.326 A:middle
All of these quantity types are

00:06:31.326 --> 00:06:32.916 A:middle
constantly being accumulated by

00:06:32.916 --> 00:06:34.106 A:middle
our users who are taking more

00:06:34.106 --> 00:06:35.676 A:middle
steps and burning more calories

00:06:35.676 --> 00:06:37.966 A:middle
and moving more distance and a

00:06:37.966 --> 00:06:39.836 A:middle
natural way to accumulate-- to

00:06:39.836 --> 00:06:41.206 A:middle
aggregate multiple quantities

00:06:41.206 --> 00:06:42.986 A:middle
for these types is with a sum.

00:06:44.856 --> 00:06:46.546 A:middle
On the other hand, we have some

00:06:46.576 --> 00:06:48.096 A:middle
other common quantity types for

00:06:48.096 --> 00:06:49.456 A:middle
which a sum doesn't make sense.

00:06:50.126 --> 00:06:51.976 A:middle
For example, heart rate, body

00:06:51.976 --> 00:06:54.506 A:middle
mass, and height won't mean

00:06:54.506 --> 00:06:55.796 A:middle
anything when summed together.

00:06:55.876 --> 00:06:57.056 A:middle
If you take multiple heart rates

00:06:57.056 --> 00:06:58.206 A:middle
over a day and add them up,

00:06:58.806 --> 00:07:00.026 A:middle
you'll get a nonsense value.

00:06:58.806 --> 00:07:00.026 A:middle
you'll get a nonsense value.

00:07:00.546 --> 00:07:01.616 A:middle
It's much more natural to

00:07:01.616 --> 00:07:03.856 A:middle
aggregate quantity types like

00:07:03.856 --> 00:07:05.396 A:middle
this with an average and maybe

00:07:05.396 --> 00:07:06.786 A:middle
some other aggregating

00:07:06.786 --> 00:07:08.606 A:middle
statistics, like minimum,

00:07:08.606 --> 00:07:10.116 A:middle
maximum, and most recent value.

00:07:10.686 --> 00:07:14.296 A:middle
Again, we can see that a

00:07:14.296 --> 00:07:16.326 A:middle
sequence of cumulative

00:07:16.326 --> 00:07:18.166 A:middle
quantities can be represented

00:07:18.166 --> 00:07:20.316 A:middle
and aggregated by a sum and a

00:07:20.316 --> 00:07:21.886 A:middle
series of discrete quantities

00:07:21.976 --> 00:07:23.566 A:middle
like heart rates are going to be

00:07:23.566 --> 00:07:25.606 A:middle
aggregated to produce some

00:07:25.606 --> 00:07:27.196 A:middle
rising statistics, like minimum,

00:07:27.536 --> 00:07:28.846 A:middle
maximum, average, and most

00:07:28.846 --> 00:07:29.366 A:middle
recent value.

00:07:29.956 --> 00:07:32.826 A:middle
In HealthKit, we use quantity

00:07:32.826 --> 00:07:34.246 A:middle
aggregation style to tell us the

00:07:34.246 --> 00:07:35.386 A:middle
aggregation style for a

00:07:35.386 --> 00:07:36.456 A:middle
particular quantity type.

00:07:37.156 --> 00:07:39.586 A:middle
And in iOS 13, we've decided to

00:07:39.586 --> 00:07:40.716 A:middle
deprecate the discrete

00:07:40.716 --> 00:07:43.716 A:middle
aggregation style in favor of a

00:07:43.716 --> 00:07:45.216 A:middle
new discrete arithmetic

00:07:45.276 --> 00:07:46.396 A:middle
aggregation style.

00:07:46.786 --> 00:07:48.226 A:middle
We've done this to make clear

00:07:48.226 --> 00:07:49.726 A:middle
that the average calculated for

00:07:49.726 --> 00:07:51.476 A:middle
this aggregation style is the

00:07:51.476 --> 00:07:52.646 A:middle
simple arithmetic mean.

00:07:53.566 --> 00:07:55.356 A:middle
We've also introduced a couple

00:07:55.356 --> 00:07:56.636 A:middle
of new aggregation styles,

00:07:56.856 --> 00:07:57.526 A:middle
starting with

00:07:57.846 --> 00:07:59.636 A:middle
discreteTemporallyWeighted, a

00:07:59.636 --> 00:08:01.186 A:middle
special aggregation style that

00:07:59.636 --> 00:08:01.186 A:middle
special aggregation style that

00:08:01.186 --> 00:08:02.726 A:middle
uses a time-weighted average

00:08:02.906 --> 00:08:04.296 A:middle
that we apply when aggregating

00:08:04.296 --> 00:08:05.146 A:middle
heart rate quantities.

00:08:06.426 --> 00:08:07.266 A:middle
We've also added

00:08:07.356 --> 00:08:08.526 A:middle
discreteEquivalent

00:08:08.526 --> 00:08:10.546 A:middle
ContinuousLevel, a special

00:08:10.546 --> 00:08:11.666 A:middle
aggregation style that gets

00:08:11.666 --> 00:08:13.196 A:middle
applied to audio exposure

00:08:13.196 --> 00:08:13.636 A:middle
quantities.

00:08:14.346 --> 00:08:15.446 A:middle
Divya's going to go into more

00:08:15.446 --> 00:08:16.776 A:middle
detail about audio exposure

00:08:16.776 --> 00:08:17.256 A:middle
later on.

00:08:17.846 --> 00:08:20.976 A:middle
Now that we know how to

00:08:20.976 --> 00:08:23.176 A:middle
aggregate multiple quantities to

00:08:23.176 --> 00:08:24.656 A:middle
produce some rising statistics,

00:08:24.946 --> 00:08:26.226 A:middle
we need somewhere to store this

00:08:26.226 --> 00:08:27.416 A:middle
information on our quantity

00:08:27.416 --> 00:08:27.826 A:middle
sample.

00:08:28.746 --> 00:08:30.346 A:middle
And we've done this in iOS 13 by

00:08:30.346 --> 00:08:31.686 A:middle
introducing two new quantity

00:08:31.686 --> 00:08:33.626 A:middle
sample subclasses, starting with

00:08:33.626 --> 00:08:34.856 A:middle
cumulative quantity sample,

00:08:34.936 --> 00:08:36.706 A:middle
which has a sum property, and

00:08:36.706 --> 00:08:38.456 A:middle
discrete quantity sample, which

00:08:38.456 --> 00:08:41.525 A:middle
has a average, minimum, maximum,

00:08:41.525 --> 00:08:42.515 A:middle
and most recent quantity

00:08:42.515 --> 00:08:42.956 A:middle
properties.

00:08:43.926 --> 00:08:45.936 A:middle
We've also made quantity sample

00:08:46.156 --> 00:08:48.006 A:middle
an abstract base class, which

00:08:48.006 --> 00:08:49.476 A:middle
means that from now on all

00:08:49.476 --> 00:08:50.966 A:middle
instances of quantity sample

00:08:50.966 --> 00:08:52.486 A:middle
that you interact with will be

00:08:52.486 --> 00:08:54.476 A:middle
one of these two quantity sample

00:08:54.476 --> 00:08:56.156 A:middle
subclasses, depending on the

00:08:56.156 --> 00:08:57.396 A:middle
quantity type's aggregation

00:08:57.396 --> 00:08:57.746 A:middle
style.

00:08:58.966 --> 00:09:01.056 A:middle
And also I want to note that all

00:08:58.966 --> 00:09:01.056 A:middle
And also I want to note that all

00:09:01.056 --> 00:09:02.296 A:middle
quantity samples can be thought

00:09:02.296 --> 00:09:04.176 A:middle
of as quantity series, some of

00:09:04.176 --> 00:09:05.686 A:middle
which just happen to have a

00:09:05.686 --> 00:09:07.756 A:middle
count of 1.

00:09:07.956 --> 00:09:09.096 A:middle
We've also introduced

00:09:09.096 --> 00:09:10.786 A:middle
corresponding predicate keypaths

00:09:10.946 --> 00:09:12.016 A:middle
for both of these new sample

00:09:12.016 --> 00:09:15.156 A:middle
types so that you can query for

00:09:15.156 --> 00:09:16.696 A:middle
corresponding properties of both

00:09:16.696 --> 00:09:17.426 A:middle
of these samples.

00:09:18.836 --> 00:09:19.766 A:middle
Going back to our quantity

00:09:19.766 --> 00:09:21.876 A:middle
series sample example, we can

00:09:21.946 --> 00:09:23.716 A:middle
see that quantity series sample

00:09:23.776 --> 00:09:24.766 A:middle
can be summarized with our

00:09:24.766 --> 00:09:26.476 A:middle
aggregating statistics, average,

00:09:26.476 --> 00:09:27.776 A:middle
min, max, and most recent value.

00:09:29.186 --> 00:09:30.236 A:middle
Now I'd like to show you how we

00:09:30.236 --> 00:09:31.756 A:middle
go about building this quantity

00:09:31.756 --> 00:09:32.106 A:middle
series.

00:09:32.746 --> 00:09:35.026 A:middle
We're going to start our

00:09:35.026 --> 00:09:36.406 A:middle
quantity series at the time that

00:09:36.406 --> 00:09:37.346 A:middle
our measurement starts.

00:09:37.806 --> 00:09:38.906 A:middle
In this scenario, it's at the

00:09:38.906 --> 00:09:39.576 A:middle
start of a game.

00:09:40.716 --> 00:09:42.426 A:middle
Then, we'll receive measurements

00:09:42.426 --> 00:09:43.536 A:middle
from our sensor which we can

00:09:43.536 --> 00:09:45.126 A:middle
insert into this quantity series

00:09:45.276 --> 00:09:46.686 A:middle
and we can continue to take

00:09:46.686 --> 00:09:47.836 A:middle
measurements from our sensor and

00:09:47.836 --> 00:09:48.846 A:middle
insert them into the quantity

00:09:48.846 --> 00:09:50.756 A:middle
series as long as the game is

00:09:50.756 --> 00:09:51.256 A:middle
being played.

00:09:52.506 --> 00:09:53.486 A:middle
Finally, when we're done

00:09:53.486 --> 00:09:55.006 A:middle
measuring, we can end the

00:09:55.006 --> 00:09:57.116 A:middle
quantity series and get back the

00:09:57.116 --> 00:09:58.426 A:middle
summarizing quantity series

00:09:58.426 --> 00:09:59.000 A:middle
sample.

00:10:01.546 --> 00:10:02.446 A:middle
Now let's see what this looks

00:10:02.446 --> 00:10:02.986 A:middle
like in code.

00:10:03.576 --> 00:10:07.006 A:middle
Our first step, as with all

00:10:07.006 --> 00:10:08.706 A:middle
HealthKit interaction is to

00:10:08.706 --> 00:10:09.946 A:middle
request authorization for the

00:10:09.946 --> 00:10:11.686 A:middle
data types that we plan to read

00:10:11.686 --> 00:10:12.096 A:middle
and write.

00:10:12.366 --> 00:10:13.416 A:middle
In this case, we're going to

00:10:13.416 --> 00:10:14.836 A:middle
request authorization for heart

00:10:14.836 --> 00:10:15.056 A:middle
rate.

00:10:16.096 --> 00:10:16.736 A:middle
Once we've requested

00:10:16.736 --> 00:10:19.096 A:middle
authorization, we can create our

00:10:19.096 --> 00:10:20.496 A:middle
quantity series sample builder

00:10:20.566 --> 00:10:21.866 A:middle
with our healthStore, the data

00:10:21.866 --> 00:10:23.366 A:middle
type, the start date of

00:10:23.366 --> 00:10:25.296 A:middle
measurement, and an optional HK

00:10:25.856 --> 00:10:26.000 A:middle
device.

00:10:27.376 --> 00:10:29.096 A:middle
Then, as long as we're receiving

00:10:29.096 --> 00:10:30.376 A:middle
measurements from our sensor, we

00:10:30.456 --> 00:10:31.756 A:middle
can insert those into our

00:10:31.756 --> 00:10:33.036 A:middle
quantity series sample builder.

00:10:33.536 --> 00:10:35.156 A:middle
And, finally, at the end of the

00:10:35.156 --> 00:10:36.736 A:middle
game, we can finish our quantity

00:10:36.736 --> 00:10:38.516 A:middle
series sample builder with

00:10:38.516 --> 00:10:39.986 A:middle
optional metadata and the end

00:10:39.986 --> 00:10:40.816 A:middle
date for our measurement.

00:10:41.326 --> 00:10:44.276 A:middle
Now that we've thought about how

00:10:44.276 --> 00:10:45.396 A:middle
we can efficiently represent

00:10:45.396 --> 00:10:46.576 A:middle
quantity data and save it to

00:10:46.576 --> 00:10:47.886 A:middle
HealthKit as a quantity series,

00:10:48.156 --> 00:10:49.086 A:middle
we can think about the

00:10:49.086 --> 00:10:50.776 A:middle
experiences we can bring to our

00:10:50.776 --> 00:10:52.086 A:middle
app with the data once it's

00:10:52.086 --> 00:10:52.806 A:middle
saved to HealthKit.

00:10:53.836 --> 00:10:55.016 A:middle
Maybe we want to give our app

00:10:55.016 --> 00:10:56.846 A:middle
the ability to record calorie

00:10:56.846 --> 00:10:58.026 A:middle
information in addition to heart

00:10:58.026 --> 00:10:59.706 A:middle
rate so that we can show our

00:10:59.706 --> 00:11:01.806 A:middle
users the total calories that

00:10:59.706 --> 00:11:01.806 A:middle
users the total calories that

00:11:01.806 --> 00:11:02.766 A:middle
they burned in some time

00:11:02.766 --> 00:11:04.746 A:middle
interval or just present some

00:11:04.746 --> 00:11:06.276 A:middle
amazing graphs and charts that

00:11:06.276 --> 00:11:07.346 A:middle
highlight and help them

00:11:07.346 --> 00:11:08.156 A:middle
visualize their data.

00:11:08.156 --> 00:11:10.406 A:middle
Or we want to point out averages

00:11:10.406 --> 00:11:11.676 A:middle
that have been recorded over a

00:11:11.676 --> 00:11:12.316 A:middle
time period.

00:11:12.896 --> 00:11:15.736 A:middle
Or help users see the minimum

00:11:15.736 --> 00:11:16.966 A:middle
and maximum value that they hit

00:11:16.966 --> 00:11:17.916 A:middle
during a particular game.

00:11:19.096 --> 00:11:20.786 A:middle
Or we just want to keep our UI

00:11:20.926 --> 00:11:23.036 A:middle
live and up to date as new data

00:11:23.036 --> 00:11:24.716 A:middle
is being recorded as it's

00:11:24.716 --> 00:11:25.606 A:middle
received from our sensor.

00:11:26.216 --> 00:11:29.526 A:middle
We can do all of this and more

00:11:29.586 --> 00:11:30.966 A:middle
with a single HealthKit query.

00:11:33.036 --> 00:11:35.156 A:middle
HKStatisticsCollectionQuery.

00:11:36.586 --> 00:11:37.946 A:middle
Many of you are already familiar

00:11:37.946 --> 00:11:39.276 A:middle
with StatisticsCollectionQuery,

00:11:39.806 --> 00:11:41.576 A:middle
but it's pretty amazing, so I

00:11:41.576 --> 00:11:43.196 A:middle
just wanted to reiterate what

00:11:43.196 --> 00:11:43.836 A:middle
it's capable of.

00:11:44.616 --> 00:11:46.336 A:middle
StatisticsCollectionQuery can

00:11:46.336 --> 00:11:48.096 A:middle
help you calculate multiple

00:11:48.096 --> 00:11:49.986 A:middle
statistics that can be separated

00:11:49.986 --> 00:11:51.776 A:middle
by the source of data and you

00:11:51.776 --> 00:11:53.296 A:middle
can receive updates to those

00:11:53.296 --> 00:11:55.186 A:middle
statistics as new data is saved

00:11:55.186 --> 00:11:55.636 A:middle
to HealthKit.

00:11:56.956 --> 00:11:58.946 A:middle
And if that wasn't enough, we've

00:11:58.946 --> 00:11:59.846 A:middle
also updated

00:11:59.846 --> 00:12:01.236 A:middle
StatisticsCollectionQuery to

00:11:59.846 --> 00:12:01.236 A:middle
StatisticsCollectionQuery to

00:12:01.236 --> 00:12:02.566 A:middle
support all of our new

00:12:02.566 --> 00:12:04.346 A:middle
aggregation styles and to

00:12:04.416 --> 00:12:06.126 A:middle
automatically include all of the

00:12:06.126 --> 00:12:08.896 A:middle
backing quantity data that is

00:12:09.066 --> 00:12:10.486 A:middle
stored in quantity series

00:12:10.486 --> 00:12:10.896 A:middle
samples.

00:12:11.886 --> 00:12:13.796 A:middle
If you want more information on

00:12:13.896 --> 00:12:15.466 A:middle
StatisticsCollectionQuery and

00:12:15.466 --> 00:12:17.136 A:middle
HKStatistics, you can always

00:12:17.136 --> 00:12:18.556 A:middle
refer back to Introducing

00:12:18.556 --> 00:12:18.936 A:middle
HealthKit.

00:12:19.426 --> 00:12:21.066 A:middle
Even though

00:12:21.756 --> 00:12:24.116 A:middle
StatisticsCollectionQuery should

00:12:24.116 --> 00:12:25.996 A:middle
be our go-to tool to efficiently

00:12:25.996 --> 00:12:27.166 A:middle
interact with quantity data

00:12:27.166 --> 00:12:28.326 A:middle
that's been saved to HealthKit,

00:12:29.546 --> 00:12:31.496 A:middle
sometimes we really do want to

00:12:31.496 --> 00:12:33.076 A:middle
enumerate every single quantity

00:12:33.256 --> 00:12:34.356 A:middle
that are stored in quantity

00:12:34.356 --> 00:12:34.726 A:middle
series.

00:12:35.516 --> 00:12:36.846 A:middle
For example, if we want to do

00:12:36.846 --> 00:12:38.906 A:middle
something like plot every single

00:12:38.906 --> 00:12:40.236 A:middle
heart rate that was measured by

00:12:40.236 --> 00:12:41.316 A:middle
our application while a user

00:12:41.316 --> 00:12:41.896 A:middle
played the game.

00:12:43.046 --> 00:12:44.696 A:middle
We can do this with

00:12:45.216 --> 00:12:46.926 A:middle
QuantitySeriesSampleQuery.

00:12:48.056 --> 00:12:49.536 A:middle
In iOS 13, we've enhanced

00:12:49.536 --> 00:12:51.156 A:middle
QuantitySeriesSampleQuery by

00:12:51.156 --> 00:12:52.836 A:middle
replacing the quantity sample

00:12:52.836 --> 00:12:55.026 A:middle
argument with a quantity type in

00:12:55.636 --> 00:12:56.316 A:middle
NSPredicate.

00:12:58.056 --> 00:12:59.356 A:middle
Now, instead of simply

00:12:59.356 --> 00:13:00.876 A:middle
enumerating the quantities for a

00:12:59.356 --> 00:13:00.876 A:middle
enumerating the quantities for a

00:13:00.876 --> 00:13:02.406 A:middle
single quantity sample, you can

00:13:02.406 --> 00:13:03.806 A:middle
enumerate multiple quantity

00:13:03.806 --> 00:13:05.366 A:middle
samples and all of their backing

00:13:05.366 --> 00:13:05.966 A:middle
quantity data.

00:13:07.466 --> 00:13:08.976 A:middle
We've also updated the date

00:13:08.976 --> 00:13:10.246 A:middle
parameter with a date interval,

00:13:10.436 --> 00:13:11.356 A:middle
so you get the full date

00:13:11.356 --> 00:13:12.446 A:middle
interval for every single

00:13:12.446 --> 00:13:13.386 A:middle
quantity while it's being

00:13:13.386 --> 00:13:13.856 A:middle
enumerated.

00:13:14.426 --> 00:13:16.026 A:middle
And we also have an optional

00:13:16.096 --> 00:13:17.746 A:middle
quantity sample parameter which

00:13:17.746 --> 00:13:19.806 A:middle
can give you the quantity series

00:13:19.836 --> 00:13:21.036 A:middle
sample that is currently being

00:13:21.036 --> 00:13:21.506 A:middle
enumerated.

00:13:22.006 --> 00:13:25.536 A:middle
This query is best explained

00:13:25.536 --> 00:13:26.916 A:middle
visually, so I'd like to show

00:13:26.916 --> 00:13:27.456 A:middle
you this.

00:13:28.306 --> 00:13:30.096 A:middle
Here we have two quantity series

00:13:30.126 --> 00:13:30.496 A:middle
samples.

00:13:31.076 --> 00:13:32.636 A:middle
The first quantity series sample

00:13:32.666 --> 00:13:33.846 A:middle
consists of quantities that were

00:13:33.846 --> 00:13:35.346 A:middle
measured with the heart sensor

00:13:35.466 --> 00:13:36.516 A:middle
built into our video game

00:13:36.516 --> 00:13:36.976 A:middle
controller.

00:13:38.206 --> 00:13:39.966 A:middle
And the second series consists

00:13:39.966 --> 00:13:41.196 A:middle
of quantities measured on Apple

00:13:41.196 --> 00:13:41.596 A:middle
Watch.

00:13:42.126 --> 00:13:43.316 A:middle
Because our user happened to be

00:13:43.316 --> 00:13:44.306 A:middle
using both devices

00:13:44.306 --> 00:13:46.436 A:middle
simultaneously, these series

00:13:46.436 --> 00:13:48.946 A:middle
overlap each other in time.

00:13:49.006 --> 00:13:49.746 A:middle
By default, the

00:13:49.746 --> 00:13:51.136 A:middle
QuantitySeriesSampleQuery is

00:13:51.136 --> 00:13:52.346 A:middle
going to enumerate all of the

00:13:52.346 --> 00:13:53.936 A:middle
quantities from both of these

00:13:53.936 --> 00:13:55.026 A:middle
quantity series in the

00:13:55.026 --> 00:13:56.326 A:middle
quantity's start date order.

00:13:56.686 --> 00:13:57.226 A:middle
Like this.

00:13:58.176 --> 00:13:59.616 A:middle
And note that at the end of the

00:13:59.616 --> 00:14:02.036 A:middle
quantity series, the done

00:13:59.616 --> 00:14:02.036 A:middle
quantity series, the done

00:14:02.036 --> 00:14:04.696 A:middle
parameter is set to true.

00:14:04.846 --> 00:14:06.736 A:middle
If you need access to properties

00:14:06.946 --> 00:14:08.306 A:middle
on the quantity series samples

00:14:08.306 --> 00:14:09.656 A:middle
themselves, like device

00:14:09.656 --> 00:14:10.866 A:middle
information, source, revision,

00:14:10.866 --> 00:14:12.826 A:middle
or metadata, you can set include

00:14:12.866 --> 00:14:14.676 A:middle
sample to true on the query

00:14:14.676 --> 00:14:15.556 A:middle
before executing it.

00:14:16.156 --> 00:14:17.296 A:middle
And notice that, in this case,

00:14:17.406 --> 00:14:18.676 A:middle
while enumerating these quantity

00:14:18.676 --> 00:14:20.266 A:middle
series you can get the

00:14:20.266 --> 00:14:21.656 A:middle
corresponding quantity series

00:14:21.696 --> 00:14:22.866 A:middle
sample in the quantities

00:14:22.866 --> 00:14:23.186 A:middle
handler.

00:14:26.966 --> 00:14:28.326 A:middle
Now that we've seen how we can

00:14:28.326 --> 00:14:29.406 A:middle
efficiently interact with

00:14:29.406 --> 00:14:30.696 A:middle
quantity data using quantity

00:14:30.696 --> 00:14:31.966 A:middle
series, I'd like to show you how

00:14:31.966 --> 00:14:33.236 A:middle
easy it is to add support for

00:14:33.236 --> 00:14:34.586 A:middle
this to the game that we've been

00:14:34.586 --> 00:14:35.426 A:middle
talking about in this

00:14:35.426 --> 00:14:35.996 A:middle
presentation.

00:14:36.836 --> 00:14:38.036 A:middle
Follow me over to Xcode and I'll

00:14:38.036 --> 00:14:38.816 A:middle
show you a brief demo.

00:14:44.486 --> 00:14:46.146 A:middle
What I have here is our game in

00:14:46.146 --> 00:14:47.576 A:middle
its current form.

00:14:48.136 --> 00:14:49.776 A:middle
I don't actually have a heart

00:14:49.776 --> 00:14:51.506 A:middle
rate sensor that's been built

00:14:51.506 --> 00:14:52.746 A:middle
into a video game controller,

00:14:52.826 --> 00:14:53.746 A:middle
but if any of you want to make

00:14:53.746 --> 00:14:55.006 A:middle
one, come find me after.

00:14:55.696 --> 00:14:57.656 A:middle
I do have another external heart

00:14:57.656 --> 00:14:59.186 A:middle
sensor that I can use to get

00:14:59.186 --> 00:15:00.966 A:middle
information into this app.

00:14:59.186 --> 00:15:00.966 A:middle
information into this app.

00:15:00.966 --> 00:15:02.486 A:middle
And remember the quantity series

00:15:02.486 --> 00:15:04.106 A:middle
can be applied to any quantity

00:15:04.106 --> 00:15:05.396 A:middle
type, not just heart rate, and

00:15:05.766 --> 00:15:06.816 A:middle
the data can come from an

00:15:06.816 --> 00:15:08.206 A:middle
external sensor, an external

00:15:08.206 --> 00:15:10.796 A:middle
database, a file on disk, or

00:15:11.296 --> 00:15:12.736 A:middle
just be directly entered by your

00:15:13.906 --> 00:15:14.016 A:middle
app.

00:15:14.376 --> 00:15:15.916 A:middle
In this game, we have two tabs.

00:15:16.916 --> 00:15:18.346 A:middle
First, the Play tab brings up

00:15:18.346 --> 00:15:19.536 A:middle
the PlayViewController where we

00:15:19.536 --> 00:15:20.196 A:middle
can play our game.

00:15:20.196 --> 00:15:22.446 A:middle
And the second tab, the Last

00:15:22.446 --> 00:15:23.816 A:middle
Game tab, brings up the

00:15:23.816 --> 00:15:24.886 A:middle
ResultsViewController, which

00:15:24.886 --> 00:15:25.946 A:middle
will show us the heart rates

00:15:25.946 --> 00:15:26.776 A:middle
that were measured during the

00:15:26.776 --> 00:15:28.686 A:middle
most recently played game.

00:15:30.786 --> 00:15:31.946 A:middle
I'm going to go ahead and switch

00:15:31.946 --> 00:15:33.076 A:middle
back to the PlayViewController

00:15:33.076 --> 00:15:34.446 A:middle
to show you what a round of the

00:15:34.446 --> 00:15:35.116 A:middle
game looks like.

00:15:35.716 --> 00:15:38.376 A:middle
In this game, I'm trying to

00:15:38.376 --> 00:15:40.046 A:middle
click these hot dogs and not hit

00:15:40.046 --> 00:15:40.516 A:middle
the broccoli.

00:15:41.136 --> 00:15:42.266 A:middle
Might seem a bit backwards for a

00:15:42.266 --> 00:15:43.796 A:middle
health app, but this is what I

00:15:43.796 --> 00:15:44.000 A:middle
have.

00:15:45.486 --> 00:15:47.226 A:middle
Every hot dog that I get scores

00:15:47.226 --> 00:15:48.626 A:middle
another point and my heart rate

00:15:48.626 --> 00:15:50.116 A:middle
has a tendency to increase while

00:15:50.116 --> 00:15:51.236 A:middle
I play.

00:15:51.426 --> 00:15:52.606 A:middle
If I switch back to the Last

00:15:52.606 --> 00:15:53.776 A:middle
Game tab, I can see we don't yet

00:15:53.776 --> 00:15:54.946 A:middle
have any heart rate data being

00:15:54.946 --> 00:15:55.956 A:middle
measured while I played that

00:15:55.956 --> 00:15:56.466 A:middle
last game.

00:15:56.856 --> 00:15:57.916 A:middle
We'd like to add that support to

00:15:57.916 --> 00:15:58.456 A:middle
our app now.

00:15:59.626 --> 00:16:01.006 A:middle
Our first step is going to

00:15:59.626 --> 00:16:01.006 A:middle
Our first step is going to

00:16:01.006 --> 00:16:02.646 A:middle
have-- be to have our app

00:16:02.646 --> 00:16:04.136 A:middle
request authorization, just like

00:16:04.136 --> 00:16:05.296 A:middle
we saw in the presentation.

00:16:05.916 --> 00:16:07.666 A:middle
And because our app is all about

00:16:08.126 --> 00:16:09.356 A:middle
writing and reading heart rate

00:16:09.356 --> 00:16:11.026 A:middle
data while users play, I want to

00:16:11.026 --> 00:16:12.096 A:middle
do this request for

00:16:12.096 --> 00:16:14.396 A:middle
authorization as soon as my app

00:16:14.436 --> 00:16:15.476 A:middle
finishes launching, so I'm going

00:16:15.476 --> 00:16:17.086 A:middle
to add this in application

00:16:17.086 --> 00:16:18.776 A:middle
didFinishLaunchingWithOptions in

00:16:18.776 --> 00:16:19.500 A:middle
my app delegate.

00:16:22.516 --> 00:16:24.646 A:middle
Here I'm requesting-- I'm

00:16:24.646 --> 00:16:26.146 A:middle
creating a set of quantity types

00:16:26.146 --> 00:16:28.026 A:middle
specifically for heart rate so

00:16:28.026 --> 00:16:29.576 A:middle
that I can request authorization

00:16:29.576 --> 00:16:31.256 A:middle
within HK healthStore for these

00:16:31.256 --> 00:16:31.886 A:middle
sample types.

00:16:32.426 --> 00:16:35.176 A:middle
After we request authorization,

00:16:35.266 --> 00:16:36.426 A:middle
we can get measurements from our

00:16:36.426 --> 00:16:38.466 A:middle
sensor and save that data to a

00:16:38.466 --> 00:16:39.136 A:middle
quantity series.

00:16:40.046 --> 00:16:41.246 A:middle
I've already created a class

00:16:41.246 --> 00:16:42.726 A:middle
that encapsulates the connection

00:16:42.996 --> 00:16:44.316 A:middle
to my external sensor and, if

00:16:44.316 --> 00:16:45.416 A:middle
you want to see how that works,

00:16:45.586 --> 00:16:46.496 A:middle
you can always check out the

00:16:46.496 --> 00:16:47.976 A:middle
sample project associated with

00:16:47.976 --> 00:16:48.436 A:middle
this session.

00:16:49.396 --> 00:16:50.806 A:middle
I'm going to switch over to the

00:16:50.806 --> 00:16:52.396 A:middle
PlayViewController now because

00:16:52.396 --> 00:16:53.826 A:middle
we want to add the connection to

00:16:53.826 --> 00:16:55.406 A:middle
record heart rate while the user

00:16:55.406 --> 00:16:55.956 A:middle
plays a game.

00:16:55.956 --> 00:16:57.446 A:middle
I'm going to open the project

00:16:57.446 --> 00:16:58.956 A:middle
navigator and switch over to our

00:16:58.956 --> 00:16:59.736 A:middle
PlayViewController.

00:17:01.256 --> 00:17:02.216 A:middle
In the PlayViewController, I

00:17:02.216 --> 00:17:03.566 A:middle
have a function, startNewGame,

00:17:03.566 --> 00:17:04.536 A:middle
that's called whenever that

00:17:04.536 --> 00:17:06.096 A:middle
Start Game button is pressed in

00:17:06.096 --> 00:17:06.316 A:middle
our app.

00:17:06.816 --> 00:17:08.146 A:middle
This is a great place for us to

00:17:08.146 --> 00:17:09.076 A:middle
create a connection to our

00:17:09.076 --> 00:17:11.165 A:middle
external heart sensor and start

00:17:11.165 --> 00:17:12.406 A:middle
our quantity series-- our

00:17:12.406 --> 00:17:13.806 A:middle
quantity series sample builder.

00:17:14.606 --> 00:17:15.506 A:middle
First, I'm going to create the

00:17:15.506 --> 00:17:17.000 A:middle
connection to my sensor.

00:17:20.195 --> 00:17:21.915 A:middle
This HeartSensorSession is the

00:17:21.915 --> 00:17:23.036 A:middle
class that I mentioned earlier

00:17:23.036 --> 00:17:24.425 A:middle
that I wrote that encapsulates

00:17:24.425 --> 00:17:25.816 A:middle
the connection to my sensor and

00:17:25.816 --> 00:17:26.336 A:middle
I'm setting the

00:17:26.336 --> 00:17:28.076 A:middle
PlayViewController itself as the

00:17:28.076 --> 00:17:28.736 A:middle
delegate of the

00:17:28.736 --> 00:17:30.000 A:middle
HeartSensorSession.

00:17:31.046 --> 00:17:32.716 A:middle
Now I can start my quantity

00:17:32.716 --> 00:17:34.356 A:middle
series sample builder for heart

00:17:34.806 --> 00:17:35.000 A:middle
rate.

00:17:36.636 --> 00:17:38.106 A:middle
Here I'm creating a quantity

00:17:38.106 --> 00:17:39.296 A:middle
series sample builder with my

00:17:39.296 --> 00:17:40.606 A:middle
healthStore for the heart rate

00:17:40.606 --> 00:17:41.896 A:middle
type where the start date of

00:17:41.896 --> 00:17:43.076 A:middle
measurement is the current date

00:17:43.386 --> 00:17:44.906 A:middle
and I'm getting my HK device

00:17:44.906 --> 00:17:45.706 A:middle
information from the

00:17:45.706 --> 00:17:46.436 A:middle
HeartSensorSession.

00:17:47.726 --> 00:17:48.626 A:middle
The HeartSensorSession

00:17:48.626 --> 00:17:49.446 A:middle
communicates to the

00:17:49.446 --> 00:17:50.486 A:middle
PlayViewController through its

00:17:50.486 --> 00:17:52.216 A:middle
delegate protocol,

00:17:53.216 --> 00:17:54.366 A:middle
HeartSensorSessionDelegate,

00:17:54.606 --> 00:17:56.056 A:middle
which has these two methods;

00:17:56.586 --> 00:17:57.916 A:middle
sessionDidReceiveHeartRate and

00:17:57.916 --> 00:17:58.766 A:middle
sessionDidEnd.

00:18:00.036 --> 00:18:01.026 A:middle
With sessionDidEnd--

00:18:01.126 --> 00:18:02.006 A:middle
DidReceiveHeartRate,

00:18:02.226 --> 00:18:03.826 A:middle
HeartSensorSession provides

00:18:03.826 --> 00:18:05.516 A:middle
heart rate measurements to its

00:18:05.516 --> 00:18:06.796 A:middle
delegate and this is a great

00:18:06.796 --> 00:18:07.576 A:middle
place for us to take these

00:18:07.576 --> 00:18:08.746 A:middle
measurements and insert them

00:18:08.746 --> 00:18:09.976 A:middle
into our quantity series sample

00:18:09.976 --> 00:18:10.330 A:middle
builder.

00:18:16.536 --> 00:18:18.626 A:middle
Here I'm inserting the heart

00:18:18.626 --> 00:18:19.926 A:middle
rates and date intervals that

00:18:19.926 --> 00:18:20.696 A:middle
I've received from the

00:18:20.696 --> 00:18:21.686 A:middle
HeartSensorSession into my

00:18:21.686 --> 00:18:22.916 A:middle
quantity series sample builder.

00:18:24.746 --> 00:18:26.626 A:middle
And, finally, sessionDidEnd is

00:18:26.626 --> 00:18:28.616 A:middle
called by the HeartSensorSession

00:18:28.866 --> 00:18:30.166 A:middle
when a HeartSensorSession ends

00:18:30.166 --> 00:18:30.896 A:middle
at the end of a game.

00:18:31.296 --> 00:18:32.646 A:middle
This is the perfect place for us

00:18:32.646 --> 00:18:33.816 A:middle
to end our quantity series

00:18:33.816 --> 00:18:35.826 A:middle
sample builder to persist the

00:18:35.826 --> 00:18:36.966 A:middle
heart rate quantities that we've

00:18:36.966 --> 00:18:37.796 A:middle
inserted to HealthKit.

00:18:37.796 --> 00:18:40.056 A:middle
And we can also associate the

00:18:40.056 --> 00:18:40.996 A:middle
quantity series that we've

00:18:40.996 --> 00:18:42.366 A:middle
created with metadata.

00:18:42.716 --> 00:18:43.886 A:middle
In this case, I'd like to use

00:18:43.886 --> 00:18:45.326 A:middle
metadata to associate these

00:18:45.326 --> 00:18:46.406 A:middle
heart rates with the game

00:18:46.406 --> 00:18:48.006 A:middle
session that we just played, so

00:18:48.006 --> 00:18:48.756 A:middle
that in the

00:18:48.756 --> 00:18:50.036 A:middle
ResultsViewController we can

00:18:50.036 --> 00:18:51.326 A:middle
query for the heart data

00:18:51.546 --> 00:18:52.806 A:middle
associated with the most recent

00:18:52.806 --> 00:18:53.000 A:middle
game.

00:18:57.546 --> 00:18:58.976 A:middle
Here I'm creating a metadata

00:18:58.976 --> 00:19:00.216 A:middle
dictionary using the

00:18:58.976 --> 00:19:00.216 A:middle
dictionary using the

00:19:00.216 --> 00:19:02.546 A:middle
MetadataKeyExternalUUID, which I

00:19:02.546 --> 00:19:03.936 A:middle
am setting to the heart sensor's

00:19:04.166 --> 00:19:04.896 A:middle
UUID string.

00:19:05.506 --> 00:19:07.016 A:middle
And finally, I am finishing my

00:19:07.016 --> 00:19:08.236 A:middle
quantity series with that

00:19:08.236 --> 00:19:09.486 A:middle
metadata and the end date of

00:19:09.486 --> 00:19:10.756 A:middle
measurement that we receive from

00:19:10.756 --> 00:19:11.576 A:middle
the HeartSensorSession.

00:19:12.186 --> 00:19:15.146 A:middle
Now that we've saved our heart

00:19:15.146 --> 00:19:17.266 A:middle
rate data to HealthKit, we want

00:19:17.266 --> 00:19:19.026 A:middle
to-- we want to display that

00:19:19.026 --> 00:19:20.166 A:middle
data to the users in the

00:19:20.166 --> 00:19:21.016 A:middle
ResultsViewController.

00:19:21.126 --> 00:19:21.936 A:middle
So, let's move over to the

00:19:21.936 --> 00:19:22.976 A:middle
ResultsViewController now.

00:19:28.356 --> 00:19:29.946 A:middle
In the ResultsViewController

00:19:29.946 --> 00:19:31.476 A:middle
viewDidLoad function, I have a

00:19:31.476 --> 00:19:32.256 A:middle
utility function,

00:19:32.786 --> 00:19:34.276 A:middle
loadHeartRateQuanitites, that's

00:19:34.276 --> 00:19:35.416 A:middle
going to query for the heart

00:19:35.416 --> 00:19:36.936 A:middle
rate data associated with the

00:19:36.936 --> 00:19:39.136 A:middle
most recent game session and

00:19:39.136 --> 00:19:40.946 A:middle
generate a string representation

00:19:40.946 --> 00:19:42.086 A:middle
of each of these quantities that

00:19:42.086 --> 00:19:43.326 A:middle
can be displayed in a table

00:19:43.326 --> 00:19:43.536 A:middle
view.

00:19:44.866 --> 00:19:46.916 A:middle
Let's go ahead and start this by

00:19:46.916 --> 00:19:48.636 A:middle
adding a quantity series sample

00:19:48.636 --> 00:19:50.406 A:middle
query for heart rate associated

00:19:50.406 --> 00:19:51.966 A:middle
with our most recent game, if we

00:19:51.966 --> 00:19:53.000 A:middle
have one.

00:19:56.336 --> 00:19:57.536 A:middle
Here I'm guarding against the

00:19:57.536 --> 00:19:59.006 A:middle
case that no game has yet been

00:19:59.006 --> 00:19:59.266 A:middle
played.

00:20:00.286 --> 00:20:01.806 A:middle
If we have a game identifier, we

00:20:01.806 --> 00:20:03.706 A:middle
can go ahead and create a query

00:20:03.706 --> 00:20:04.646 A:middle
predicate for the

00:20:04.646 --> 00:20:07.376 A:middle
MetadataExternalKeyUUID using

00:20:07.376 --> 00:20:08.156 A:middle
that game identifier.

00:20:08.646 --> 00:20:10.136 A:middle
Remember, we use this metadata

00:20:10.136 --> 00:20:11.286 A:middle
so that we would later be able

00:20:11.286 --> 00:20:12.626 A:middle
to query for the heart rate data

00:20:12.626 --> 00:20:13.916 A:middle
associated with our most recent

00:20:13.916 --> 00:20:14.000 A:middle
game.

00:20:16.416 --> 00:20:18.056 A:middle
Then, I can create my quantity

00:20:18.056 --> 00:20:19.236 A:middle
series sample query for the

00:20:19.236 --> 00:20:20.326 A:middle
heart rate type using the

00:20:20.326 --> 00:20:21.476 A:middle
predicate we created above.

00:20:22.886 --> 00:20:24.146 A:middle
Inside of the query's handler,

00:20:24.336 --> 00:20:25.426 A:middle
I'm going to be enumerating the

00:20:25.426 --> 00:20:26.566 A:middle
quantities and date intervals

00:20:26.636 --> 00:20:29.446 A:middle
associated with this-- with this

00:20:29.546 --> 00:20:30.796 A:middle
latest game and I'm going to

00:20:31.146 --> 00:20:32.416 A:middle
create a string representation

00:20:32.416 --> 00:20:32.916 A:middle
for each of them.

00:20:33.326 --> 00:20:34.356 A:middle
Let's go ahead and create an

00:20:34.356 --> 00:20:35.846 A:middle
array of strings we can use to

00:20:36.556 --> 00:20:38.000 A:middle
store these result strings.

00:20:41.066 --> 00:20:43.526 A:middle
And then we can use this in our

00:20:43.916 --> 00:20:44.626 A:middle
query handler.

00:20:45.116 --> 00:20:48.996 A:middle
First, I'm going to guard

00:20:48.996 --> 00:20:50.226 A:middle
against errors that might have

00:20:50.226 --> 00:20:51.306 A:middle
been returned during

00:20:51.306 --> 00:20:51.936 A:middle
enumeration.

00:20:52.406 --> 00:20:53.646 A:middle
And if I don't have any errors,

00:20:53.826 --> 00:20:54.996 A:middle
I can go ahead and create a

00:20:54.996 --> 00:20:56.916 A:middle
heartRateDetailsStrings using

00:20:56.916 --> 00:20:58.236 A:middle
the enumerated quantities and

00:20:58.236 --> 00:20:59.956 A:middle
date intervals and I'll append

00:20:59.956 --> 00:21:01.326 A:middle
these detail strings to my

00:20:59.956 --> 00:21:01.326 A:middle
these detail strings to my

00:21:01.326 --> 00:21:02.346 A:middle
heartRateStrings array.

00:21:03.556 --> 00:21:05.616 A:middle
Finally, when enumeration is

00:21:05.616 --> 00:21:07.026 A:middle
complete, the done parameter

00:21:07.026 --> 00:21:08.596 A:middle
will be set to true and this is

00:21:08.596 --> 00:21:09.956 A:middle
the perfect place for me to

00:21:09.956 --> 00:21:11.366 A:middle
dispatch back to the main queue

00:21:11.626 --> 00:21:12.496 A:middle
to reload our

00:21:12.496 --> 00:21:14.056 A:middle
ResultsViewController to display

00:21:14.226 --> 00:21:14.646 A:middle
these strings.

00:21:16.986 --> 00:21:18.296 A:middle
Now I'd like to re-run the app

00:21:18.416 --> 00:21:19.586 A:middle
to show you what this looks like

00:21:19.586 --> 00:21:21.246 A:middle
now that we've added support for

00:21:21.326 --> 00:21:22.606 A:middle
writing and reading heart rate

00:21:22.606 --> 00:21:22.766 A:middle
data.

00:21:24.066 --> 00:21:25.106 A:middle
Remember, the first thing we're

00:21:25.106 --> 00:21:26.006 A:middle
going to see when our app

00:21:26.006 --> 00:21:27.286 A:middle
launches is that request for

00:21:27.286 --> 00:21:27.966 A:middle
authorization.

00:21:28.536 --> 00:21:31.846 A:middle
I'm going to go ahead and turn

00:21:31.846 --> 00:21:33.636 A:middle
on authorization to read and

00:21:33.636 --> 00:21:34.296 A:middle
write heart rate data.

00:21:35.596 --> 00:21:37.036 A:middle
And now I'll play another round

00:21:37.036 --> 00:21:37.436 A:middle
of our game.

00:21:38.826 --> 00:21:39.856 A:middle
Remember, I'm trying to hit the

00:21:39.856 --> 00:21:41.306 A:middle
hot dogs and miss the broccoli.

00:21:41.886 --> 00:21:42.786 A:middle
Oh, scored zero.

00:21:42.786 --> 00:21:43.776 A:middle
Let me play another round.

00:21:49.486 --> 00:21:50.906 A:middle
Oh, scored two, but we can still

00:21:50.906 --> 00:21:51.936 A:middle
see what my heart rate looked

00:21:51.936 --> 00:21:52.126 A:middle
like.

00:21:52.756 --> 00:21:53.216 A:middle
There we go.

00:21:53.216 --> 00:21:54.506 A:middle
We have some heart rates that

00:21:54.506 --> 00:21:55.636 A:middle
were measured during this most

00:21:55.636 --> 00:21:56.776 A:middle
recent game.

00:21:58.516 --> 00:22:04.676 A:middle
[ Applause ]

00:21:58.516 --> 00:22:04.676 A:middle
[ Applause ]

00:22:05.176 --> 00:22:06.936 A:middle
What we just saw was how easy it

00:22:06.936 --> 00:22:09.606 A:middle
is to efficiently save quantity

00:22:09.606 --> 00:22:10.896 A:middle
data with a quantity series

00:22:10.896 --> 00:22:12.966 A:middle
sample builder and how we can

00:22:12.966 --> 00:22:14.396 A:middle
query for that data using

00:22:14.446 --> 00:22:15.746 A:middle
QuantitySeriesSampleQuery.

00:22:16.536 --> 00:22:18.006 A:middle
Now I'd like to invite up my

00:22:18.006 --> 00:22:19.736 A:middle
teammate Divya, who is going to

00:22:20.016 --> 00:22:21.266 A:middle
show you how HealthKit has

00:22:21.266 --> 00:22:22.906 A:middle
expanded our representations in

00:22:22.906 --> 00:22:24.836 A:middle
the area of heart and how we've

00:22:24.836 --> 00:22:25.956 A:middle
moved into the brand-new health

00:22:26.006 --> 00:22:27.206 A:middle
domain of hearing health.

00:22:27.816 --> 00:22:28.666 A:middle
Thank you.

00:22:29.516 --> 00:22:34.546 A:middle
[ Applause ]

00:22:35.046 --> 00:22:36.616 A:middle
&gt;&gt; So, my colleague Luke just

00:22:36.616 --> 00:22:37.826 A:middle
described to you the new

00:22:37.826 --> 00:22:39.596 A:middle
efficient way to store HK

00:22:39.596 --> 00:22:42.586 A:middle
quantities now in iOS 13 and

00:22:42.586 --> 00:22:43.846 A:middle
HealthKit has become a

00:22:43.846 --> 00:22:46.006 A:middle
repository for more and more of

00:22:46.006 --> 00:22:47.726 A:middle
our users' daily health data.

00:22:47.726 --> 00:22:50.196 A:middle
And in addition to storing more

00:22:50.196 --> 00:22:51.726 A:middle
and more data, we're also

00:22:51.726 --> 00:22:53.206 A:middle
storing more kinds of data.

00:22:54.106 --> 00:22:55.446 A:middle
This year, we're adding on to

00:22:55.446 --> 00:22:57.086 A:middle
our existing support for heart

00:22:57.086 --> 00:22:58.746 A:middle
health and adding new support

00:22:58.746 --> 00:22:59.556 A:middle
for hearing health.

00:22:59.996 --> 00:23:03.566 A:middle
Our users have been interacting

00:22:59.996 --> 00:23:03.566 A:middle
Our users have been interacting

00:23:03.566 --> 00:23:04.896 A:middle
with heart-related features

00:23:04.896 --> 00:23:07.036 A:middle
since iOS 8, where they've been

00:23:07.036 --> 00:23:08.406 A:middle
able to get heart rate from

00:23:08.406 --> 00:23:10.466 A:middle
Apple Watch, or from sensors

00:23:10.466 --> 00:23:12.426 A:middle
connected to apps created by

00:23:12.426 --> 00:23:14.106 A:middle
developers like you, and view

00:23:14.106 --> 00:23:15.566 A:middle
that data all together in the

00:23:15.566 --> 00:23:16.666 A:middle
Health app.

00:23:18.016 --> 00:23:20.126 A:middle
HealthKit has always had heart

00:23:20.126 --> 00:23:22.296 A:middle
rate support, so if you had a

00:23:22.296 --> 00:23:23.596 A:middle
heart rate reading like the one

00:23:23.706 --> 00:23:25.546 A:middle
here, you could determine that

00:23:25.546 --> 00:23:27.356 A:middle
over a five-second period that

00:23:27.736 --> 00:23:29.996 A:middle
the average heart rate was 68

00:23:30.186 --> 00:23:30.766 A:middle
beats per minute.

00:23:30.766 --> 00:23:33.516 A:middle
And in HealthKit, you would save

00:23:33.736 --> 00:23:35.416 A:middle
that as an HK quantity sample.

00:23:35.976 --> 00:23:40.046 A:middle
In iOS 11, we introduced heart

00:23:40.046 --> 00:23:41.606 A:middle
rate variability SDNN.

00:23:42.446 --> 00:23:43.976 A:middle
Heart rate variability is a

00:23:43.976 --> 00:23:45.846 A:middle
measurement of the variation in

00:23:45.846 --> 00:23:47.446 A:middle
the time intervals between

00:23:47.446 --> 00:23:49.636 A:middle
heartbeats and SDNN stands for

00:23:49.636 --> 00:23:51.506 A:middle
standard deviation normal to

00:23:51.506 --> 00:23:51.856 A:middle
normal.

00:23:52.586 --> 00:23:54.196 A:middle
So, Apple Watch would take the

00:23:54.196 --> 00:23:56.616 A:middle
same heart rate reading and take

00:23:56.616 --> 00:23:58.386 A:middle
the time intervals between each

00:23:58.386 --> 00:24:00.286 A:middle
beat to calculate a standard

00:23:58.386 --> 00:24:00.286 A:middle
beat to calculate a standard

00:24:00.286 --> 00:24:02.386 A:middle
deviation and save that as a

00:24:02.386 --> 00:24:03.906 A:middle
quantity sample to HealthKit.

00:24:05.076 --> 00:24:06.516 A:middle
Heart rate and heart rate

00:24:06.516 --> 00:24:08.596 A:middle
variability are both important

00:24:08.596 --> 00:24:10.106 A:middle
metrics for cardiovascular

00:24:10.106 --> 00:24:12.076 A:middle
health and our users have loved

00:24:12.076 --> 00:24:13.616 A:middle
looking at these at a glance

00:24:13.616 --> 00:24:15.126 A:middle
throughout the day or in more

00:24:15.126 --> 00:24:16.356 A:middle
detail, like when they do a

00:24:16.356 --> 00:24:16.876 A:middle
workout.

00:24:18.036 --> 00:24:20.386 A:middle
So, let's take a look at this

00:24:20.386 --> 00:24:21.696 A:middle
same heart rate reading one more

00:24:21.696 --> 00:24:22.106 A:middle
time.

00:24:22.916 --> 00:24:24.666 A:middle
Thus far, I've described to you

00:24:24.666 --> 00:24:26.566 A:middle
ways in which we can summarize

00:24:26.646 --> 00:24:28.346 A:middle
this heart rate data, but

00:24:28.346 --> 00:24:29.866 A:middle
sometimes you want the actual

00:24:29.866 --> 00:24:31.336 A:middle
underlying data itself.

00:24:31.996 --> 00:24:33.616 A:middle
So, let's say that I want the

00:24:33.896 --> 00:24:35.736 A:middle
time-- to know the times at

00:24:35.736 --> 00:24:37.046 A:middle
which each heartbeat occurred.

00:24:37.676 --> 00:24:39.536 A:middle
And returning to our scenario,

00:24:39.866 --> 00:24:40.986 A:middle
let's say that our game

00:24:40.986 --> 00:24:42.906 A:middle
controller has a sensor capable

00:24:42.906 --> 00:24:44.546 A:middle
of telling us any time a new

00:24:44.546 --> 00:24:46.276 A:middle
beat comes in while the user is

00:24:46.276 --> 00:24:46.916 A:middle
playing a game.

00:24:47.356 --> 00:24:49.496 A:middle
So here, the first heartbeat

00:24:49.496 --> 00:24:51.716 A:middle
occurs at 0.5 seconds from the

00:24:51.716 --> 00:24:53.166 A:middle
start point of data collection,

00:24:53.496 --> 00:24:56.116 A:middle
the second at 1.49 seconds, and

00:24:56.346 --> 00:24:57.906 A:middle
we can get-- we can continue to

00:24:57.906 --> 00:24:59.486 A:middle
get the rest of the times that

00:24:59.486 --> 00:25:00.856 A:middle
these beats occurred since the

00:24:59.486 --> 00:25:00.856 A:middle
these beats occurred since the

00:25:00.856 --> 00:25:01.946 A:middle
start of data collection.

00:25:02.846 --> 00:25:04.496 A:middle
So, you'll notice that each beat

00:25:04.606 --> 00:25:05.886 A:middle
happens at a certain point of

00:25:05.886 --> 00:25:08.176 A:middle
time and put together they form

00:25:08.216 --> 00:25:09.786 A:middle
a series of heartbeats.

00:25:10.436 --> 00:25:12.136 A:middle
To save this data to HealthKit,

00:25:12.456 --> 00:25:13.076 A:middle
we have an

00:25:13.076 --> 00:25:15.666 A:middle
HKHeartbeatSeriesSample that

00:25:15.666 --> 00:25:17.466 A:middle
stores a series of heartbeats by

00:25:17.466 --> 00:25:18.936 A:middle
the time stamps at which they

00:25:18.936 --> 00:25:19.316 A:middle
occurred.

00:25:20.506 --> 00:25:22.256 A:middle
Now, you might notice that this

00:25:22.256 --> 00:25:24.166 A:middle
feels similar to the series API

00:25:24.166 --> 00:25:25.466 A:middle
that Luke showed to you before,

00:25:26.246 --> 00:25:27.936 A:middle
but it's important to note that

00:25:28.066 --> 00:25:29.446 A:middle
heartbeat series samples

00:25:29.446 --> 00:25:31.746 A:middle
encapsulate a type of data that

00:25:31.746 --> 00:25:33.316 A:middle
deviates from our other sample

00:25:33.316 --> 00:25:34.296 A:middle
types in HealthKit.

00:25:34.946 --> 00:25:36.996 A:middle
There are no values or units

00:25:36.996 --> 00:25:38.706 A:middle
like the HK quantities that are

00:25:38.706 --> 00:25:40.146 A:middle
the underlying data behind a

00:25:40.146 --> 00:25:42.266 A:middle
quantity series, and therefore

00:25:42.266 --> 00:25:43.836 A:middle
we can more efficiently just

00:25:43.836 --> 00:25:46.166 A:middle
store a series of timestamps to

00:25:46.166 --> 00:25:47.786 A:middle
represent a heartbeat series.

00:25:48.366 --> 00:25:51.736 A:middle
But because we're still storing

00:25:51.736 --> 00:25:53.366 A:middle
a series of data that could get

00:25:53.396 --> 00:25:55.246 A:middle
potentially large, we have in--

00:25:55.526 --> 00:25:57.926 A:middle
we have designed the API to be

00:25:58.076 --> 00:25:59.676 A:middle
familiar to the quantity series,

00:26:00.246 --> 00:26:01.316 A:middle
so we've equipped this

00:26:01.316 --> 00:26:03.086 A:middle
HeartbeatSeriesSample with its

00:26:03.086 --> 00:26:04.816 A:middle
own builder and custom query.

00:26:05.366 --> 00:26:08.446 A:middle
Like quantity series samples,

00:26:08.696 --> 00:26:10.056 A:middle
heartbeat series samples get

00:26:10.056 --> 00:26:11.496 A:middle
created with a builder and

00:26:11.536 --> 00:26:12.716 A:middle
finished when you're done saving

00:26:12.716 --> 00:26:12.956 A:middle
data.

00:26:13.646 --> 00:26:14.906 A:middle
So, let's build one in code.

00:26:16.426 --> 00:26:18.316 A:middle
Our first step, as always, is to

00:26:18.316 --> 00:26:19.406 A:middle
request the proper

00:26:19.406 --> 00:26:20.316 A:middle
authorizations.

00:26:20.946 --> 00:26:22.946 A:middle
For this, you'll need to request

00:26:22.946 --> 00:26:25.066 A:middle
the new heartbeat series type as

00:26:25.066 --> 00:26:26.346 A:middle
well as the quantity type

00:26:26.346 --> 00:26:28.256 A:middle
heartRateVariabilitySDNN

00:26:28.386 --> 00:26:30.106 A:middle
introduced back in iOS 11.

00:26:30.896 --> 00:26:31.736 A:middle
You'll need to request

00:26:31.736 --> 00:26:33.396 A:middle
authorization for both of these

00:26:33.396 --> 00:26:34.556 A:middle
types since heart rate

00:26:34.556 --> 00:26:36.436 A:middle
variability is a metric that can

00:26:36.436 --> 00:26:37.846 A:middle
be directly derived from

00:26:37.846 --> 00:26:39.716 A:middle
heartbeat series and this way

00:26:39.716 --> 00:26:40.846 A:middle
your users have a clear

00:26:40.846 --> 00:26:42.256 A:middle
understanding of exactly the

00:26:42.256 --> 00:26:43.686 A:middle
kind of data they're sharing

00:26:43.686 --> 00:26:45.266 A:middle
with you.

00:26:45.486 --> 00:26:46.416 A:middle
Once we've requested

00:26:46.416 --> 00:26:48.526 A:middle
authorization, we can initialize

00:26:48.526 --> 00:26:50.036 A:middle
a heartbeat series builder with

00:26:50.036 --> 00:26:52.016 A:middle
a healthStore, gameDevice, and

00:26:52.016 --> 00:26:53.196 A:middle
the gameStartDate that will

00:26:53.196 --> 00:26:54.586 A:middle
indicate when we're starting

00:26:54.586 --> 00:26:55.366 A:middle
data collection.

00:26:55.856 --> 00:26:58.476 A:middle
And while the game is ongoing

00:26:58.596 --> 00:26:59.606 A:middle
and our user is playing the

00:26:59.606 --> 00:27:01.466 A:middle
game, we'll add heartbeats with

00:26:59.606 --> 00:27:01.466 A:middle
game, we'll add heartbeats with

00:27:01.466 --> 00:27:02.906 A:middle
the time interval since the

00:27:02.906 --> 00:27:04.236 A:middle
series start date to our

00:27:04.236 --> 00:27:04.596 A:middle
builder.

00:27:04.976 --> 00:27:08.266 A:middle
But you might enter a case like

00:27:08.326 --> 00:27:10.486 A:middle
this where your sensor goes down

00:27:10.686 --> 00:27:12.096 A:middle
and here we have a gap in data

00:27:12.096 --> 00:27:13.936 A:middle
collection between seconds two

00:27:13.966 --> 00:27:14.466 A:middle
and three.

00:27:15.366 --> 00:27:16.806 A:middle
Now, it might look like there is

00:27:16.806 --> 00:27:19.286 A:middle
a 1.99 second gap between beats

00:27:19.286 --> 00:27:20.876 A:middle
two and three that could lead to

00:27:20.876 --> 00:27:23.516 A:middle
erroneous interpretation of this

00:27:23.516 --> 00:27:24.416 A:middle
user's heart data.

00:27:25.486 --> 00:27:26.846 A:middle
In order to account for this,

00:27:27.056 --> 00:27:28.856 A:middle
we'll set precededByGap to YES,

00:27:29.366 --> 00:27:30.936 A:middle
which you can set for each beat

00:27:30.936 --> 00:27:32.566 A:middle
that you add if you're aware

00:27:32.566 --> 00:27:33.636 A:middle
that there was a gap in data

00:27:33.636 --> 00:27:35.076 A:middle
collection from a sensor going

00:27:35.076 --> 00:27:35.326 A:middle
down.

00:27:35.326 --> 00:27:39.276 A:middle
Now I can add metadata to my

00:27:39.276 --> 00:27:40.736 A:middle
builder like I would to any

00:27:40.736 --> 00:27:41.996 A:middle
other HK sample.

00:27:42.946 --> 00:27:44.816 A:middle
And when I'm done saving data,

00:27:44.906 --> 00:27:46.396 A:middle
I'll finish the series, which

00:27:46.396 --> 00:27:47.696 A:middle
will save the Heartbeat series

00:27:47.696 --> 00:27:51.366 A:middle
sample to HealthKit.

00:27:51.366 --> 00:27:52.936 A:middle
Now we've added support for

00:27:52.936 --> 00:27:54.276 A:middle
beat-to-beat measurements to our

00:27:54.276 --> 00:27:55.806 A:middle
game and we're ready to start

00:27:55.806 --> 00:27:57.556 A:middle
querying for the underlying beat

00:27:57.686 --> 00:27:58.446 A:middle
measurements.

00:27:58.986 --> 00:28:02.056 A:middle
Like what Luke described to you

00:27:58.986 --> 00:28:02.056 A:middle
Like what Luke described to you

00:28:02.056 --> 00:28:03.906 A:middle
before, we can interact with our

00:28:03.906 --> 00:28:06.666 A:middle
normal HK queries to fetch the

00:28:06.866 --> 00:28:09.126 A:middle
high-level samples and then use

00:28:09.126 --> 00:28:11.176 A:middle
the custom queries to interact

00:28:11.176 --> 00:28:12.156 A:middle
with the finer-grain data.

00:28:13.536 --> 00:28:15.306 A:middle
So, my first step will be to run

00:28:15.376 --> 00:28:17.326 A:middle
a normal HK sample query to

00:28:17.326 --> 00:28:18.926 A:middle
fetch my heartbeat series sample

00:28:18.926 --> 00:28:19.686 A:middle
of interest.

00:28:20.116 --> 00:28:22.036 A:middle
And once I've done that, I'll

00:28:22.036 --> 00:28:23.336 A:middle
initialize a heartbeat series

00:28:23.336 --> 00:28:25.126 A:middle
query with that sample, which

00:28:25.126 --> 00:28:26.576 A:middle
will let me enumerate over the

00:28:26.576 --> 00:28:27.946 A:middle
times for each beat.

00:28:28.436 --> 00:28:30.866 A:middle
And finally, I'll execute my

00:28:30.866 --> 00:28:31.726 A:middle
query.

00:28:32.286 --> 00:28:35.136 A:middle
Now, heartbeat series are a

00:28:35.136 --> 00:28:36.856 A:middle
powerful addition to HealthKit,

00:28:36.976 --> 00:28:38.296 A:middle
but that's not all we have

00:28:38.526 --> 00:28:39.776 A:middle
related to heart features.

00:28:40.626 --> 00:28:42.696 A:middle
Back in iOS 12, Apple Watch

00:28:42.696 --> 00:28:44.326 A:middle
started notifying users with

00:28:44.326 --> 00:28:45.236 A:middle
heart alerts.

00:28:46.436 --> 00:28:47.776 A:middle
A low heart rate alert when

00:28:47.776 --> 00:28:49.806 A:middle
Apple Watch detected a heart

00:28:49.806 --> 00:28:51.656 A:middle
rate below a given BPM

00:28:51.656 --> 00:28:53.946 A:middle
threshold, a high heart rate

00:28:53.946 --> 00:28:55.856 A:middle
alert for when heart rate rose

00:28:55.856 --> 00:28:58.626 A:middle
above a given BPM threshold, and

00:28:58.626 --> 00:29:00.056 A:middle
an irregular heart rate alert

00:28:58.626 --> 00:29:00.056 A:middle
an irregular heart rate alert

00:29:00.246 --> 00:29:01.776 A:middle
for when Apple Watch detected a

00:29:01.776 --> 00:29:03.326 A:middle
rhythm that could be indicative

00:29:03.426 --> 00:29:04.000 A:middle
of AFib.

00:29:05.876 --> 00:29:07.666 A:middle
Well, in HealthKit, these alerts

00:29:07.666 --> 00:29:09.086 A:middle
now come in the form of three

00:29:09.086 --> 00:29:11.266 A:middle
new category types that will get

00:29:11.266 --> 00:29:12.816 A:middle
saved to HealthKit any time

00:29:12.816 --> 00:29:14.436 A:middle
Apple Watch detects an alert.

00:29:15.006 --> 00:29:18.326 A:middle
Now, in addition to all this

00:29:18.326 --> 00:29:19.816 A:middle
great heart support, there's

00:29:19.816 --> 00:29:21.576 A:middle
also this new area that we're

00:29:21.576 --> 00:29:23.656 A:middle
exposing in iOS 13 and I'm

00:29:23.656 --> 00:29:25.846 A:middle
excited to share with you that

00:29:25.906 --> 00:29:27.026 A:middle
hearing health has found its

00:29:27.026 --> 00:29:28.036 A:middle
place in HealthKit.

00:29:28.036 --> 00:29:31.766 A:middle
At some point in your life, you

00:29:31.766 --> 00:29:33.196 A:middle
might remember getting a hearing

00:29:33.196 --> 00:29:35.006 A:middle
test where you put on a pair of

00:29:35.006 --> 00:29:36.696 A:middle
headphones and listened to a

00:29:36.696 --> 00:29:39.086 A:middle
series of sounds and would raise

00:29:39.086 --> 00:29:40.586 A:middle
your hand as soon as a single

00:29:40.586 --> 00:29:41.736 A:middle
sound was loud enough for you to

00:29:41.736 --> 00:29:42.056 A:middle
hear it.

00:29:42.056 --> 00:29:44.066 A:middle
Well, this was an example of a

00:29:44.066 --> 00:29:46.026 A:middle
pure tone hearing test, where a

00:29:46.026 --> 00:29:47.496 A:middle
pure tone is a sound with a

00:29:47.496 --> 00:29:48.506 A:middle
single frequency.

00:29:49.026 --> 00:29:52.706 A:middle
Pure tone testing helps identify

00:29:52.706 --> 00:29:54.266 A:middle
the quietest sound that you can

00:29:54.316 --> 00:29:55.456 A:middle
hear at a set of different

00:29:55.486 --> 00:29:57.996 A:middle
frequencies and it can provide

00:29:57.996 --> 00:29:59.236 A:middle
assessment on the kind of

00:29:59.236 --> 00:30:00.806 A:middle
hearing impairment or loss that

00:29:59.236 --> 00:30:00.806 A:middle
hearing impairment or loss that

00:30:00.806 --> 00:30:01.546 A:middle
you might have.

00:30:03.046 --> 00:30:04.936 A:middle
The results of pure tone testing

00:30:04.986 --> 00:30:06.776 A:middle
most commonly get displayed in

00:30:06.776 --> 00:30:08.246 A:middle
graphs called audiograms.

00:30:08.636 --> 00:30:11.656 A:middle
This here is an example of an

00:30:11.656 --> 00:30:13.796 A:middle
audiogram for someone with mild

00:30:13.826 --> 00:30:15.576 A:middle
hearing impairment and let's

00:30:15.576 --> 00:30:17.456 A:middle
just zoom into this graph to get

00:30:17.456 --> 00:30:19.106 A:middle
a better idea of the kind of

00:30:19.106 --> 00:30:20.496 A:middle
data that is stored in an

00:30:20.496 --> 00:30:21.096 A:middle
audiogram.

00:30:21.666 --> 00:30:24.256 A:middle
So, here you'll see two lines,

00:30:24.716 --> 00:30:26.206 A:middle
one corresponding to the pure

00:30:26.206 --> 00:30:27.916 A:middle
tone hearing test results from

00:30:27.916 --> 00:30:29.306 A:middle
the left ear and one for the

00:30:29.306 --> 00:30:29.716 A:middle
right ear.

00:30:29.716 --> 00:30:31.406 A:middle
And let's just take a look at

00:30:31.406 --> 00:30:32.726 A:middle
the first two data points at the

00:30:32.726 --> 00:30:34.076 A:middle
125-hertz line.

00:30:35.456 --> 00:30:37.126 A:middle
This shows that for this user to

00:30:37.126 --> 00:30:39.256 A:middle
hear a sound at a 125-hertz

00:30:39.256 --> 00:30:41.466 A:middle
frequency, they need around 11

00:30:41.466 --> 00:30:43.086 A:middle
decibel hearing level units in

00:30:43.086 --> 00:30:45.116 A:middle
their left ear and 31 in their

00:30:45.116 --> 00:30:45.336 A:middle
right.

00:30:46.186 --> 00:30:47.696 A:middle
The decibel hearing level unit

00:30:47.696 --> 00:30:49.226 A:middle
measures the intensity of a

00:30:49.226 --> 00:30:51.016 A:middle
sound relative to the quietest

00:30:51.016 --> 00:30:52.416 A:middle
sound that a young, healthy

00:30:52.416 --> 00:30:53.556 A:middle
individual would be able to

00:30:53.556 --> 00:30:53.766 A:middle
hear.

00:30:55.156 --> 00:30:56.706 A:middle
So, we can get the rest of the

00:30:56.706 --> 00:30:58.516 A:middle
data points associated with this

00:30:58.516 --> 00:31:00.586 A:middle
audiogram and in order to store

00:30:58.516 --> 00:31:00.586 A:middle
audiogram and in order to store

00:31:00.586 --> 00:31:02.206 A:middle
this data in HealthKit, we're

00:31:02.206 --> 00:31:05.106 A:middle
introducing an HKAudiogramSample

00:31:05.346 --> 00:31:06.926 A:middle
that stores an array of hearing

00:31:06.926 --> 00:31:08.686 A:middle
sensitivity points associated

00:31:08.686 --> 00:31:09.706 A:middle
with a hearing test.

00:31:09.966 --> 00:31:11.576 A:middle
So, let's create an audiogram

00:31:11.576 --> 00:31:14.406 A:middle
sample and code.

00:31:14.406 --> 00:31:16.606 A:middle
Our first step is to create an

00:31:16.606 --> 00:31:18.706 A:middle
HKAudiogramSensitivityPoint that

00:31:18.706 --> 00:31:20.456 A:middle
encapsulates the intensity of a

00:31:20.456 --> 00:31:22.526 A:middle
sound required for both ears to

00:31:22.526 --> 00:31:23.676 A:middle
hear a given frequency.

00:31:24.606 --> 00:31:26.346 A:middle
So, I'll create a frequency

00:31:26.346 --> 00:31:28.646 A:middle
quantity with my new HK unit

00:31:28.646 --> 00:31:31.206 A:middle
hertz unit and a left-ear and

00:31:31.206 --> 00:31:32.786 A:middle
right-ear sensitivity quantity

00:31:32.786 --> 00:31:34.226 A:middle
with my new decibel hearing

00:31:34.226 --> 00:31:34.766 A:middle
level unit.

00:31:36.226 --> 00:31:37.506 A:middle
Now I'm ready to create an

00:31:37.506 --> 00:31:38.856 A:middle
audiogram sensitivity point.

00:31:39.786 --> 00:31:41.736 A:middle
Once you've created an array of

00:31:41.736 --> 00:31:43.336 A:middle
audiogram sensitivity points,

00:31:43.676 --> 00:31:44.826 A:middle
you can store that in an

00:31:44.826 --> 00:31:45.916 A:middle
audiogramSample.

00:31:46.516 --> 00:31:47.586 A:middle
Now, you'll need to make sure

00:31:47.586 --> 00:31:49.166 A:middle
that the array of sensitivity

00:31:49.166 --> 00:31:51.036 A:middle
points are all unique and in

00:31:51.086 --> 00:31:52.646 A:middle
order, since that's how you

00:31:52.646 --> 00:31:54.156 A:middle
should expect to interact with

00:31:54.156 --> 00:31:56.176 A:middle
this data later on in analysis

00:31:56.176 --> 00:31:56.816 A:middle
or charting.

00:31:58.136 --> 00:31:59.856 A:middle
And finally, I'm ready to store

00:31:59.856 --> 00:32:01.206 A:middle
that data to HealthKit.

00:31:59.856 --> 00:32:01.206 A:middle
that data to HealthKit.

00:32:02.156 --> 00:32:03.516 A:middle
And that's how easy it is for

00:32:03.516 --> 00:32:04.886 A:middle
you to start creating audiogram

00:32:04.886 --> 00:32:06.556 A:middle
samples and to start building

00:32:06.616 --> 00:32:07.576 A:middle
hearing health apps with

00:32:07.576 --> 00:32:07.996 A:middle
HealthKit.

00:32:07.996 --> 00:32:10.866 A:middle
But an audiogram sample only

00:32:10.866 --> 00:32:12.426 A:middle
represents the health of your

00:32:12.426 --> 00:32:13.846 A:middle
ears at a given point of time

00:32:13.886 --> 00:32:14.816 A:middle
when you're taking a hearing

00:32:14.816 --> 00:32:15.266 A:middle
test.

00:32:15.536 --> 00:32:17.906 A:middle
Most of the day, we're exposed

00:32:17.906 --> 00:32:19.556 A:middle
to sounds through our headphones

00:32:19.556 --> 00:32:21.036 A:middle
or while we're walking down the

00:32:21.036 --> 00:32:22.906 A:middle
street in the environment and

00:32:22.906 --> 00:32:24.346 A:middle
all of that can impact our

00:32:24.346 --> 00:32:25.666 A:middle
hearing health for life.

00:32:26.256 --> 00:32:28.456 A:middle
To keep track of the audio

00:32:28.456 --> 00:32:29.966 A:middle
exposure that you're exposed to

00:32:29.966 --> 00:32:31.456 A:middle
through your headphones, we have

00:32:31.456 --> 00:32:32.776 A:middle
a read-write quantity type,

00:32:32.926 --> 00:32:34.306 A:middle
headphoneAudioExposure.

00:32:34.876 --> 00:32:37.406 A:middle
And for the rest of the day,

00:32:37.526 --> 00:32:38.676 A:middle
when we're walking down the

00:32:38.676 --> 00:32:40.306 A:middle
street exposed to construction

00:32:40.306 --> 00:32:42.556 A:middle
work sounds or traffic, Apple

00:32:42.556 --> 00:32:44.216 A:middle
Watch is capable of capturing

00:32:44.216 --> 00:32:45.456 A:middle
that environmental audio

00:32:45.456 --> 00:32:47.046 A:middle
exposure data and saving it to

00:32:47.046 --> 00:32:48.846 A:middle
HealthKit, and for that we have

00:32:48.846 --> 00:32:50.326 A:middle
an analogous read-write quantity

00:32:50.326 --> 00:32:50.666 A:middle
type,

00:32:50.976 --> 00:32:52.496 A:middle
environmentalAudioExposure.

00:32:52.496 --> 00:32:55.516 A:middle
And for times when environmental

00:32:55.516 --> 00:32:57.326 A:middle
audio exposure gets too high,

00:32:57.856 --> 00:32:59.376 A:middle
Apple Watch will generate an

00:32:59.376 --> 00:33:00.926 A:middle
audio exposure alert to make

00:32:59.376 --> 00:33:00.926 A:middle
audio exposure alert to make

00:33:00.926 --> 00:33:02.226 A:middle
sure that you're aware of the

00:33:02.226 --> 00:33:04.216 A:middle
possible impact that can have on

00:33:04.216 --> 00:33:05.126 A:middle
the health of your ears.

00:33:05.836 --> 00:33:06.986 A:middle
And it will save this as a

00:33:06.986 --> 00:33:09.576 A:middle
category sample using the new

00:33:09.576 --> 00:33:11.466 A:middle
audioExposureEvent category type

00:33:11.466 --> 00:33:12.146 A:middle
identifier.

00:33:12.696 --> 00:33:16.016 A:middle
So, we've covered a lot about

00:33:16.016 --> 00:33:17.856 A:middle
the new data representations now

00:33:17.856 --> 00:33:19.596 A:middle
available with HealthKit and iOS

00:33:19.596 --> 00:33:22.146 A:middle
13, from new efficient series

00:33:22.146 --> 00:33:23.726 A:middle
representations to the new

00:33:23.726 --> 00:33:25.196 A:middle
support with hearing health.

00:33:25.476 --> 00:33:28.366 A:middle
Now you can officially store

00:33:28.516 --> 00:33:30.656 A:middle
large numbers of HK quantities,

00:33:30.916 --> 00:33:32.616 A:middle
the most abundant kind of data

00:33:32.616 --> 00:33:33.396 A:middle
stored in HealthKit.

00:33:33.396 --> 00:33:36.246 A:middle
And you have the opportunity to

00:33:36.246 --> 00:33:38.536 A:middle
represent even more rich data

00:33:38.536 --> 00:33:40.706 A:middle
representations related to heart

00:33:40.706 --> 00:33:41.406 A:middle
and hearing health.

00:33:42.676 --> 00:33:44.696 A:middle
For more information as well as

00:33:44.696 --> 00:33:46.096 A:middle
our sample code projects you saw

00:33:46.236 --> 00:33:47.896 A:middle
here, you can visit our session

00:33:47.896 --> 00:33:50.386 A:middle
link listed or come talk to us

00:33:50.386 --> 00:33:51.806 A:middle
right after this session at the

00:33:51.806 --> 00:33:53.076 A:middle
Health and Fitness Technologies

00:33:53.836 --> 00:33:53.926 A:middle
Lab.

00:33:54.496 --> 00:33:56.736 A:middle
Thank you and have a great rest

00:33:56.736 --> 00:33:57.976 A:middle
of your WWDC.

00:33:58.516 --> 00:34:04.500 A:middle
[ Cheering and Applause ]
