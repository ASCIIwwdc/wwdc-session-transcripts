WEBVTT

00:00:00.506 --> 00:00:04.516 A:middle
[ Music ]

00:00:05.516 --> 00:00:12.796 A:middle
[ Applause ]

00:00:13.296 --> 00:00:14.916 A:middle
&gt;&gt; Hi. I'm Roberto from the

00:00:14.916 --> 00:00:16.245 A:middle
Software Battery Life Team here

00:00:16.245 --> 00:00:17.776 A:middle
at Apple, and I'm really excited

00:00:17.776 --> 00:00:19.326 A:middle
to talk to you guys today about

00:00:19.326 --> 00:00:20.916 A:middle
advances in App Background

00:00:20.916 --> 00:00:21.436 A:middle
Execution.

00:00:23.526 --> 00:00:26.196 A:middle
Users love apps, and they love

00:00:26.196 --> 00:00:27.556 A:middle
apps because of the many great

00:00:27.556 --> 00:00:28.886 A:middle
experiences that they enable.

00:00:29.526 --> 00:00:30.526 A:middle
Some of these are in the

00:00:30.526 --> 00:00:31.686 A:middle
foreground when the user is

00:00:31.686 --> 00:00:33.806 A:middle
actively using the app, and some

00:00:33.806 --> 00:00:35.216 A:middle
of these are in the background

00:00:35.306 --> 00:00:36.926 A:middle
and require background execution

00:00:36.926 --> 00:00:37.866 A:middle
in order to be possible.

00:00:38.686 --> 00:00:39.666 A:middle
So, if we come up with a list of

00:00:39.666 --> 00:00:40.746 A:middle
what might require background

00:00:40.746 --> 00:00:42.586 A:middle
execution, we might come up with

00:00:42.586 --> 00:00:44.256 A:middle
something like this, things like

00:00:44.526 --> 00:00:46.506 A:middle
navigation or accessory

00:00:46.506 --> 00:00:48.676 A:middle
communication or maybe periodic

00:00:48.676 --> 00:00:49.546 A:middle
updates and downloads.

00:00:49.976 --> 00:00:51.836 A:middle
And at Apple, we design APIs

00:00:51.836 --> 00:00:53.686 A:middle
that give background execution

00:00:53.686 --> 00:00:55.436 A:middle
to enable these use cases and

00:00:55.436 --> 00:00:55.996 A:middle
experiences.

00:00:57.516 --> 00:00:59.076 A:middle
So, today, we'll talk about

00:00:59.076 --> 00:01:00.586 A:middle
background execution, give a

00:00:59.076 --> 00:01:00.586 A:middle
background execution, give a

00:01:00.586 --> 00:01:02.466 A:middle
general overview, then talk

00:01:02.466 --> 00:01:03.556 A:middle
about some best practices to

00:01:03.556 --> 00:01:05.766 A:middle
follow, and finally, my

00:01:05.766 --> 00:01:06.846 A:middle
colleague, Thomas, will come up

00:01:06.846 --> 00:01:08.076 A:middle
to introduce a new background

00:01:08.076 --> 00:01:09.636 A:middle
task framework that offers new

00:01:09.786 --> 00:01:10.736 A:middle
background execution

00:01:10.766 --> 00:01:11.366 A:middle
opportunities.

00:01:11.906 --> 00:01:14.766 A:middle
Let's begin with an overview of

00:01:14.766 --> 00:01:15.656 A:middle
background execution.

00:01:16.006 --> 00:01:18.496 A:middle
We can begin by answering the

00:01:18.496 --> 00:01:20.006 A:middle
question of what is background

00:01:20.006 --> 00:01:20.556 A:middle
execution?

00:01:20.636 --> 00:01:21.536 A:middle
What do we mean?

00:01:21.706 --> 00:01:23.596 A:middle
So, when we think of background,

00:01:23.596 --> 00:01:24.566 A:middle
it can mean many things.

00:01:24.566 --> 00:01:26.446 A:middle
Background threads or background

00:01:26.446 --> 00:01:27.946 A:middle
queues, but when we're talking

00:01:27.946 --> 00:01:29.186 A:middle
about background execution,

00:01:29.186 --> 00:01:30.186 A:middle
we're talking about the app

00:01:30.186 --> 00:01:32.866 A:middle
running or executing code while

00:01:32.866 --> 00:01:34.176 A:middle
it's not in the foreground.

00:01:35.076 --> 00:01:36.736 A:middle
So, looking at this diagram,

00:01:37.046 --> 00:01:38.646 A:middle
we're talking about that third

00:01:38.646 --> 00:01:40.476 A:middle
box where the app is running in

00:01:40.476 --> 00:01:41.866 A:middle
the background but it's not

00:01:41.866 --> 00:01:45.096 A:middle
necessarily visible to the user.

00:01:45.376 --> 00:01:47.476 A:middle
Now, why do we enter this state?

00:01:47.916 --> 00:01:49.446 A:middle
It really boils down to two

00:01:49.446 --> 00:01:49.846 A:middle
ways.

00:01:50.666 --> 00:01:52.236 A:middle
The first is a request by the

00:01:52.386 --> 00:01:52.736 A:middle
app.

00:01:53.086 --> 00:01:54.606 A:middle
This applies to more generic

00:01:54.606 --> 00:01:56.246 A:middle
background execution where the

00:01:56.246 --> 00:01:57.956 A:middle
app wants to perform some work

00:01:58.336 --> 00:01:59.526 A:middle
and it makes a request to the

00:01:59.526 --> 00:01:59.956 A:middle
system.

00:02:00.626 --> 00:02:01.566 A:middle
You can think of something like

00:02:01.696 --> 00:02:04.296 A:middle
downloads or periodic updates or

00:02:04.296 --> 00:02:05.706 A:middle
maybe finishing some foreground

00:02:05.706 --> 00:02:05.876 A:middle
work.

00:02:06.976 --> 00:02:08.265 A:middle
The second way is through

00:02:08.265 --> 00:02:10.786 A:middle
specific event triggers where

00:02:11.066 --> 00:02:12.906 A:middle
the app gets background time in

00:02:12.906 --> 00:02:14.446 A:middle
order to respond to something

00:02:14.446 --> 00:02:16.186 A:middle
that happened in the world.

00:02:16.956 --> 00:02:18.596 A:middle
For example, maybe the user

00:02:18.596 --> 00:02:20.626 A:middle
entered some foreign region or

00:02:20.846 --> 00:02:21.876 A:middle
maybe there was some new health

00:02:21.876 --> 00:02:22.986 A:middle
data that your app needed to be

00:02:22.986 --> 00:02:23.576 A:middle
made aware of.

00:02:25.956 --> 00:02:26.806 A:middle
And when running in the

00:02:26.806 --> 00:02:28.666 A:middle
background, we care deeply about

00:02:28.666 --> 00:02:30.136 A:middle
user experience, so there are

00:02:30.136 --> 00:02:31.546 A:middle
many important factors we

00:02:31.546 --> 00:02:32.876 A:middle
consider when we design APIs to

00:02:33.146 --> 00:02:34.166 A:middle
support these use cases.

00:02:34.796 --> 00:02:35.756 A:middle
And I want to highlight three of

00:02:35.756 --> 00:02:36.000 A:middle
these.

00:02:37.646 --> 00:02:41.616 A:middle
Power, performance, and privacy.

00:02:41.616 --> 00:02:44.876 A:middle
So, let's start with power.

00:02:45.696 --> 00:02:47.236 A:middle
Whenever your app is running in

00:02:47.236 --> 00:02:48.266 A:middle
the foreground or the

00:02:48.266 --> 00:02:50.376 A:middle
background, it's using power,

00:02:50.876 --> 00:02:52.466 A:middle
and over time, this drains

00:02:52.466 --> 00:02:53.906 A:middle
energy and can drain battery.

00:02:55.346 --> 00:02:56.766 A:middle
To visualize this, let's take a

00:02:56.766 --> 00:02:57.236 A:middle
timeline.

00:02:57.686 --> 00:02:58.896 A:middle
The left might be the start of

00:02:58.896 --> 00:03:00.446 A:middle
the day when the sun rises, and

00:02:58.896 --> 00:03:00.446 A:middle
the day when the sun rises, and

00:03:00.446 --> 00:03:01.766 A:middle
the right might be the end of

00:03:01.766 --> 00:03:03.256 A:middle
the day, and maybe the user

00:03:03.256 --> 00:03:04.466 A:middle
decides to plug in their device

00:03:04.466 --> 00:03:06.686 A:middle
towards the end of the day, and

00:03:06.686 --> 00:03:07.746 A:middle
we have that green charging

00:03:07.746 --> 00:03:08.786 A:middle
region to represent that.

00:03:09.506 --> 00:03:11.186 A:middle
So, we can plot the times our

00:03:11.186 --> 00:03:12.476 A:middle
app runs in the foreground in

00:03:12.476 --> 00:03:13.856 A:middle
these lightly shaded rectangles,

00:03:14.396 --> 00:03:15.986 A:middle
and we can plot the time the app

00:03:15.986 --> 00:03:17.076 A:middle
runs in the background in these

00:03:17.076 --> 00:03:18.276 A:middle
darkly shaded rectangles.

00:03:19.206 --> 00:03:21.376 A:middle
If we run for longer, then we'll

00:03:21.376 --> 00:03:22.416 A:middle
drain more battery.

00:03:22.956 --> 00:03:24.556 A:middle
If we run for less time, we'll

00:03:24.556 --> 00:03:25.286 A:middle
drain less battery.

00:03:26.416 --> 00:03:28.626 A:middle
And so, when we design APIs, we

00:03:28.676 --> 00:03:29.606 A:middle
focus on the right amount of

00:03:29.606 --> 00:03:31.326 A:middle
time to run to support specific

00:03:31.326 --> 00:03:32.506 A:middle
use cases while maintaining

00:03:32.506 --> 00:03:34.006 A:middle
great battery life, and when

00:03:34.006 --> 00:03:35.696 A:middle
using these APIs, think about

00:03:35.696 --> 00:03:37.386 A:middle
how to be efficient and alert

00:03:37.386 --> 00:03:38.576 A:middle
the system when you're done

00:03:38.576 --> 00:03:40.226 A:middle
doing work by calling completion

00:03:40.226 --> 00:03:40.616 A:middle
handlers.

00:03:41.036 --> 00:03:42.316 A:middle
That way, if the system gave

00:03:42.316 --> 00:03:43.846 A:middle
your app time to run, you can

00:03:43.846 --> 00:03:45.186 A:middle
tell the system, hey, I'm done a

00:03:45.186 --> 00:03:45.806 A:middle
little early.

00:03:45.806 --> 00:03:47.466 A:middle
It can suspend your app, and

00:03:47.466 --> 00:03:48.676 A:middle
you'll stop consuming the user's

00:03:48.676 --> 00:03:49.036 A:middle
battery.

00:03:50.516 --> 00:03:52.106 A:middle
Next, we have performance.

00:03:52.696 --> 00:03:54.396 A:middle
We want our system to perform as

00:03:54.466 --> 00:03:55.526 A:middle
smoothly as possible.

00:03:56.136 --> 00:03:58.206 A:middle
This means that we want fast app

00:03:58.206 --> 00:04:00.066 A:middle
launches and responsive UI, and

00:03:58.206 --> 00:04:00.066 A:middle
launches and responsive UI, and

00:04:00.066 --> 00:04:01.276 A:middle
this is especially important

00:04:01.276 --> 00:04:01.936 A:middle
when we're running in the

00:04:01.936 --> 00:04:02.436 A:middle
background.

00:04:02.526 --> 00:04:05.116 A:middle
And the reason is that while we

00:04:05.116 --> 00:04:06.726 A:middle
may be tempted to think that

00:04:07.156 --> 00:04:08.646 A:middle
there's only one app running

00:04:09.246 --> 00:04:10.586 A:middle
over the course of the day,

00:04:10.586 --> 00:04:13.116 A:middle
there actually are multiple apps

00:04:13.116 --> 00:04:14.246 A:middle
running at different points in

00:04:14.246 --> 00:04:15.896 A:middle
time in the foreground and the

00:04:15.896 --> 00:04:16.386 A:middle
background.

00:04:17.565 --> 00:04:18.946 A:middle
And when we overlay this, we can

00:04:18.946 --> 00:04:19.995 A:middle
see that our app may be running

00:04:19.995 --> 00:04:21.336 A:middle
in the background while another

00:04:21.336 --> 00:04:22.916 A:middle
app is running in the foreground

00:04:23.286 --> 00:04:24.596 A:middle
or multiple apps can be running

00:04:24.596 --> 00:04:25.736 A:middle
in the background when an app is

00:04:25.736 --> 00:04:26.506 A:middle
running in the foreground.

00:04:26.916 --> 00:04:29.356 A:middle
And so when we design APIs, we

00:04:29.356 --> 00:04:31.356 A:middle
think about setting smart CPU

00:04:31.356 --> 00:04:33.066 A:middle
and memory limits to minimize

00:04:33.126 --> 00:04:35.066 A:middle
the impact on other usage, and

00:04:35.066 --> 00:04:36.856 A:middle
when using these APIs, you

00:04:36.856 --> 00:04:37.946 A:middle
should be aware of what these

00:04:37.946 --> 00:04:39.356 A:middle
limits are so that you don't

00:04:39.356 --> 00:04:40.416 A:middle
affect what the user is actively

00:04:40.416 --> 00:04:41.926 A:middle
doing but more importantly so

00:04:41.926 --> 00:04:42.886 A:middle
that the system doesn't

00:04:42.886 --> 00:04:44.166 A:middle
terminate your app, and then

00:04:44.166 --> 00:04:45.356 A:middle
when you launch in the future,

00:04:45.356 --> 00:04:46.686 A:middle
you might be slower to launch.

00:04:48.196 --> 00:04:50.486 A:middle
The last important factor is

00:04:50.556 --> 00:04:51.126 A:middle
privacy.

00:04:51.526 --> 00:04:53.366 A:middle
Users are really sensitive and

00:04:53.366 --> 00:04:54.786 A:middle
really care about their personal

00:04:54.786 --> 00:04:55.076 A:middle
data.

00:04:55.746 --> 00:04:57.766 A:middle
And, while they may be aware of

00:04:57.766 --> 00:04:59.036 A:middle
all the times that the app is

00:04:59.036 --> 00:05:00.186 A:middle
running in the foreground and

00:04:59.036 --> 00:05:00.186 A:middle
running in the foreground and

00:05:00.186 --> 00:05:01.566 A:middle
expected to have access to

00:05:01.566 --> 00:05:02.976 A:middle
certain pieces of information,

00:05:03.546 --> 00:05:05.246 A:middle
they may not be as aware of all

00:05:05.246 --> 00:05:06.516 A:middle
the times the app is running in

00:05:06.516 --> 00:05:07.116 A:middle
the background.

00:05:08.116 --> 00:05:09.836 A:middle
And so, when we design APIs,

00:05:09.836 --> 00:05:10.556 A:middle
this means that we have

00:05:10.626 --> 00:05:12.376 A:middle
different APIs for different use

00:05:12.406 --> 00:05:14.706 A:middle
cases, each with their own set

00:05:14.706 --> 00:05:16.116 A:middle
to a specific set of data that

00:05:16.116 --> 00:05:17.326 A:middle
it needs to support that.

00:05:17.326 --> 00:05:19.116 A:middle
And when using these APIs, think

00:05:19.116 --> 00:05:20.346 A:middle
about how to be transparent to

00:05:20.346 --> 00:05:23.216 A:middle
the user and let them know which

00:05:23.216 --> 00:05:24.326 A:middle
pieces of data you're using.

00:05:25.616 --> 00:05:26.636 A:middle
So, those were the three

00:05:26.636 --> 00:05:27.626 A:middle
important considerations to

00:05:27.626 --> 00:05:28.836 A:middle
consider in background

00:05:28.836 --> 00:05:29.386 A:middle
execution.

00:05:29.776 --> 00:05:31.966 A:middle
Power, performance, and privacy.

00:05:32.066 --> 00:05:34.066 A:middle
And when we go back to our list

00:05:34.066 --> 00:05:35.896 A:middle
of use cases, these different

00:05:35.896 --> 00:05:37.506 A:middle
use cases translate into

00:05:37.506 --> 00:05:39.566 A:middle
different APIs, each with a

00:05:39.566 --> 00:05:41.206 A:middle
different set of requirements to

00:05:41.206 --> 00:05:42.596 A:middle
achieve the desired behavior

00:05:42.906 --> 00:05:44.476 A:middle
while maintaining a great user

00:05:44.476 --> 00:05:44.976 A:middle
experience.

00:05:45.586 --> 00:05:48.306 A:middle
So now that we have a general

00:05:48.306 --> 00:05:49.686 A:middle
overview, let's dive into some

00:05:49.686 --> 00:05:51.226 A:middle
best practices to follow for

00:05:51.226 --> 00:05:53.246 A:middle
some specific modes and talk

00:05:53.246 --> 00:05:56.376 A:middle
about changes to APIs.

00:05:56.376 --> 00:05:58.706 A:middle
So, to do so, let's take a

00:05:58.706 --> 00:05:59.776 A:middle
messaging app.

00:05:59.776 --> 00:06:00.456 A:middle
It might have core

00:05:59.776 --> 00:06:00.456 A:middle
It might have core

00:06:00.456 --> 00:06:02.216 A:middle
functionality, like sending

00:06:02.216 --> 00:06:04.606 A:middle
messages or making phone calls,

00:06:04.886 --> 00:06:05.896 A:middle
and then it might have some

00:06:05.896 --> 00:06:07.456 A:middle
bonus features like allowing the

00:06:07.456 --> 00:06:09.866 A:middle
user to mute a chatty thread or

00:06:10.166 --> 00:06:11.566 A:middle
downloading past attachments.

00:06:12.186 --> 00:06:13.546 A:middle
And so now, I'll go through each

00:06:13.546 --> 00:06:15.226 A:middle
of these four and talk about

00:06:15.226 --> 00:06:16.376 A:middle
which API we would use to

00:06:16.376 --> 00:06:17.036 A:middle
accomplish this.

00:06:18.346 --> 00:06:19.916 A:middle
The first is sending messages.

00:06:20.556 --> 00:06:22.106 A:middle
Sending messages is a core

00:06:22.106 --> 00:06:23.236 A:middle
functionality of your app.

00:06:23.726 --> 00:06:24.866 A:middle
If I'm sending a message to my

00:06:24.866 --> 00:06:25.936 A:middle
friend, I want it to be

00:06:25.936 --> 00:06:27.436 A:middle
delivered right now, not a day

00:06:27.436 --> 00:06:28.546 A:middle
from now or a week from now.

00:06:29.716 --> 00:06:31.056 A:middle
And so the user expects that

00:06:31.056 --> 00:06:32.336 A:middle
this will complete immediately.

00:06:33.266 --> 00:06:35.366 A:middle
And while this may usually be

00:06:35.366 --> 00:06:37.326 A:middle
very quick, sometimes this might

00:06:37.326 --> 00:06:38.036 A:middle
not be the case.

00:06:38.536 --> 00:06:39.986 A:middle
Maybe the network's congested or

00:06:39.986 --> 00:06:41.156 A:middle
maybe the backend servers are

00:06:41.156 --> 00:06:42.716 A:middle
slow, and it might take

00:06:42.716 --> 00:06:43.716 A:middle
additional time to send the

00:06:43.716 --> 00:06:44.046 A:middle
message.

00:06:44.886 --> 00:06:46.166 A:middle
And in this additional time, the

00:06:46.166 --> 00:06:47.926 A:middle
user might even leave the app or

00:06:48.026 --> 00:06:49.156 A:middle
put their phone down and lock

00:06:49.156 --> 00:06:49.256 A:middle
it.

00:06:49.436 --> 00:06:51.836 A:middle
And so, we need a way to protect

00:06:51.836 --> 00:06:53.126 A:middle
the completion of this task.

00:06:53.786 --> 00:06:54.926 A:middle
We need to make sure that our

00:06:54.926 --> 00:06:56.446 A:middle
message finishes sending so that

00:06:56.446 --> 00:06:57.556 A:middle
the user doesn't come back to

00:06:57.556 --> 00:06:59.706 A:middle
the app and realize, hey, why

00:06:59.706 --> 00:07:00.846 A:middle
didn't my message send to my

00:06:59.706 --> 00:07:00.846 A:middle
didn't my message send to my

00:07:00.846 --> 00:07:01.136 A:middle
friend.

00:07:01.716 --> 00:07:03.796 A:middle
The API to use for this is

00:07:03.796 --> 00:07:04.936 A:middle
background task completion.

00:07:06.026 --> 00:07:07.366 A:middle
This gives apps additional run

00:07:07.366 --> 00:07:09.286 A:middle
time to run in the background

00:07:09.286 --> 00:07:10.276 A:middle
before being suspended.

00:07:10.866 --> 00:07:12.206 A:middle
To do it, you call UI

00:07:12.266 --> 00:07:13.606 A:middle
Application Begin Background

00:07:13.606 --> 00:07:15.806 A:middle
Task or you call Process Info

00:07:15.806 --> 00:07:17.346 A:middle
Perform Expiring Activity if

00:07:17.346 --> 00:07:17.856 A:middle
you're running from an

00:07:17.856 --> 00:07:18.296 A:middle
extension.

00:07:18.986 --> 00:07:20.736 A:middle
And again, this is to complete

00:07:20.736 --> 00:07:22.056 A:middle
work that started in the

00:07:22.056 --> 00:07:22.566 A:middle
foreground.

00:07:22.796 --> 00:07:24.696 A:middle
So, other examples might include

00:07:24.696 --> 00:07:26.686 A:middle
saving files to disk or

00:07:26.846 --> 00:07:28.326 A:middle
completing any user-initiated

00:07:28.326 --> 00:07:28.836 A:middle
requests.

00:07:29.276 --> 00:07:30.376 A:middle
So, let's take a look at what

00:07:30.376 --> 00:07:31.566 A:middle
this might look like in code for

00:07:31.566 --> 00:07:32.936 A:middle
our sending messages example.

00:07:34.196 --> 00:07:35.876 A:middle
Here, we have our send message

00:07:35.876 --> 00:07:36.216 A:middle
function.

00:07:36.816 --> 00:07:39.566 A:middle
In it, after we establish our

00:07:39.566 --> 00:07:41.566 A:middle
send operation, we call Begin

00:07:41.566 --> 00:07:42.326 A:middle
Background Task.

00:07:42.726 --> 00:07:44.086 A:middle
This lets the system know that,

00:07:44.086 --> 00:07:45.816 A:middle
hey, we're starting a task that

00:07:45.816 --> 00:07:46.966 A:middle
even if the user backgrounds the

00:07:46.966 --> 00:07:48.696 A:middle
app, let us continue running to

00:07:48.696 --> 00:07:49.926 A:middle
finish it.

00:07:50.836 --> 00:07:52.606 A:middle
Then, when we finish sending the

00:07:52.606 --> 00:07:54.476 A:middle
message, in our completion

00:07:54.476 --> 00:07:56.556 A:middle
block, we'll let the system know

00:07:56.686 --> 00:07:58.106 A:middle
to end the background task.

00:07:58.316 --> 00:07:59.326 A:middle
We don't need time anymore.

00:07:59.776 --> 00:08:00.626 A:middle
This is for cases when the

00:07:59.776 --> 00:08:00.626 A:middle
This is for cases when the

00:08:00.686 --> 00:08:01.716 A:middle
system might have given us time,

00:08:01.716 --> 00:08:02.656 A:middle
the user backgrounds the app,

00:08:02.656 --> 00:08:03.866 A:middle
and we're done, and we can tell

00:08:03.866 --> 00:08:05.376 A:middle
the system to suspend us so that

00:08:05.376 --> 00:08:06.376 A:middle
we stop draining the user's

00:08:06.376 --> 00:08:07.736 A:middle
battery or potentially affect

00:08:07.736 --> 00:08:08.396 A:middle
their performance.

00:08:09.326 --> 00:08:10.146 A:middle
And there's one last thing I

00:08:10.146 --> 00:08:10.686 A:middle
want to highlight.

00:08:10.686 --> 00:08:13.226 A:middle
There are some cases where maybe

00:08:13.226 --> 00:08:14.246 A:middle
the system gives you additional

00:08:14.246 --> 00:08:15.656 A:middle
time, but conditions were so

00:08:15.656 --> 00:08:17.376 A:middle
bad, maybe it was so congested

00:08:17.776 --> 00:08:19.086 A:middle
that even with the additional

00:08:19.086 --> 00:08:20.236 A:middle
time we didn't finish.

00:08:20.606 --> 00:08:22.226 A:middle
And so, we have an expiration

00:08:22.226 --> 00:08:23.696 A:middle
handler for that, and the system

00:08:23.696 --> 00:08:25.036 A:middle
will call the expiration handler

00:08:25.036 --> 00:08:25.826 A:middle
at this point in time.

00:08:26.286 --> 00:08:27.896 A:middle
So, in this case, we post the

00:08:27.896 --> 00:08:29.406 A:middle
user notification to the user, a

00:08:29.406 --> 00:08:31.596 A:middle
local banner saying hey, hop

00:08:31.596 --> 00:08:32.775 A:middle
back into the app, because the

00:08:32.775 --> 00:08:34.326 A:middle
message didn't send.

00:08:34.996 --> 00:08:36.976 A:middle
So, to recap, when we're sending

00:08:36.976 --> 00:08:38.265 A:middle
messages, we want to protect

00:08:38.265 --> 00:08:39.905 A:middle
that it sends by using

00:08:39.905 --> 00:08:42.515 A:middle
background task completions, and

00:08:42.515 --> 00:08:43.826 A:middle
we want to make sure we start it

00:08:43.986 --> 00:08:45.116 A:middle
based on the user action.

00:08:45.476 --> 00:08:46.636 A:middle
We don't want to wait until we

00:08:46.636 --> 00:08:47.796 A:middle
enter the background to call

00:08:47.796 --> 00:08:49.426 A:middle
begin background task, because

00:08:49.426 --> 00:08:51.426 A:middle
if we do so, then we're limiting

00:08:51.426 --> 00:08:52.206 A:middle
the amount of time we're

00:08:52.206 --> 00:08:53.446 A:middle
actively trying to send it

00:08:53.446 --> 00:08:54.656 A:middle
before the system may suspend

00:08:54.656 --> 00:08:55.000 A:middle
our app.

00:08:56.556 --> 00:08:58.106 A:middle
So, now that we've talked about

00:08:58.106 --> 00:08:59.556 A:middle
sending messages, let's talk

00:08:59.556 --> 00:09:00.266 A:middle
about phone calls.

00:08:59.556 --> 00:09:00.266 A:middle
about phone calls.

00:09:01.766 --> 00:09:04.396 A:middle
So, I may want to message my

00:09:04.396 --> 00:09:06.226 A:middle
friends all the time, but

00:09:06.226 --> 00:09:07.236 A:middle
sometimes you just want to get

00:09:07.236 --> 00:09:08.976 A:middle
on the phone and quickly hop in

00:09:09.436 --> 00:09:11.266 A:middle
a phone call and tell them

00:09:11.266 --> 00:09:12.266 A:middle
something so you don't have to

00:09:12.266 --> 00:09:12.746 A:middle
type it out.

00:09:13.516 --> 00:09:15.166 A:middle
There's an API for this, and

00:09:15.166 --> 00:09:17.096 A:middle
it's VoIP push notifications.

00:09:17.776 --> 00:09:19.206 A:middle
This is a special type of push

00:09:19.456 --> 00:09:21.096 A:middle
that launches your app and gives

00:09:21.096 --> 00:09:22.186 A:middle
it run time so that you can

00:09:22.186 --> 00:09:23.776 A:middle
present to the user the fact

00:09:23.776 --> 00:09:24.856 A:middle
that they're being called, and

00:09:24.856 --> 00:09:26.026 A:middle
the user can answer a phone

00:09:26.026 --> 00:09:26.166 A:middle
call.

00:09:27.596 --> 00:09:29.696 A:middle
To register for this, you simply

00:09:29.696 --> 00:09:32.806 A:middle
set the VoIP push type in your

00:09:33.096 --> 00:09:35.046 A:middle
PK push registry when you

00:09:35.046 --> 00:09:37.656 A:middle
register for your VoIP pushes.

00:09:39.646 --> 00:09:41.766 A:middle
And new this year, it's very

00:09:41.766 --> 00:09:43.006 A:middle
important that you know that you

00:09:43.006 --> 00:09:46.016 A:middle
must report incoming calls with

00:09:46.016 --> 00:09:46.756 A:middle
CallKit in the

00:09:46.756 --> 00:09:49.016 A:middle
didReceiveIncomingPush callback

00:09:49.206 --> 00:09:50.646 A:middle
or your app will be terminated.

00:09:51.176 --> 00:09:53.316 A:middle
And, if you repeatedly do this,

00:09:53.396 --> 00:09:55.036 A:middle
or if you repeatedly fail not to

00:09:55.036 --> 00:09:56.506 A:middle
report an incoming call, the

00:09:56.506 --> 00:09:57.876 A:middle
system may stop launching your

00:09:57.876 --> 00:09:59.586 A:middle
app for VoIP pushes altogether.

00:10:00.726 --> 00:10:01.876 A:middle
So, let's take a look at how we

00:10:01.876 --> 00:10:03.826 A:middle
might adapt to this change in

00:10:03.826 --> 00:10:04.086 A:middle
code.

00:10:05.226 --> 00:10:06.646 A:middle
Here, we have our

00:10:06.676 --> 00:10:08.276 A:middle
didReceiveIncomingPush callback,

00:10:08.276 --> 00:10:11.356 A:middle
and in it, we see that if the

00:10:11.396 --> 00:10:13.146 A:middle
push type is VoIP, we'll use the

00:10:13.146 --> 00:10:14.246 A:middle
information from our push

00:10:14.276 --> 00:10:16.256 A:middle
payload to populate a CX call

00:10:16.256 --> 00:10:18.806 A:middle
update object, and then we

00:10:18.896 --> 00:10:20.506 A:middle
report a new incoming call using

00:10:20.506 --> 00:10:22.000 A:middle
our CX provider.

00:10:24.756 --> 00:10:26.236 A:middle
And so, you need to make sure

00:10:26.236 --> 00:10:27.276 A:middle
that you report your incoming

00:10:27.276 --> 00:10:28.476 A:middle
calls before that method

00:10:28.476 --> 00:10:31.066 A:middle
returns, or your system, the

00:10:31.066 --> 00:10:32.686 A:middle
system will kill your app.

00:10:32.876 --> 00:10:34.286 A:middle
A couple other tips you might

00:10:34.286 --> 00:10:36.546 A:middle
want to take note of is that if

00:10:36.546 --> 00:10:37.986 A:middle
you include your caller info in

00:10:37.986 --> 00:10:39.146 A:middle
the push payload, then you'll

00:10:39.146 --> 00:10:40.176 A:middle
have all the information you

00:10:40.176 --> 00:10:41.536 A:middle
need to quickly present that

00:10:41.536 --> 00:10:43.466 A:middle
incoming call UI, and so try to

00:10:43.466 --> 00:10:44.556 A:middle
include as much information as

00:10:44.556 --> 00:10:46.226 A:middle
possible so that you can present

00:10:46.376 --> 00:10:49.386 A:middle
as rich of a UI as possible.

00:10:49.486 --> 00:10:51.406 A:middle
Second, make sure that you set

00:10:51.406 --> 00:10:53.106 A:middle
an apns-expiration on your push

00:10:53.356 --> 00:10:54.896 A:middle
to 0 or something small.

00:10:56.006 --> 00:10:57.506 A:middle
In this way, the user won't

00:10:57.506 --> 00:10:59.616 A:middle
receive a push minutes later for

00:10:59.616 --> 00:11:00.596 A:middle
a call that is no longer

00:10:59.616 --> 00:11:00.596 A:middle
a call that is no longer

00:11:00.596 --> 00:11:01.016 A:middle
dialing.

00:11:01.846 --> 00:11:03.796 A:middle
So, for example, if someone

00:11:03.796 --> 00:11:05.646 A:middle
called my device, and the push

00:11:05.646 --> 00:11:07.536 A:middle
took two minutes to send, then I

00:11:07.536 --> 00:11:08.576 A:middle
wouldn't want to report an

00:11:08.576 --> 00:11:09.736 A:middle
incoming call once the push

00:11:09.736 --> 00:11:10.966 A:middle
comes in two minutes later

00:11:11.356 --> 00:11:12.886 A:middle
because that person is probably

00:11:12.886 --> 00:11:13.776 A:middle
not dialing anymore.

00:11:14.106 --> 00:11:15.716 A:middle
So, if we set the expiration to

00:11:15.716 --> 00:11:17.326 A:middle
0, which means deliver

00:11:17.326 --> 00:11:18.896 A:middle
immediately or fail or something

00:11:18.896 --> 00:11:20.176 A:middle
on the order of a few seconds,

00:11:20.446 --> 00:11:21.726 A:middle
then we know that if the device

00:11:21.726 --> 00:11:23.326 A:middle
is receiving a push, it's still

00:11:23.326 --> 00:11:24.216 A:middle
for a phone call that's

00:11:24.216 --> 00:11:24.556 A:middle
relevant.

00:11:25.986 --> 00:11:27.696 A:middle
And, it's important to note that

00:11:27.696 --> 00:11:29.216 A:middle
if you prefer a banner, you can

00:11:29.216 --> 00:11:30.936 A:middle
always just use standard pushes

00:11:30.936 --> 00:11:32.676 A:middle
instead of the full-- and that

00:11:32.676 --> 00:11:33.596 A:middle
way you don't have to a full

00:11:33.596 --> 00:11:34.756 A:middle
screen in call UI.

00:11:35.276 --> 00:11:36.656 A:middle
And you can use a notification

00:11:36.656 --> 00:11:37.996 A:middle
service extension if you need to

00:11:37.996 --> 00:11:39.056 A:middle
modify the content of your

00:11:39.056 --> 00:11:39.356 A:middle
pushes.

00:11:39.606 --> 00:11:41.176 A:middle
For example, if you needed to

00:11:42.456 --> 00:11:42.576 A:middle
Decrypt them.

00:11:42.776 --> 00:11:44.346 A:middle
So that was VoIP pushes and

00:11:44.346 --> 00:11:44.926 A:middle
phone calls.

00:11:45.336 --> 00:11:46.716 A:middle
Now let's talk about muted

00:11:46.716 --> 00:11:47.106 A:middle
threads.

00:11:48.616 --> 00:11:50.276 A:middle
So, when a user has a messaging

00:11:50.276 --> 00:11:51.546 A:middle
app, they might be messaging a

00:11:51.546 --> 00:11:52.636 A:middle
lot of different friends or a

00:11:52.636 --> 00:11:53.546 A:middle
lot of different groups of

00:11:53.546 --> 00:11:55.186 A:middle
friends, and some of these

00:11:55.186 --> 00:11:56.956 A:middle
threads can get pretty chatty,

00:11:56.956 --> 00:11:58.306 A:middle
and the user might not want an

00:11:58.306 --> 00:12:00.096 A:middle
alert for that specific thread.

00:11:58.306 --> 00:12:00.096 A:middle
alert for that specific thread.

00:12:00.636 --> 00:12:02.706 A:middle
But, the content may still be

00:12:02.706 --> 00:12:03.256 A:middle
relevant.

00:12:03.256 --> 00:12:04.596 A:middle
It may still be nice to have.

00:12:04.896 --> 00:12:06.286 A:middle
When the user hops back into the

00:12:06.286 --> 00:12:07.316 A:middle
app, they want to be able to see

00:12:07.316 --> 00:12:07.726 A:middle
the message.

00:12:08.016 --> 00:12:09.326 A:middle
They just don't want to be told

00:12:09.326 --> 00:12:10.596 A:middle
every time the message is coming

00:12:10.596 --> 00:12:11.816 A:middle
in by having their device

00:12:11.816 --> 00:12:12.216 A:middle
vibrate.

00:12:13.106 --> 00:12:14.386 A:middle
And so we need a way to alert

00:12:14.386 --> 00:12:16.416 A:middle
the device but not the user

00:12:16.866 --> 00:12:18.746 A:middle
about content being available.

00:12:19.966 --> 00:12:21.496 A:middle
To do so, you should use

00:12:21.496 --> 00:12:22.396 A:middle
background pushes.

00:12:23.676 --> 00:12:24.886 A:middle
Background pushes are a

00:12:24.886 --> 00:12:26.146 A:middle
mechanism to tell the device

00:12:26.246 --> 00:12:27.506 A:middle
that new data is available

00:12:27.746 --> 00:12:29.096 A:middle
without alerting the user.

00:12:30.616 --> 00:12:32.236 A:middle
To use these, you just send a

00:12:32.236 --> 00:12:33.576 A:middle
push with the content available

00:12:33.576 --> 00:12:36.046 A:middle
flag set to 1 without an alert,

00:12:36.046 --> 00:12:37.196 A:middle
a sound, or a badge.

00:12:37.866 --> 00:12:38.796 A:middle
And then the system will

00:12:38.796 --> 00:12:40.176 A:middle
intelligently decide when to

00:12:40.176 --> 00:12:41.446 A:middle
launch the app to download the

00:12:41.446 --> 00:12:44.146 A:middle
content based on power and

00:12:44.146 --> 00:12:45.526 A:middle
performance impacts and trying

00:12:45.526 --> 00:12:46.206 A:middle
to minimize that.

00:12:46.556 --> 00:12:47.736 A:middle
So, to look at this on a

00:12:47.736 --> 00:12:48.986 A:middle
timeline, it might look

00:12:48.986 --> 00:12:49.896 A:middle
something like this.

00:12:50.636 --> 00:12:51.876 A:middle
The user might foreground the

00:12:51.876 --> 00:12:53.356 A:middle
app and decide to mute a

00:12:53.356 --> 00:12:54.426 A:middle
specific thread.

00:12:54.696 --> 00:12:56.026 A:middle
Then at some point in the

00:12:56.026 --> 00:12:57.466 A:middle
future, someone might message

00:12:57.466 --> 00:12:58.936 A:middle
that thread, and a background

00:12:58.936 --> 00:12:59.876 A:middle
push will be received by the

00:12:59.876 --> 00:13:00.236 A:middle
device.

00:12:59.876 --> 00:13:00.236 A:middle
device.

00:13:01.356 --> 00:13:03.056 A:middle
Sometime after that, the app

00:13:03.056 --> 00:13:04.426 A:middle
will be launched and get some

00:13:04.426 --> 00:13:06.056 A:middle
run time to fetch that content,

00:13:06.766 --> 00:13:08.066 A:middle
and then when the user comes

00:13:08.066 --> 00:13:09.556 A:middle
back to the app later on in the

00:13:09.556 --> 00:13:11.616 A:middle
day and foregrounds it, the user

00:13:11.616 --> 00:13:12.866 A:middle
will open the thread and see

00:13:12.866 --> 00:13:14.316 A:middle
that the content is right there.

00:13:14.926 --> 00:13:16.346 A:middle
And, there's some very important

00:13:16.346 --> 00:13:17.196 A:middle
new things with background

00:13:17.196 --> 00:13:18.256 A:middle
pushes too.

00:13:19.186 --> 00:13:21.346 A:middle
You must set the apns-priority

00:13:21.346 --> 00:13:23.446 A:middle
to 5 or your app will not

00:13:23.446 --> 00:13:26.926 A:middle
launch, and you should also set

00:13:26.926 --> 00:13:27.966 A:middle
the apns push type to

00:13:27.966 --> 00:13:28.556 A:middle
background.

00:13:28.826 --> 00:13:30.986 A:middle
This is required for watchOS but

00:13:30.986 --> 00:13:32.986 A:middle
we highly recommend it for all

00:13:32.986 --> 00:13:33.586 A:middle
platforms.

00:13:33.926 --> 00:13:35.296 A:middle
And if you want more information

00:13:35.296 --> 00:13:37.476 A:middle
about pushes on watchOS, you can

00:13:37.476 --> 00:13:38.706 A:middle
see the creating independent

00:13:38.706 --> 00:13:39.866 A:middle
watch app session from

00:13:39.866 --> 00:13:40.296 A:middle
yesterday.

00:13:40.946 --> 00:13:45.076 A:middle
So to recap, for muted threads,

00:13:45.286 --> 00:13:46.906 A:middle
use background pushes as a best

00:13:46.906 --> 00:13:47.846 A:middle
effort way to download the

00:13:47.846 --> 00:13:50.826 A:middle
content, and in cases where

00:13:50.826 --> 00:13:52.436 A:middle
maybe the app didn't runtime

00:13:52.436 --> 00:13:53.906 A:middle
after the background push was

00:13:53.906 --> 00:13:55.396 A:middle
received, you can always just

00:13:55.396 --> 00:13:56.846 A:middle
download that content when the

00:13:56.846 --> 00:13:58.196 A:middle
app re-enters the foreground.

00:13:58.196 --> 00:14:01.386 A:middle
Now, let's talk about

00:13:58.196 --> 00:14:01.386 A:middle
Now, let's talk about

00:14:01.386 --> 00:14:02.706 A:middle
downloading past attachments.

00:14:03.346 --> 00:14:05.966 A:middle
Say the user signs into their

00:14:05.966 --> 00:14:09.016 A:middle
account, and it's a new device.

00:14:09.776 --> 00:14:11.316 A:middle
There might be some content that

00:14:11.316 --> 00:14:12.406 A:middle
they immediately want from their

00:14:12.406 --> 00:14:13.736 A:middle
account, like their conversation

00:14:13.736 --> 00:14:15.336 A:middle
list or some recent messages.

00:14:16.736 --> 00:14:17.786 A:middle
But there might be a bunch of

00:14:17.786 --> 00:14:19.766 A:middle
older content that it would be

00:14:19.766 --> 00:14:20.566 A:middle
nice if you didn't have to

00:14:20.566 --> 00:14:21.886 A:middle
download it right when the user

00:14:21.886 --> 00:14:22.396 A:middle
was in the app.

00:14:23.686 --> 00:14:25.856 A:middle
To visualize this, why download

00:14:25.856 --> 00:14:26.706 A:middle
it while the user is in the

00:14:26.766 --> 00:14:28.286 A:middle
foreground and potentially

00:14:28.286 --> 00:14:29.906 A:middle
impact their performance or

00:14:29.906 --> 00:14:31.936 A:middle
battery life when we could do it

00:14:31.936 --> 00:14:33.286 A:middle
at some point when the device is

00:14:33.286 --> 00:14:34.406 A:middle
charging and idle.

00:14:35.936 --> 00:14:37.416 A:middle
The way to do this is to use a

00:14:37.416 --> 00:14:38.866 A:middle
discretionary background URL

00:14:38.866 --> 00:14:39.196 A:middle
session.

00:14:40.066 --> 00:14:42.046 A:middle
This allows the system to defer

00:14:42.046 --> 00:14:43.566 A:middle
a download until a better time,

00:14:44.146 --> 00:14:45.896 A:middle
and it's an API that allows you

00:14:45.896 --> 00:14:47.956 A:middle
to pass more information so that

00:14:47.956 --> 00:14:49.126 A:middle
it can be smarter about

00:14:49.126 --> 00:14:49.696 A:middle
scheduling it.

00:14:50.476 --> 00:14:52.486 A:middle
To use it, you simply set up a

00:14:52.486 --> 00:14:53.806 A:middle
background URL session the way

00:14:53.806 --> 00:14:55.886 A:middle
you would normally, and then you

00:14:55.886 --> 00:14:57.446 A:middle
set your discretionary flag to

00:14:57.446 --> 00:14:57.806 A:middle
true.

00:14:58.376 --> 00:15:00.346 A:middle
Let's take a look at some of

00:14:58.376 --> 00:15:00.346 A:middle
Let's take a look at some of

00:15:00.346 --> 00:15:01.796 A:middle
those additional information

00:15:01.796 --> 00:15:02.686 A:middle
that you might be able to pass

00:15:02.686 --> 00:15:03.676 A:middle
in so that the system can be

00:15:03.676 --> 00:15:04.066 A:middle
smarter.

00:15:05.596 --> 00:15:06.856 A:middle
You can pass in timeout

00:15:06.856 --> 00:15:07.276 A:middle
intervals.

00:15:07.606 --> 00:15:09.016 A:middle
Maybe you don't want it to keep

00:15:09.016 --> 00:15:09.826 A:middle
attempting to download

00:15:09.826 --> 00:15:11.056 A:middle
something, so you want to bound

00:15:11.056 --> 00:15:11.776 A:middle
how long it does it.

00:15:13.186 --> 00:15:14.596 A:middle
You could pass in an earliest

00:15:14.596 --> 00:15:15.186 A:middle
begin date.

00:15:15.416 --> 00:15:16.266 A:middle
Maybe you don't want to do an

00:15:16.266 --> 00:15:17.816 A:middle
upload or a download until some

00:15:17.816 --> 00:15:18.726 A:middle
point later in the future.

00:15:19.366 --> 00:15:21.346 A:middle
And, you can pass in an expected

00:15:21.346 --> 00:15:23.106 A:middle
workload size so that the system

00:15:23.106 --> 00:15:25.606 A:middle
knows how much work it should

00:15:25.606 --> 00:15:27.026 A:middle
expect to do when it runs your

00:15:27.026 --> 00:15:28.000 A:middle
download.

00:15:30.346 --> 00:15:31.986 A:middle
So, when you're downloading past

00:15:31.986 --> 00:15:33.576 A:middle
attachments, you want to defer

00:15:33.576 --> 00:15:35.296 A:middle
the work if possible to minimize

00:15:35.296 --> 00:15:37.606 A:middle
the user-visible impact, and we

00:15:37.606 --> 00:15:39.106 A:middle
can apply the same principles to

00:15:39.106 --> 00:15:40.406 A:middle
any deferrable download or

00:15:40.406 --> 00:15:40.786 A:middle
upload.

00:15:41.106 --> 00:15:42.166 A:middle
So, maybe you have some

00:15:42.166 --> 00:15:43.226 A:middle
analytics you want to batch

00:15:43.226 --> 00:15:44.566 A:middle
together and upload at a better

00:15:44.566 --> 00:15:45.836 A:middle
time, or maybe you have some

00:15:45.836 --> 00:15:47.256 A:middle
photos the user took that you

00:15:47.256 --> 00:15:48.346 A:middle
want to back up later on.

00:15:49.806 --> 00:15:51.646 A:middle
So, to recap, we had a messaging

00:15:51.646 --> 00:15:52.876 A:middle
app, and it features some core

00:15:52.876 --> 00:15:53.496 A:middle
functionality.

00:15:53.986 --> 00:15:55.436 A:middle
You can send messages, make

00:15:55.436 --> 00:15:57.336 A:middle
phone calls, allow the user to

00:15:57.336 --> 00:15:58.356 A:middle
mute threads, and you can

00:15:58.356 --> 00:15:59.436 A:middle
download past attachments.

00:15:59.956 --> 00:16:01.746 A:middle
And we used a different API to

00:15:59.956 --> 00:16:01.746 A:middle
And we used a different API to

00:16:01.746 --> 00:16:02.666 A:middle
accomplish each of these.

00:16:02.976 --> 00:16:04.066 A:middle
We used a background task

00:16:04.066 --> 00:16:05.516 A:middle
completion to guard that our

00:16:05.516 --> 00:16:06.696 A:middle
message would send even if the

00:16:06.696 --> 00:16:07.466 A:middle
user left the app.

00:16:07.856 --> 00:16:09.326 A:middle
We used VoIP pushes as a way to

00:16:09.326 --> 00:16:10.256 A:middle
enable phone calls.

00:16:10.646 --> 00:16:12.596 A:middle
We used background pushes as a

00:16:12.596 --> 00:16:14.286 A:middle
best effort way to give the app

00:16:14.286 --> 00:16:15.896 A:middle
runtime to respond to new

00:16:15.896 --> 00:16:17.176 A:middle
content, and we used a

00:16:17.176 --> 00:16:18.746 A:middle
discretionary URL session to

00:16:18.746 --> 00:16:19.846 A:middle
download attachments at the

00:16:19.846 --> 00:16:20.336 A:middle
right time.

00:16:21.606 --> 00:16:22.516 A:middle
But there are still many other

00:16:22.516 --> 00:16:23.736 A:middle
uses cases that are not

00:16:23.736 --> 00:16:24.716 A:middle
currently covered by our

00:16:24.716 --> 00:16:26.296 A:middle
existing modes, and so I'd like

00:16:26.296 --> 00:16:27.456 A:middle
to invite my colleague, Thomas,

00:16:27.456 --> 00:16:29.126 A:middle
up to introduce a new background

00:16:29.126 --> 00:16:30.276 A:middle
mode and framework designed

00:16:30.276 --> 00:16:31.346 A:middle
specifically for these use

00:16:31.346 --> 00:16:31.666 A:middle
cases.

00:16:32.106 --> 00:16:32.816 A:middle
Thanks everyone.

00:16:32.981 --> 00:16:34.981 A:middle
[ Applause ]

00:16:35.146 --> 00:16:35.716 A:middle
&gt;&gt; Thanks, Roberto.

00:16:36.776 --> 00:16:38.076 A:middle
So let's talk about these use

00:16:38.076 --> 00:16:38.436 A:middle
cases.

00:16:39.716 --> 00:16:41.706 A:middle
These are things like actively

00:16:41.706 --> 00:16:43.186 A:middle
syncing state with the server,

00:16:43.616 --> 00:16:45.386 A:middle
cleaning up your databases, or

00:16:45.386 --> 00:16:46.766 A:middle
backing up data to the Cloud.

00:16:47.256 --> 00:16:48.316 A:middle
These are deferrable,

00:16:48.476 --> 00:16:50.386 A:middle
maintenance-type tasks that

00:16:50.586 --> 00:16:51.926 A:middle
ideally you would want to do in

00:16:51.926 --> 00:16:53.546 A:middle
the background in order not to

00:16:53.546 --> 00:16:55.526 A:middle
impact foreground user activity.

00:16:56.336 --> 00:16:58.016 A:middle
And what we see today, is that

00:16:58.016 --> 00:16:59.436 A:middle
apps are doing this kind of work

00:16:59.706 --> 00:17:00.766 A:middle
right as they enter the

00:16:59.706 --> 00:17:00.766 A:middle
right as they enter the

00:17:00.766 --> 00:17:02.416 A:middle
background, and over the course

00:17:02.416 --> 00:17:04.165 A:middle
of an entire day, that can

00:17:04.165 --> 00:17:05.086 A:middle
really add up.

00:17:06.266 --> 00:17:07.136 A:middle
So, what if you could take all

00:17:07.136 --> 00:17:08.476 A:middle
that work and defer it to later,

00:17:08.786 --> 00:17:10.346 A:middle
perhaps when the device is on

00:17:10.346 --> 00:17:11.816 A:middle
charger and otherwise idle?

00:17:12.986 --> 00:17:14.406 A:middle
That's what we're introducing

00:17:14.406 --> 00:17:15.846 A:middle
this year with a brand-new

00:17:15.846 --> 00:17:17.586 A:middle
background mode and framework to

00:17:17.586 --> 00:17:19.126 A:middle
go along with it that we call

00:17:19.126 --> 00:17:20.096 A:middle
background tasks.

00:17:20.736 --> 00:17:22.175 A:middle
Background tasks let's you

00:17:22.175 --> 00:17:23.546 A:middle
schedule work to do in the

00:17:23.546 --> 00:17:24.935 A:middle
background later.

00:17:26.386 --> 00:17:28.986 A:middle
We're making it available on

00:17:29.236 --> 00:17:32.256 A:middle
iOS, iPadOS, tvOS, and iPad apps

00:17:32.256 --> 00:17:32.806 A:middle
on the Mac.

00:17:33.946 --> 00:17:35.796 A:middle
And not only are we introducing

00:17:35.796 --> 00:17:37.526 A:middle
this new background mode we call

00:17:37.526 --> 00:17:38.956 A:middle
background processing tasks,

00:17:39.496 --> 00:17:40.426 A:middle
we're also taking this

00:17:40.426 --> 00:17:42.076 A:middle
opportunity to refine the

00:17:42.076 --> 00:17:44.196 A:middle
existing API for background app

00:17:44.276 --> 00:17:44.876 A:middle
refresh.

00:17:45.316 --> 00:17:47.936 A:middle
So, let's talk about the new

00:17:47.936 --> 00:17:48.616 A:middle
background mode.

00:17:49.386 --> 00:17:51.256 A:middle
Background processing tasks give

00:17:51.256 --> 00:17:52.816 A:middle
your apps several minutes of

00:17:52.816 --> 00:17:54.706 A:middle
runtime at system friendly times

00:17:55.236 --> 00:17:57.006 A:middle
so you can do that deferrable

00:17:57.006 --> 00:17:58.446 A:middle
maintenance-level work I

00:17:58.446 --> 00:17:59.966 A:middle
mentioned earlier as well as

00:17:59.966 --> 00:18:01.826 A:middle
entirely new things, such as

00:17:59.966 --> 00:18:01.826 A:middle
entirely new things, such as

00:18:01.906 --> 00:18:04.246 A:middle
on-device, Core ML, training and

00:18:04.246 --> 00:18:05.386 A:middle
inference in the background,

00:18:05.576 --> 00:18:06.666 A:middle
which you can learn about in

00:18:06.666 --> 00:18:07.500 A:middle
their session.

00:18:09.296 --> 00:18:10.896 A:middle
CPU Monitor is a feature in our

00:18:10.896 --> 00:18:12.536 A:middle
systems that automatically

00:18:12.536 --> 00:18:13.766 A:middle
terminates apps that use too

00:18:13.766 --> 00:18:15.306 A:middle
many CPU cycles in the

00:18:15.306 --> 00:18:17.166 A:middle
background in order to protect

00:18:17.476 --> 00:18:18.336 A:middle
user's battery life.

00:18:18.716 --> 00:18:20.626 A:middle
For the first time ever, we're

00:18:20.626 --> 00:18:22.206 A:middle
giving you the ability to turn

00:18:22.206 --> 00:18:23.786 A:middle
that off for the duration of

00:18:23.786 --> 00:18:25.356 A:middle
your processing task so you can

00:18:25.356 --> 00:18:26.616 A:middle
take full advantage of the

00:18:26.616 --> 00:18:28.316 A:middle
hardware while the device is

00:18:28.316 --> 00:18:28.766 A:middle
plugged in.

00:18:29.346 --> 00:18:32.106 A:middle
And finally, we'll make sure

00:18:32.106 --> 00:18:33.726 A:middle
that you're eligible to run

00:18:33.726 --> 00:18:35.356 A:middle
these tasks as long as you

00:18:35.356 --> 00:18:36.766 A:middle
request them when your app is

00:18:36.766 --> 00:18:38.796 A:middle
foreground or if your app has

00:18:38.796 --> 00:18:40.036 A:middle
been recently used in the

00:18:40.036 --> 00:18:40.516 A:middle
foreground.

00:18:41.006 --> 00:18:45.076 A:middle
Next, I'd like to talk about the

00:18:45.076 --> 00:18:46.996 A:middle
new API for background app

00:18:47.096 --> 00:18:47.666 A:middle
refresh.

00:18:48.756 --> 00:18:50.586 A:middle
This is a new API, but it has

00:18:50.696 --> 00:18:51.896 A:middle
the same policies as the

00:18:51.896 --> 00:18:53.446 A:middle
existing one, which means your

00:18:53.556 --> 00:18:55.116 A:middle
app will get 30 seconds of run

00:18:55.116 --> 00:18:56.796 A:middle
time, each time it's launched,

00:18:57.096 --> 00:18:58.766 A:middle
to fetch new content and keep

00:18:58.766 --> 00:19:00.076 A:middle
itself up to date throughout the

00:18:58.766 --> 00:19:00.076 A:middle
itself up to date throughout the

00:19:00.076 --> 00:19:00.330 A:middle
day.

00:19:02.366 --> 00:19:04.076 A:middle
How often your app is launched

00:19:04.076 --> 00:19:06.006 A:middle
and at what times depends on how

00:19:06.006 --> 00:19:07.566 A:middle
the user has historically used

00:19:07.566 --> 00:19:07.916 A:middle
your app.

00:19:08.966 --> 00:19:11.016 A:middle
So, if the user typically uses

00:19:11.016 --> 00:19:12.896 A:middle
your app in the morning, the

00:19:12.956 --> 00:19:14.806 A:middle
afternoon, and the evening, the

00:19:15.026 --> 00:19:16.356 A:middle
system will learn this pattern

00:19:16.356 --> 00:19:17.566 A:middle
and start launching your app

00:19:17.716 --> 00:19:19.406 A:middle
shortly before those times so

00:19:19.406 --> 00:19:21.046 A:middle
you have an opportunity to get

00:19:21.046 --> 00:19:22.826 A:middle
the content you need.

00:19:23.026 --> 00:19:24.976 A:middle
This also means that an app that

00:19:24.976 --> 00:19:26.726 A:middle
isn't used as frequently may not

00:19:26.726 --> 00:19:29.936 A:middle
launch as frequently as well.

00:19:30.136 --> 00:19:31.586 A:middle
As I mentioned, this is the new

00:19:31.586 --> 00:19:33.486 A:middle
API for background app refresh,

00:19:33.716 --> 00:19:34.736 A:middle
so we're deprecating the

00:19:34.736 --> 00:19:36.456 A:middle
existing ones on UI Application

00:19:36.716 --> 00:19:37.216 A:middle
seen here.

00:19:38.216 --> 00:19:39.586 A:middle
These APIs will continue the

00:19:39.586 --> 00:19:41.266 A:middle
work the same way they do today

00:19:41.476 --> 00:19:45.026 A:middle
on iOS, iPadOS, and tvOS devices

00:19:45.346 --> 00:19:46.496 A:middle
but they're not supported on

00:19:46.496 --> 00:19:48.246 A:middle
Mac, so make sure to adopt

00:19:48.246 --> 00:19:49.806 A:middle
background tasks for background

00:19:49.806 --> 00:19:51.566 A:middle
app refresh on Mac.

00:19:53.706 --> 00:19:55.026 A:middle
Let's take a look at how this

00:19:55.026 --> 00:19:55.816 A:middle
API works.

00:19:56.916 --> 00:19:58.416 A:middle
Let's say we have an app and a

00:19:58.416 --> 00:19:59.536 A:middle
couple of extensions that's

00:19:59.536 --> 00:19:59.976 A:middle
contained within.

00:20:00.736 --> 00:20:02.926 A:middle
The primary object that you will

00:20:02.926 --> 00:20:04.796 A:middle
be interacting with is the BG

00:20:04.796 --> 00:20:06.156 A:middle
Task Scheduler.

00:20:07.506 --> 00:20:09.556 A:middle
The BG Task Scheduler is your

00:20:09.556 --> 00:20:11.106 A:middle
interface to the systems

00:20:11.106 --> 00:20:13.156 A:middle
intelligent, dynamic activity

00:20:13.156 --> 00:20:14.646 A:middle
scheduler that constantly

00:20:14.646 --> 00:20:16.106 A:middle
monitors various system

00:20:16.106 --> 00:20:18.016 A:middle
conditions including battery

00:20:18.016 --> 00:20:20.186 A:middle
level, app usage, network

00:20:20.186 --> 00:20:23.056 A:middle
connectivity, and more.

00:20:23.246 --> 00:20:24.926 A:middle
While your app is running, you

00:20:24.926 --> 00:20:26.616 A:middle
can request that it be woken up

00:20:26.616 --> 00:20:27.636 A:middle
later to do work in the

00:20:27.636 --> 00:20:28.126 A:middle
background.

00:20:28.826 --> 00:20:30.596 A:middle
To do so, you'll create an

00:20:30.596 --> 00:20:32.776 A:middle
instance of a BG task request

00:20:32.776 --> 00:20:35.476 A:middle
object that corresponds to the

00:20:35.476 --> 00:20:36.476 A:middle
type of task you would like to

00:20:36.476 --> 00:20:36.976 A:middle
perform.

00:20:37.436 --> 00:20:39.326 A:middle
In this case, we want to do a

00:20:39.326 --> 00:20:41.326 A:middle
background app refresh so I made

00:20:41.456 --> 00:20:43.386 A:middle
a BG app refresh task request.

00:20:44.256 --> 00:20:45.286 A:middle
And we submit that to the

00:20:45.286 --> 00:20:45.756 A:middle
scheduler.

00:20:46.356 --> 00:20:48.726 A:middle
If you have several types of

00:20:48.726 --> 00:20:50.016 A:middle
tasks you want to do, you can

00:20:50.016 --> 00:20:51.366 A:middle
submit multiple requests.

00:20:51.706 --> 00:20:53.106 A:middle
In this case, we also want to do

00:20:53.106 --> 00:20:54.886 A:middle
some database cleanup, so I'm

00:20:54.886 --> 00:20:56.466 A:middle
going to make a BG processing

00:20:56.466 --> 00:20:57.966 A:middle
task request and submit it as

00:20:57.966 --> 00:20:59.000 A:middle
well.

00:21:00.256 --> 00:21:02.086 A:middle
You can also submit requests

00:21:02.296 --> 00:21:03.686 A:middle
from an extension while it's

00:21:03.686 --> 00:21:03.976 A:middle
running.

00:21:05.126 --> 00:21:06.886 A:middle
So, if our keyboard extension

00:21:06.886 --> 00:21:08.496 A:middle
wants to do some learning based

00:21:08.496 --> 00:21:10.186 A:middle
on the user's typing habits, it

00:21:10.186 --> 00:21:11.776 A:middle
can create a BG processing task

00:21:11.776 --> 00:21:13.256 A:middle
request and submit it too.

00:21:14.176 --> 00:21:15.506 A:middle
As you can see, you can have

00:21:15.506 --> 00:21:17.586 A:middle
multiple pending BG processing

00:21:17.586 --> 00:21:19.796 A:middle
task requests, each representing

00:21:20.006 --> 00:21:22.336 A:middle
a specific task you would like

00:21:22.336 --> 00:21:24.186 A:middle
your app to do.

00:21:24.426 --> 00:21:25.696 A:middle
Now the scheduler knows about

00:21:25.696 --> 00:21:27.056 A:middle
all the tasks our app would like

00:21:27.056 --> 00:21:29.616 A:middle
to do, and when all the

00:21:29.616 --> 00:21:31.256 A:middle
necessary system conditions and

00:21:31.256 --> 00:21:33.206 A:middle
policies are satisfied, it's

00:21:33.206 --> 00:21:35.366 A:middle
going to fulfill that task by

00:21:35.366 --> 00:21:36.646 A:middle
waking up your app and launching

00:21:36.646 --> 00:21:38.506 A:middle
it into the background and

00:21:38.506 --> 00:21:40.676 A:middle
deliver it a BG task object

00:21:40.916 --> 00:21:42.396 A:middle
corresponding to that task you

00:21:42.396 --> 00:21:43.026 A:middle
should perform.

00:21:43.706 --> 00:21:45.486 A:middle
In this case, we got a BG app

00:21:45.486 --> 00:21:47.616 A:middle
refresh task, so we can now

00:21:47.616 --> 00:21:48.816 A:middle
perform a background app

00:21:48.856 --> 00:21:50.786 A:middle
refresh, fetch content, and

00:21:50.786 --> 00:21:51.356 A:middle
update our UI.

00:21:52.476 --> 00:21:53.866 A:middle
When we're done, we're going to

00:21:53.866 --> 00:21:56.066 A:middle
call set task completed, and

00:21:56.066 --> 00:21:57.376 A:middle
that's going to mark the task

00:21:57.376 --> 00:21:58.786 A:middle
complete and allow your app to

00:21:58.786 --> 00:21:59.500 A:middle
suspend.

00:22:00.476 --> 00:22:02.456 A:middle
Depending on how you configure

00:22:02.626 --> 00:22:04.216 A:middle
the BG task request and on

00:22:04.216 --> 00:22:05.366 A:middle
various system conditions and

00:22:05.366 --> 00:22:07.226 A:middle
policies, we may choose to

00:22:07.226 --> 00:22:08.856 A:middle
launch your app for multiple

00:22:08.856 --> 00:22:10.216 A:middle
tasks at the same time.

00:22:11.036 --> 00:22:12.746 A:middle
So, in this case, our app is

00:22:12.746 --> 00:22:14.966 A:middle
launched and delivered both BG

00:22:14.966 --> 00:22:16.756 A:middle
processing tasks requested

00:22:16.756 --> 00:22:17.176 A:middle
earlier.

00:22:18.556 --> 00:22:19.686 A:middle
When your app is launched, it's

00:22:19.686 --> 00:22:21.556 A:middle
given a finite amount of time to

00:22:21.556 --> 00:22:22.746 A:middle
complete the work it's given,

00:22:22.916 --> 00:22:24.566 A:middle
and that time is allotted per

00:22:24.566 --> 00:22:26.746 A:middle
launch, not per task, so you

00:22:26.746 --> 00:22:28.226 A:middle
should be prepared to

00:22:28.226 --> 00:22:29.686 A:middle
concurrently handle all the

00:22:29.686 --> 00:22:31.066 A:middle
tasks you're given in the time

00:22:31.066 --> 00:22:31.446 A:middle
allotted.

00:22:32.246 --> 00:22:34.016 A:middle
Also, note that that processing

00:22:34.016 --> 00:22:36.066 A:middle
task requested from the keyboard

00:22:36.066 --> 00:22:37.796 A:middle
extension was delivered to the

00:22:37.796 --> 00:22:39.706 A:middle
main app, and that's because

00:22:40.026 --> 00:22:41.956 A:middle
it's always the main containing

00:22:41.956 --> 00:22:43.536 A:middle
app that is launched to handle

00:22:43.536 --> 00:22:45.026 A:middle
background tasks, never

00:22:45.026 --> 00:22:45.566 A:middle
extensions.

00:22:46.156 --> 00:22:49.206 A:middle
When your app is done doing the

00:22:49.206 --> 00:22:50.686 A:middle
necessary work in call set task

00:22:50.686 --> 00:22:52.446 A:middle
completed on all of the BG task

00:22:52.446 --> 00:22:53.926 A:middle
objects it's given, it'll

00:22:53.926 --> 00:22:54.356 A:middle
suspend.

00:22:55.086 --> 00:22:56.766 A:middle
So that's a high-level overview

00:22:56.906 --> 00:22:58.266 A:middle
of how to use the background

00:22:58.266 --> 00:22:58.766 A:middle
task API.

00:22:59.386 --> 00:23:01.336 A:middle
You create and submit BG task

00:22:59.386 --> 00:23:01.336 A:middle
You create and submit BG task

00:23:01.336 --> 00:23:02.976 A:middle
requests to the BG task

00:23:02.976 --> 00:23:04.966 A:middle
scheduler, wait for the system

00:23:04.966 --> 00:23:05.866 A:middle
to launch your app into the

00:23:05.866 --> 00:23:07.396 A:middle
background, perform the

00:23:07.396 --> 00:23:09.116 A:middle
necessary work, and then call

00:23:09.286 --> 00:23:11.176 A:middle
set task completed on the BG

00:23:11.176 --> 00:23:11.966 A:middle
task objects.

00:23:12.916 --> 00:23:14.276 A:middle
And to walk you through how you

00:23:14.276 --> 00:23:15.156 A:middle
would implement this in your

00:23:15.156 --> 00:23:16.396 A:middle
app, I'd like to step you

00:23:16.396 --> 00:23:17.926 A:middle
through a demo.

00:23:18.516 --> 00:23:23.796 A:middle
[ Applause ]

00:23:24.296 --> 00:23:25.926 A:middle
So this is our app.

00:23:25.926 --> 00:23:27.296 A:middle
It's called Color Feed, and it's

00:23:27.296 --> 00:23:29.006 A:middle
a typical social media type app

00:23:29.336 --> 00:23:31.186 A:middle
except instead of a feed of

00:23:31.246 --> 00:23:32.686 A:middle
photos, you get a feed of the

00:23:32.686 --> 00:23:33.876 A:middle
latest trending colors.

00:23:34.446 --> 00:23:36.526 A:middle
And what you can see is that I

00:23:36.526 --> 00:23:37.876 A:middle
can scroll through and see what

00:23:37.876 --> 00:23:39.536 A:middle
the latest colors are at various

00:23:39.536 --> 00:23:40.306 A:middle
points in time.

00:23:40.956 --> 00:23:42.386 A:middle
So, what I would really like to

00:23:42.386 --> 00:23:44.166 A:middle
do is make sure that my app can

00:23:44.166 --> 00:23:45.446 A:middle
keep itself up to date and

00:23:45.446 --> 00:23:46.836 A:middle
refresh itself throughout the

00:23:46.836 --> 00:23:48.076 A:middle
day without the user having to

00:23:48.076 --> 00:23:49.276 A:middle
go in and manually do that.

00:23:49.746 --> 00:23:51.276 A:middle
And the perfect tool for this is

00:23:51.276 --> 00:23:52.296 A:middle
background app refresh.

00:23:52.486 --> 00:23:53.666 A:middle
So, I'll implement it with

00:23:53.666 --> 00:23:54.466 A:middle
background tasks.

00:23:55.896 --> 00:23:57.356 A:middle
The first thing you need to do

00:23:57.796 --> 00:23:59.906 A:middle
is add the required keys to your

00:23:59.906 --> 00:24:01.416 A:middle
info.plist to declare your

00:23:59.906 --> 00:24:01.416 A:middle
info.plist to declare your

00:24:01.416 --> 00:24:03.286 A:middle
support for background tasks and

00:24:03.316 --> 00:24:04.336 A:middle
background app refresh.

00:24:04.946 --> 00:24:06.956 A:middle
So, I'm going to go here into my

00:24:06.956 --> 00:24:09.556 A:middle
project settings, click on the

00:24:09.786 --> 00:24:13.496 A:middle
target for my app, and go into

00:24:13.496 --> 00:24:14.876 A:middle
the signing and capabilities

00:24:15.026 --> 00:24:15.330 A:middle
tab.

00:24:16.586 --> 00:24:18.206 A:middle
I'm going to click the plus sign

00:24:18.246 --> 00:24:20.416 A:middle
and add a new capability for

00:24:20.416 --> 00:24:21.346 A:middle
background modes.

00:24:21.996 --> 00:24:25.386 A:middle
As you can see, it added this

00:24:25.386 --> 00:24:26.606 A:middle
new section, and we need to

00:24:26.606 --> 00:24:27.886 A:middle
choose the right background mode

00:24:28.016 --> 00:24:29.126 A:middle
for this type of task.

00:24:29.586 --> 00:24:30.886 A:middle
In this case, for background app

00:24:30.886 --> 00:24:32.366 A:middle
refresh, the box is labeled

00:24:32.436 --> 00:24:34.046 A:middle
background fetch, just like with

00:24:34.046 --> 00:24:34.536 A:middle
the old API.

00:24:34.886 --> 00:24:35.896 A:middle
So, I'll go ahead and check

00:24:36.376 --> 00:24:36.500 A:middle
that.

00:24:38.046 --> 00:24:39.606 A:middle
Next, I'm going to head into my

00:24:39.746 --> 00:24:41.516 A:middle
ask info.plist file and I'm

00:24:41.516 --> 00:24:46.136 A:middle
going to click the plus sign to

00:24:46.136 --> 00:24:46.946 A:middle
add a new key.

00:24:47.496 --> 00:24:50.416 A:middle
This key is called permitted

00:24:50.506 --> 00:24:51.776 A:middle
background task scheduler

00:24:51.776 --> 00:24:52.376 A:middle
identifiers.

00:24:52.986 --> 00:24:54.786 A:middle
And it's an array of strings.

00:24:55.406 --> 00:24:57.286 A:middle
So, each string in this array

00:24:57.426 --> 00:24:59.256 A:middle
uniquely identifies a specific

00:24:59.256 --> 00:25:01.296 A:middle
task your app wants to do, and

00:24:59.256 --> 00:25:01.296 A:middle
task your app wants to do, and

00:25:01.456 --> 00:25:02.566 A:middle
it should be unique within your

00:25:02.566 --> 00:25:02.796 A:middle
app.

00:25:03.246 --> 00:25:04.716 A:middle
We recommend using reverse DNS

00:25:04.826 --> 00:25:06.416 A:middle
notation to avoid conflicts with

00:25:06.416 --> 00:25:07.676 A:middle
any third-party frameworks you

00:25:07.676 --> 00:25:08.836 A:middle
may be using.

00:25:09.616 --> 00:25:11.646 A:middle
So, here, I'm going to expand

00:25:11.646 --> 00:25:12.936 A:middle
that array and click the plus

00:25:12.936 --> 00:25:14.156 A:middle
sign to add a new string.

00:25:14.946 --> 00:25:16.066 A:middle
And I'll call it

00:25:16.256 --> 00:25:20.796 A:middle
com.colorfeed.refresh and hit

00:25:20.796 --> 00:25:21.036 A:middle
save.

00:25:22.346 --> 00:25:23.986 A:middle
Next, I need to actually

00:25:23.986 --> 00:25:25.486 A:middle
implement the code to handle

00:25:25.486 --> 00:25:26.496 A:middle
when my app is launched.

00:25:26.886 --> 00:25:28.066 A:middle
So, I'm going to do that in my

00:25:28.066 --> 00:25:28.656 A:middle
app delegate.

00:25:29.896 --> 00:25:32.786 A:middle
I'll head into my app delegate

00:25:32.786 --> 00:25:34.146 A:middle
file, and the first thing I need

00:25:34.146 --> 00:25:35.416 A:middle
to do is import background

00:25:35.416 --> 00:25:36.000 A:middle
tasks.

00:25:39.666 --> 00:25:40.006 A:middle
All right.

00:25:41.096 --> 00:25:43.346 A:middle
So, the next step is to tell the

00:25:43.346 --> 00:25:44.686 A:middle
system what you want to do when

00:25:44.686 --> 00:25:45.916 A:middle
you get launched, and you do

00:25:45.916 --> 00:25:47.686 A:middle
this by registering a launch

00:25:47.686 --> 00:25:49.606 A:middle
handler before your application

00:25:49.606 --> 00:25:50.446 A:middle
finishes launching.

00:25:51.196 --> 00:25:53.576 A:middle
So, in my application did finish

00:25:53.576 --> 00:25:54.796 A:middle
launching with options method,

00:25:55.546 --> 00:25:59.356 A:middle
I'm going to call BG task

00:25:59.586 --> 00:26:01.986 A:middle
scheduler shared, register for

00:25:59.586 --> 00:26:01.986 A:middle
scheduler shared, register for

00:26:01.986 --> 00:26:03.776 A:middle
task with identifier and then

00:26:03.776 --> 00:26:06.186 A:middle
pass in that same identifier I

00:26:06.186 --> 00:26:07.456 A:middle
just put into the info.plist.

00:26:08.696 --> 00:26:10.296 A:middle
The next parameter is a dispatch

00:26:10.296 --> 00:26:11.926 A:middle
queue, which is what my handler

00:26:11.926 --> 00:26:13.246 A:middle
will be called on, and I can

00:26:13.246 --> 00:26:14.636 A:middle
specify a queue that I'm using

00:26:14.796 --> 00:26:15.826 A:middle
if I want to synchronize with

00:26:15.826 --> 00:26:17.076 A:middle
other things in my app.

00:26:17.406 --> 00:26:19.196 A:middle
Or, I can pass in nil, and the

00:26:19.196 --> 00:26:20.756 A:middle
system will create a background

00:26:20.756 --> 00:26:22.516 A:middle
serial queue for me.

00:26:23.156 --> 00:26:25.246 A:middle
The next parameter is the actual

00:26:25.246 --> 00:26:26.326 A:middle
launch handler, which is what

00:26:26.326 --> 00:26:27.866 A:middle
will be called when my app is

00:26:27.866 --> 00:26:28.786 A:middle
launched for the task.

00:26:29.506 --> 00:26:31.086 A:middle
As you can see, it takes one

00:26:31.086 --> 00:26:32.766 A:middle
parameter of type BG task.

00:26:34.076 --> 00:26:36.026 A:middle
What I'm going to do is I'm

00:26:36.026 --> 00:26:38.896 A:middle
going to call a method I'll

00:26:38.896 --> 00:26:40.786 A:middle
write called handle app refresh

00:26:41.066 --> 00:26:43.396 A:middle
and downcast that BG task object

00:26:43.626 --> 00:26:45.966 A:middle
to a BG app refresh task since

00:26:45.966 --> 00:26:47.076 A:middle
this is used for background app

00:26:47.076 --> 00:26:47.566 A:middle
refreshes.

00:26:48.446 --> 00:26:49.856 A:middle
I'm going to go ahead and write

00:26:49.856 --> 00:26:51.056 A:middle
that handle app refresh method

00:26:51.806 --> 00:26:52.000 A:middle
now.

00:26:54.616 --> 00:26:56.236 A:middle
Here, I've written all the code

00:26:56.236 --> 00:26:57.926 A:middle
I need to actually perform the

00:26:57.926 --> 00:26:58.976 A:middle
background app refresh.

00:26:59.246 --> 00:27:00.366 A:middle
It's going to fetch the latest

00:26:59.246 --> 00:27:00.366 A:middle
It's going to fetch the latest

00:27:00.366 --> 00:27:02.046 A:middle
content from the server, update

00:27:02.046 --> 00:27:03.686 A:middle
my database, and update my UI.

00:27:04.666 --> 00:27:05.946 A:middle
But to integrate this with

00:27:05.946 --> 00:27:07.836 A:middle
background tasks, there are two

00:27:07.836 --> 00:27:08.786 A:middle
things I need to do.

00:27:09.656 --> 00:27:11.166 A:middle
The first is to handle

00:27:11.166 --> 00:27:11.926 A:middle
expiration.

00:27:12.506 --> 00:27:14.116 A:middle
Your task is given a limited

00:27:14.116 --> 00:27:17.086 A:middle
amount of time to finish, so

00:27:17.346 --> 00:27:18.756 A:middle
when your time is almost out,

00:27:18.856 --> 00:27:19.946 A:middle
we'll warn you and give you a

00:27:19.946 --> 00:27:20.936 A:middle
chance to quickly wrap

00:27:20.936 --> 00:27:22.106 A:middle
everything up and complete your

00:27:22.106 --> 00:27:22.346 A:middle
work.

00:27:23.016 --> 00:27:24.816 A:middle
The system may also choose to

00:27:24.816 --> 00:27:26.846 A:middle
terminate your task early in

00:27:26.846 --> 00:27:28.466 A:middle
case the system decides the

00:27:28.466 --> 00:27:29.376 A:middle
conditions are no longer

00:27:29.376 --> 00:27:30.546 A:middle
sufficient for you to run your

00:27:31.736 --> 00:27:31.896 A:middle
task.

00:27:32.136 --> 00:27:34.016 A:middle
So what I'm going to do is set

00:27:34.016 --> 00:27:37.036 A:middle
an expiration handler on the

00:27:37.036 --> 00:27:38.696 A:middle
task, and in the expiration

00:27:38.696 --> 00:27:40.336 A:middle
handler, I'm going to call

00:27:40.336 --> 00:27:41.736 A:middle
cancel all operations on my

00:27:41.736 --> 00:27:43.086 A:middle
operation queue, and that's

00:27:43.086 --> 00:27:44.656 A:middle
going to stop all the work I'm

00:27:44.656 --> 00:27:45.966 A:middle
doing and cancel any work that I

00:27:45.966 --> 00:27:47.466 A:middle
haven't even started yet.

00:27:48.196 --> 00:27:50.546 A:middle
The next thing I need to do is

00:27:50.546 --> 00:27:53.326 A:middle
to call set task completed on

00:27:53.326 --> 00:27:54.766 A:middle
the task when I'm done with my

00:27:54.766 --> 00:27:55.000 A:middle
work.

00:27:56.286 --> 00:27:58.016 A:middle
I need to do this even if the

00:27:58.016 --> 00:27:59.296 A:middle
expiration handler has been

00:27:59.296 --> 00:27:59.676 A:middle
called.

00:28:00.706 --> 00:28:02.926 A:middle
And if I fail to do this, the

00:28:02.926 --> 00:28:04.346 A:middle
system may actually terminate my

00:28:04.346 --> 00:28:06.336 A:middle
app, and that will impact launch

00:28:06.336 --> 00:28:07.146 A:middle
performance later, and I

00:28:07.146 --> 00:28:07.996 A:middle
definitely don't want to do

00:28:07.996 --> 00:28:08.196 A:middle
that.

00:28:08.656 --> 00:28:11.216 A:middle
So, what I'm going to do is I'm

00:28:11.216 --> 00:28:14.666 A:middle
going to say that when my last

00:28:14.666 --> 00:28:16.396 A:middle
operation in that queue is

00:28:16.396 --> 00:28:18.266 A:middle
complete, I'm going to call set

00:28:18.266 --> 00:28:19.786 A:middle
task completed, and I'm taking

00:28:19.786 --> 00:28:20.916 A:middle
advantage of the fact that

00:28:21.086 --> 00:28:22.516 A:middle
operations always call their

00:28:22.516 --> 00:28:24.116 A:middle
completion block regardless if

00:28:24.116 --> 00:28:25.416 A:middle
they were cancelled early or

00:28:25.416 --> 00:28:26.816 A:middle
they finish normally, and I'm

00:28:26.816 --> 00:28:28.376 A:middle
using that to determine if my

00:28:28.376 --> 00:28:29.816 A:middle
task completed successfully or

00:28:30.406 --> 00:28:30.500 A:middle
not.

00:28:31.136 --> 00:28:31.906 A:middle
All right.

00:28:31.906 --> 00:28:34.116 A:middle
So the last step is to actually

00:28:34.116 --> 00:28:36.616 A:middle
schedule a BG task request, and

00:28:36.686 --> 00:28:38.246 A:middle
I'm going to do that when my app

00:28:38.296 --> 00:28:39.556 A:middle
enters the background because

00:28:39.556 --> 00:28:40.696 A:middle
that's when the user has stopped

00:28:40.696 --> 00:28:41.286 A:middle
using my app.

00:28:41.626 --> 00:28:42.656 A:middle
So, I'll go ahead and write that

00:28:42.656 --> 00:28:43.000 A:middle
now.

00:28:47.386 --> 00:28:49.086 A:middle
As you can see, I'm calling a

00:28:49.086 --> 00:28:50.176 A:middle
method I just wrote called

00:28:50.176 --> 00:28:51.696 A:middle
schedule app refresh, and my

00:28:51.696 --> 00:28:53.176 A:middle
application did enter background

00:28:53.176 --> 00:28:53.496 A:middle
method.

00:28:53.796 --> 00:28:55.876 A:middle
And here, I'm creating a BG app

00:28:55.976 --> 00:28:57.956 A:middle
refresh task request object and

00:28:57.956 --> 00:28:59.756 A:middle
passing in again that same

00:28:59.756 --> 00:29:00.396 A:middle
identifier.

00:28:59.756 --> 00:29:00.396 A:middle
identifier.

00:29:00.396 --> 00:29:03.606 A:middle
I then submit to that request to

00:29:03.606 --> 00:29:05.016 A:middle
the being task scheduler.

00:29:06.446 --> 00:29:07.776 A:middle
There's one additional property

00:29:07.976 --> 00:29:09.516 A:middle
I want to call out on the being

00:29:09.516 --> 00:29:11.596 A:middle
task request object, and that's

00:29:11.786 --> 00:29:12.756 A:middle
earliest begin date.

00:29:13.446 --> 00:29:14.816 A:middle
This is how you can specify a

00:29:14.816 --> 00:29:16.096 A:middle
start delay for your task.

00:29:16.546 --> 00:29:18.026 A:middle
So, in this case, I'm saying

00:29:18.316 --> 00:29:20.126 A:middle
don't start app refresh, don't

00:29:20.126 --> 00:29:22.376 A:middle
start refreshing my app until at

00:29:22.376 --> 00:29:23.686 A:middle
least 15 minutes from when I

00:29:23.686 --> 00:29:25.106 A:middle
schedule it, and this lets me

00:29:25.106 --> 00:29:26.636 A:middle
get the same behavior as with

00:29:26.636 --> 00:29:28.426 A:middle
the old set minimum background

00:29:28.426 --> 00:29:29.266 A:middle
fetch interval API.

00:29:29.906 --> 00:29:32.366 A:middle
So, I schedule my task, but

00:29:32.786 --> 00:29:34.006 A:middle
there's actually one more thing

00:29:34.096 --> 00:29:35.646 A:middle
I'll probably want to do.

00:29:36.646 --> 00:29:39.096 A:middle
Because every single BG task

00:29:39.096 --> 00:29:40.326 A:middle
request object corresponds to

00:29:40.326 --> 00:29:42.906 A:middle
exactly one launch, right now if

00:29:42.906 --> 00:29:44.026 A:middle
my app gets launched for a

00:29:44.026 --> 00:29:45.616 A:middle
background app refresh, it won't

00:29:45.616 --> 00:29:46.776 A:middle
get launched again until the

00:29:46.776 --> 00:29:48.126 A:middle
user enters and then leaves my

00:29:48.126 --> 00:29:48.386 A:middle
app.

00:29:48.856 --> 00:29:49.606 A:middle
But I don't want that.

00:29:49.606 --> 00:29:50.816 A:middle
I want it to keep refreshing

00:29:50.996 --> 00:29:51.596 A:middle
throughout the day.

00:29:51.926 --> 00:29:54.026 A:middle
So, all I have to do is call

00:29:54.146 --> 00:29:55.706 A:middle
schedule app refresh in my

00:29:55.706 --> 00:29:56.396 A:middle
handle method.

00:29:57.216 --> 00:29:58.316 A:middle
So, I'll schedule another

00:29:58.316 --> 00:29:59.826 A:middle
request as soon as I get launch

00:29:59.826 --> 00:30:00.546 A:middle
for an existing one.

00:29:59.826 --> 00:30:00.546 A:middle
for an existing one.

00:30:01.416 --> 00:30:02.326 A:middle
And that's it.

00:30:02.326 --> 00:30:03.636 A:middle
That's all the code I need to

00:30:03.636 --> 00:30:04.996 A:middle
write to handle background app

00:30:04.996 --> 00:30:06.906 A:middle
refresh in my app.

00:30:07.196 --> 00:30:08.716 A:middle
But, as I'm using my app and I'm

00:30:08.716 --> 00:30:11.226 A:middle
scrolling through, I'm seeing

00:30:11.226 --> 00:30:12.346 A:middle
that there are like a lot of

00:30:12.346 --> 00:30:13.826 A:middle
entries from a really long time

00:30:13.826 --> 00:30:15.136 A:middle
ago, things that are probably

00:30:15.136 --> 00:30:16.286 A:middle
not relevant to the user

00:30:16.286 --> 00:30:17.716 A:middle
anymore, and just taking up disk

00:30:17.716 --> 00:30:17.976 A:middle
space.

00:30:17.976 --> 00:30:19.606 A:middle
So it would be really great if

00:30:19.606 --> 00:30:21.096 A:middle
we could clean our database up

00:30:21.136 --> 00:30:23.056 A:middle
for the user, and the best tool

00:30:23.056 --> 00:30:25.306 A:middle
for that is BG processing tasks.

00:30:25.536 --> 00:30:26.556 A:middle
So, I'll go ahead and implement

00:30:26.556 --> 00:30:27.156 A:middle
that as well.

00:30:28.516 --> 00:30:29.856 A:middle
Just like before, I'm going to

00:30:29.856 --> 00:30:31.036 A:middle
head into my project settings,

00:30:32.036 --> 00:30:33.116 A:middle
the signing and capabilities

00:30:33.116 --> 00:30:35.736 A:middle
tab, and this time, in

00:30:35.736 --> 00:30:37.196 A:middle
background modes, I'm going to

00:30:37.196 --> 00:30:38.256 A:middle
make sure to check the

00:30:38.256 --> 00:30:39.846 A:middle
background processing checkbox.

00:30:40.376 --> 00:30:45.526 A:middle
I'll go into my info.plist and

00:30:46.756 --> 00:30:48.506 A:middle
hit the plus sign to add a new

00:30:48.506 --> 00:30:49.046 A:middle
identifier.

00:30:49.736 --> 00:30:50.806 A:middle
This one I'll call

00:30:50.806 --> 00:30:56.296 A:middle
com.colorfeed.dbcleaning and hit

00:30:56.296 --> 00:30:56.866 A:middle
save.

00:30:57.576 --> 00:30:59.826 A:middle
Then, just like before, I'll go

00:30:59.826 --> 00:31:02.316 A:middle
into my app delegate and call

00:30:59.826 --> 00:31:02.316 A:middle
into my app delegate and call

00:31:02.316 --> 00:31:03.676 A:middle
register again.

00:31:06.636 --> 00:31:08.716 A:middle
Here, it's the same call I made

00:31:08.716 --> 00:31:10.126 A:middle
earlier, except I'm passing in

00:31:10.126 --> 00:31:12.686 A:middle
the new identifier, and I'm

00:31:12.686 --> 00:31:14.936 A:middle
calling handle database cleaning

00:31:15.116 --> 00:31:16.366 A:middle
and down casting to BG

00:31:16.366 --> 00:31:17.686 A:middle
processing task instead.

00:31:18.596 --> 00:31:19.986 A:middle
I'll go ahead and implement

00:31:19.986 --> 00:31:20.976 A:middle
handle database cleaning now.

00:31:27.246 --> 00:31:28.336 A:middle
I've already integrated this

00:31:28.336 --> 00:31:30.486 A:middle
code with background tasks, and

00:31:30.486 --> 00:31:31.836 A:middle
what it does is it just deletes

00:31:31.836 --> 00:31:32.916 A:middle
everything that's older than the

00:31:32.916 --> 00:31:33.426 A:middle
past day.

00:31:34.266 --> 00:31:35.756 A:middle
As you can see, I make sure to

00:31:35.756 --> 00:31:37.156 A:middle
set an expiration handler and

00:31:37.156 --> 00:31:39.726 A:middle
cancel all my operations, and I

00:31:39.726 --> 00:31:41.176 A:middle
make sure to call set task

00:31:41.176 --> 00:31:42.836 A:middle
completed with success when I'm

00:31:42.836 --> 00:31:42.976 A:middle
done.

00:31:44.036 --> 00:31:45.266 A:middle
One thing I am doing differently

00:31:45.266 --> 00:31:47.066 A:middle
here is I'm keeping track of the

00:31:47.066 --> 00:31:48.606 A:middle
last time I successfully cleaned

00:31:48.606 --> 00:31:49.236 A:middle
my database.

00:31:49.796 --> 00:31:52.736 A:middle
I'm doing this because when I

00:31:52.736 --> 00:31:54.246 A:middle
schedule my task, I want to be

00:31:54.246 --> 00:31:55.836 A:middle
conscientious of how I'm using

00:31:55.836 --> 00:31:56.906 A:middle
the system's resources.

00:31:57.106 --> 00:31:58.536 A:middle
I don't want to schedule a

00:31:58.536 --> 00:31:59.896 A:middle
database cleaning task every

00:31:59.896 --> 00:32:01.336 A:middle
time the user leaves my app if

00:31:59.896 --> 00:32:01.336 A:middle
time the user leaves my app if

00:32:01.336 --> 00:32:02.586 A:middle
my database doesn't actually

00:32:02.586 --> 00:32:03.666 A:middle
need to be cleaned.

00:32:03.956 --> 00:32:05.486 A:middle
So, what I'm going to do is

00:32:05.486 --> 00:32:07.436 A:middle
write a method called schedule

00:32:07.436 --> 00:32:09.606 A:middle
database cleaning if needed.

00:32:11.256 --> 00:32:13.176 A:middle
And here, I'm just checking that

00:32:13.406 --> 00:32:14.806 A:middle
if it hasn't been at least a

00:32:14.806 --> 00:32:16.306 A:middle
week since I last cleaned it,

00:32:16.386 --> 00:32:17.936 A:middle
don't do anything and bail out

00:32:17.936 --> 00:32:18.396 A:middle
immediately.

00:32:19.316 --> 00:32:20.596 A:middle
Otherwise, I'll go ahead and

00:32:20.596 --> 00:32:21.556 A:middle
schedule that request.

00:32:22.146 --> 00:32:23.736 A:middle
I'll create a BG processing task

00:32:23.736 --> 00:32:25.756 A:middle
request and pass it that same

00:32:25.756 --> 00:32:26.826 A:middle
identifier I did before.

00:32:27.426 --> 00:32:29.386 A:middle
There are some additional

00:32:29.386 --> 00:32:31.046 A:middle
properties on the BG processing

00:32:31.046 --> 00:32:32.176 A:middle
task request you may want to be

00:32:32.176 --> 00:32:32.566 A:middle
aware of.

00:32:33.326 --> 00:32:35.396 A:middle
The first is requires network

00:32:35.396 --> 00:32:37.066 A:middle
connectivity, and this actually

00:32:37.066 --> 00:32:37.876 A:middle
defaults to false.

00:32:38.506 --> 00:32:39.766 A:middle
You should make sure to set this

00:32:39.766 --> 00:32:41.576 A:middle
to true if you actually require

00:32:41.736 --> 00:32:42.866 A:middle
network connectivity for your

00:32:42.866 --> 00:32:44.826 A:middle
task because otherwise we may

00:32:44.826 --> 00:32:46.116 A:middle
launch your task at a time where

00:32:46.116 --> 00:32:47.346 A:middle
there is no network and you

00:32:47.346 --> 00:32:48.456 A:middle
won't be able to do much work.

00:32:49.186 --> 00:32:50.116 A:middle
In our case, we're doing some

00:32:50.116 --> 00:32:51.836 A:middle
local database maintenance, so

00:32:51.836 --> 00:32:52.986 A:middle
we can just leave this as false.

00:32:53.406 --> 00:32:56.156 A:middle
The next is requires external

00:32:56.196 --> 00:32:56.596 A:middle
power.

00:32:57.846 --> 00:32:59.506 A:middle
Now, depending on the specific

00:32:59.536 --> 00:33:01.306 A:middle
type of device and various

00:32:59.536 --> 00:33:01.306 A:middle
type of device and various

00:33:01.306 --> 00:33:02.676 A:middle
system conditions and policies,

00:33:03.046 --> 00:33:05.006 A:middle
we may tend to launch apps while

00:33:05.236 --> 00:33:06.066 A:middle
they're plugged in and on

00:33:06.066 --> 00:33:06.936 A:middle
charger anyway.

00:33:07.606 --> 00:33:10.216 A:middle
However, if you require, if you

00:33:10.216 --> 00:33:11.846 A:middle
are requiring yourself to do

00:33:11.966 --> 00:33:13.716 A:middle
intensive work and use a lot of

00:33:13.716 --> 00:33:15.666 A:middle
resources, we highly recommend

00:33:15.856 --> 00:33:17.006 A:middle
that you set this to true so

00:33:17.006 --> 00:33:18.146 A:middle
that you can preserve your

00:33:18.146 --> 00:33:19.086 A:middle
user's battery life.

00:33:19.676 --> 00:33:21.596 A:middle
Setting this to true is also how

00:33:21.596 --> 00:33:23.306 A:middle
you'll disable CPU monitor for

00:33:23.306 --> 00:33:24.566 A:middle
CPU intensive tasks.

00:33:25.116 --> 00:33:26.786 A:middle
And that's it.

00:33:26.906 --> 00:33:28.046 A:middle
I'm going to go ahead and submit

00:33:28.046 --> 00:33:28.916 A:middle
that request through the

00:33:28.916 --> 00:33:30.356 A:middle
scheduler, and I'm going to do

00:33:30.356 --> 00:33:32.746 A:middle
that, if I need to, when my

00:33:32.746 --> 00:33:33.736 A:middle
application enters the

00:33:33.736 --> 00:33:34.176 A:middle
background.

00:33:35.576 --> 00:33:36.626 A:middle
So that's all the code I need to

00:33:36.626 --> 00:33:37.856 A:middle
write to handle both background

00:33:37.966 --> 00:33:39.436 A:middle
app refresh and background

00:33:39.436 --> 00:33:40.326 A:middle
processing tasks.

00:33:41.066 --> 00:33:41.936 A:middle
But how do I know this all

00:33:41.936 --> 00:33:42.466 A:middle
works?

00:33:43.056 --> 00:33:44.516 A:middle
I'd like to think I'm perfect

00:33:44.516 --> 00:33:46.946 A:middle
program, but that's obviously

00:33:46.946 --> 00:33:47.846 A:middle
not always the case.

00:33:48.226 --> 00:33:50.686 A:middle
So, the best way to test this

00:33:50.756 --> 00:33:52.486 A:middle
end to end is to live on your

00:33:52.486 --> 00:33:53.726 A:middle
device and use it like a user

00:33:53.726 --> 00:33:55.116 A:middle
would, and that will make sure

00:33:55.116 --> 00:33:56.506 A:middle
that you can get the time and

00:33:56.506 --> 00:33:57.696 A:middle
policies that you need for your

00:33:57.696 --> 00:33:58.816 A:middle
specific task.

00:33:59.376 --> 00:34:01.076 A:middle
But, we also know that you don't

00:33:59.376 --> 00:34:01.076 A:middle
But, we also know that you don't

00:34:01.076 --> 00:34:02.146 A:middle
have time to just sit there and

00:34:02.146 --> 00:34:04.116 A:middle
wait when you're coding, so we

00:34:04.176 --> 00:34:05.236 A:middle
added a couple of methods you

00:34:05.236 --> 00:34:07.196 A:middle
can call in a debugger to debug

00:34:07.196 --> 00:34:08.876 A:middle
your use of background tasks,

00:34:09.025 --> 00:34:09.985 A:middle
and let me demonstrate that for

00:34:09.985 --> 00:34:10.346 A:middle
you now.

00:34:11.286 --> 00:34:12.766 A:middle
I'm going to build and run this

00:34:12.766 --> 00:34:14.536 A:middle
new version of background tasks

00:34:14.536 --> 00:34:14.936 A:middle
onto my iPhone.

00:34:21.206 --> 00:34:23.286 A:middle
As you see, it launched, and now

00:34:23.286 --> 00:34:24.295 A:middle
I'm going to send it into the

00:34:24.295 --> 00:34:26.576 A:middle
background to make sure that my

00:34:26.576 --> 00:34:27.676 A:middle
task requests are scheduled.

00:34:28.596 --> 00:34:30.366 A:middle
I'll bring it back, and here,

00:34:30.706 --> 00:34:32.306 A:middle
I'm going to click the pause

00:34:32.335 --> 00:34:35.356 A:middle
button right here on the bottom.

00:34:35.516 --> 00:34:36.696 A:middle
This will enter the debugger.

00:34:37.966 --> 00:34:39.246 A:middle
And I can see the console right

00:34:39.246 --> 00:34:39.446 A:middle
here.

00:34:40.416 --> 00:34:41.775 A:middle
What I'm going to do is I'm

00:34:41.775 --> 00:34:42.835 A:middle
going to paste in the command

00:34:42.996 --> 00:34:43.726 A:middle
that's available in our

00:34:43.726 --> 00:34:45.466 A:middle
documentation so no need to

00:34:45.466 --> 00:34:46.045 A:middle
write this down.

00:34:47.266 --> 00:34:49.406 A:middle
Here, all I have to do is

00:34:49.406 --> 00:34:51.076 A:middle
replace the word task identifier

00:34:51.266 --> 00:34:52.496 A:middle
with the identifier of the task

00:34:52.496 --> 00:34:53.235 A:middle
I want to simulate.

00:34:53.456 --> 00:34:54.876 A:middle
I want to test background app

00:34:54.876 --> 00:34:56.146 A:middle
refresh, so I'll type in

00:34:56.146 --> 00:34:58.326 A:middle
com.colorfeed.refresh.

00:34:58.966 --> 00:35:00.196 A:middle
But the steps are the same for

00:34:58.966 --> 00:35:00.196 A:middle
But the steps are the same for

00:35:00.196 --> 00:35:01.276 A:middle
my processing task as well.

00:35:02.186 --> 00:35:04.706 A:middle
I'll hit enter, and as you can

00:35:04.706 --> 00:35:06.066 A:middle
see, the system has recognized

00:35:06.066 --> 00:35:07.356 A:middle
that I want to simulate a launch

00:35:07.576 --> 00:35:08.566 A:middle
for my background app refresh

00:35:09.346 --> 00:35:09.486 A:middle
task.

00:35:10.486 --> 00:35:11.786 A:middle
I'll hit the play button right

00:35:11.786 --> 00:35:12.000 A:middle
here.

00:35:15.356 --> 00:35:17.516 A:middle
And as you can see, the system

00:35:17.516 --> 00:35:18.896 A:middle
is starting my app refresh task,

00:35:18.896 --> 00:35:19.956 A:middle
and my app is actively

00:35:19.956 --> 00:35:21.486 A:middle
refreshing, and I can see that

00:35:21.486 --> 00:35:21.966 A:middle
it's working.

00:35:22.596 --> 00:35:24.406 A:middle
I'm going to hit pause again,

00:35:25.016 --> 00:35:26.666 A:middle
and this time I'll make sure

00:35:26.856 --> 00:35:28.196 A:middle
that expiration works as well,

00:35:28.236 --> 00:35:29.126 A:middle
because that's equally

00:35:29.126 --> 00:35:29.656 A:middle
important.

00:35:30.576 --> 00:35:31.816 A:middle
What I'm going to do is I'm

00:35:31.816 --> 00:35:33.526 A:middle
going to enter that same command

00:35:34.116 --> 00:35:35.576 A:middle
except this time I'm going to

00:35:35.576 --> 00:35:36.946 A:middle
replace the word launch with

00:35:36.946 --> 00:35:39.126 A:middle
expiration and hit enter.

00:35:40.596 --> 00:35:41.586 A:middle
As you can see, the system

00:35:41.586 --> 00:35:42.646 A:middle
recognized that I made this

00:35:42.646 --> 00:35:44.486 A:middle
request, and when I hit play,

00:35:44.906 --> 00:35:46.346 A:middle
you should see that my app has

00:35:46.346 --> 00:35:47.696 A:middle
successfully stopped refreshing,

00:35:47.896 --> 00:35:49.436 A:middle
recognized that it expired, and

00:35:49.436 --> 00:35:50.456 A:middle
mark the task complete.

00:35:51.186 --> 00:35:53.146 A:middle
So, I know now that my app has

00:35:53.256 --> 00:35:54.736 A:middle
both successfully implemented

00:35:54.886 --> 00:35:56.556 A:middle
and tested background app

00:35:56.556 --> 00:35:57.666 A:middle
refresh and background

00:35:57.896 --> 00:35:59.826 A:middle
processing tasks with background

00:35:59.826 --> 00:36:00.330 A:middle
tasks.

00:35:59.826 --> 00:36:00.330 A:middle
tasks.

00:36:01.516 --> 00:36:05.546 A:middle
[ Applause ]

00:36:06.046 --> 00:36:06.396 A:middle
Thank you.

00:36:07.576 --> 00:36:08.336 A:middle
There are some additional

00:36:08.336 --> 00:36:09.686 A:middle
considerations that you may want

00:36:09.686 --> 00:36:11.056 A:middle
to be aware of when you use our

00:36:11.056 --> 00:36:11.366 A:middle
framework.

00:36:12.596 --> 00:36:14.686 A:middle
First, be aware of how you set

00:36:14.686 --> 00:36:16.036 A:middle
earliest begin date, and don't

00:36:16.036 --> 00:36:17.256 A:middle
set it too far in the future.

00:36:17.926 --> 00:36:18.936 A:middle
If you set it too far in the

00:36:18.936 --> 00:36:20.456 A:middle
future and the user doesn't come

00:36:20.456 --> 00:36:21.516 A:middle
back to your app in the

00:36:21.516 --> 00:36:23.266 A:middle
meantime, we may choose to not

00:36:23.266 --> 00:36:24.836 A:middle
launch your task at all, and

00:36:24.836 --> 00:36:26.356 A:middle
that's just to protect users

00:36:26.356 --> 00:36:28.356 A:middle
expectations and privacy.

00:36:28.746 --> 00:36:30.446 A:middle
A user that doesn't use your app

00:36:30.446 --> 00:36:32.106 A:middle
for months does not expect that

00:36:32.106 --> 00:36:33.186 A:middle
it suddenly starts running in

00:36:33.186 --> 00:36:33.736 A:middle
the background.

00:36:34.156 --> 00:36:36.046 A:middle
So, we recommend that you keep

00:36:36.046 --> 00:36:37.936 A:middle
earliest begin date, your delays

00:36:37.936 --> 00:36:39.976 A:middle
we earliest begin date, down to

00:36:39.976 --> 00:36:41.426 A:middle
a week or less.

00:36:42.616 --> 00:36:45.026 A:middle
Next, make sure that any files

00:36:45.026 --> 00:36:46.136 A:middle
you need to access during a

00:36:46.136 --> 00:36:48.096 A:middle
processing task are accessible

00:36:48.096 --> 00:36:49.106 A:middle
when the device is locked

00:36:49.546 --> 00:36:50.446 A:middle
because that's the time when

00:36:50.446 --> 00:36:51.566 A:middle
we'll typically launch your

00:36:51.566 --> 00:36:51.756 A:middle
task.

00:36:53.026 --> 00:36:54.416 A:middle
We do guarantee that we won't

00:36:54.416 --> 00:36:55.876 A:middle
start your task until the user

00:36:55.986 --> 00:36:57.606 A:middle
first unlocks their device, so

00:36:57.606 --> 00:36:58.766 A:middle
make sure any files you need to

00:36:58.766 --> 00:37:00.856 A:middle
access are at most file

00:36:58.766 --> 00:37:00.856 A:middle
access are at most file

00:37:00.856 --> 00:37:02.796 A:middle
protection type complete until

00:37:02.886 --> 00:37:04.286 A:middle
first user authentication.

00:37:04.876 --> 00:37:07.996 A:middle
We showed you how to implement

00:37:07.996 --> 00:37:09.116 A:middle
background app refresh in a

00:37:09.116 --> 00:37:11.116 A:middle
traditional single-window UIKit

00:37:11.116 --> 00:37:13.066 A:middle
app, but as you know, this year

00:37:13.066 --> 00:37:14.546 A:middle
we're introducing multiwindow

00:37:14.546 --> 00:37:16.156 A:middle
apps with a UIScene API.

00:37:16.766 --> 00:37:18.906 A:middle
If you're adopting that API, you

00:37:18.906 --> 00:37:20.656 A:middle
should make sure to call UI

00:37:20.736 --> 00:37:22.556 A:middle
application request scene

00:37:22.556 --> 00:37:23.966 A:middle
session refresh at the

00:37:23.966 --> 00:37:25.676 A:middle
appropriate time to tell the

00:37:25.676 --> 00:37:27.706 A:middle
system that the snapshot in the

00:37:27.706 --> 00:37:28.366 A:middle
app switcher needs to be

00:37:28.366 --> 00:37:28.846 A:middle
updated.

00:37:29.156 --> 00:37:30.406 A:middle
And you can find out details

00:37:30.406 --> 00:37:31.436 A:middle
about this in their

00:37:31.436 --> 00:37:32.096 A:middle
documentation.

00:37:32.736 --> 00:37:34.856 A:middle
And finally,

00:37:35.356 --> 00:37:37.376 A:middle
BGTaskScheduler.submit is a

00:37:37.376 --> 00:37:39.426 A:middle
blocking, synchronous call, and

00:37:39.426 --> 00:37:40.826 A:middle
we designed it that way because

00:37:40.826 --> 00:37:42.186 A:middle
that simplifies adoption when

00:37:42.186 --> 00:37:43.226 A:middle
you're scheduling, when you

00:37:43.226 --> 00:37:44.636 A:middle
enter the background, which is

00:37:44.636 --> 00:37:45.416 A:middle
the common case.

00:37:46.126 --> 00:37:47.446 A:middle
However, if you plan on

00:37:47.446 --> 00:37:49.296 A:middle
scheduling during more

00:37:49.296 --> 00:37:51.096 A:middle
performance-sensitive scenarios

00:37:51.536 --> 00:37:52.886 A:middle
such as when the app is being

00:37:52.886 --> 00:37:54.366 A:middle
launched, you'll want to make

00:37:54.366 --> 00:37:55.686 A:middle
sure to call it on a background

00:37:55.686 --> 00:37:57.156 A:middle
queue so you don't block the

00:37:57.156 --> 00:37:58.736 A:middle
main thread and impede your

00:37:58.736 --> 00:37:59.660 A:middle
launch performance.

00:38:01.856 --> 00:38:02.536 A:middle
All right.

00:38:02.916 --> 00:38:04.466 A:middle
So, to sum up what we talked

00:38:04.466 --> 00:38:04.956 A:middle
about today.

00:38:06.416 --> 00:38:07.966 A:middle
Be really thoughtful about how

00:38:07.966 --> 00:38:09.276 A:middle
you use your time in the

00:38:09.276 --> 00:38:11.026 A:middle
background and keep in mind, the

00:38:11.026 --> 00:38:12.876 A:middle
same things we do when we design

00:38:12.876 --> 00:38:14.586 A:middle
our APIs, things like power,

00:38:14.866 --> 00:38:16.766 A:middle
performance, and privacy.

00:38:17.306 --> 00:38:20.316 A:middle
Make sure to use the right

00:38:20.406 --> 00:38:21.806 A:middle
background mode to accomplish

00:38:21.806 --> 00:38:23.206 A:middle
the exact thing you want to do

00:38:23.296 --> 00:38:24.906 A:middle
and enable the exact user

00:38:24.906 --> 00:38:26.000 A:middle
experience you want.

00:38:28.046 --> 00:38:30.096 A:middle
And finally, use a new

00:38:30.096 --> 00:38:31.866 A:middle
background task API to schedule

00:38:31.866 --> 00:38:32.886 A:middle
work to do in the background

00:38:32.886 --> 00:38:33.256 A:middle
later.

00:38:33.656 --> 00:38:35.876 A:middle
Use BG app refresh task to keep

00:38:35.876 --> 00:38:37.106 A:middle
your app content up to date

00:38:37.106 --> 00:38:38.526 A:middle
throughout the day and BG

00:38:38.526 --> 00:38:40.456 A:middle
processing task to do deferrable

00:38:40.456 --> 00:38:42.346 A:middle
maintenance-level work when the

00:38:42.346 --> 00:38:46.556 A:middle
device is idle and on charger.

00:38:46.696 --> 00:38:48.626 A:middle
For more information, stop by

00:38:48.626 --> 00:38:50.886 A:middle
our labs or visit our session

00:38:50.886 --> 00:38:52.036 A:middle
website, for links to

00:38:52.036 --> 00:38:53.716 A:middle
documentation and sample code.

00:38:53.716 --> 00:38:53.976 A:middle
Thank you.

00:38:54.516 --> 00:38:59.500 A:middle
[ Applause ]
