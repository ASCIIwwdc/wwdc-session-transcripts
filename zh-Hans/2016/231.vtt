WEBVTT

00:00:19.353 --> 00:00:24.625
<c.magenta>CloudKit最佳实践</c>

00:00:29.796 --> 00:00:31.865
<c.magenta>早上好</c>
<c.magenta>谢谢你们来参加本次演讲</c>

00:00:31.932 --> 00:00:35.002
<c.magenta>我叫Dave Browning</c>
<c.magenta>今天和我一起的还有Nihar Sharma</c>

00:00:35.169 --> 00:00:37.538
<c.magenta>我们是CloudKit团队的工程师</c>

00:00:37.604 --> 00:00:40.140
<c.magenta>今天我们跟你们谈一些最佳实践</c>

00:00:40.207 --> 00:00:42.609
<c.magenta>来用CloudKit构建你应用</c>

00:00:43.210 --> 00:00:44.978
<c.magenta>那么 我们具体会谈些什么呢？</c>

00:00:48.382 --> 00:00:52.286
<c.magenta>这个 首先我要介绍在Apple</c>
<c.magenta>我们怎么使用CloudKit</c>

00:00:53.020 --> 00:00:56.190
<c.magenta>我会说一下整个工作流程</c>
<c.magenta>还有我们用的一些API</c>

00:00:56.256 --> 00:00:58.625
<c.magenta>我们用这些API给顾客们</c>
<c.magenta>提供流畅的体验</c>

00:00:58.692 --> 00:01:01.562
<c.magenta>我指的是让他们可以</c>
<c.magenta>一直访问相同的数据</c>

00:00:58.692 --> 00:01:01.562
<c.magenta>我指的是让他们可以</c>
<c.magenta>一直访问相同的数据</c>

00:01:01.628 --> 00:01:04.063
<c.magenta>在他们所有设备的应用里</c>

00:01:05.098 --> 00:01:07.668
<c.magenta>接着 Nihar会细说</c>

00:01:07.734 --> 00:01:09.837
<c.magenta>CKOperation API</c>
<c.magenta>的使用</c>

00:01:09.903 --> 00:01:12.973
<c.magenta>以及使用时的可配置性和灵活性</c>

00:01:13.774 --> 00:01:17.344
<c.magenta>然后 他会聊一下数据建模时</c>
<c.magenta>需要考虑的一些东西</c>

00:01:17.444 --> 00:01:20.948
<c.magenta>你在CloudKit存什么 怎样存</c>
<c.magenta>怎样建立你数据库的架构</c>

00:01:22.482 --> 00:01:24.384
<c.magenta>接下来 他会讨论错误处理</c>

00:01:24.451 --> 00:01:27.221
<c.magenta>我们说过 这对于</c>
<c.magenta>CloudKit应用来说至关重要</c>

00:01:27.287 --> 00:01:31.258
<c.magenta>他的讲话会涵盖你在用API时</c>
<c.magenta>可能会遇到的不同类型的错误</c>

00:01:31.558 --> 00:01:35.229
<c.magenta>还有怎样根据你应用的使用情况</c>
<c.magenta>考虑应对之策</c>

00:01:36.263 --> 00:01:38.932
<c.magenta>给各位提个醒 我们在Apple</c>
<c.magenta>创建了CloudKit</c>

00:01:38.999 --> 00:01:41.502
<c.magenta>还创建了很多</c>
<c.magenta>基于CloudKit的应用</c>

00:01:42.202 --> 00:01:44.404
<c.magenta>所以你们应有信心</c>
<c.magenta>你们的应用会成长和扩张</c>

00:01:44.471 --> 00:01:47.007
<c.magenta>因为我们已把应用扩展到</c>
<c.magenta>拥有数亿用户的规模</c>

00:01:47.708 --> 00:01:50.544
<c.magenta>我还想给你们</c>
<c.magenta>快速回顾一下概念模型</c>

00:01:50.677 --> 00:01:53.013
<c.magenta>在最高层 我们有所谓的容器</c>

00:01:53.080 --> 00:01:55.816
<c.magenta>这个一般跟应用一一对应起来</c>

00:01:56.149 --> 00:02:00.320
<c.magenta>Photos、Notes和你应用</c>
<c.magenta>在CloudKit有一个容器</c>

00:01:56.149 --> 00:02:00.320
<c.magenta>Photos、Notes和你应用</c>
<c.magenta>在CloudKit有一个容器</c>

00:02:01.555 --> 00:02:03.857
<c.magenta>在一个容器里</c>
<c.magenta>你有一个公用数据库</c>

00:02:04.124 --> 00:02:06.760
<c.magenta>你可以将所有用户</c>
<c.magenta>可以看到的数据存在这儿</c>

00:02:07.060 --> 00:02:09.196
<c.magenta>所以 其中一个实例是WWDC应用</c>

00:02:09.263 --> 00:02:11.832
<c.magenta>或iOS里的News应用</c>
<c.magenta>都由CloudKit创建</c>

00:02:11.899 --> 00:02:14.735
<c.magenta>它们用公用数据库来储存文章、新闻</c>

00:02:14.801 --> 00:02:16.670
<c.magenta>这些所有人都能看到的东西</c>

00:02:17.404 --> 00:02:19.072
<c.magenta>我们还有私人数据库</c>

00:02:19.273 --> 00:02:21.642
<c.magenta>你在这儿给</c>
<c.magenta>一个特定用户储存数据</c>

00:02:22.142 --> 00:02:24.711
<c.magenta>这个用户可以在</c>
<c.magenta>所有设备上看到其数据</c>

00:02:24.778 --> 00:02:26.313
<c.magenta>但别的用户都看不见</c>

00:02:27.047 --> 00:02:29.616
<c.magenta>而今年我们新增了共享数据库</c>

00:02:29.983 --> 00:02:33.520
<c.magenta>关于这个 如果你想了解更多</c>
<c.magenta>一定要看昨天演讲的视频</c>

00:02:33.587 --> 00:02:34.855
<c.magenta>“CloudKit的新特性”</c>

00:02:34.922 --> 00:02:36.890
<c.magenta>深入探讨了共享</c>

00:02:37.724 --> 00:02:40.594
<c.magenta>接着 在一个数据库里</c>
<c.magenta>你有一个地带</c>

00:02:40.661 --> 00:02:43.463
<c.magenta>在公用和私人数据库里</c>
<c.magenta>都有一个默认地带</c>

00:02:43.730 --> 00:02:46.834
<c.magenta>如果你把档案默认搁在数据库里</c>
<c.magenta>这就是档案会去到的地方</c>

00:02:46.934 --> 00:02:51.104
<c.magenta>你在私人数据库里可以选择</c>
<c.magenta>创建一个或多个自定义地带</c>

00:02:51.471 --> 00:02:53.307
<c.magenta>你便可以在那些地带储存东西</c>

00:02:53.707 --> 00:02:56.810
<c.magenta>而当一个用户</c>
<c.magenta>分享内容给另一个用户时</c>

00:02:57.110 --> 00:02:59.813
<c.magenta>这份内容就会呈现为</c>
<c.magenta>他们共享数据库里的一个共享地带</c>

00:03:00.113 --> 00:03:01.982
<c.magenta>你可以把它的本质想成是一个代理</c>

00:03:02.149 --> 00:03:04.818
<c.magenta>是所有者私人数据库和自定义地带</c>
<c.magenta>的一个代理</c>

00:03:05.586 --> 00:03:08.922
<c.magenta>当然 如果多个用户在</c>
<c.magenta>多个自定义地带跟你分享东西</c>

00:03:08.989 --> 00:03:11.758
<c.magenta>你就会见到很多共享地带</c>

00:03:11.825 --> 00:03:12.960
<c.magenta>在共享数据库里</c>

00:03:13.227 --> 00:03:17.698
<c.magenta>而在整个工作流程中 我演讲的重点</c>
<c.magenta>会在自定义和共享地带上</c>

00:03:17.965 --> 00:03:19.633
<c.magenta>就是我们刚在这儿谈的</c>

00:03:19.733 --> 00:03:22.002
<c.magenta>最后在最低级 你有档案</c>

00:03:22.069 --> 00:03:24.438
<c.magenta>这是键值结构数据存储</c>

00:03:24.505 --> 00:03:27.107
<c.magenta>一份档案永远存在于一个特定地带</c>

00:03:29.309 --> 00:03:33.046
<c.magenta>好 我快速地回顾一下</c>
<c.magenta>在高层使用CloudKit的好处</c>

00:03:33.113 --> 00:03:36.650
<c.magenta>你可以专注于构建你的应用</c>
<c.magenta>而无需为搭建后台服务操心</c>

00:03:36.717 --> 00:03:37.551
<c.magenta>我们帮你做了这步</c>

00:03:38.385 --> 00:03:41.154
<c.magenta>你的用户能够进行</c>
<c.magenta>所谓的自动认证</c>

00:03:41.488 --> 00:03:44.091
<c.magenta>是指若他们在一台设备上</c>
<c.magenta>登录了iCloud</c>

00:03:44.157 --> 00:03:46.527
<c.magenta>你就不用提示他们</c>
<c.magenta>注册、登录</c>

00:03:46.593 --> 00:03:49.196
<c.magenta>或者任何常常会</c>
<c.magenta>造成阻碍的东西</c>

00:03:49.263 --> 00:03:50.464
<c.magenta>妨碍他们使用你的应用</c>

00:03:50.697 --> 00:03:52.699
<c.magenta>他们若用CloudKit</c>
<c.magenta>登录iCloud</c>

00:03:52.766 --> 00:03:56.103
<c.magenta>你马上就有这个用户的</c>
<c.magenta>唯一标识码</c>

00:03:56.303 --> 00:03:58.372
<c.magenta>你就可以替他们</c>
<c.magenta>储存数据了</c>

00:03:59.339 --> 00:04:02.743
<c.magenta>最后 也是今天值得强调的</c>
<c.magenta>就是你可以得到同样的数据</c>

00:03:59.339 --> 00:04:02.743
<c.magenta>最后 也是今天值得强调的</c>
<c.magenta>就是你可以得到同样的数据</c>

00:04:02.809 --> 00:04:05.579
<c.magenta>不对 是你用户可以在</c>
<c.magenta>他们所有的设备上得到同样数据</c>

00:04:05.646 --> 00:04:06.813
<c.magenta>若你将数据存于CloudKit</c>

00:04:08.115 --> 00:04:11.018
<c.magenta>好 我们现在来说一下</c>
<c.magenta>我们看到的常用案例</c>

00:04:11.084 --> 00:04:13.253
<c.magenta>以CloudKit为基础</c>
<c.magenta>构建应用时</c>

00:04:13.787 --> 00:04:16.156
<c.magenta>我们看到 你有一个用户</c>
<c.magenta>在运行一个应用</c>

00:04:16.223 --> 00:04:17.991
<c.magenta>此案例里</c>
<c.magenta>谈论的主角是Notes</c>

00:04:18.058 --> 00:04:19.526
<c.magenta>Notes是</c>
<c.magenta>基于CloudKit构建的</c>

00:04:19.593 --> 00:04:23.430
<c.magenta>假设用户在iPhone上创建了</c>
<c.magenta>一个note并存到了云端</c>

00:04:23.964 --> 00:04:27.501
<c.magenta>当用户在第二台设备 比如iPad上</c>
<c.magenta>第一次打开Notes的时候</c>

00:04:28.035 --> 00:04:30.404
<c.magenta>会感觉数据</c>
<c.magenta>神一样地推送出来</c>

00:04:30.470 --> 00:04:31.872
<c.magenta>它已在iPad里了</c>

00:04:32.105 --> 00:04:33.674
<c.magenta>而且 如果他们在iPad编辑</c>

00:04:33.874 --> 00:04:36.343
<c.magenta>也会感觉数据神一样地</c>
<c.magenta>向另一个方向推送</c>

00:04:36.410 --> 00:04:39.313
<c.magenta>这就是我们想提供给</c>
<c.magenta>我们用户的使用案例</c>

00:04:40.581 --> 00:04:44.751
<c.magenta>我们应该这样想</c>
<c.magenta>iCloud服务器是真实数据的来源</c>

00:04:45.319 --> 00:04:48.121
<c.magenta>你的设备有这个</c>
<c.magenta>真实数据的本地缓存</c>

00:04:48.388 --> 00:04:51.124
<c.magenta>而CloudKit API就是</c>
<c.magenta>两者之间的桥梁</c>

00:04:53.427 --> 00:04:55.362
<c.magenta>好 所以这个实际上</c>
<c.magenta>到底是怎么运作的呢</c>

00:04:57.264 --> 00:04:59.800
<c.magenta>这个基本上就是</c>
<c.magenta>当你的应用启动的时候</c>

00:04:59.867 --> 00:05:04.071
<c.magenta>我们推荐的工作流程是</c>
<c.magenta>你从服务器获取数据的变化</c>

00:04:59.867 --> 00:05:04.071
<c.magenta>我们推荐的工作流程是</c>
<c.magenta>你从服务器获取数据的变化</c>

00:05:04.304 --> 00:05:05.839
<c.magenta>特别是在你应用首次启动时</c>

00:05:05.906 --> 00:05:08.342
<c.magenta>因为你不知道</c>
<c.magenta>有没有东西已经存在</c>

00:05:08.509 --> 00:05:10.310
<c.magenta>用户从另一台设备写了一些东西</c>

00:05:10.410 --> 00:05:13.847
<c.magenta>对吧 所以你连接到服务器</c>
<c.magenta>获取任何你还没有的数据</c>

00:05:14.348 --> 00:05:17.718
<c.magenta>然后你确保订阅了</c>
<c.magenta>未来的数据变化</c>

00:05:18.051 --> 00:05:21.455
<c.magenta>通过订阅未来的数据变化</c>
<c.magenta>你告诉CloudKit让服务器</c>

00:05:21.522 --> 00:05:23.023
<c.magenta>推送通知</c>

00:05:23.223 --> 00:05:25.526
<c.magenta>到用户其它设备上的你的应用</c>

00:05:26.026 --> 00:05:28.562
<c.magenta>接着 当然若你收到一个推送</c>
<c.magenta>你应再获取数据变化</c>

00:05:28.629 --> 00:05:31.965
<c.magenta>把用户其它设备上</c>
<c.magenta>产生的新变化下载下来</c>

00:05:33.267 --> 00:05:35.302
<c.magenta>好 我们来挖掘</c>
<c.magenta>关于这个的更多细节</c>

00:05:35.736 --> 00:05:37.070
<c.magenta>订阅数据变化</c>

00:05:37.171 --> 00:05:40.641
<c.magenta>它是这样运作的</c>
<c.magenta>当你的应用第一次运行时</c>

00:05:40.707 --> 00:05:43.710
<c.magenta>我们一会儿会探讨为什么</c>
<c.magenta>不过现在 当它第一次运行时</c>

00:05:43.777 --> 00:05:46.280
<c.magenta>你设定好订阅告诉服务器</c>

00:05:46.346 --> 00:05:48.982
<c.magenta>这些是我关心和订阅的数据</c>

00:05:49.283 --> 00:05:51.685
<c.magenta>当这些数据发生改变时</c>
<c.magenta>服务器就会告诉你</c>

00:05:51.852 --> 00:05:54.555
<c.magenta>当你的应用在</c>
<c.magenta>另一台设备上第一次启动时</c>

00:05:54.621 --> 00:05:57.624
<c.magenta>给用户的订阅可能</c>
<c.magenta>已经存在于服务器上了</c>

00:05:57.691 --> 00:06:00.260
<c.magenta>但你的应用并不知道这个</c>
<c.magenta>因为这是它第一次启动</c>

00:05:57.691 --> 00:06:00.260
<c.magenta>但你的应用并不知道这个</c>
<c.magenta>因为这是它第一次启动</c>

00:06:00.327 --> 00:06:01.962
<c.magenta>所以你要保证</c>
<c.magenta>这个订阅确实存在</c>

00:06:02.262 --> 00:06:05.265
<c.magenta>你接下来要做的跟你之前</c>
<c.magenta>在另一台设备做的一样</c>

00:06:06.433 --> 00:06:10.437
<c.magenta>现在 既然你订阅了数据变更</c>
<c.magenta>并且CloudKit会推送通知</c>

00:06:10.504 --> 00:06:13.540
<c.magenta>你就要侦听这些通知</c>
<c.magenta>我们来具体看一个例子</c>

00:06:14.141 --> 00:06:15.475
<c.magenta>用户写一个新笔记</c>

00:06:15.776 --> 00:06:17.978
<c.magenta>应用将它存于服务器上</c>

00:06:18.045 --> 00:06:20.647
<c.magenta>服务器看了看说</c>
<c.magenta>啊哈 这个用户有订阅</c>

00:06:20.714 --> 00:06:23.016
<c.magenta>当有新数据的时候</c>
<c.magenta>它们想第一时间知道</c>

00:06:23.817 --> 00:06:26.987
<c.magenta>它说它来自iPhone</c>
<c.magenta>所以不用打扰iPhone</c>

00:06:27.054 --> 00:06:28.622
<c.magenta>但这个用户还有一台iPad</c>

00:06:28.922 --> 00:06:31.992
<c.magenta>服务器于是就查找合适的</c>
<c.magenta>Apple推送通知服务标记</c>

00:06:32.226 --> 00:06:36.697
<c.magenta>帮你跟APNS连接</c>
<c.magenta>并且告诉后者发一个推送给iPad</c>

00:06:36.763 --> 00:06:39.099
<c.magenta>你于是就用不着</c>
<c.magenta>亲自在后台发推送了</c>

00:06:39.166 --> 00:06:41.301
<c.magenta>你的iPad终于收到推送</c>

00:06:41.368 --> 00:06:43.170
<c.magenta>iPad接着干嘛呢</c>
<c.magenta>我们之前提到</c>

00:06:43.237 --> 00:06:45.873
<c.magenta>现在它会向服务器</c>
<c.magenta>索取这些新的数据更改</c>

00:06:46.273 --> 00:06:48.909
<c.magenta>具体就是iPad经CloudKit</c>
<c.magenta>下载新的数据</c>

00:06:48.976 --> 00:06:51.778
<c.magenta>更新自己的本地缓存</c>
<c.magenta>然后用户在iPad上打开Notes</c>

00:06:51.845 --> 00:06:54.481
<c.magenta>瞧 用户看到刚在</c>
<c.magenta>iPhone上写的同样的东西</c>

00:06:56.016 --> 00:06:57.851
<c.magenta>好 我们来实践一下</c>
<c.magenta>搭建这个系统</c>

00:06:57.918 --> 00:07:00.587
<c.magenta>我们深入到代码里</c>
<c.magenta>到我们专门用的API里</c>

00:06:57.918 --> 00:07:00.587
<c.magenta>我们深入到代码里</c>
<c.magenta>到我们专门用的API里</c>

00:07:00.654 --> 00:07:01.855
<c.magenta>实现一切</c>

00:07:02.189 --> 00:07:04.658
<c.magenta>我们首先看到订阅数据改动</c>

00:07:05.792 --> 00:07:06.827
<c.magenta>记得我说过的话</c>

00:07:06.894 --> 00:07:10.564
<c.magenta>这是那些只在你应用第一次启动时</c>
<c.magenta>你才需要做的一件事</c>

00:07:10.631 --> 00:07:13.934
<c.magenta>所以 你会注意到</c>
<c.magenta>在我们代码顶部有一步审查</c>

00:07:14.001 --> 00:07:16.103
<c.magenta>查看我们在这台设备上</c>
<c.magenta>是否本地缓存</c>

00:07:16.170 --> 00:07:18.438
<c.magenta>既然我们都已经</c>
<c.magenta>设置了这个订阅</c>

00:07:18.505 --> 00:07:21.341
<c.magenta>我们不用每次应用启动</c>
<c.magenta>都执行后面的程序</c>

00:07:21.508 --> 00:07:24.945
<c.magenta>你为自己节省了网络请求</c>
<c.magenta>你也为用户节省了一些网络操作</c>

00:07:25.412 --> 00:07:29.383
<c.magenta>好 那么如果我们之前没有订阅</c>
<c.magenta>我们来看看代码是怎么设置订阅的</c>

00:07:29.750 --> 00:07:31.151
<c.magenta>今年 iOS 10新特性</c>

00:07:31.385 --> 00:07:34.054
<c.magenta>CKDatabaseSubscription API</c>

00:07:34.288 --> 00:07:37.758
<c.magenta>让你可以订阅整个数据库的任何改动</c>

00:07:37.824 --> 00:07:40.327
<c.magenta>而且它可以用在私人数据库</c>
<c.magenta>可以用在共享数据库</c>

00:07:40.694 --> 00:07:43.330
<c.magenta>在这个例子里</c>
<c.magenta>我们来关注新的共享数据库</c>

00:07:43.630 --> 00:07:48.569
<c.magenta>所以你给订阅赋予一个ID</c>
<c.magenta>方便之后查找 我稍后也会谈这个ID</c>

00:07:48.635 --> 00:07:51.138
<c.magenta>在这个案例里 因为我们的对象是</c>
<c.magenta>一个共享数据库</c>

00:07:51.205 --> 00:07:52.639
<c.magenta>我们称数据改动为共享改动</c>

00:07:53.774 --> 00:07:57.811
<c.magenta>接着 你要告诉CloudKit</c>
<c.magenta>你想要发送的推送类型</c>

00:07:58.011 --> 00:07:59.580
<c.magenta>在订阅触发的时候发送</c>

00:07:59.813 --> 00:08:02.115
<c.magenta>我们来深入聊聊</c>
<c.magenta>你可以用的不同类型</c>

00:07:59.813 --> 00:08:02.115
<c.magenta>我们来深入聊聊</c>
<c.magenta>你可以用的不同类型</c>

00:08:02.583 --> 00:08:06.053
<c.magenta>第一个类型实际上我们用得很多</c>
<c.magenta>而且对于大多数用例我们都很推荐</c>

00:08:06.119 --> 00:08:07.688
<c.magenta>这是一个静默推送通知</c>

00:08:08.155 --> 00:08:12.025
<c.magenta>要做到这点 在我们的API里要</c>
<c.magenta>关注到一个订阅对象</c>

00:08:12.092 --> 00:08:16.496
<c.magenta>你可以用一个CKNotificationInfo对象</c>
<c.magenta>设置notificationInfo</c>

00:08:16.563 --> 00:08:19.700
<c.magenta>然后 如果你将should</c>
<c.magenta>SendContentAvailable属性设为真</c>

00:08:19.766 --> 00:08:22.402
<c.magenta>并且只设置这个属性</c>
<c.magenta>你就可以静默推送了</c>

00:08:22.469 --> 00:08:25.706
<c.magenta>后台就会替你</c>
<c.magenta>给这个订阅发一个静默推送</c>

00:08:26.440 --> 00:08:30.611
<c.magenta>而这个关键的一点是</c>
<c.magenta>你不需要提示用户并取得同意</c>

00:08:30.677 --> 00:08:34.648
<c.magenta>过去我们有开发者抱怨“嘿</c>
<c.magenta>我们有这个订阅 但它会弹出窗口”</c>

00:08:34.715 --> 00:08:37.384
<c.magenta>你们也见过这种情况</c>
<c.magenta>对这个应用允许推送通知</c>

00:08:37.451 --> 00:08:39.086
<c.magenta>很多人会选不</c>

00:08:39.152 --> 00:08:41.321
<c.magenta>没得推送的话</c>
<c.magenta>你就只能靠下载数据了</c>

00:08:41.421 --> 00:08:44.591
<c.magenta>如果你这样做的话</c>
<c.magenta>基本上你怎么样都不能引起用户注意</c>

00:08:44.658 --> 00:08:46.460
<c.magenta>所以 你不需要征求用户接受</c>

00:08:47.594 --> 00:08:51.064
<c.magenta>最后 你侦听这些通知的地方是在</c>
<c.magenta>AppDelegate里的</c>

00:08:51.131 --> 00:08:52.599
<c.magenta>RegisterForRemoteNotifications</c>

00:08:53.333 --> 00:08:56.370
<c.magenta>而如果你确实想发送一个UI推送</c>
<c.magenta>你其实想要的是标记</c>

00:08:56.436 --> 00:09:00.407
<c.magenta>横幅或者发出声响</c>
<c.magenta>你可设置三个设置中的任何一个</c>

00:08:56.436 --> 00:09:00.407
<c.magenta>横幅或者发出声响</c>
<c.magenta>你可设置三个设置中的任何一个</c>

00:09:00.974 --> 00:09:04.111
<c.magenta>这会告诉CloudKit</c>
<c.magenta>给你的用户发一个UI推送</c>

00:09:04.845 --> 00:09:08.615
<c.magenta>而在这个案例里 因为你要提醒用户</c>
<c.magenta>所以你需要征得他们的同意</c>

00:09:08.882 --> 00:09:12.152
<c.magenta>你跟以前用一样的方法登记远程通知</c>

00:09:13.187 --> 00:09:14.521
<c.magenta>一些要注意的细节</c>

00:09:14.588 --> 00:09:16.757
<c.magenta>如果你去读APNS文档</c>

00:09:16.823 --> 00:09:21.128
<c.magenta>它们会告诉你说</c>
<c.magenta>推送可以根据设备条件进行合并</c>

00:09:21.728 --> 00:09:25.666
<c.magenta>这个指的是 如果一个订阅触发了</c>
<c.magenta>并且一个推送发到你用户的设备上</c>

00:09:25.732 --> 00:09:28.368
<c.magenta>有很多情况 比如低电量</c>
<c.magenta>网络不稳定等等</c>

00:09:28.435 --> 00:09:29.970
<c.magenta>这些情况下</c>
<c.magenta>不一定收到推送</c>

00:09:30.304 --> 00:09:33.941
<c.magenta>这个合并协定的目的</c>
<c.magenta>就是要至少实现其中一个推送</c>

00:09:34.708 --> 00:09:35.676
<c.magenta>这意味着</c>

00:09:35.742 --> 00:09:39.613
<c.magenta>你不应该认为推送就是要</c>
<c.magenta>告诉你的应用具体“什么”数据改变了</c>

00:09:39.680 --> 00:09:41.815
<c.magenta>因为如果发了五个推送</c>
<c.magenta>而你错过其中四个</c>

00:09:41.882 --> 00:09:43.617
<c.magenta>你只是错过了</c>
<c.magenta>其中四个“什么”</c>

00:09:43.684 --> 00:09:47.120
<c.magenta>取而代之 你应该将推送想作是</c>
<c.magenta>告诉你“有些”数据改变了</c>

00:09:47.187 --> 00:09:48.155
<c.magenta>一个或多个东西</c>

00:09:48.222 --> 00:09:51.291
<c.magenta>这就是为什么我们要从服务器那儿</c>
<c.magenta>找出哪些数据改变了</c>

00:09:51.358 --> 00:09:53.961
<c.magenta>好消息是CloudKit API</c>

00:09:54.027 --> 00:09:56.763
<c.magenta>给你提供了一个途径</c>
<c.magenta>询问哪些东西改变了</c>

00:09:56.830 --> 00:09:59.533
<c.magenta>所以你不用下载</c>
<c.magenta>你服务器已经有的所有东西</c>

00:10:00.534 --> 00:10:03.570
<c.magenta>我们回到我们的程序</c>
<c.magenta>记得我们还在创建一个订阅</c>

00:10:03.637 --> 00:10:06.073
<c.magenta>在这个案例中</c>
<c.magenta>我们设定了一个静默推送通知</c>

00:10:06.406 --> 00:10:09.076
<c.magenta>通过把</c>
<c.magenta>shouldSendContentAvailable设为真</c>

00:10:09.843 --> 00:10:11.478
<c.magenta>现在 我们需要拿这个订阅</c>

00:10:11.545 --> 00:10:14.014
<c.magenta>让CloudKit客户端</c>
<c.magenta>把它存到服务器上</c>

00:10:14.414 --> 00:10:16.083
<c.magenta>你可能熟悉这个</c>

00:10:16.149 --> 00:10:18.485
<c.magenta>但你做所有东西</c>
<c.magenta>都要用到操作</c>

00:10:18.819 --> 00:10:22.356
<c.magenta>而在这个例子里 我们用到</c>
<c.magenta>CKModifySubscriptionsOperation</c>

00:10:22.422 --> 00:10:25.058
<c.magenta>我们把刚创建的订阅告诉它</c>

00:10:25.125 --> 00:10:26.460
<c.magenta>而这就是我想储存的</c>
<c.magenta>那个订阅</c>

00:10:27.895 --> 00:10:31.765
<c.magenta>有了CloudKit 因为客户端要</c>
<c.magenta>通过网络跟服务器连接</c>

00:10:31.832 --> 00:10:34.568
<c.magenta>这可能会耗很多时间</c>
<c.magenta>所有东西都是非同步的</c>

00:10:34.635 --> 00:10:37.471
<c.magenta>这意味着所有操作</c>
<c.magenta>都有完成模块</c>

00:10:37.538 --> 00:10:40.541
<c.magenta>一旦有一个响应回来</c>
<c.magenta>这些模块就会被调用</c>

00:10:40.607 --> 00:10:44.111
<c.magenta>在这儿 我们有一个</c>
<c.magenta>modifySubscriptionsCompletionBlock</c>

00:10:44.645 --> 00:10:46.647
<c.magenta>所有完成模块里</c>
<c.magenta>你首先要做的是</c>

00:10:46.713 --> 00:10:49.116
<c.magenta>检查错误</c>
<c.magenta>我知道我们总是说这个</c>

00:10:49.216 --> 00:10:52.319
<c.magenta>Nihar会跟你们</c>
<c.magenta>更详细地讲解</c>

00:10:52.386 --> 00:10:54.888
<c.magenta>不过 在这个案例里</c>
<c.magenta>假设如果我们没有错误</c>

00:10:54.955 --> 00:10:56.924
<c.magenta>那我们就知道</c>
<c.magenta>订阅已经储存好了</c>

00:10:56.990 --> 00:10:59.493
<c.magenta>而我可以在本地缓存</c>
<c.magenta>我们已经做了这一步的记录</c>

00:10:59.560 --> 00:11:02.296
<c.magenta>这样下一次我们就不用做了</c>
<c.magenta>多亏有程序顶部的错误检查</c>

00:10:59.560 --> 00:11:02.296
<c.magenta>这样下一次我们就不用做了</c>
<c.magenta>多亏有程序顶部的错误检查</c>

00:11:03.830 --> 00:11:05.899
<c.magenta>顺便讲一下</c>
<c.magenta>Nihar也会谈这个</c>

00:11:05.966 --> 00:11:09.736
<c.magenta>CKOperation继承了NSOperation</c>
<c.magenta>即Swift 3里的操作</c>

00:11:10.037 --> 00:11:12.806
<c.magenta>所以你可以设置</c>
<c.magenta>这个服务质量属性</c>

00:11:12.873 --> 00:11:14.074
<c.magenta>默认值是.utility</c>

00:11:14.141 --> 00:11:16.743
<c.magenta>他会讲一些设置这个时</c>
<c.magenta>要切记的东西</c>

00:11:17.277 --> 00:11:18.145
<c.magenta>而最后</c>

00:11:18.412 --> 00:11:22.316
<c.magenta>拿这个操作</c>
<c.magenta>让客户端发送回来的方法</c>

00:11:22.382 --> 00:11:25.385
<c.magenta>就是把它加进数据库的</c>
<c.magenta>操作队列里</c>

00:11:25.452 --> 00:11:28.555
<c.magenta>既然这个例子里我们做的是</c>
<c.magenta>共享数据库的订阅</c>

00:11:28.622 --> 00:11:30.891
<c.magenta>就把操作加到共享数据库的</c>
<c.magenta>操作队列里</c>

00:11:30.958 --> 00:11:32.826
<c.magenta>客户端于是就会把</c>
<c.magenta>操作发送到服务器</c>

00:11:34.328 --> 00:11:36.697
<c.magenta>好 我们现在订阅了数据变化</c>

00:11:37.164 --> 00:11:40.067
<c.magenta>下一步就是侦听推送了</c>

00:11:40.434 --> 00:11:44.037
<c.magenta>既然CloudKit在另一台设备的</c>
<c.magenta>数据改变时会发推送给我们</c>

00:11:45.672 --> 00:11:48.408
<c.magenta>你要确保在Xcode里</c>
<c.magenta>你打开了背景模式</c>

00:11:48.675 --> 00:11:51.411
<c.magenta>你要在远程通知的选项打钩</c>

00:11:51.478 --> 00:11:52.746
<c.magenta>可能还要选后台获取</c>

00:11:52.813 --> 00:11:55.349
<c.magenta>如果当你应用在背景的时候</c>
<c.magenta>你想做这个</c>

00:11:56.016 --> 00:11:59.553
<c.magenta>这一步后 AppDelegate</c>
<c.magenta>有一个你可能知道的方法</c>

00:11:59.620 --> 00:12:02.122
<c.magenta>application</c>
<c.magenta>didReceiveRemoteNotification</c>

00:11:59.620 --> 00:12:02.122
<c.magenta>application</c>
<c.magenta>didReceiveRemoteNotification</c>

00:12:02.189 --> 00:12:03.524
<c.magenta>fetchCompletionHandler</c>

00:12:04.525 --> 00:12:06.994
<c.magenta>你给这方法一个用户信息字典</c>

00:12:07.594 --> 00:12:09.563
<c.magenta>CloudKit就可以让你很方便地</c>

00:12:09.630 --> 00:12:13.333
<c.magenta>看能否从这个字典对象里获取</c>
<c.magenta>一个CKNotification</c>

00:12:14.835 --> 00:12:17.371
<c.magenta>记得推送还可能有别的各种原因</c>

00:12:17.437 --> 00:12:21.175
<c.magenta>但若它来自一个CloudKit订阅</c>
<c.magenta>就会有CKNotification</c>

00:12:21.341 --> 00:12:23.677
<c.magenta>现在我们可以查订阅ID</c>

00:12:24.344 --> 00:12:28.615
<c.magenta>这一步很重要 因为你可能会有</c>
<c.magenta>一个数据库订阅</c>

00:12:28.682 --> 00:12:31.585
<c.magenta>在私人或者共享数据库</c>
<c.magenta>可能还有别的东西</c>

00:12:31.852 --> 00:12:35.389
<c.magenta>这一步让你辨别哪个订阅</c>
<c.magenta>触发了这个推送</c>

00:12:35.689 --> 00:12:38.125
<c.magenta>在这个案例里 我们假设</c>
<c.magenta>推送来自我们的共享改动</c>

00:12:38.192 --> 00:12:40.561
<c.magenta>现在我们可以去</c>
<c.magenta>获取这些共享数据</c>

00:12:40.894 --> 00:12:42.229
<c.magenta>这个流程我们待会儿会探讨</c>

00:12:42.362 --> 00:12:44.631
<c.magenta>这步完成后 我们调用</c>
<c.magenta>完成处理程序</c>

00:12:44.698 --> 00:12:46.166
<c.magenta>这个方法的参数之一</c>

00:12:47.534 --> 00:12:50.571
<c.magenta>好 现在我们设置好侦听推送了</c>

00:12:51.004 --> 00:12:53.874
<c.magenta>我们假设一段时间后</c>
<c.magenta>你的应用收到一个推送</c>

00:12:54.141 --> 00:12:56.076
<c.magenta>我们该怎么办呢</c>
<c.magenta>记得我们刚讲的东西</c>

00:12:56.176 --> 00:12:57.578
<c.magenta>我们要获取新的数据变化</c>

00:12:57.811 --> 00:13:00.614
<c.magenta>我们来看图说话</c>
<c.magenta>看看这个是怎么运作的</c>

00:12:57.811 --> 00:13:00.614
<c.magenta>我们来看图说话</c>
<c.magenta>看看这个是怎么运作的</c>

00:13:01.148 --> 00:13:02.583
<c.magenta>我们的设备收到一个推送</c>

00:13:02.649 --> 00:13:04.718
<c.magenta>我们说了这个是</c>
<c.magenta>共享数据库的推送</c>

00:13:04.785 --> 00:13:06.753
<c.magenta>你需要做下面两步</c>

00:13:07.087 --> 00:13:10.290
<c.magenta>一</c>
<c.magenta>你询问服务器</c>

00:13:10.490 --> 00:13:13.560
<c.magenta>共享数据库里哪些地带变动了</c>

00:13:13.927 --> 00:13:15.696
<c.magenta>记得我们之前谈过地带</c>

00:13:15.762 --> 00:13:19.132
<c.magenta>可能还会有</c>
<c.magenta>新地带出现而你甚至都不知道</c>

00:13:19.199 --> 00:13:21.201
<c.magenta>因为有人跟你分享了一些东西</c>

00:13:21.735 --> 00:13:23.971
<c.magenta>你接着发一个服务器变动标记</c>

00:13:24.037 --> 00:13:26.106
<c.magenta>告诉服务器你在</c>
<c.magenta>数据历史的哪个位置</c>

00:13:26.173 --> 00:13:27.941
<c.magenta>这个我们一会儿也会深入讲解</c>

00:13:28.242 --> 00:13:32.312
<c.magenta>有了地带的数字后 第二步就是</c>
<c.magenta>你又询问服务器说 好</c>

00:13:32.379 --> 00:13:35.749
<c.magenta>请告诉我在那些具体地带里</c>
<c.magenta>哪些档案有改动</c>

00:13:35.983 --> 00:13:38.218
<c.magenta>同样地</c>
<c.magenta>对于每个地带你都有改动标记</c>

00:13:38.285 --> 00:13:40.854
<c.magenta>标明你本地的设备缓存在</c>
<c.magenta>数据历史里的位置</c>

00:13:42.756 --> 00:13:45.459
<c.magenta>好 我们来更详细地</c>
<c.magenta>讲讲这个改动标记</c>

00:13:46.059 --> 00:13:49.563
<c.magenta>假设你的用户有一台设备</c>
<c.magenta>就我们之前说的那台iPhone吧</c>

00:13:49.630 --> 00:13:52.666
<c.magenta>用户用你的应用</c>
<c.magenta>发送了一些改动到服务器</c>

00:13:52.866 --> 00:13:56.236
<c.magenta>改动得到认可</c>
<c.magenta>服务器在历史上标明这一点</c>

00:13:56.303 --> 00:13:58.071
<c.magenta>这要用到服务器改动标记</c>

00:13:58.138 --> 00:14:00.974
<c.magenta>在这个例子里 为了简便</c>
<c.magenta>我们标明为字母A</c>

00:13:58.138 --> 00:14:00.974
<c.magenta>在这个例子里 为了简便</c>
<c.magenta>我们标明为字母A</c>

00:14:01.041 --> 00:14:04.344
<c.magenta>这台设备又发送</c>
<c.magenta>另一些得到认可的改动</c>

00:14:04.411 --> 00:14:06.346
<c.magenta>这些标为B 等等 接着就是C</c>

00:14:06.780 --> 00:14:09.983
<c.magenta>一段时间后 用户在</c>
<c.magenta>第二台设备运行你的应用</c>

00:14:10.050 --> 00:14:12.186
<c.magenta>假设是我们之前说到的那台iPad</c>

00:14:12.252 --> 00:14:14.988
<c.magenta>iPad首先要做的</c>
<c.magenta>记得在应用启动时</c>

00:14:15.055 --> 00:14:17.291
<c.magenta>要做的是索要</c>
<c.magenta>任何它没有的改动</c>

00:14:17.824 --> 00:14:20.827
<c.magenta>于是它说</c>
<c.magenta>“我想从服务器获取改动”</c>

00:14:20.894 --> 00:14:23.197
<c.magenta>服务器说“拿去吧</c>
<c.magenta>这些是我有的”</c>

00:14:23.263 --> 00:14:26.834
<c.magenta>最后它说</c>
<c.magenta>“你现在位于服务器改动标记C”</c>

00:14:27.100 --> 00:14:29.503
<c.magenta>所以二号设备自己</c>
<c.magenta>记好了它在历史上的位置</c>

00:14:30.137 --> 00:14:32.606
<c.magenta>现在假设二号设备</c>
<c.magenta>接着写了一些数据</c>

00:14:32.773 --> 00:14:34.908
<c.magenta>写的过程中 一号设备收到推送</c>

00:14:35.342 --> 00:14:37.244
<c.magenta>一号设备下载新的变动</c>

00:14:37.311 --> 00:14:40.581
<c.magenta>最后 服务器说</c>
<c.magenta>“你现在位于改动标记E”</c>

00:14:40.647 --> 00:14:42.916
<c.magenta>好 二号设备又改了一些东西</c>

00:14:42.983 --> 00:14:45.919
<c.magenta>一号设备收到推送</c>
<c.magenta>下载东西</c>

00:14:46.019 --> 00:14:47.554
<c.magenta>现在它位于改动标记I</c>

00:14:48.755 --> 00:14:51.592
<c.magenta>你会意识到二号设备</c>
<c.magenta>还在改动标记C</c>

00:14:51.925 --> 00:14:55.095
<c.magenta>你写数据的时候</c>
<c.magenta>你是不会得到改动标记的</c>

00:14:55.195 --> 00:14:57.297
<c.magenta>除非你去索取</c>
<c.magenta>你是不会得到标记的</c>

00:14:57.364 --> 00:14:59.700
<c.magenta>我们假设在二号设备</c>
<c.magenta>应用重启</c>

00:15:00.000 --> 00:15:02.803
<c.magenta>或者用户重启iPad还是别的什么</c>
<c.magenta>你的应用启动了</c>

00:15:02.870 --> 00:15:04.071
<c.magenta>你去要数据改动</c>

00:15:04.171 --> 00:15:06.840
<c.magenta>服务器就会发给你</c>
<c.magenta>你从设备写了的东西</c>

00:15:06.907 --> 00:15:09.977
<c.magenta>它不知道你会不会</c>
<c.magenta>因为各种原因而没有本地缓存</c>

00:15:10.043 --> 00:15:12.312
<c.magenta>如果你见到类似的情况</c>
<c.magenta>也不要惊讶</c>

00:15:12.379 --> 00:15:15.816
<c.magenta>这么做让你可以确认</c>
<c.magenta>你有这一部分数据</c>

00:15:15.883 --> 00:15:19.319
<c.magenta>最后 服务器会</c>
<c.magenta>告诉你位于改动标记I</c>

00:15:19.553 --> 00:15:23.390
<c.magenta>注意两台设备都在同样的状态</c>
<c.magenta>都有同样的服务器改动标记</c>

00:15:23.724 --> 00:15:25.893
<c.magenta>这就是展示系统</c>
<c.magenta>如何运作的一个例子</c>

00:15:27.261 --> 00:15:30.797
<c.magenta>好 我们来看看真正写代码来</c>
<c.magenta>获取这些变化</c>

00:15:31.231 --> 00:15:34.101
<c.magenta>这个案例里</c>
<c.magenta>我们要讲解数据库</c>

00:15:34.301 --> 00:15:38.872
<c.magenta>iOS 10一个新API叫</c>
<c.magenta>CKFetchDatabaseChangesOperation</c>

00:15:39.373 --> 00:15:42.609
<c.magenta>如我们所说 你把我们刚提到的</c>
<c.magenta>服务器改动标记作为参数</c>

00:15:42.776 --> 00:15:46.880
<c.magenta>你第一次用它时</c>
<c.magenta>它会告诉服务器你啥都没有</c>

00:15:46.947 --> 00:15:49.516
<c.magenta>服务器也会把它的所有东西给你</c>

00:15:50.350 --> 00:15:54.288
<c.magenta>接下来</c>
<c.magenta>在API以前的版本里</c>

00:15:54.354 --> 00:15:57.691
<c.magenta>在这个操作最后</c>
<c.magenta>你通常要检查一个旗标</c>

00:15:57.891 --> 00:16:00.694
<c.magenta>看服务器有没有说</c>
<c.magenta>之后还有更多的数据</c>

00:15:57.891 --> 00:16:00.694
<c.magenta>看服务器有没有说</c>
<c.magenta>之后还有更多的数据</c>

00:16:01.128 --> 00:16:02.896
<c.magenta>我们一会儿也会谈论这个</c>

00:16:02.963 --> 00:16:06.533
<c.magenta>但通常如果这个设为真的话</c>
<c.magenta>你就要负责在客户端</c>

00:16:06.600 --> 00:16:08.302
<c.magenta>重新触发这个操作</c>

00:16:09.002 --> 00:16:11.438
<c.magenta>但我们加了一个新属性</c>

00:16:11.638 --> 00:16:13.907
<c.magenta>到这些操作里</c>
<c.magenta>叫获取所有改动</c>

00:16:13.974 --> 00:16:15.175
<c.magenta>其默认值为真</c>

00:16:15.409 --> 00:16:18.045
<c.magenta>它做的是</c>
<c.magenta>让CloudKit客户端</c>

00:16:18.111 --> 00:16:20.814
<c.magenta>替你做这个</c>
<c.magenta>所以你不用亲自动手</c>

00:16:20.881 --> 00:16:22.950
<c.magenta>运行了其中一个操作后</c>

00:16:23.016 --> 00:16:25.252
<c.magenta>如果客户端看到</c>
<c.magenta>服务器还有更多数据</c>

00:16:25.452 --> 00:16:28.222
<c.magenta>它又会帮你自动把</c>
<c.magenta>你的操作加入队列</c>

00:16:28.422 --> 00:16:30.490
<c.magenta>当然 顺便调用你的回调方法</c>

00:16:30.691 --> 00:16:32.960
<c.magenta>所以你再也不用担心</c>

00:16:33.427 --> 00:16:35.696
<c.magenta>然后 你要实现这个</c>
<c.magenta>完成模块</c>

00:16:35.762 --> 00:16:37.965
<c.magenta>recordZoneWithIDChangedBlock</c>

00:16:38.232 --> 00:16:40.567
<c.magenta>在这里 你会得知哪些地带</c>

00:16:40.634 --> 00:16:42.269
<c.magenta>在共享服务器里改动了</c>

00:16:42.736 --> 00:16:44.671
<c.magenta>你有收集这些地带ID</c>

00:16:44.738 --> 00:16:47.007
<c.magenta>我们等会儿会讲</c>
<c.magenta>怎么处理它们</c>

00:16:47.074 --> 00:16:50.310
<c.magenta>再接下来是</c>
<c.magenta>recordZoneWithIDWasDeletedBlock</c>

00:16:50.377 --> 00:16:53.146
<c.magenta>这个告诉你哪些地带在</c>
<c.magenta>服务器里已经不复存在</c>

00:16:53.213 --> 00:16:55.716
<c.magenta>还可以让你清理</c>
<c.magenta>任何本地缓存数据</c>

00:16:56.049 --> 00:16:57.684
<c.magenta>之前位于那些</c>
<c.magenta>现在不再存在的地带里的缓存</c>

00:16:58.352 --> 00:16:59.686
<c.magenta>你会在下面的情形看到这个</c>

00:16:59.753 --> 00:17:02.456
<c.magenta>就是有些东西</c>
<c.magenta>没有跟你的用户分享</c>

00:16:59.753 --> 00:17:02.456
<c.magenta>就是有些东西</c>
<c.magenta>没有跟你的用户分享</c>

00:17:02.656 --> 00:17:05.192
<c.magenta>因为在他们的共享数据库里</c>
<c.magenta>没有这个地带</c>

00:17:05.259 --> 00:17:08.127
<c.magenta>另一个新事物是</c>
<c.magenta>changedTokenUpdatedBlock</c>

00:17:08.194 --> 00:17:09.363
<c.magenta>我们来看一下</c>

00:17:09.730 --> 00:17:14.034
<c.magenta>记得之前我们一号设备</c>
<c.magenta>写了一些东西到服务器</c>

00:17:14.401 --> 00:17:16.737
<c.magenta>二号设备写了一些东西</c>

00:17:16.904 --> 00:17:20.207
<c.magenta>过了一会儿 这个用户的</c>
<c.magenta>三号设备也加入进来了</c>

00:17:20.406 --> 00:17:21.808
<c.magenta>它首先要做的</c>

00:17:21.875 --> 00:17:24.077
<c.magenta>是跟服务器连接</c>
<c.magenta>并且获取任何改动</c>

00:17:24.444 --> 00:17:27.580
<c.magenta>因为获取所有改动为真</c>
<c.magenta>它要下载所有数据</c>

00:17:28.182 --> 00:17:30.551
<c.magenta>但我们可能有很多数据</c>
<c.magenta>比如这个案例里面</c>

00:17:30.617 --> 00:17:34.488
<c.magenta>服务器会觉得没必要只在</c>
<c.magenta>一个响应里就将所有数据传过来</c>

00:17:34.555 --> 00:17:35.656
<c.magenta>我们分段来进行</c>

00:17:36.924 --> 00:17:38.859
<c.magenta>服务器发给你一部分数据</c>

00:17:39.626 --> 00:17:42.663
<c.magenta>CloudKit服务器会看到</c>
<c.magenta>服务器还有更多数据</c>

00:17:42.729 --> 00:17:45.666
<c.magenta>所以它要替你去设立</c>
<c.magenta>另外一个操作</c>

00:17:45.899 --> 00:17:48.836
<c.magenta>但它在做这步前</c>
<c.magenta>要调用changeTokenUpdated</c>

00:17:48.902 --> 00:17:51.271
<c.magenta>并且告诉你</c>
<c.magenta>你现在在改动标记C</c>

00:17:52.172 --> 00:17:54.141
<c.magenta>这让你可以跟客户端配合</c>

00:17:54.208 --> 00:17:55.576
<c.magenta>随之设立操作</c>

00:17:55.642 --> 00:17:57.311
<c.magenta>你更新你的本地改动标记</c>

00:17:57.377 --> 00:17:59.346
<c.magenta>就用不着重复</c>
<c.magenta>你已经做了的一些事情</c>

00:17:59.813 --> 00:18:02.349
<c.magenta>比如说这个客户端替你说</c>

00:17:59.813 --> 00:18:02.349
<c.magenta>比如说这个客户端替你说</c>

00:18:02.416 --> 00:18:05.385
<c.magenta>“还有更多数据要从服务器传过来</c>
<c.magenta>我们去获取吧</c>

00:18:05.452 --> 00:18:06.286
<c.magenta>下载一些新数据”</c>

00:18:06.353 --> 00:18:08.455
<c.magenta>结束后再调用</c>
<c.magenta>changeTokenUpdated</c>

00:18:08.522 --> 00:18:10.858
<c.magenta>看还有没有新数据</c>
<c.magenta>然后又跟服务器连接</c>

00:18:10.924 --> 00:18:12.359
<c.magenta>不过这一次会有一个错误</c>

00:18:12.893 --> 00:18:16.363
<c.magenta>你处理错误时可能最终还是</c>
<c.magenta>重新调用获取改动</c>

00:18:16.864 --> 00:18:18.832
<c.magenta>但你就不用从头从A开始了</c>

00:18:18.999 --> 00:18:21.134
<c.magenta>因为你有一个</c>
<c.magenta>changeTokenUpdatedBlock</c>

00:18:21.201 --> 00:18:22.803
<c.magenta>你的本地改动标记</c>
<c.magenta>现在E</c>

00:18:23.070 --> 00:18:24.338
<c.magenta>当你调用下一个时</c>

00:18:24.404 --> 00:18:26.139
<c.magenta>服务器说</c>
<c.magenta>“你只需从F到I的数据”</c>

00:18:26.206 --> 00:18:28.842
<c.magenta>你不需要</c>
<c.magenta>你已经处理的旧东西</c>

00:18:29.209 --> 00:18:32.246
<c.magenta>这就是实现</c>
<c.magenta>changeTokenUpdatedBlock的重要性</c>

00:18:32.312 --> 00:18:35.082
<c.magenta>你就像正常情况那样</c>
<c.magenta>缓存服务器改动标记</c>

00:18:36.817 --> 00:18:38.452
<c.magenta>我们有</c>
<c.magenta>完成模块</c>

00:18:38.519 --> 00:18:41.688
<c.magenta>在这个例子里是 fetchDatabase</c>
<c.magenta>ChangesCompletionBlock</c>

00:18:41.989 --> 00:18:43.724
<c.magenta>同样地 你首先要做错误处理</c>

00:18:43.790 --> 00:18:45.158
<c.magenta>Nihar也会谈这个</c>

00:18:45.993 --> 00:18:47.661
<c.magenta>然后你会得到</c>
<c.magenta>一个最后的改动标记</c>

00:18:47.728 --> 00:18:51.331
<c.magenta>如果我们没有错误 最后就会是I</c>

00:18:51.532 --> 00:18:53.200
<c.magenta>像正常情况一样缓存这个标记</c>

00:18:53.400 --> 00:18:57.070
<c.magenta>现在我们收集了</c>
<c.magenta>在数据库有变动的地带</c>

00:18:57.237 --> 00:18:59.306
<c.magenta>我们要去获取有变动的档案</c>

00:18:59.373 --> 00:19:01.208
<c.magenta>这也就是之前</c>
<c.magenta>那个图表的第二步</c>

00:18:59.373 --> 00:19:01.208
<c.magenta>这也就是之前</c>
<c.magenta>那个图表的第二步</c>

00:19:01.475 --> 00:19:03.177
<c.magenta>我们通过一个新API</c>
<c.magenta>来完成这步</c>

00:19:03.243 --> 00:19:06.213
<c.magenta>CKFetchRecordZone</c>
<c.magenta>ChangesOperation</c>

00:19:06.380 --> 00:19:08.849
<c.magenta>它接受地带ID的集合作为参数</c>

00:19:09.049 --> 00:19:11.785
<c.magenta>所以你不用担心要根据不同</c>
<c.magenta>带有改动的地带来调取档案</c>

00:19:11.852 --> 00:19:14.388
<c.magenta>你只需调用一个方法</c>
<c.magenta>赋给它所有有变动的地带</c>

00:19:14.788 --> 00:19:16.990
<c.magenta>我们不细看代码了</c>
<c.magenta>不过它大概看起来是这样</c>

00:19:17.057 --> 00:19:20.694
<c.magenta>在处理档案而非地带的地方</c>
<c.magenta>你会有一些完成模块</c>

00:19:20.761 --> 00:19:23.063
<c.magenta>而且在这个过程中</c>
<c.magenta>你会收到改动标记</c>

00:19:24.665 --> 00:19:26.900
<c.magenta>好 快速回顾一下</c>
<c.magenta>我们讲了什么</c>

00:19:27.601 --> 00:19:31.505
<c.magenta>你订阅了数据改动</c>
<c.magenta>告诉CloudKit你想接收推送</c>

00:19:31.572 --> 00:19:33.674
<c.magenta>一旦用户在另一台设备上</c>
<c.magenta>改动了数据</c>

00:19:34.174 --> 00:19:36.143
<c.magenta>你侦听了推送通知</c>

00:19:36.243 --> 00:19:38.645
<c.magenta>当你收到推送时</c>
<c.magenta>你连接服务器</c>

00:19:38.712 --> 00:19:40.314
<c.magenta>获取变动了的数据</c>

00:19:40.547 --> 00:19:44.051
<c.magenta>这么做的话 你的应用就能提供</c>
<c.magenta>流畅的体验</c>

00:19:44.117 --> 00:19:46.520
<c.magenta>给你的用户使用他们所有的设备</c>

00:19:48.088 --> 00:19:51.792
<c.magenta>好 现在Nihar要上来</c>
<c.magenta>讲一些特别的最佳实践</c>

00:19:57.097 --> 00:19:58.065
<c.magenta>谢谢 Dave</c>

00:19:58.131 --> 00:19:59.933
<c.magenta>大家早上好</c>
<c.magenta>谢谢大家的到来</c>

00:20:00.400 --> 00:20:03.403
<c.magenta>我是Nihar Sharma</c>
<c.magenta>CloudKit团队工程师</c>

00:20:03.470 --> 00:20:07.708
<c.magenta>我很高兴能够跟你们</c>
<c.magenta>分享一些CloudKit最佳实践</c>

00:20:07.774 --> 00:20:10.577
<c.magenta>我们过去几年在Apple</c>
<c.magenta>领悟到这些操作</c>

00:20:10.644 --> 00:20:13.046
<c.magenta>你也可以在你的应用里利用它们</c>

00:20:13.447 --> 00:20:15.349
<c.magenta>我们先来看看</c>
<c.magenta>我们要谈些什么</c>

00:20:16.683 --> 00:20:19.920
<c.magenta>首先 我想说一下自动认证</c>

00:20:20.120 --> 00:20:23.891
<c.magenta>Dave提了一点点</c>
<c.magenta>我想更详细地讲讲它是什么</c>

00:20:23.957 --> 00:20:25.526
<c.magenta>你怎么用它</c>

00:20:26.860 --> 00:20:29.830
<c.magenta>接着 我要讲到</c>
<c.magenta>CKOperation API</c>

00:20:29.897 --> 00:20:32.633
<c.magenta>这是我们原生CloudKit框架</c>
<c.magenta>主要用到的API</c>

00:20:34.635 --> 00:20:37.137
<c.magenta>然后 我们会谈</c>
<c.magenta>你可以牢记的一些点子</c>

00:20:37.204 --> 00:20:39.006
<c.magenta>在设计你应用的</c>
<c.magenta>数据库框架时可以用</c>

00:20:39.072 --> 00:20:42.442
<c.magenta>它们让你更有效地利用</c>
<c.magenta>CloudKit API</c>

00:20:43.377 --> 00:20:45.345
<c.magenta>最后 如我们之前告诉过你们的</c>

00:20:45.412 --> 00:20:49.249
<c.magenta>错误处理对编写</c>
<c.magenta>一个CloudKit应用至关重要</c>

00:20:49.316 --> 00:20:52.119
<c.magenta>我今天在这儿想重申一遍</c>

00:20:52.186 --> 00:20:54.688
<c.magenta>并且探讨几个不同类型的错误</c>

00:20:54.755 --> 00:20:56.957
<c.magenta>还有你的应用应该如何处理它们</c>

00:20:57.090 --> 00:20:58.192
<c.magenta>那么 我们开始吧</c>

00:20:58.659 --> 00:21:01.128
<c.magenta>首先是自动认证</c>

00:20:58.659 --> 00:21:01.128
<c.magenta>首先是自动认证</c>

00:21:02.062 --> 00:21:05.499
<c.magenta>你可能熟悉这样的一个UI</c>

00:21:05.566 --> 00:21:10.137
<c.magenta>第一次启动时</c>
<c.magenta>应用向用户索要很多私人信息</c>

00:21:10.637 --> 00:21:13.106
<c.magenta>用户甚至都没开始用这个应用</c>

00:21:13.874 --> 00:21:16.343
<c.magenta>而我们觉得在CloudKit</c>
<c.magenta>我们有很好的方法</c>

00:21:16.410 --> 00:21:19.646
<c.magenta>让你增加和用户互动的机会</c>

00:21:19.713 --> 00:21:22.282
<c.magenta>不需要开门见山</c>
<c.magenta>索要任何私人信息</c>

00:21:23.350 --> 00:21:26.687
<c.magenta>我们通过CloudKit用户记录</c>
<c.magenta>做到这一点</c>

00:21:28.856 --> 00:21:33.627
<c.magenta>我提醒你们一下 我们给每个用户都</c>
<c.magenta>自动创建用户记录</c>

00:21:33.694 --> 00:21:38.065
<c.magenta>用户第一次用你的应用时</c>
<c.magenta>就记录到了你的iCloud账户</c>

00:21:39.399 --> 00:21:42.636
<c.magenta>这样的话 它在每个</c>
<c.magenta>CloudKit容器里都具有唯一性</c>

00:21:43.437 --> 00:21:46.673
<c.magenta>也给你提供用户的</c>
<c.magenta>一个可靠的标识符</c>

00:21:47.174 --> 00:21:50.744
<c.magenta>对于应用重启 OS更新等等</c>
<c.magenta>都非常可靠</c>

00:21:51.178 --> 00:21:53.313
<c.magenta>所以你可以将这个标识符</c>
<c.magenta>存在你的服务器上</c>

00:21:53.380 --> 00:21:55.716
<c.magenta>并且可以马上开始</c>
<c.magenta>给用户建立一个档案</c>

00:21:55.782 --> 00:21:59.219
<c.magenta>而当你发现他们</c>
<c.magenta>跟你的应用有更多互动时</c>

00:21:59.286 --> 00:22:02.055
<c.magenta>你这时就可以向他们征求</c>
<c.magenta>更多信息来充实他们的档案</c>

00:21:59.286 --> 00:22:02.055
<c.magenta>你这时就可以向他们征求</c>
<c.magenta>更多信息来充实他们的档案</c>

00:22:03.257 --> 00:22:05.893
<c.magenta>你找到当前用户的</c>
<c.magenta>用户记录ID的方法</c>

00:22:05.959 --> 00:22:10.430
<c.magenta>是用CKContainer里的fetchUser</c>
<c.magenta>RecordIDcompletionHandler API</c>

00:22:11.131 --> 00:22:13.567
<c.magenta>这就是CloudKit自动认证</c>

00:22:15.435 --> 00:22:17.137
<c.magenta>我们谈谈CKOperation</c>

00:22:18.939 --> 00:22:20.674
<c.magenta>回顾一下 有两种主要的方法</c>

00:22:20.741 --> 00:22:24.244
<c.magenta>来让CloudKit框架</c>
<c.magenta>将操作呈现给你的应用</c>

00:22:24.845 --> 00:22:29.449
<c.magenta>一个是通过调用便利API</c>
<c.magenta>它一次针对一个东西</c>

00:22:31.451 --> 00:22:33.687
<c.magenta>二则通过</c>
<c.magenta>相对应的CKOperation</c>

00:22:33.754 --> 00:22:37.024
<c.magenta>这样 我们呈现的每个</c>
<c.magenta>便利API调用</c>

00:22:37.090 --> 00:22:40.360
<c.magenta>一次只针对一个东西</c>
<c.magenta>都有相对应的CKOperation</c>

00:22:41.495 --> 00:22:43.564
<c.magenta>后者则是批量处理</c>

00:22:43.764 --> 00:22:47.534
<c.magenta>比如说 我们有</c>
<c.magenta>fetchWithRecordID API</c>

00:22:47.601 --> 00:22:49.837
<c.magenta>在CKDatabase里</c>
<c.magenta>一次获取一份档案</c>

00:22:50.170 --> 00:22:52.806
<c.magenta>我们有它对应的</c>
<c.magenta>CKFetchRecordsOperation</c>

00:22:52.873 --> 00:22:56.410
<c.magenta>它接受一个档案ID列表</c>
<c.magenta>并且批量获取档案</c>

00:22:57.945 --> 00:23:00.581
<c.magenta>用这个CKOperation API</c>
<c.magenta>有一定的优势</c>

00:22:57.945 --> 00:23:00.581
<c.magenta>用这个CKOperation API</c>
<c.magenta>有一定的优势</c>

00:23:00.647 --> 00:23:02.850
<c.magenta>相对调用</c>
<c.magenta>便利API</c>

00:23:03.016 --> 00:23:04.985
<c.magenta>我今天要讲其中的很多优势</c>

00:23:05.052 --> 00:23:06.920
<c.magenta>首先</c>

00:23:07.654 --> 00:23:10.457
<c.magenta>CKOperation是</c>
<c.magenta>NSOperation子类</c>

00:23:11.124 --> 00:23:14.294
<c.magenta>这意味着</c>
<c.magenta>你有全套设备的</c>

00:23:14.361 --> 00:23:17.197
<c.magenta>NSOperation API</c>
<c.magenta>让你可以免费使用</c>

00:23:18.432 --> 00:23:21.768
<c.magenta>你可以做比如建立你的</c>
<c.magenta>CKOperation之间依赖关系</c>

00:23:23.403 --> 00:23:25.205
<c.magenta>你可以给它们的</c>
<c.magenta>服务质量属性赋值</c>

00:23:25.272 --> 00:23:27.975
<c.magenta>让系统知道那个</c>
<c.magenta>操作对你有多重要</c>

00:23:28.175 --> 00:23:29.610
<c.magenta>甚至是管理队列的优先性</c>

00:23:29.676 --> 00:23:32.145
<c.magenta>在你的NSOperation</c>
<c.magenta>队列安排它们时</c>

00:23:33.514 --> 00:23:35.816
<c.magenta>你还可以取消</c>
<c.magenta>CKOperation</c>

00:23:35.883 --> 00:23:37.618
<c.magenta>就是那些已经开始执行的</c>

00:23:39.720 --> 00:23:44.525
<c.magenta>我推荐你们回去读</c>
<c.magenta>NSOperation的参考文档</c>

00:23:44.591 --> 00:23:47.060
<c.magenta>来很好地利用</c>
<c.magenta>CKOperation API</c>

00:23:47.461 --> 00:23:50.664
<c.magenta>一个很好的参考资料是</c>
<c.magenta>我们的进阶NSOperation</c>

00:23:50.731 --> 00:23:52.966
<c.magenta>即我们去年WWDC的演讲</c>

00:23:55.235 --> 00:23:57.404
<c.magenta>既然我们讲到</c>
<c.magenta>CloudKit操作</c>

00:23:57.471 --> 00:23:59.740
<c.magenta>还有更多东西值得一提</c>

00:23:59.806 --> 00:24:03.043
<c.magenta>今天我谈其中三个比较重要的</c>

00:23:59.806 --> 00:24:03.043
<c.magenta>今天我谈其中三个比较重要的</c>

00:24:03.710 --> 00:24:07.447
<c.magenta>第一个是CKOperation</c>
<c.magenta>给你的可配置性</c>

00:24:08.315 --> 00:24:11.952
<c.magenta>第二个是它让你可以优化资源</c>

00:24:12.019 --> 00:24:14.855
<c.magenta>针对系统还有</c>
<c.magenta>作为开发者的你们</c>

00:24:16.857 --> 00:24:19.226
<c.magenta>最后 我想说一下寿命管理</c>

00:24:19.293 --> 00:24:21.295
<c.magenta>这是我们新开的一个东西</c>
<c.magenta>让你可以</c>

00:24:21.361 --> 00:24:23.530
<c.magenta>在iOS 9.3使用</c>

00:24:26.333 --> 00:24:30.437
<c.magenta>首先 快速回顾你可以给一个</c>
<c.magenta>CKOperation配置些什么</c>

00:24:31.338 --> 00:24:34.575
<c.magenta>操作让你</c>
<c.magenta>可以精确调节使用权利</c>

00:24:34.641 --> 00:24:38.045
<c.magenta>调节你想不想让这个</c>
<c.magenta>操作的网络活动</c>

00:24:38.111 --> 00:24:39.313
<c.magenta>通过手机网络来进行</c>

00:24:40.147 --> 00:24:44.985
<c.magenta>你还可以给从服务器下载东西的</c>
<c.magenta>操作设置关键词</c>

00:24:45.052 --> 00:24:48.522
<c.magenta>如果你想下载部分档案</c>
<c.magenta>而不是全部的档案</c>

00:24:48.689 --> 00:24:50.824
<c.magenta>社区的API不让你做这个</c>

00:24:52.926 --> 00:24:54.595
<c.magenta>你可以限制响应结果的数目</c>

00:24:54.661 --> 00:24:56.630
<c.magenta>一个操作</c>
<c.magenta>返回的结果</c>

00:24:58.532 --> 00:25:01.869
<c.magenta>最后 持续运行的</c>
<c.magenta>操作还会给你进度更新</c>

00:24:58.532 --> 00:25:01.869
<c.magenta>最后 持续运行的</c>
<c.magenta>操作还会给你进度更新</c>

00:25:01.935 --> 00:25:04.204
<c.magenta>你可以用这个来</c>
<c.magenta>驱动一些UI元素</c>

00:25:05.806 --> 00:25:07.908
<c.magenta>现在 我们来说一下资源优化</c>

00:25:09.243 --> 00:25:12.479
<c.magenta>你的操作在系统中</c>
<c.magenta>用得最多的资源</c>

00:25:12.546 --> 00:25:13.881
<c.magenta>是网络请求</c>

00:25:15.148 --> 00:25:17.084
<c.magenta>现在每个</c>
<c.magenta>便利API调用</c>

00:25:17.150 --> 00:25:20.087
<c.magenta>都转为系统中至少一个网络请求</c>

00:25:21.488 --> 00:25:24.091
<c.magenta>所以 当你使用</c>
<c.magenta>CKOperation批量API</c>

00:25:24.625 --> 00:25:28.061
<c.magenta>你让系统可以去</c>
<c.magenta>最小化所需要的请求数</c>

00:25:28.128 --> 00:25:30.097
<c.magenta>来将你的改动发到服务器</c>

00:25:31.031 --> 00:25:33.333
<c.magenta>比如 如果你想保存一批档案</c>

00:25:33.433 --> 00:25:35.802
<c.magenta>并且你用的是</c>
<c.magenta>CKModifiedRecordsOperation</c>

00:25:35.936 --> 00:25:40.274
<c.magenta>系统会拿这批档案</c>
<c.magenta>并且优化需要的请求</c>

00:25:40.340 --> 00:25:41.608
<c.magenta>来把这批档案发到服务器</c>

00:25:44.778 --> 00:25:48.382
<c.magenta>这样 这不仅对系统资源是一件好事</c>

00:25:48.448 --> 00:25:53.887
<c.magenta>还帮作为开发者的你们</c>
<c.magenta>优化你们的网络请求限额</c>

00:25:57.057 --> 00:26:02.863
<c.magenta>更进一步 CKOperation</c>
<c.magenta>默认让你的网络活动</c>

00:25:57.057 --> 00:26:02.863
<c.magenta>更进一步 CKOperation</c>
<c.magenta>默认让你的网络活动</c>

00:26:02.930 --> 00:26:04.364
<c.magenta>酌情进行</c>

00:26:05.599 --> 00:26:09.770
<c.magenta>我们指的是你让你的系统</c>
<c.magenta>决定一个合适的时间</c>

00:26:09.837 --> 00:26:11.338
<c.magenta>来安排你的请求</c>

00:26:12.773 --> 00:26:16.243
<c.magenta>欲知更多详情 推荐看看</c>
<c.magenta>酌情处理属性</c>

00:26:16.310 --> 00:26:18.445
<c.magenta>它在</c>
<c.magenta>NSURLSessionConfiguration里</c>

00:26:19.079 --> 00:26:21.448
<c.magenta>我们在CKOperation</c>
<c.magenta>把它呈现给你的方法</c>

00:26:21.515 --> 00:26:23.617
<c.magenta>是通过服务质量属性</c>

00:26:23.784 --> 00:26:27.554
<c.magenta>CKOperation有一个</c>
<c.magenta>默认值为实用的服务质量</c>

00:26:28.622 --> 00:26:30.557
<c.magenta>任何是实用或以下的服务质量</c>

00:26:30.624 --> 00:26:32.793
<c.magenta>会默认选择这个酌情进行的行为</c>

00:26:32.860 --> 00:26:34.962
<c.magenta>所以如果你注意到</c>
<c.magenta>CKOperation</c>

00:26:35.028 --> 00:26:38.298
<c.magenta>花了比你预计的</c>
<c.magenta>还要长很多的时间来执行</c>

00:26:38.365 --> 00:26:40.067
<c.magenta>很可能就是因为系统</c>

00:26:40.133 --> 00:26:43.136
<c.magenta>觉得现在还不是一个让你的请求</c>
<c.magenta>发出去的好时间</c>

00:26:45.072 --> 00:26:48.008
<c.magenta>还有切记的其它几个行为</c>

00:26:48.408 --> 00:26:50.444
<c.magenta>当你选择了酌情进行的行为</c>

00:26:50.844 --> 00:26:53.947
<c.magenta>网络错误就会重新尝试</c>

00:26:55.048 --> 00:26:59.052
<c.magenta>与此同时 你默认有一个</c>
<c.magenta>七天的资源超时</c>

00:26:59.253 --> 00:27:02.022
<c.magenta>你的操作执行的</c>
<c.magenta>每个请求都有这个默认超时</c>

00:26:59.253 --> 00:27:02.022
<c.magenta>你的操作执行的</c>
<c.magenta>每个请求都有这个默认超时</c>

00:27:03.457 --> 00:27:05.425
<c.magenta>这就是资源优化</c>

00:27:05.826 --> 00:27:08.695
<c.magenta>现在 我们来说说</c>
<c.magenta>CKOperation寿命管理</c>

00:27:09.696 --> 00:27:10.664
<c.magenta>在我们的平台</c>

00:27:10.731 --> 00:27:14.067
<c.magenta>你的应用退出</c>
<c.magenta>可能有多重原因</c>

00:27:14.801 --> 00:27:17.671
<c.magenta>比如 你的应用在背景可能被中止</c>

00:27:17.738 --> 00:27:20.908
<c.magenta>或删除 或者被用户强行退出</c>

00:27:21.875 --> 00:27:25.846
<c.magenta>当这些事情发生的时候</c>
<c.magenta>你可能有一些更新正在运行</c>

00:27:25.913 --> 00:27:27.514
<c.magenta>这些更新可能是用户发起的</c>

00:27:27.581 --> 00:27:30.450
<c.magenta>你就应该把它们存到服务器</c>

00:27:30.517 --> 00:27:33.387
<c.magenta>不管你的应用是否已经退出</c>

00:27:33.921 --> 00:27:36.190
<c.magenta>这些更新也可能因为</c>
<c.magenta>你有更新的运行时间比较长</c>

00:27:36.323 --> 00:27:38.725
<c.magenta>但优先度比较低</c>
<c.magenta>你想尽快完成它们</c>

00:27:38.792 --> 00:27:40.527
<c.magenta>不管你的应用还在不在</c>

00:27:41.662 --> 00:27:44.631
<c.magenta>在iOS 9.3里</c>
<c.magenta>为了达到这个目的</c>

00:27:44.698 --> 00:27:48.168
<c.magenta>我们引进了CloudKit</c>
<c.magenta>长寿命操作的概念</c>

00:27:49.670 --> 00:27:53.740
<c.magenta>这些操作</c>
<c.magenta>一旦让你标为长寿命</c>

00:27:53.807 --> 00:27:57.077
<c.magenta>系统就会替你的应用执行</c>

00:27:57.144 --> 00:27:58.846
<c.magenta>不管你的应用还在不在</c>

00:28:00.714 --> 00:28:04.651
<c.magenta>我们会缓存从这个操作</c>
<c.magenta>得到的任何服务器响应</c>

00:28:04.718 --> 00:28:08.188
<c.magenta>并且会给你提供一个</c>
<c.magenta>API来重新处理这些响应</c>

00:28:08.255 --> 00:28:09.389
<c.magenta>一旦你的应用再回来</c>

00:28:11.458 --> 00:28:14.728
<c.magenta>我们来看看我们呈现的API</c>
<c.magenta>它能做到这点</c>

00:28:15.929 --> 00:28:18.298
<c.magenta>对于CKOperation</c>
<c.magenta>这个非常直截了当</c>

00:28:18.465 --> 00:28:20.067
<c.magenta>你有一个</c>
<c.magenta>isLongLived旗标</c>

00:28:20.334 --> 00:28:22.469
<c.magenta>像正常那样建</c>
<c.magenta>一个CKOperation</c>

00:28:22.569 --> 00:28:23.804
<c.magenta>一旦你设置了这个旗标</c>

00:28:23.871 --> 00:28:25.939
<c.magenta>它就成了一个长寿命操作</c>

00:28:26.974 --> 00:28:29.343
<c.magenta>与此同时 你有一个</c>
<c.magenta>操作ID</c>

00:28:29.977 --> 00:28:31.945
<c.magenta>它是一个系统指定的字符串</c>

00:28:32.112 --> 00:28:34.681
<c.magenta>唯一地标识每个</c>
<c.magenta>CKOperation</c>

00:28:35.582 --> 00:28:38.385
<c.magenta>我们等会儿会看看</c>
<c.magenta>为什么这个很重要</c>

00:28:39.620 --> 00:28:43.190
<c.magenta>下面我们讲你怎样运行一个</c>
<c.magenta>长寿命操作的大体架构</c>

00:28:43.557 --> 00:28:46.026
<c.magenta>你像正常那样</c>
<c.magenta>初始化一个操作</c>

00:28:46.093 --> 00:28:47.628
<c.magenta>设isLongLived旗标</c>

00:28:47.694 --> 00:28:50.797
<c.magenta>再加上你的参数和回调来</c>
<c.magenta>运行这个操作</c>

00:28:51.298 --> 00:28:52.866
<c.magenta>现在 当你想</c>
<c.magenta>重新运行它的话</c>

00:28:54.067 --> 00:28:57.938
<c.magenta>你可以从CKContainer类</c>
<c.magenta>获取这个长寿命操作</c>

00:28:58.005 --> 00:28:59.573
<c.magenta>通过操作ID</c>

00:29:00.741 --> 00:29:03.677
<c.magenta>如果你想留意运行的情况</c>
<c.magenta>你可以设置回调</c>

00:29:03.844 --> 00:29:05.779
<c.magenta>可以再运行一次</c>
<c.magenta>这个操作</c>

00:29:06.813 --> 00:29:08.182
<c.magenta>我们来看一个例子</c>

00:29:08.649 --> 00:29:12.085
<c.magenta>假设我们运行一个长寿命</c>
<c.magenta>fetchRecordsOperation</c>

00:29:12.953 --> 00:29:16.156
<c.magenta>我们像正常那样用参数</c>
<c.magenta>设置这个操作</c>

00:29:16.657 --> 00:29:18.825
<c.magenta>但要记得设置</c>
<c.magenta>isLongLived旗标</c>

00:29:19.459 --> 00:29:22.663
<c.magenta>并且将操作ID属性</c>
<c.magenta>存入我们的本地缓存</c>

00:29:22.796 --> 00:29:25.599
<c.magenta>这样我们就会记得</c>
<c.magenta>这个操作代表了什么</c>

00:29:27.301 --> 00:29:29.670
<c.magenta>我们设置回调</c>
<c.magenta>且把操作加入队列</c>

00:29:29.937 --> 00:29:31.605
<c.magenta>现在 当你想要重新运行时</c>

00:29:31.939 --> 00:29:36.476
<c.magenta>就用CKContainer里的</c>
<c.magenta>fetchLongLivedOperationwithID API</c>

00:29:36.543 --> 00:29:37.744
<c.magenta>获取操作</c>

00:29:38.812 --> 00:29:40.814
<c.magenta>因为你知道</c>
<c.magenta>操作所代表的东西</c>

00:29:40.881 --> 00:29:43.083
<c.magenta>通过缓存</c>
<c.magenta>所以你可以安全地执行它</c>

00:29:43.650 --> 00:29:45.552
<c.magenta>并且设置合适的回调</c>

00:29:46.386 --> 00:29:50.190
<c.magenta>你不用再设置参数</c>
<c.magenta>或调节其它的操作属性</c>

00:29:50.257 --> 00:29:51.758
<c.magenta>你之前可能设置过</c>

00:29:52.159 --> 00:29:53.794
<c.magenta>这样重启了操作</c>

00:29:55.095 --> 00:29:59.066
<c.magenta>现在 CloudKit会重新处理</c>
<c.magenta>我们有的所有缓存响应</c>

00:29:59.132 --> 00:30:00.267
<c.magenta>给操作</c>

00:29:59.132 --> 00:30:00.267
<c.magenta>给操作</c>

00:30:00.400 --> 00:30:02.002
<c.magenta>让你跟上进度</c>

00:30:02.069 --> 00:30:04.505
<c.magenta>达到你的应用不在时</c>
<c.magenta>操作所取得的进度</c>

00:30:04.571 --> 00:30:08.141
<c.magenta>或者给你</c>
<c.magenta>操作所有的结果</c>

00:30:09.076 --> 00:30:11.945
<c.magenta>这也意味着这些操作</c>
<c.magenta>会被清理</c>

00:30:12.012 --> 00:30:13.080
<c.magenta>这是一个重要的信号</c>

00:30:13.313 --> 00:30:16.016
<c.magenta>正常情况下发生在</c>
<c.magenta>完成模块</c>

00:30:16.083 --> 00:30:17.351
<c.magenta>被操作调用</c>

00:30:18.619 --> 00:30:22.322
<c.magenta>你要记住你的应用</c>
<c.magenta>有至少24小时</c>

00:30:22.523 --> 00:30:25.592
<c.magenta>重新运行任何他们可能加入队列的</c>
<c.magenta>长寿命操作</c>

00:30:30.330 --> 00:30:33.100
<c.magenta>这就是关于CKOperation</c>
<c.magenta>API的全部内容</c>

00:30:33.700 --> 00:30:36.270
<c.magenta>现在我们转移到数据建模的话题</c>

00:30:37.437 --> 00:30:39.907
<c.magenta>今天我想给你三条主要的点子</c>

00:30:40.174 --> 00:30:42.676
<c.magenta>第一条是关于数据库架构的冗余</c>

00:30:42.743 --> 00:30:43.944
<c.magenta>你可以怎样利用它们</c>

00:30:44.011 --> 00:30:46.980
<c.magenta>还有它们怎样帮你</c>
<c.magenta>更有效利用CloudKit API</c>

00:30:47.648 --> 00:30:50.717
<c.magenta>第二条是如何用引用</c>

00:30:50.784 --> 00:30:53.420
<c.magenta>来避免你可能遇到的一类错误</c>

00:30:53.487 --> 00:30:54.821
<c.magenta>在你CloudKit应用中</c>

00:30:55.522 --> 00:30:58.091
<c.magenta>最后 我想谈一下父级引用</c>

00:30:58.225 --> 00:31:01.361
<c.magenta>是我们在这次发布里</c>
<c.magenta>新加的一种引用</c>

00:30:58.225 --> 00:31:01.361
<c.magenta>是我们在这次发布里</c>
<c.magenta>新加的一种引用</c>

00:31:01.428 --> 00:31:02.963
<c.magenta>来支持CloudKit分享</c>

00:31:04.431 --> 00:31:06.533
<c.magenta>那么 我们来说说</c>
<c.magenta>数据库架构的冗余</c>

00:31:07.568 --> 00:31:11.238
<c.magenta>我们用开发照片分享应用的例子</c>

00:31:11.972 --> 00:31:14.708
<c.magenta>现在对于这个应用 你在服务器</c>
<c.magenta>可能有的第一个东西</c>

00:31:14.775 --> 00:31:16.877
<c.magenta>就是给照片的档案类型</c>

00:31:17.311 --> 00:31:20.747
<c.magenta>你可以储存用户的高像素照片</c>

00:31:20.814 --> 00:31:25.652
<c.magenta>是在我们某款iOS设备上照的</c>
<c.magenta>储存为CKAsset</c>

00:31:27.955 --> 00:31:30.557
<c.magenta>现在 假设用户第一次启动应用</c>

00:31:30.624 --> 00:31:33.594
<c.magenta>当你像Dave之前</c>
<c.magenta>推荐的那样获取改动时</c>

00:31:33.660 --> 00:31:36.363
<c.magenta>你可能想展示一个缩略图</c>

00:31:36.430 --> 00:31:38.465
<c.magenta>囊括用户所有最近的照片</c>

00:31:38.732 --> 00:31:41.134
<c.magenta>就像这样</c>
<c.magenta>Photos应用就有这个功能</c>

00:31:42.269 --> 00:31:44.805
<c.magenta>这样一来</c>
<c.magenta>可能会造成网络带宽的巨大浪费</c>

00:31:44.872 --> 00:31:48.175
<c.magenta>的一种情形就是</c>
<c.magenta>下载全部的高清资源</c>

00:31:48.242 --> 00:31:50.410
<c.magenta>每次你打开这个页面时都下载</c>

00:31:51.211 --> 00:31:54.181
<c.magenta>那你该怎么办</c>
<c.magenta>答案非常简单</c>

00:31:54.882 --> 00:31:58.285
<c.magenta>你可以考虑在档案里</c>
<c.magenta>加入一个冗余的域</c>

00:31:58.352 --> 00:32:00.654
<c.magenta>代表缩小的资产</c>

00:31:58.352 --> 00:32:00.654
<c.magenta>代表缩小的资产</c>

00:32:02.856 --> 00:32:07.594
<c.magenta>而这可以让你</c>
<c.magenta>配合使用CKOperation</c>

00:32:08.629 --> 00:32:10.998
<c.magenta>和我们讲过的</c>
<c.magenta>所需关键词的属性</c>

00:32:11.064 --> 00:32:13.200
<c.magenta>让你可以获取部分档案</c>

00:32:13.267 --> 00:32:17.137
<c.magenta>你现在可以只获取那些</c>
<c.magenta>你需要的关键词 用来驱动UI</c>

00:32:17.204 --> 00:32:18.639
<c.magenta>你用户感兴趣的UI</c>

00:32:20.274 --> 00:32:22.342
<c.magenta>甚至能用</c>
<c.magenta>结果限制的属性</c>

00:32:22.576 --> 00:32:26.280
<c.magenta>来限制你在</c>
<c.magenta>一个页面上显示的结果数</c>

00:32:28.549 --> 00:32:31.785
<c.magenta>这样 你就可以把</c>
<c.magenta>一个优化的下载加入队列</c>

00:32:32.186 --> 00:32:34.922
<c.magenta>能够将一个动态UI</c>
<c.magenta>呈现给你的用户</c>

00:32:35.255 --> 00:32:38.125
<c.magenta>你只在需要的时候取需要的东西</c>

00:32:39.927 --> 00:32:43.163
<c.magenta>能用所需关键词属性的还有新的</c>

00:32:43.230 --> 00:32:45.632
<c.magenta>CKFetchRecordZone</c>
<c.magenta>ChangesOperation</c>

00:32:45.699 --> 00:32:47.668
<c.magenta>和CKFetchRecordsOperation</c>

00:32:47.734 --> 00:32:49.837
<c.magenta>两者都从Cloud给你获取东西</c>

00:32:51.538 --> 00:32:55.142
<c.magenta>我提醒一点 就是这些API</c>
<c.magenta>在网上也可以用</c>

00:32:55.209 --> 00:32:56.543
<c.magenta>通过CloudKit JS</c>

00:32:58.679 --> 00:33:00.814
<c.magenta>通过利用这些工具</c>
<c.magenta>你让你的用户可以</c>

00:32:58.679 --> 00:33:00.814
<c.magenta>通过利用这些工具</c>
<c.magenta>你让你的用户可以</c>

00:33:00.881 --> 00:33:03.217
<c.magenta>在你的应用里</c>
<c.magenta>有更为动态的体验</c>

00:33:03.283 --> 00:33:06.286
<c.magenta>因为他们不必</c>
<c.magenta>等你完成操作</c>

00:33:06.553 --> 00:33:09.056
<c.magenta>来下载他们会用到的数据</c>

00:33:10.757 --> 00:33:15.629
<c.magenta>接着 讨论CKReferences</c>
<c.magenta>我提醒你们这些是什么</c>

00:33:16.663 --> 00:33:21.034
<c.magenta>CloudKit让你的档案</c>
<c.magenta>可以指向其它档案</c>

00:33:21.768 --> 00:33:24.938
<c.magenta>比如 如果我这儿有两份档案</c>
<c.magenta>档案A和档案B</c>

00:33:25.339 --> 00:33:27.574
<c.magenta>我们把引用存在档案A上</c>

00:33:28.108 --> 00:33:29.743
<c.magenta>用档案B来给它初始化</c>

00:33:30.277 --> 00:33:31.979
<c.magenta>创建了CKReference</c>

00:33:33.547 --> 00:33:36.617
<c.magenta>现在假设我们想给</c>
<c.magenta>我们的照片分享应用添加相册</c>

00:33:37.050 --> 00:33:38.952
<c.magenta>可以涵括多张照片</c>

00:33:39.019 --> 00:33:42.389
<c.magenta>我们怎样可以给</c>
<c.magenta>这个一对多的关系建模呢？</c>

00:33:44.424 --> 00:33:46.293
<c.magenta>简单地</c>

00:33:46.360 --> 00:33:49.663
<c.magenta>而又天真地 你会觉得</c>
<c.magenta>下面的建模方法比较好</c>

00:33:50.264 --> 00:33:54.034
<c.magenta>储存档案ID</c>
<c.magenta>档案ID用来引用照片档案</c>

00:33:54.101 --> 00:33:57.738
<c.magenta>把ID作为一个数组直接存在</c>
<c.magenta>照片所属相册的相册档案里</c>

00:33:59.339 --> 00:34:00.807
<c.magenta>这就是概念图</c>

00:33:59.339 --> 00:34:00.807
<c.magenta>这就是概念图</c>

00:34:02.142 --> 00:34:06.380
<c.magenta>现在 我们来瞧瞧当你用户的多个设备</c>

00:34:06.446 --> 00:34:09.949
<c.magenta>尝试添加照片到</c>
<c.magenta>相同的相册会发生些什么</c>

00:34:12.152 --> 00:34:14.221
<c.magenta>假设我们在Cloud</c>
<c.magenta>有一个相册档案</c>

00:34:14.288 --> 00:34:15.822
<c.magenta>相册还没有照片</c>

00:34:17.424 --> 00:34:20.427
<c.magenta>现在 记得你的用户会有多台设备</c>

00:34:21.762 --> 00:34:23.397
<c.magenta>它们都获取这个相册记录</c>

00:34:24.231 --> 00:34:26.733
<c.magenta>看到相册没有照片</c>
<c.magenta>它们很满意</c>

00:34:28.969 --> 00:34:29.969
<c.magenta>设备现在都有了新照片</c>

00:34:30.036 --> 00:34:32.706
<c.magenta>它们各自有想加到</c>
<c.magenta>同一个相册的照片</c>

00:34:34.208 --> 00:34:36.476
<c.magenta>所以它们把档案更新加入队列</c>

00:34:37.110 --> 00:34:38.812
<c.magenta>假设iPhone档案</c>
<c.magenta>最先到相册</c>

00:34:38.879 --> 00:34:41.014
<c.magenta>服务器现在知道有一张照片</c>

00:34:41.081 --> 00:34:43.050
<c.magenta>对其中一张照片的引用</c>

00:34:44.184 --> 00:34:48.021
<c.magenta>当别的新设备加入进来</c>
<c.magenta>并且尝试更新时</c>

00:34:48.121 --> 00:34:51.291
<c.magenta>它们更新的不再是</c>
<c.magenta>最新的服务器档案</c>

00:34:52.259 --> 00:34:56.263
<c.magenta>所以 在这个案例里</c>
<c.magenta>两台设备都会出现错误</c>

00:34:56.330 --> 00:34:58.465
<c.magenta>CKError</c>
<c.magenta>serverRecordChanged</c>

00:34:59.366 --> 00:35:02.970
<c.magenta>现在 我推荐你们去看我们的</c>
<c.magenta>进阶CloudKit演讲</c>

00:34:59.366 --> 00:35:02.970
<c.magenta>现在 我推荐你们去看我们的</c>
<c.magenta>进阶CloudKit演讲</c>

00:35:03.036 --> 00:35:07.040
<c.magenta>是2014年的WWDC</c>
<c.magenta>你会学到更多如何处理这个错误的细节</c>

00:35:07.608 --> 00:35:11.211
<c.magenta>不过 现在我们来看</c>
<c.magenta>可不可以完全避免它</c>

00:35:13.680 --> 00:35:17.618
<c.magenta>在这个例子里 我们知道我们的</c>
<c.magenta>相册档案会有频繁的写操作</c>

00:35:17.985 --> 00:35:21.255
<c.magenta>所以 取而代之 如果我们</c>
<c.magenta>一对多关系的建模</c>

00:35:21.321 --> 00:35:26.059
<c.magenta>用的是一个反向指针</c>
<c.magenta>把引用存在照片档案上</c>

00:35:26.994 --> 00:35:28.428
<c.magenta>照片归属这个相册</c>

00:35:28.762 --> 00:35:30.063
<c.magenta>这样我们就彻底排除了</c>

00:35:30.130 --> 00:35:32.766
<c.magenta>我们在相册档案上的</c>
<c.magenta>写操作纠纷</c>

00:35:34.268 --> 00:35:36.670
<c.magenta>在这个情况下</c>
<c.magenta>每当你加入新的照片时</c>

00:35:37.004 --> 00:35:40.307
<c.magenta>你就设置它引用所属的相册的档案</c>

00:35:40.374 --> 00:35:41.742
<c.magenta>并且保存照片档案</c>

00:35:43.977 --> 00:35:47.781
<c.magenta>这么做的话 你就可以完全</c>
<c.magenta>排除掉你之前有的纠纷</c>

00:35:48.415 --> 00:35:50.984
<c.magenta>你还会想知道</c>
<c.magenta>我怎样可以获取所有照片</c>

00:35:51.051 --> 00:35:52.886
<c.magenta>这就是我们一开始遇到的问题</c>

00:35:53.187 --> 00:35:55.556
<c.magenta>为了达到这个目的 你可以用请求</c>

00:35:58.559 --> 00:36:02.763
<c.magenta>你要获取归属</c>
<c.magenta>这个相册的所有照片记录</c>

00:35:58.559 --> 00:36:02.763
<c.magenta>你要获取归属</c>
<c.magenta>这个相册的所有照片记录</c>

00:36:02.829 --> 00:36:03.997
<c.magenta>这非常简单直白</c>

00:36:04.064 --> 00:36:07.134
<c.magenta>你要的就是相册的引用域</c>

00:36:07.201 --> 00:36:09.236
<c.magenta>那儿有你所有的照片档案</c>

00:36:12.005 --> 00:36:14.074
<c.magenta>下面 我们来讲父级引用</c>

00:36:15.509 --> 00:36:16.910
<c.magenta>今年 在CKRecord</c>

00:36:16.977 --> 00:36:20.214
<c.magenta>我们加了新的一类引用</c>
<c.magenta>叫父级引用</c>

00:36:20.280 --> 00:36:22.316
<c.magenta>帮你给数据建模</c>

00:36:22.382 --> 00:36:24.585
<c.magenta>并且更好地支持</c>
<c.magenta>CloudKit分享</c>

00:36:25.752 --> 00:36:27.454
<c.magenta>我们推荐的是</c>

00:36:27.521 --> 00:36:31.124
<c.magenta>如果你的应用支持分享</c>
<c.magenta>你就用父级引用</c>

00:36:31.325 --> 00:36:33.627
<c.magenta>来建立一个等级制数据模型</c>

00:36:34.695 --> 00:36:36.830
<c.magenta>规定好你应用分享的单元</c>

00:36:36.897 --> 00:36:38.799
<c.magenta>并且根据情况来设置父级引用</c>

00:36:38.866 --> 00:36:41.268
<c.magenta>我们来看看一个例子</c>
<c.magenta>来解释我刚说的内容</c>

00:36:43.971 --> 00:36:47.541
<c.magenta>我们的照片和相册档案是一个</c>
<c.magenta>父级引用的很棒的例子</c>

00:36:48.509 --> 00:36:51.578
<c.magenta>相册很明显是照片档案的父亲</c>

00:36:51.879 --> 00:36:54.147
<c.magenta>我们只需设置父母属性</c>

00:36:54.515 --> 00:36:57.150
<c.magenta>在照片档案上</c>
<c.magenta>指向我们相册档案的ID</c>

00:36:58.085 --> 00:36:59.553
<c.magenta>并且保存照片档案</c>

00:37:02.823 --> 00:37:05.526
<c.magenta>现在 假设我们在我们</c>
<c.magenta>应用里都用这个模型</c>

00:37:05.826 --> 00:37:08.128
<c.magenta>我们有一个像这样的等级分配</c>

00:37:08.529 --> 00:37:11.732
<c.magenta>现在 一个用户想分享整个相册</c>

00:37:12.432 --> 00:37:14.134
<c.magenta>这种情况下你需要做的只是</c>

00:37:14.201 --> 00:37:17.871
<c.magenta>创建一个CKShare</c>
<c.magenta>附上相册档案作为组档案</c>

00:37:18.172 --> 00:37:20.841
<c.magenta>你一下子便可以分享整个等级分层</c>

00:37:20.908 --> 00:37:22.876
<c.magenta>你就是用父级引用来建立的这个等级</c>

00:37:24.511 --> 00:37:27.781
<c.magenta>现在 CloudKit还支持</c>
<c.magenta>部分分享的等级制</c>

00:37:28.615 --> 00:37:33.353
<c.magenta>这种情况下</c>
<c.magenta>比如用户只想分享照片C</c>

00:37:34.188 --> 00:37:36.557
<c.magenta>你可以创建一个分享</c>
<c.magenta>只附上照片C</c>

00:37:36.823 --> 00:37:38.025
<c.magenta>这样</c>

00:37:39.193 --> 00:37:42.963
<c.magenta>只有照片C</c>
<c.magenta>还有它的所有子代</c>

00:37:43.030 --> 00:37:45.566
<c.magenta>通过父级设置将加入这个分享</c>

00:37:47.367 --> 00:37:48.969
<c.magenta>以上就是数据建模</c>

00:37:50.604 --> 00:37:52.072
<c.magenta>我们来谈谈错误处理</c>

00:37:52.873 --> 00:37:55.442
<c.magenta>现在 我们有不同类型的错误</c>

00:37:55.509 --> 00:37:57.611
<c.magenta>而你的应用应该处理它们</c>

00:37:57.678 --> 00:38:00.280
<c.magenta>通过几个主要的不同方法</c>

00:37:57.678 --> 00:38:00.280
<c.magenta>通过几个主要的不同方法</c>

00:38:00.347 --> 00:38:01.982
<c.magenta>我们来看看它们各是什么样的</c>

00:38:03.183 --> 00:38:04.685
<c.magenta>我们有一个简单的例子</c>

00:38:04.751 --> 00:38:06.587
<c.magenta>假设你的设备</c>

00:38:06.653 --> 00:38:08.689
<c.magenta>选择一个</c>
<c.magenta>CKModifyRecordsOperation</c>

00:38:08.755 --> 00:38:10.157
<c.magenta>尝试跟服务器连接</c>

00:38:10.624 --> 00:38:13.760
<c.magenta>服务器有可能响应</c>
<c.magenta>两种主要的东西</c>

00:38:14.061 --> 00:38:18.131
<c.magenta>它可以说</c>
<c.magenta>我一点儿也不喜欢这个请求</c>

00:38:18.198 --> 00:38:19.800
<c.magenta>别再试着跟我连接</c>

00:38:20.901 --> 00:38:24.037
<c.magenta>或者它可以说你的请求什么都好</c>

00:38:24.171 --> 00:38:28.208
<c.magenta>就是现在的时间不太合适</c>
<c.magenta>等会儿再试一次吧</c>

00:38:29.476 --> 00:38:32.412
<c.magenta>你们的应用需要</c>
<c.magenta>处理这两种错误</c>

00:38:32.479 --> 00:38:35.516
<c.magenta>而且要用很不同的方法</c>
<c.magenta>我们来仔细看看到底是什么</c>

00:38:36.884 --> 00:38:39.052
<c.magenta>第一种错误是致命错误</c>

00:38:39.386 --> 00:38:40.621
<c.magenta>你基本上无能为力</c>

00:38:41.922 --> 00:38:44.725
<c.magenta>我们有几个错误代码</c>
<c.magenta>表明你遇到的错误是严重的</c>

00:38:45.425 --> 00:38:49.263
<c.magenta>比如内部错误</c>
<c.magenta>服务器拒绝请求</c>

00:38:50.197 --> 00:38:53.567
<c.magenta>非法参数</c>
<c.magenta>或者权限失败</c>

00:38:54.801 --> 00:38:59.273
<c.magenta>你要在你的应用里</c>
<c.magenta>给你的用户显示合适的UI</c>

00:38:59.339 --> 00:39:02.442
<c.magenta>让他们知道出错误了</c>
<c.magenta>重试也没辙</c>

00:38:59.339 --> 00:39:02.442
<c.magenta>让他们知道出错误了</c>
<c.magenta>重试也没辙</c>

00:39:04.545 --> 00:39:06.513
<c.magenta>然而 另外一种错误</c>

00:39:06.880 --> 00:39:10.184
<c.magenta>服务器让你歇一会儿再重试</c>

00:39:10.417 --> 00:39:13.954
<c.magenta>我们会告诉你</c>
<c.magenta>服务器想让你等的时间</c>

00:39:15.022 --> 00:39:19.526
<c.magenta>下面是一系列错误代码</c>
<c.magenta>每个里面都嵌入了时间值</c>

00:39:20.894 --> 00:39:26.066
<c.magenta>zoneBusy serviceUnavailable</c>
<c.magenta>和requestRateLimited</c>

00:39:27.334 --> 00:39:29.303
<c.magenta>当你收到这些错误代码中的</c>
<c.magenta>任意一个时</c>

00:39:29.369 --> 00:39:32.372
<c.magenta>你要找到</c>
<c.magenta>CKErrorRetryAfterKey</c>

00:39:32.439 --> 00:39:34.441
<c.magenta>在错误的用户信息字典里面</c>

00:39:34.908 --> 00:39:39.246
<c.magenta>你要等上面说明的时间并且重新初始化</c>
<c.magenta>同一个CKOperation</c>

00:39:39.313 --> 00:39:43.283
<c.magenta>用相同的参数</c>
<c.magenta>并重试这个操作</c>

00:39:44.151 --> 00:39:46.386
<c.magenta>下面是一个简单的例子</c>
<c.magenta>还有你需要的所有代码</c>

00:39:46.453 --> 00:39:48.355
<c.magenta>如何等一段时间</c>

00:39:48.422 --> 00:39:51.225
<c.magenta>而CKErrorRetryAfterValue</c>
<c.magenta>代表了这个时间值</c>

00:39:51.525 --> 00:39:53.894
<c.magenta>如何重新初始化</c>
<c.magenta>同一个CKOperation</c>

00:39:56.330 --> 00:39:58.565
<c.magenta>注意 如果有些时候</c>

00:39:58.632 --> 00:40:01.001
<c.magenta>你的操作可能</c>
<c.magenta>在设备上出现错误</c>

00:39:58.632 --> 00:40:01.001
<c.magenta>你的操作可能</c>
<c.magenta>在设备上出现错误</c>

00:40:01.068 --> 00:40:02.703
<c.magenta>而甚至还没连到服务器</c>
<c.magenta>怎么办？</c>

00:40:03.737 --> 00:40:06.006
<c.magenta>我今天讲解两种主要的情况</c>

00:40:06.073 --> 00:40:08.475
<c.magenta>CloudKit可能完全用不了</c>

00:40:09.376 --> 00:40:11.845
<c.magenta>第一种是设备处于下线状态</c>

00:40:13.680 --> 00:40:15.549
<c.magenta>这种情况下 我们推荐</c>

00:40:15.916 --> 00:40:19.720
<c.magenta>你监测可能连到的网络</c>
<c.magenta>就像</c>

00:40:19.786 --> 00:40:21.455
<c.magenta>在别的基于网络的</c>
<c.magenta>应用里做的一样</c>

00:40:22.923 --> 00:40:26.960
<c.magenta>若你用的服务质量</c>
<c.magenta>是用户发起或者更高等级</c>

00:40:27.127 --> 00:40:31.632
<c.magenta>而网络错误不会自动为你重试</c>

00:40:31.698 --> 00:40:35.002
<c.magenta>你会看到这个错误代码</c>
<c.magenta>CKErrorNetworkUnavailable</c>

00:40:35.903 --> 00:40:37.671
<c.magenta>一旦你监测可连接的网络</c>

00:40:37.738 --> 00:40:40.674
<c.magenta>你可以通过SCNetworkReachability</c>
<c.magenta>API 做到这点</c>

00:40:40.741 --> 00:40:43.210
<c.magenta>比如在系统配置框架里</c>

00:40:44.578 --> 00:40:46.213
<c.magenta>这样你就可以让你的用户知道</c>

00:40:46.280 --> 00:40:50.017
<c.magenta>“嘿 这些改动现还传不到服务器上”</c>

00:40:50.484 --> 00:40:55.122
<c.magenta>但我们推荐你让你的用户</c>
<c.magenta>保持跟应用的互动</c>

00:40:55.189 --> 00:40:56.590
<c.magenta>即便设备处于下线状态</c>

00:40:56.823 --> 00:40:59.626
<c.magenta>你应该把这些改动</c>
<c.magenta>存在你的本地缓存中</c>

00:40:59.960 --> 00:41:03.330
<c.magenta>当可连接性API</c>
<c.magenta>告诉你设备重新上线时</c>

00:40:59.960 --> 00:41:03.330
<c.magenta>当可连接性API</c>
<c.magenta>告诉你设备重新上线时</c>

00:41:03.530 --> 00:41:07.100
<c.magenta>你就可把CloudKit操作</c>
<c.magenta>加入队列并把档案存到服务器上了</c>

00:41:10.070 --> 00:41:14.208
<c.magenta>另一种主要的情况是</c>
<c.magenta>当你想给用户用私人数据库</c>

00:41:14.274 --> 00:41:16.677
<c.magenta>而用户没有登录到</c>
<c.magenta>一个iCloud账户的时候</c>

00:41:17.411 --> 00:41:21.548
<c.magenta>此情况下 返回错误代码</c>
<c.magenta>CKErrorNotAuthenticatedTo</c>

00:41:22.816 --> 00:41:25.419
<c.magenta>我们推荐的是 对于你所有的应用</c>

00:41:25.485 --> 00:41:30.357
<c.magenta>在首次启动一定要登记侦听</c>
<c.magenta>CKAccountChange通知</c>

00:41:31.892 --> 00:41:36.129
<c.magenta>当它触发时 用 accountStatus</c>
<c.magenta>completionHandler API</c>

00:41:36.396 --> 00:41:38.899
<c.magenta>来重新获取</c>
<c.magenta>当前用户的账户状态</c>

00:41:39.266 --> 00:41:42.503
<c.magenta>告知他们</c>
<c.magenta>一些操作会失败</c>

00:41:42.569 --> 00:41:44.738
<c.magenta>因为他们没有登录</c>
<c.magenta>一个iCloud账号</c>

00:41:47.007 --> 00:41:49.543
<c.magenta>我来总结一下</c>
<c.magenta>我们今天都看了哪些内容</c>

00:41:51.144 --> 00:41:53.947
<c.magenta>我们学习了如何订阅并且获取改动</c>

00:41:54.014 --> 00:41:56.283
<c.magenta>来高效地和服务器同步</c>

00:41:57.718 --> 00:42:01.522
<c.magenta>我们领略了使用批量</c>
<c.magenta>CKOperation API优势</c>

00:41:57.718 --> 00:42:01.522
<c.magenta>我们领略了使用批量</c>
<c.magenta>CKOperation API优势</c>

00:42:02.022 --> 00:42:04.424
<c.magenta>我们推荐你</c>
<c.magenta>所有的应用都采用它</c>

00:42:06.126 --> 00:42:08.695
<c.magenta>我们也研究了几个点子</c>
<c.magenta>如何设计你的数据库架构</c>

00:42:08.762 --> 00:42:11.031
<c.magenta>来完全避免一类错误</c>

00:42:11.098 --> 00:42:13.300
<c.magenta>或更有效利用</c>
<c.magenta>CloudKit API</c>

00:42:14.935 --> 00:42:18.605
<c.magenta>最后 我们探讨了</c>
<c.magenta>如何处理一些类型的错误</c>

00:42:18.672 --> 00:42:20.541
<c.magenta>还有如何分辨它们</c>

00:42:21.742 --> 00:42:24.211
<c.magenta>还有服务器的意图 当它返回</c>

00:42:24.278 --> 00:42:26.446
<c.magenta>一些特定错误代码 而不是其它代码</c>

00:42:28.182 --> 00:42:31.051
<c.magenta>我们昨天有一个相关演讲</c>
<c.magenta>如果你没有去</c>

00:42:31.118 --> 00:42:33.520
<c.magenta>我推荐你回去在网上补看回来</c>

00:42:34.254 --> 00:42:37.357
<c.magenta>这儿有更多的信息</c>
<c.magenta>谢谢你们 祝你们有很棒的一天</c>
