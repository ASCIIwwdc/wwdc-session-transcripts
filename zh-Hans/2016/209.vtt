WEBVTT

00:00:19.987 --> 00:00:23.690
<c.magenta>发挥HealthKit最大价值</c>

00:00:28.195 --> 00:00:31.398
<c.magenta>早上好 欢迎来到</c>
<c.magenta>“发挥HealthKit最大价值”</c>

00:00:31.899 --> 00:00:34.635
<c.magenta>我是Matt</c>
<c.magenta>HealthKit团队软件工程师</c>

00:00:34.768 --> 00:00:37.304
<c.magenta>稍后这个舞台</c>
<c.magenta>会交给我的同事Jeff</c>

00:00:38.138 --> 00:00:41.475
<c.magenta>本场演讲 我们会讲一些</c>
<c.magenta>很棒的新功能</c>

00:00:41.542 --> 00:00:44.511
<c.magenta>是iOS 10和watchOS 3中</c>
<c.magenta>HealthKit API的新拓展</c>

00:00:45.412 --> 00:00:48.715
<c.magenta>与此同时</c>
<c.magenta>我们也会讲到一些主要的新特性</c>

00:00:48.782 --> 00:00:51.685
<c.magenta>核心概念和重要的工作流程</c>
<c.magenta>以确保</c>

00:00:51.752 --> 00:00:54.621
<c.magenta>你真正可以</c>
<c.magenta>充分利用HealthKit的价值</c>

00:00:55.889 --> 00:00:57.791
<c.magenta>希望你已经</c>
<c.magenta>对HealthKit有所了解</c>

00:00:57.858 --> 00:00:59.393
<c.magenta>若你在此观看这场演讲</c>

00:00:59.459 --> 00:01:01.228
<c.magenta>如果不是</c>
<c.magenta>我们会列出之前的演讲</c>

00:00:59.459 --> 00:01:01.228
<c.magenta>如果不是</c>
<c.magenta>我们会列出之前的演讲</c>

00:01:01.295 --> 00:01:02.262
<c.magenta>在这场演讲最后</c>

00:01:02.329 --> 00:01:04.397
<c.magenta>供你日后参考</c>
<c.magenta>来快速了解这些内容</c>

00:01:05.065 --> 00:01:06.834
<c.magenta>但是现在</c>
<c.magenta>我们开始讲今天的内容</c>

00:01:09.837 --> 00:01:13.240
<c.magenta>在座的都知道</c>
<c.magenta>Apple的健康与健身生态系统</c>

00:01:13.307 --> 00:01:15.375
<c.magenta>在我们的用户中</c>
<c.magenta>大受好评</c>

00:01:16.043 --> 00:01:18.145
<c.magenta>人们越来越健美</c>
<c.magenta>也越来越健康</c>

00:01:18.212 --> 00:01:20.214
<c.magenta>这归功于我们将</c>
<c.magenta>HealthKit</c>

00:01:20.280 --> 00:01:22.482
<c.magenta>ResearchKit</c>
<c.magenta>和CareKit</c>

00:01:22.549 --> 00:01:25.319
<c.magenta>在iPhone和Apple Watch上</c>
<c.magenta>与你的应用和设备结合在一起</c>

00:01:26.353 --> 00:01:28.288
<c.magenta>我们想保证</c>
<c.magenta>你们可以</c>

00:01:28.355 --> 00:01:31.458
<c.magenta>一直创造这些很棒的</c>
<c.magenta>有关健康和健美的用户体验</c>

00:01:31.525 --> 00:01:33.827
<c.magenta>让我们的用户</c>
<c.magenta>有所期待并享受其中</c>

00:01:35.195 --> 00:01:38.565
<c.magenta>那么今天我们就来看看</c>
<c.magenta>你都要做哪些事情</c>

00:01:38.632 --> 00:01:40.467
<c.magenta>来确保这些体验</c>
<c.magenta>正确而且理想</c>

00:01:41.835 --> 00:01:43.637
<c.magenta>首先来讲授权</c>

00:01:43.704 --> 00:01:46.240
<c.magenta>这是HealthKit</c>
<c.magenta>所有其他功能的基础</c>

00:01:47.040 --> 00:01:51.512
<c.magenta>然后是Activity Rings API</c>
<c.magenta>在iOS 9.3下引入的</c>

00:01:51.879 --> 00:01:54.381
<c.magenta>还有健康记录</c>
<c.magenta>今年在iOS 10系统下发布的</c>

00:01:54.848 --> 00:01:57.317
<c.magenta>这两个都会产生</c>
<c.magenta>一些重要的影响</c>

00:01:57.384 --> 00:01:58.685
<c.magenta>与授权相关</c>

00:02:00.587 --> 00:02:02.389
<c.magenta>最后</c>
<c.magenta>在剩下的时间里</c>

00:02:02.456 --> 00:02:05.559
<c.magenta>我们会讲解各种</c>
<c.magenta>处理数据的好方法</c>

00:02:05.692 --> 00:02:07.561
<c.magenta>在你与HealthKit互动时</c>

00:02:10.864 --> 00:02:11.698
<c.magenta>现在就开始讲吧</c>

00:02:12.165 --> 00:02:13.901
<c.magenta>首先就是授权</c>

00:02:14.468 --> 00:02:16.370
<c.magenta>若你使用HealthKit</c>
<c.magenta>一段时间</c>

00:02:16.436 --> 00:02:18.939
<c.magenta>那么这里大部分内容</c>
<c.magenta>对你来说可能就是回顾</c>

00:02:19.239 --> 00:02:21.909
<c.magenta>但我们建议你</c>
<c.magenta>重点关注一些细节</c>

00:02:21.975 --> 00:02:25.045
<c.magenta>因为它们很重要</c>
<c.magenta>对我们过会儿要讲的内容而言</c>

00:02:25.212 --> 00:02:28.382
<c.magenta>我们也会讲到一些最佳操作</c>
<c.magenta>所以竖起耳朵听</c>

00:02:31.084 --> 00:02:34.388
<c.magenta>iOS让用户</c>
<c.magenta>能完全掌握他们的健康数据</c>

00:02:34.488 --> 00:02:37.124
<c.magenta>以及哪个应用可以访问</c>
<c.magenta>哪一部分数据</c>

00:02:38.258 --> 00:02:39.893
<c.magenta>在与HealthKit互动前</c>

00:02:40.093 --> 00:02:43.797
<c.magenta>你的应用需要请求许可</c>
<c.magenta>通过HK Health Store访问正确的类型</c>

00:02:44.364 --> 00:02:46.266
<c.magenta>Health Store反过来会显示</c>

00:02:46.333 --> 00:02:49.203
<c.magenta>一个正确的授权UI给用户</c>
<c.magenta>如果有必要的话</c>

00:02:51.038 --> 00:02:54.341
<c.magenta>注意 用户可以随时更改</c>
<c.magenta>给你应用的权限</c>

00:02:54.408 --> 00:02:56.777
<c.magenta>在开发应用的时候</c>
<c.magenta>一定要记住这一点</c>

00:02:57.811 --> 00:03:01.348
<c.magenta>同样重要的是</c>
<c.magenta>读授权和写授权</c>

00:02:57.811 --> 00:03:01.348
<c.magenta>同样重要的是</c>
<c.magenta>读授权和写授权</c>

00:03:01.415 --> 00:03:02.783
<c.magenta>完全独立不相干</c>

00:03:03.383 --> 00:03:05.152
<c.magenta>最后这点</c>
<c.magenta>是有点复杂</c>

00:03:05.219 --> 00:03:07.254
<c.magenta>所以</c>
<c.magenta>我们来讲的更细一点</c>

00:03:11.191 --> 00:03:13.293
<c.magenta>这里看到的是</c>
<c.magenta>读和写的授权如何运行</c>

00:03:14.094 --> 00:03:15.362
<c.magenta>如果用户同时授权你</c>

00:03:15.429 --> 00:03:17.998
<c.magenta>读和写的许可</c>
<c.magenta>给一个指定的HealthKit类型</c>

00:03:18.298 --> 00:03:20.133
<c.magenta>那么你的应用</c>
<c.magenta>可以如你所愿地查询并保存</c>

00:03:20.200 --> 00:03:22.302
<c.magenta>这个HealthKit类型的数据</c>

00:03:23.337 --> 00:03:26.173
<c.magenta>如果用户只给你</c>
<c.magenta>读某个类型的权限</c>

00:03:26.340 --> 00:03:27.174
<c.magenta>那么你的应用可读</c>

00:03:27.241 --> 00:03:29.076
<c.magenta>但是不可改写</c>
<c.magenta>这个HealthKit类型的数据</c>

00:03:29.142 --> 00:03:30.010
<c.magenta>到目前一切都好</c>

00:03:31.778 --> 00:03:34.581
<c.magenta>现在 如果用户给你</c>
<c.magenta>改写某个类型的权限</c>

00:03:35.048 --> 00:03:37.417
<c.magenta>那么你的应用可以改写</c>
<c.magenta>HealthKit中这个类型的数据</c>

00:03:37.484 --> 00:03:39.653
<c.magenta>但不能从HealthKit</c>
<c.magenta>回读这个类型</c>

00:03:40.120 --> 00:03:43.023
<c.magenta>有写的权限</c>
<c.magenta>不意味有读的权限</c>

00:03:43.390 --> 00:03:45.959
<c.magenta>但是</c>
<c.magenta>这有一个很重要的例外</c>

00:03:46.326 --> 00:03:48.629
<c.magenta>如果你的应用</c>
<c.magenta>可改写HealthKit类型</c>

00:03:48.695 --> 00:03:51.698
<c.magenta>那么你可以回读</c>
<c.magenta>你的应用所写的内容</c>

00:03:51.765 --> 00:03:53.400
<c.magenta>只是不能读</c>
<c.magenta>其他来源的数据</c>

00:03:55.369 --> 00:03:57.104
<c.magenta>最后 如果用户拒绝</c>

00:03:57.171 --> 00:03:59.339
<c.magenta>对某个类型</c>
<c.magenta>所有读和写的权限</c>

00:03:59.406 --> 00:04:01.909
<c.magenta>那你就既不能查询</c>
<c.magenta>也不能保存这个类型</c>

00:03:59.406 --> 00:04:01.909
<c.magenta>那你就既不能查询</c>
<c.magenta>也不能保存这个类型</c>

00:04:02.709 --> 00:04:05.279
<c.magenta>最后这一点</c>
<c.magenta>会产生重要的影响</c>

00:04:05.412 --> 00:04:09.183
<c.magenta>如果用户拒绝了</c>
<c.magenta>之前授权给应用的许可</c>

00:04:09.583 --> 00:04:11.752
<c.magenta>那么你的应用</c>
<c.magenta>就无法再读取任何</c>

00:04:11.818 --> 00:04:13.220
<c.magenta>这个HealthKit类型的数据</c>

00:04:13.387 --> 00:04:17.024
<c.magenta>即便是你的应用之前写的数据</c>
<c.magenta>一定要牢记这一点</c>

00:04:21.195 --> 00:04:22.863
<c.magenta>以上就是所有的技术回顾</c>

00:04:22.930 --> 00:04:26.667
<c.magenta>但是这里iOS X的授权</c>
<c.magenta>有个重要的变化</c>

00:04:26.733 --> 00:04:28.769
<c.magenta>它与使用说明相关</c>

00:04:30.070 --> 00:04:34.174
<c.magenta>iOS X及以后版本的应用</c>
<c.magenta>必须为用户提供一个说明</c>

00:04:34.241 --> 00:04:36.210
<c.magenta>说明他们为什么要</c>
<c.magenta>访问健康数据</c>

00:04:36.643 --> 00:04:39.546
<c.magenta>这也是再次强调了我们的原则</c>
<c.magenta>就是用户控制数据</c>

00:04:41.348 --> 00:04:45.118
<c.magenta>使用说明应当在</c>
<c.magenta>应用的info.plist文件中声明</c>

00:04:45.185 --> 00:04:48.488
<c.magenta>为NSHealthShareUsageDescription验证码</c>

00:04:48.555 --> 00:04:49.590
<c.magenta>这是读取数据的时候</c>

00:04:50.324 --> 00:04:53.460
<c.magenta>或者声明为NSHealthUpdateUsageDescription</c>
<c.magenta>在改写数据的时候</c>

00:04:56.129 --> 00:04:58.799
<c.magenta>换个画面</c>
<c.magenta>来看看你如何请求授权</c>

00:04:59.766 --> 00:05:02.402
<c.magenta>第一件事</c>
<c.magenta>是保证HealthKit</c>

00:04:59.766 --> 00:05:02.402
<c.magenta>第一件事</c>
<c.magenta>是保证HealthKit</c>

00:05:02.469 --> 00:05:04.071
<c.magenta>可用于当前设备</c>

00:05:04.137 --> 00:05:07.107
<c.magenta>比如说</c>
<c.magenta>iPad上的应用就不行</c>

00:05:07.875 --> 00:05:09.243
<c.magenta>建好这个之后</c>

00:05:09.409 --> 00:05:12.179
<c.magenta>我们列举一些类型</c>
<c.magenta>是我们想要读取和改写的</c>

00:05:12.813 --> 00:05:14.781
<c.magenta>最后</c>
<c.magenta>调出requestAuthorization</c>

00:05:14.848 --> 00:05:17.718
<c.magenta>在HK Health Store里</c>
<c.magenta>传递我们感兴趣的类型</c>

00:05:17.784 --> 00:05:19.686
<c.magenta>然后处理反馈</c>
<c.magenta>并回调</c>

00:05:23.123 --> 00:05:24.458
<c.magenta>watchOS应用怎么办？</c>

00:05:25.125 --> 00:05:27.594
<c.magenta>授权可以共享于</c>
<c.magenta>你的iOS应用</c>

00:05:27.661 --> 00:05:29.129
<c.magenta>和匹配的watchOS应用</c>

00:05:29.463 --> 00:05:31.665
<c.magenta>请求授权</c>
<c.magenta>可以随时进行</c>

00:05:31.732 --> 00:05:33.634
<c.magenta>通过iOS代码</c>
<c.magenta>或者watchOS代码</c>

00:05:34.434 --> 00:05:36.503
<c.magenta>但是 系统授权UI</c>

00:05:36.570 --> 00:05:38.772
<c.magenta>只能显示于</c>
<c.magenta>用户的手机上</c>

00:05:39.039 --> 00:05:41.441
<c.magenta>因此这就造成了</c>
<c.magenta>重要的可用性问题</c>

00:05:42.609 --> 00:05:45.412
<c.magenta>比如</c>
<c.magenta>用户准备开始锻炼</c>

00:05:45.479 --> 00:05:47.714
<c.magenta>他们可能已经</c>
<c.magenta>把手机绑在了臂带上</c>

00:05:47.781 --> 00:05:48.782
<c.magenta>如果是这样</c>

00:05:49.183 --> 00:05:52.152
<c.magenta>他们很难允许</c>
<c.magenta>你的应用发出的授权请求</c>

00:05:52.219 --> 00:05:55.322
<c.magenta>所以这就不是</c>
<c.magenta>请求初始授权的好时机</c>

00:05:57.457 --> 00:05:59.259
<c.magenta>但是还有一个更麻烦的情况</c>

00:05:59.860 --> 00:06:02.996
<c.magenta>如果用户使用Watch应用</c>
<c.magenta>手机可能根本不在身边</c>

00:05:59.860 --> 00:06:02.996
<c.magenta>如果用户使用Watch应用</c>
<c.magenta>手机可能根本不在身边</c>

00:06:03.063 --> 00:06:03.931
<c.magenta>这样的话</c>

00:06:04.031 --> 00:06:06.266
<c.magenta>请求表单</c>
<c.magenta>甚至都无法显示</c>

00:06:06.934 --> 00:06:09.536
<c.magenta>因此我们建议你</c>
<c.magenta>实际考虑一下这些问题</c>

00:06:09.603 --> 00:06:11.371
<c.magenta>在开发Watch应用的时候</c>

00:06:12.439 --> 00:06:15.876
<c.magenta>同样要记住</c>
<c.magenta>请求授权调令的反馈时间</c>

00:06:15.943 --> 00:06:16.844
<c.magenta>没有保证</c>

00:06:16.910 --> 00:06:20.347
<c.magenta>所以在等待反馈的时候</c>
<c.magenta>一定不要阻碍任何UI</c>

00:06:24.551 --> 00:06:28.021
<c.magenta>现在重要的是</c>
<c.magenta>提供给用户正确的授权体验</c>

00:06:28.488 --> 00:06:29.523
<c.magenta>在此之上</c>

00:06:29.590 --> 00:06:33.861
<c.magenta>应用可能会请求访问一些</c>
<c.magenta>或者很多HealthKit数据类型</c>

00:06:34.094 --> 00:06:36.230
<c.magenta>所以就出现了</c>
<c.magenta>一个很重要的问题</c>

00:06:36.663 --> 00:06:40.100
<c.magenta>什么时候应该请求访问</c>
<c.magenta>一些或者所有的数据类型？</c>

00:06:41.435 --> 00:06:43.437
<c.magenta>以下是我们的一些建议</c>
<c.magenta>针对这个问题</c>

00:06:44.304 --> 00:06:46.707
<c.magenta>首先我们建议你</c>
<c.magenta>请求访问</c>

00:06:46.773 --> 00:06:48.642
<c.magenta>合理的类型集合</c>

00:06:48.709 --> 00:06:51.478
<c.magenta>它们要对应</c>
<c.magenta>应用的逻辑活动</c>

00:06:52.479 --> 00:06:55.015
<c.magenta>比如说你的应用</c>
<c.magenta>允许用户监测</c>

00:06:55.082 --> 00:06:57.985
<c.magenta>食物摄入量和身体指标</c>
<c.magenta>比如BMI</c>

00:06:58.719 --> 00:06:59.553
<c.magenta>要是这样</c>

00:06:59.620 --> 00:07:02.256
<c.magenta>你要考虑请求访问</c>
<c.magenta>营养数据类型</c>

00:06:59.620 --> 00:07:02.256
<c.magenta>你要考虑请求访问</c>
<c.magenta>营养数据类型</c>

00:07:02.322 --> 00:07:04.224
<c.magenta>在第一次用户</c>
<c.magenta>记录食物摄入的时候</c>

00:07:04.791 --> 00:07:07.261
<c.magenta>然后请求访问</c>
<c.magenta>身体指标的数据类型</c>

00:07:07.327 --> 00:07:09.329
<c.magenta>在用户每次要</c>
<c.magenta>记录它们的时候</c>

00:07:12.232 --> 00:07:13.400
<c.magenta>这个规则也有一个例外</c>

00:07:13.467 --> 00:07:15.202
<c.magenta>就是当应用有加载流程的时候</c>

00:07:15.602 --> 00:07:17.871
<c.magenta>如果是这样</c>
<c.magenta>你实际上就要</c>

00:07:17.938 --> 00:07:21.742
<c.magenta>请求访问所有</c>
<c.magenta>应用要提前使用的数据类型</c>

00:07:22.075 --> 00:07:25.646
<c.magenta>因为你现在已经可以</c>
<c.magenta>清楚地向用户解释</c>

00:07:25.712 --> 00:07:27.948
<c.magenta>你的应用</c>
<c.magenta>要用这些类型做什么</c>

00:07:29.383 --> 00:07:32.119
<c.magenta>无论你选择哪个类型</c>
<c.magenta>我们必须要建议你</c>

00:07:32.186 --> 00:07:34.988
<c.magenta>在开发过程中</c>
<c.magenta>常常测试授权</c>

00:07:35.556 --> 00:07:38.192
<c.magenta>你可以简单的重设</c>
<c.magenta>初始授权流程</c>

00:07:38.258 --> 00:07:41.061
<c.magenta>通过删除应用</c>
<c.magenta>从你的设备或者模拟器上</c>

00:07:41.395 --> 00:07:42.963
<c.magenta>在建立和运行之前</c>

00:07:43.063 --> 00:07:44.665
<c.magenta>这样HealthKit</c>
<c.magenta>就显示给用户</c>

00:07:44.731 --> 00:07:47.067
<c.magenta>初始授权流程</c>
<c.magenta>从头开始</c>

00:07:49.169 --> 00:07:51.271
<c.magenta>这时一定要测试</c>

00:07:51.338 --> 00:07:54.842
<c.magenta>授权有没有延迟</c>
<c.magenta>或者被用户完全拒绝</c>

00:07:55.475 --> 00:07:57.344
<c.magenta>应用在这些情况下如何运行？</c>

00:07:57.711 --> 00:07:59.179
<c.magenta>还有更多能力吗？</c>

00:08:01.215 --> 00:08:04.585
<c.magenta>最后 如果要用一句话总结授权</c>
<c.magenta>那就是</c>

00:08:05.619 --> 00:08:07.154
<c.magenta>时刻考虑用户体验</c>

00:08:08.055 --> 00:08:10.257
<c.magenta>不要在不合适的时间</c>
<c.magenta>显示问题</c>

00:08:10.324 --> 00:08:12.492
<c.magenta>并保证你的流程有意义</c>

00:08:16.330 --> 00:08:19.199
<c.magenta>我们已经花了很多时间</c>
<c.magenta>了解授权</c>

00:08:19.266 --> 00:08:20.767
<c.magenta>现在我们来讲一些新特性</c>

00:08:20.834 --> 00:08:23.570
<c.magenta>是去年以后HealthKit新出的</c>
<c.magenta>从活动环开始吧</c>

00:08:27.040 --> 00:08:30.077
<c.magenta>Apple开发了一个很棒的</c>
<c.magenta>健康与健美的追踪体验</c>

00:08:30.143 --> 00:08:31.144
<c.magenta>在Apple Watch上</c>

00:08:31.845 --> 00:08:34.948
<c.magenta>用户喜欢它能简单地</c>
<c.magenta>追踪主要的活动规律</c>

00:08:35.015 --> 00:08:36.250
<c.magenta>改善他们的生活</c>

00:08:36.450 --> 00:08:38.318
<c.magenta>在iOS 10和watchOS 3</c>

00:08:38.385 --> 00:08:41.121
<c.magenta>用户甚至可以跟其他人</c>
<c.magenta>分享他们的活动环</c>

00:08:41.188 --> 00:08:42.022
<c.magenta>可以比赛</c>

00:08:43.690 --> 00:08:45.292
<c.magenta>我们提供给你一个很棒的方法</c>

00:08:45.425 --> 00:08:47.528
<c.magenta>来融合</c>
<c.magenta>这个活动环体验</c>

00:08:47.594 --> 00:08:51.598
<c.magenta>到你的应用里</c>
<c.magenta>通过iOS 9.3的Activity Rings API</c>

00:08:54.201 --> 00:08:57.504
<c.magenta>首先我们要开始</c>
<c.magenta>一个HKActivitySummary对象</c>

00:08:59.506 --> 00:09:01.708
<c.magenta>HKActivitySummary</c>
<c.magenta>代表的是</c>

00:08:59.506 --> 00:09:01.708
<c.magenta>HKActivitySummary</c>
<c.magenta>代表的是</c>

00:09:02.075 --> 00:09:05.012
<c.magenta>在某一天的时间内</c>
<c.magenta>用户的活动总量</c>

00:09:05.512 --> 00:09:10.651
<c.magenta>这包括了他们的热量消耗</c>
<c.magenta>锻炼分钟数和站立小时数</c>

00:09:10.717 --> 00:09:12.152
<c.magenta>以及他们设定的每个目标</c>

00:09:15.322 --> 00:09:18.792
<c.magenta>HKActivitySummary</c>
<c.magenta>是授权的一种独特类型</c>

00:09:19.293 --> 00:09:22.095
<c.magenta>它不是HKObject</c>
<c.magenta>更像是一个特殊的只读类型</c>

00:09:22.162 --> 00:09:25.432
<c.magenta>是你单独从组件类型</c>
<c.magenta>请求的授权</c>

00:09:26.667 --> 00:09:28.268
<c.magenta>最后这一部分</c>
<c.magenta>十分重要</c>

00:09:29.603 --> 00:09:32.840
<c.magenta>HKActivitySummary</c>
<c.magenta>包含了一些HealthKit信息</c>

00:09:32.906 --> 00:09:35.209
<c.magenta>与HealthKit类型相同：</c>
<c.magenta>活动能量</c>

00:09:35.475 --> 00:09:37.544
<c.magenta>锻炼分钟数</c>
<c.magenta>和站立小时数</c>

00:09:38.612 --> 00:09:41.014
<c.magenta>但这些都是以天为单位累加</c>

00:09:41.181 --> 00:09:43.383
<c.magenta>所以</c>
<c.magenta>如果你想要做得</c>

00:09:43.450 --> 00:09:45.485
<c.magenta>更具体些 比如...</c>

00:09:46.987 --> 00:09:50.324
<c.magenta>更改用户的Move ring</c>
<c.magenta>通过改写活动能量的数据类型</c>

00:09:50.691 --> 00:09:52.659
<c.magenta>或者显示精细粮食数据</c>

00:09:52.726 --> 00:09:54.628
<c.magenta>给这一天的活动</c>

00:09:55.095 --> 00:09:57.030
<c.magenta>这样的话</c>
<c.magenta>你就需要请求</c>

00:09:57.097 --> 00:09:58.932
<c.magenta>单独访问每个成分类型</c>

00:10:00.901 --> 00:10:03.937
<c.magenta>由于ActivitySummary</c>
<c.magenta>对象代表的活动</c>

00:10:04.004 --> 00:10:05.806
<c.magenta>是某一天内的活动</c>

00:10:05.873 --> 00:10:09.343
<c.magenta>它可能 或许不能</c>
<c.magenta>对应24小时的时间段</c>

00:10:09.910 --> 00:10:12.546
<c.magenta>所以我们要指定</c>
<c.magenta>对应活动小结的日期</c>

00:10:12.613 --> 00:10:14.281
<c.magenta>通过使用</c>
<c.magenta>DateComponents对象</c>

00:10:15.015 --> 00:10:17.050
<c.magenta>那要怎么做</c>
<c.magenta>就看下面这个例子</c>

00:10:21.922 --> 00:10:24.992
<c.magenta>假设我们想要获取</c>
<c.magenta>今天的活动小结</c>

00:10:25.526 --> 00:10:28.328
<c.magenta>那么就要使用</c>
<c.magenta>HKActivitySummaryQuery</c>

00:10:29.863 --> 00:10:31.465
<c.magenta>首先让日历</c>

00:10:31.532 --> 00:10:34.468
<c.magenta>对应今天创建</c>
<c.magenta>DateComponents对象</c>

00:10:34.868 --> 00:10:39.540
<c.magenta>使用规定的组件</c>
<c.magenta>时代 年 月 日</c>

00:10:41.241 --> 00:10:44.077
<c.magenta>接下来用这些组件</c>
<c.magenta>创建一个predicate对象</c>

00:10:44.178 --> 00:10:46.880
<c.magenta>这将我们的查询</c>
<c.magenta>控制在活动小结里</c>

00:10:46.947 --> 00:10:48.415
<c.magenta>日期与今天对应</c>

00:10:49.783 --> 00:10:52.886
<c.magenta>最后创建query</c>
<c.magenta>传递给predicate</c>

00:10:53.153 --> 00:10:55.956
<c.magenta>之后在这种情况下</c>
<c.magenta>处理单一的活动小结</c>

00:10:56.023 --> 00:10:57.724
<c.magenta>这会返回一个值</c>

00:11:01.161 --> 00:11:03.363
<c.magenta>以上就是如何</c>
<c.magenta>获取活动小结数据</c>

00:11:03.430 --> 00:11:05.966
<c.magenta>但是最有意思的部分</c>
<c.magenta>是显示环本身</c>

00:11:06.033 --> 00:11:09.269
<c.magenta>要做这个 我们要使用iOS的</c>
<c.magenta>HKActivityRingView</c>

00:11:09.770 --> 00:11:13.841
<c.magenta>或watchOS上类似的</c>
<c.magenta>WKInterfaceActivityRing</c>

00:11:14.641 --> 00:11:15.742
<c.magenta>外观是这样</c>

00:11:15.809 --> 00:11:18.712
<c.magenta>就像你想的那样</c>
<c.magenta>它们用漂亮的动画来显示</c>

00:11:18.779 --> 00:11:21.248
<c.magenta>调出setActivitySummary</c>
<c.magenta>就能动了</c>

00:11:24.785 --> 00:11:28.856
<c.magenta>下面讲几个使用HKActivityRingView</c>
<c.magenta>和WKInterfaceActivityRing的技巧</c>

00:11:30.224 --> 00:11:33.827
<c.magenta>首先就像iOS和watchOS上的</c>
<c.magenta>健康和活动的应用那样</c>

00:11:34.561 --> 00:11:36.330
<c.magenta>这个环在黑色背景上</c>
<c.magenta>最好看</c>

00:11:36.396 --> 00:11:39.066
<c.magenta>所以我们建议</c>
<c.magenta>你的应用也用类似的显示</c>

00:11:40.968 --> 00:11:43.937
<c.magenta>第二 如果你的应用有</c>
<c.magenta>分享和交流的功能</c>

00:11:44.004 --> 00:11:47.140
<c.magenta>可以使用</c>
<c.magenta>HKActivitySummary的可写属性</c>

00:11:47.307 --> 00:11:48.775
<c.magenta>来架构你自己的对象</c>

00:11:49.076 --> 00:11:53.080
<c.magenta>并提供给HKActivityRingView</c>
<c.magenta>或者WKInterfaceActivityRing</c>

00:11:53.480 --> 00:11:55.449
<c.magenta>这样就会显示</c>
<c.magenta>另一个用户的环形图</c>

00:11:55.516 --> 00:11:57.784
<c.magenta>紧挨当前用户的环形图</c>
<c.magenta>在你自己的应用里</c>

00:12:00.354 --> 00:12:02.956
<c.magenta>最后 当你使用</c>
<c.magenta>HKActivitySummaryQuery</c>

00:12:03.023 --> 00:12:05.259
<c.magenta>记住要使用</c>
<c.magenta>规定的DateComponents</c>

00:12:05.325 --> 00:12:09.263
<c.magenta>时代 年 月 日</c>
<c.magenta>在你的HKActivitySummaryQuery里</c>

00:12:11.098 --> 00:12:12.766
<c.magenta>时间映射有时十分复杂</c>

00:12:12.833 --> 00:12:16.170
<c.magenta>所以如果你有任何使用日历或</c>
<c.magenta>DateComponents的问题</c>

00:12:16.236 --> 00:12:19.106
<c.magenta>请参考上一次会议的精彩演讲</c>

00:12:22.843 --> 00:12:25.579
<c.magenta>讲了很多关于</c>
<c.magenta>授权和Activity Rings的信息</c>

00:12:25.646 --> 00:12:27.514
<c.magenta>现在来实际操作</c>
<c.magenta>通过快速的演示</c>

00:12:28.448 --> 00:12:30.784
<c.magenta>在右边</c>
<c.magenta>有一个越来越流行的应用</c>

00:12:30.851 --> 00:12:32.619
<c.magenta>是给医疗小组用的</c>
<c.magenta>叫做LoopHealth</c>

00:12:33.287 --> 00:12:34.555
<c.magenta>这个应用有不一样的功能</c>

00:12:34.621 --> 00:12:37.424
<c.magenta>但主界面都是dashboard</c>
<c.magenta>里面有些很有用的信息</c>

00:12:37.491 --> 00:12:39.726
<c.magenta>比如说</c>
<c.magenta>你的医生名字</c>

00:12:39.793 --> 00:12:42.196
<c.magenta>最近的预约</c>
<c.magenta>以及一些健康知识</c>

00:12:43.564 --> 00:12:47.067
<c.magenta>LoopHealth希望他们的病人</c>
<c.magenta>每天生活得更健康</c>

00:12:47.134 --> 00:12:50.571
<c.magenta>所以他们看到了一个好机会</c>
<c.magenta>就是能把Apple的Activity Rings</c>

00:12:50.637 --> 00:12:51.905
<c.magenta>带入他们的界面</c>

00:12:52.739 --> 00:12:54.441
<c.magenta>这里你看到</c>
<c.magenta>我们已经把</c>

00:12:54.508 --> 00:12:57.945
<c.magenta>一个HKActivityRingView</c>
<c.magenta>融入了应用的storyboard里</c>

00:12:58.245 --> 00:13:00.781
<c.magenta>但是我们还没有写一个代码</c>
<c.magenta>来链接到这个数据</c>

00:12:58.245 --> 00:13:00.781
<c.magenta>但是我们还没有写一个代码</c>
<c.magenta>来链接到这个数据</c>

00:13:00.981 --> 00:13:02.482
<c.magenta>让我们看看</c>
<c.magenta>这有多简单</c>

00:13:02.950 --> 00:13:06.086
<c.magenta>在Xcode里</c>
<c.magenta>有个DashboardViewController</c>

00:13:06.153 --> 00:13:08.388
<c.magenta>这个视图控制器</c>
<c.magenta>是我们刚刚</c>

00:13:08.589 --> 00:13:09.590
<c.magenta>在LoopHealth里看到的</c>

00:13:10.357 --> 00:13:11.491
<c.magenta>现在这里很空</c>

00:13:11.925 --> 00:13:13.927
<c.magenta>但是我们的确有些</c>
<c.magenta>有用的信息可填</c>

00:13:14.595 --> 00:13:16.496
<c.magenta>你看到这里</c>
<c.magenta>有一个IBOutlet</c>

00:13:16.763 --> 00:13:19.800
<c.magenta>被设置连接到应用里已有的</c>
<c.magenta>activityRingView</c>

00:13:21.134 --> 00:13:23.303
<c.magenta>这里我们导入HealthKitUI</c>

00:13:23.370 --> 00:13:24.838
<c.magenta>这是一个新的框架</c>

00:13:24.905 --> 00:13:27.741
<c.magenta>可在iOS的</c>
<c.magenta>HKActivityRingView里找到</c>

00:13:29.176 --> 00:13:30.644
<c.magenta>最后在这个下面</c>

00:13:30.711 --> 00:13:34.448
<c.magenta>LoopHealth在应用代理中</c>
<c.magenta>设置了适用于全应用的HKHealthStore</c>

00:13:34.515 --> 00:13:36.783
<c.magenta>所以我们只要设置</c>
<c.magenta>一个简单的计算属性</c>

00:13:36.850 --> 00:13:38.919
<c.magenta>能方便我们检索</c>
<c.magenta>需要的东西</c>

00:13:41.288 --> 00:13:44.157
<c.magenta>好的 如果我们想要</c>
<c.magenta>在应用中显示活动小结</c>

00:13:44.224 --> 00:13:46.827
<c.magenta>第一件事就是</c>
<c.magenta>请求可读许可</c>

00:13:46.894 --> 00:13:48.228
<c.magenta>给HKActivitySummary</c>

00:13:49.196 --> 00:13:50.664
<c.magenta>鉴于我们在读取健康数据</c>

00:13:50.731 --> 00:13:53.100
<c.magenta>所以我们需要</c>
<c.magenta>包含一个使用说明</c>

00:13:53.267 --> 00:13:54.968
<c.magenta>那么就让我们去</c>
<c.magenta>info.plist文件</c>

00:13:56.336 --> 00:13:57.437
<c.magenta>添加一个新的key</c>

00:13:58.972 --> 00:14:02.276
<c.magenta>我们需要的这个key叫做</c>
<c.magenta>NSHealthShareUsageDescription</c>

00:13:58.972 --> 00:14:02.276
<c.magenta>我们需要的这个key叫做</c>
<c.magenta>NSHealthShareUsageDescription</c>

00:14:02.342 --> 00:14:05.479
<c.magenta>这里用简易英语写着</c>
<c.magenta>Privacy Health Share</c>

00:14:09.383 --> 00:14:13.754
<c.magenta>很好 然后只要加入</c>
<c.magenta>一个简单的使用说明</c>

00:14:13.820 --> 00:14:14.655
<c.magenta>设置全部完成</c>

00:14:15.722 --> 00:14:17.791
<c.magenta>现在就可以回到</c>
<c.magenta>DashboardViewController</c>

00:14:17.858 --> 00:14:20.661
<c.magenta>再写代码</c>
<c.magenta>实际请求授权</c>

00:14:21.828 --> 00:14:24.698
<c.magenta>由于我们想让这个初始画面</c>
<c.magenta>能立刻显示给用户</c>

00:14:24.765 --> 00:14:28.101
<c.magenta>而每次用户转到dashboard的时候</c>
<c.magenta>都要更新环形图</c>

00:14:28.168 --> 00:14:31.138
<c.magenta>要做这个最好是在</c>
<c.magenta>viewDidAppear方法里</c>

00:14:33.240 --> 00:14:34.341
<c.magenta>那么我把它拉到这里</c>

00:14:35.609 --> 00:14:37.411
<c.magenta>在调出super后</c>

00:14:37.611 --> 00:14:40.881
<c.magenta>注意我们在HKHealthStore上调出</c>
<c.magenta>RequestAuthorization</c>

00:14:41.381 --> 00:14:43.016
<c.magenta>传递进activitySummaryType</c>

00:14:43.684 --> 00:14:46.887
<c.magenta>然后作为返回</c>
<c.magenta>调出updateActivitySummary</c>

00:14:47.654 --> 00:14:50.157
<c.magenta>是为了真正获取</c>
<c.magenta>并更新数据</c>

00:14:50.224 --> 00:14:51.491
<c.magenta>现在就来执行这个代码吧</c>

00:14:55.996 --> 00:14:58.432
<c.magenta>这就是</c>
<c.magenta>updateActivitySummary的基本构成</c>

00:14:58.799 --> 00:15:00.100
<c.magenta>我们这里要做的</c>

00:14:58.799 --> 00:15:00.100
<c.magenta>我们这里要做的</c>

00:15:00.167 --> 00:15:03.170
<c.magenta>是创建一个</c>
<c.magenta>HKActivitySummaryQuery</c>

00:15:03.770 --> 00:15:05.873
<c.magenta>请求今天的活动小结</c>

00:15:05.939 --> 00:15:09.409
<c.magenta>然后把这个活动小结定义到</c>
<c.magenta>HKActivityRingView</c>

00:15:09.543 --> 00:15:10.410
<c.magenta>在收到这个小结后</c>

00:15:11.678 --> 00:15:14.848
<c.magenta>首先 对应今天 创建一个</c>
<c.magenta>DateComponents对象</c>

00:15:16.450 --> 00:15:19.887
<c.magenta>由于DateComponents</c>
<c.magenta>只作用于一个特定的日历</c>

00:15:19.953 --> 00:15:22.089
<c.magenta>我们就要把</c>
<c.magenta>需要的日历对象</c>

00:15:22.789 --> 00:15:24.424
<c.magenta>放回组件对象</c>

00:15:26.393 --> 00:15:27.528
<c.magenta>呃 好了</c>

00:15:28.362 --> 00:15:31.398
<c.magenta>下面来创建predicate</c>
<c.magenta>通过那个组件对象</c>

00:15:33.433 --> 00:15:36.403
<c.magenta>一旦有了这个predicate</c>
<c.magenta>就可以创建query</c>

00:15:36.470 --> 00:15:39.339
<c.magenta>传递给predicate</c>
<c.magenta>然后在返回中</c>

00:15:39.406 --> 00:15:42.142
<c.magenta>获取今天的活动小结</c>

00:15:44.611 --> 00:15:46.146
<c.magenta>现在只要有了这个小结</c>

00:15:46.213 --> 00:15:49.550
<c.magenta>我们要做的就是调度回主队列</c>
<c.magenta>更新UI</c>

00:15:51.351 --> 00:15:56.156
<c.magenta>然后调出setActivitySummary</c>
<c.magenta>让活动环变成动画视图</c>

00:15:57.891 --> 00:16:01.061
<c.magenta>现在有了query</c>
<c.magenta>剩下的就是去执行</c>

00:15:57.891 --> 00:16:01.061
<c.magenta>现在有了query</c>
<c.magenta>剩下的就是去执行</c>

00:16:03.864 --> 00:16:04.765
<c.magenta>就这么多</c>

00:16:05.365 --> 00:16:07.901
<c.magenta>那么让我们来</c>
<c.magenta>运行看看怎么样</c>

00:16:23.684 --> 00:16:25.352
<c.magenta>很好</c>
<c.magenta>那么你看到的第一个东西</c>

00:16:25.419 --> 00:16:28.121
<c.magenta>是我们在请求访问</c>
<c.magenta>活动小结</c>

00:16:28.388 --> 00:16:31.091
<c.magenta>Health正请求用户</c>
<c.magenta>允许授权</c>

00:16:33.493 --> 00:16:35.762
<c.magenta>我们允许它读取</c>
<c.magenta>活动数据类型</c>

00:16:35.829 --> 00:16:37.965
<c.magenta>这个时候</c>
<c.magenta>注意下屏幕底部</c>

00:16:38.031 --> 00:16:40.501
<c.magenta>有个使用说明</c>
<c.magenta>是为读取健康数据时添加的</c>

00:16:40.567 --> 00:16:42.035
<c.magenta>现在就在这里</c>
<c.magenta>显示给用户了</c>

00:16:42.536 --> 00:16:44.338
<c.magenta>值得注意的是</c>
<c.magenta>在一个真正的应用里</c>

00:16:44.404 --> 00:16:46.173
<c.magenta>我们要确保</c>
<c.magenta>这个说明已经本地化</c>

00:16:46.240 --> 00:16:49.343
<c.magenta>所以我们要把它放进</c>
<c.magenta>info.plist.strings文件</c>

00:16:51.912 --> 00:16:53.514
<c.magenta>我要在这里允许授权</c>

00:16:55.749 --> 00:16:57.484
<c.magenta>就像这样</c>
<c.magenta>我们看到这个活动环</c>

00:16:57.551 --> 00:16:59.086
<c.magenta>就在合适的地方</c>
<c.magenta>漂亮的动起来</c>

00:17:09.096 --> 00:17:10.063
<c.magenta>就是这么简单</c>

00:17:10.130 --> 00:17:12.332
<c.magenta>就将活动环加入了</c>
<c.magenta>你的应用</c>

00:17:12.398 --> 00:17:13.934
<c.magenta>一定要检查API</c>

00:17:14.601 --> 00:17:16.637
<c.magenta>下面 我把舞台交给</c>
<c.magenta>我的同事Jeff</c>

00:17:16.703 --> 00:17:19.573
<c.magenta>他会为你们讲述</c>
<c.magenta>一个 iOS X最棒的新功能</c>

00:17:25.979 --> 00:17:26.813
<c.magenta>谢谢你 Matt</c>

00:17:27.181 --> 00:17:28.281
<c.magenta>大家早上好</c>

00:17:28.649 --> 00:17:30.117
<c.magenta>我是Joefrey Kibuule</c>

00:17:30.584 --> 00:17:31.752
<c.magenta>与Matt是同事</c>

00:17:31.818 --> 00:17:34.054
<c.magenta>我是iOS软件工程师</c>
<c.magenta>在Health团队工作</c>

00:17:34.855 --> 00:17:37.424
<c.magenta>今天我很感到很自豪</c>
<c.magenta>来为你们介绍</c>

00:17:37.491 --> 00:17:39.393
<c.magenta>iOS 10的一个新功能</c>

00:17:39.626 --> 00:17:40.527
<c.magenta>健康记录</c>

00:17:41.328 --> 00:17:43.864
<c.magenta>健康记录提供了</c>
<c.magenta>一个简单便携的方法</c>

00:17:43.931 --> 00:17:46.500
<c.magenta>让你的私人信息</c>
<c.magenta>能随你而动</c>

00:17:47.100 --> 00:17:48.268
<c.magenta>就在你的手机上</c>

00:17:50.237 --> 00:17:51.939
<c.magenta>由现在的经验来看</c>

00:17:52.005 --> 00:17:54.842
<c.magenta>如果用户去看医生</c>

00:17:54.908 --> 00:17:57.644
<c.magenta>并要健康记录的话</c>
<c.magenta>拿到的是这个</c>

00:17:58.712 --> 00:18:00.981
<c.magenta>一大叠文件</c>
<c.magenta>这会很麻烦</c>

00:17:58.712 --> 00:18:00.981
<c.magenta>一大叠文件</c>
<c.magenta>这会很麻烦</c>

00:18:01.281 --> 00:18:03.584
<c.magenta>如果你想从中</c>
<c.magenta>找一个特定的信息的话</c>

00:18:05.319 --> 00:18:06.153
<c.magenta>再近一点的时间</c>

00:18:06.220 --> 00:18:09.289
<c.magenta>健康机构</c>
<c.magenta>会给病人提供这个</c>

00:18:10.224 --> 00:18:14.494
<c.magenta>存有电子信息的光盘</c>
<c.magenta>使用起来不直观</c>

00:18:17.197 --> 00:18:21.401
<c.magenta>但现在iOS有了健康记录</c>
<c.magenta>我们就能解决这个问题</c>

00:18:23.937 --> 00:18:26.106
<c.magenta>通过我们的努力</c>
<c.magenta>推出的这个功能</c>

00:18:26.273 --> 00:18:28.942
<c.magenta>为你的应用</c>
<c.magenta>开启了新的可能</c>

00:18:29.676 --> 00:18:31.979
<c.magenta>尤其是与健康记录的</c>
<c.magenta>交流与互动</c>

00:18:34.448 --> 00:18:37.751
<c.magenta>事实上在美国</c>
<c.magenta>使用这些API</c>

00:18:37.818 --> 00:18:40.988
<c.magenta>可以帮助健康机构</c>
<c.magenta>遵守新的规定</c>

00:18:41.455 --> 00:18:45.392
<c.magenta>就是要求他们给病人更多权利</c>
<c.magenta>掌握他们自己的健康数据</c>

00:18:48.161 --> 00:18:49.830
<c.magenta>首先</c>
<c.magenta>做个概述</c>

00:18:50.564 --> 00:18:53.500
<c.magenta>iOS健康记录</c>
<c.magenta>是一个涵盖性术语</c>

00:18:53.600 --> 00:18:56.036
<c.magenta>代表的是</c>
<c.magenta>各种不同病人就诊信息</c>

00:18:56.236 --> 00:18:58.172
<c.magenta>由健康机构生成</c>

00:18:59.873 --> 00:19:03.110
<c.magenta>今天我们特别为</c>
<c.magenta>健康档案添加了支持</c>

00:18:59.873 --> 00:19:03.110
<c.magenta>今天我们特别为</c>
<c.magenta>健康档案添加了支持</c>

00:19:04.545 --> 00:19:08.849
<c.magenta>用标准的机器可读的XML</c>
<c.magenta>代表特定的病人就诊信息</c>

00:19:10.017 --> 00:19:11.151
<c.magenta>这些包括</c>

00:19:11.518 --> 00:19:12.719
<c.magenta>病人就诊总结</c>

00:19:13.453 --> 00:19:15.022
<c.magenta>持续护理记录</c>

00:19:15.422 --> 00:19:18.058
<c.magenta>以及手术记录</c>
<c.magenta>还有很多</c>

00:19:19.927 --> 00:19:23.030
<c.magenta>我们支持</c>
<c.magenta>国际HL-7 CDA标准</c>

00:19:23.096 --> 00:19:26.066
<c.magenta>来完成</c>
<c.magenta>与大量不同提供者的互操作</c>

00:19:28.435 --> 00:19:32.306
<c.magenta>这些文件可以</c>
<c.magenta>在病人的在线健康门户里找到...</c>

00:19:32.973 --> 00:19:37.911
<c.magenta>并且能通过Safari和邮件导入</c>
<c.magenta>现在所有应用都可以导入了</c>

00:19:39.947 --> 00:19:43.517
<c.magenta>这些文件的保存</c>
<c.magenta>跟其他HealthKit数据一样</c>

00:19:44.351 --> 00:19:47.855
<c.magenta>安全的加密在</c>
<c.magenta>你的iOS设备上</c>

00:19:49.957 --> 00:19:52.025
<c.magenta>接下来</c>
<c.magenta>我们讲讲许可</c>

00:19:53.093 --> 00:19:56.563
<c.magenta>由于每份健康文件里</c>
<c.magenta>都包含着大量的信息</c>

00:19:56.897 --> 00:20:01.568
<c.magenta>相比于HealthKit的其他数据类型</c>
<c.magenta>我们给用户更多的控制力</c>

00:19:56.897 --> 00:20:01.568
<c.magenta>相比于HealthKit的其他数据类型</c>
<c.magenta>我们给用户更多的控制力</c>

00:20:02.903 --> 00:20:05.639
<c.magenta>访问许可</c>
<c.magenta>是基于每个文件的</c>

00:20:05.706 --> 00:20:07.808
<c.magenta>不仅仅是</c>
<c.magenta>健康文件数据类型</c>

00:20:10.210 --> 00:20:11.945
<c.magenta>在右边你看到</c>

00:20:12.012 --> 00:20:14.081
<c.magenta>我们显示的这个UI</c>
<c.magenta>可以让用户</c>

00:20:14.147 --> 00:20:17.885
<c.magenta>在授权你的应用之前</c>
<c.magenta>浏览和选择文件</c>

00:20:20.187 --> 00:20:22.856
<c.magenta>这个UI会出现在</c>
<c.magenta>任何你想查询文件的时候</c>

00:20:22.923 --> 00:20:24.258
<c.magenta>以及有新文件可用的时候</c>

00:20:25.559 --> 00:20:26.727
<c.magenta>如果要查询文件</c>

00:20:27.528 --> 00:20:29.162
<c.magenta>并且没有任何更改</c>

00:20:30.631 --> 00:20:32.699
<c.magenta>我们就不会</c>
<c.magenta>显示这个UI给用户</c>

00:20:32.766 --> 00:20:35.502
<c.magenta>那么你的查询</c>
<c.magenta>就会立刻返回结果</c>

00:20:41.508 --> 00:20:42.676
<c.magenta>如果查询文件是在</c>

00:20:42.743 --> 00:20:44.878
<c.magenta>应用在后台运行的时候</c>

00:20:45.879 --> 00:20:49.416
<c.magenta>我们永远不会弹出UI</c>
<c.magenta>来授权新文件的许可</c>

00:20:50.017 --> 00:20:52.386
<c.magenta>HealthKit确保了</c>
<c.magenta>用户总是知道</c>

00:20:52.452 --> 00:20:54.888
<c.magenta>他们何时授予你的应用</c>
<c.magenta>访问文件的权限</c>

00:20:55.289 --> 00:20:56.423
<c.magenta>在第一次需要授权的时候</c>

00:20:59.193 --> 00:21:01.995
<c.magenta>下面来讲讲</c>
<c.magenta>如何在HealthKit创建文件</c>

00:20:59.193 --> 00:21:01.995
<c.magenta>下面来讲讲</c>
<c.magenta>如何在HealthKit创建文件</c>

00:21:04.531 --> 00:21:07.534
<c.magenta>要保存文件到HealthKit</c>
<c.magenta>你可保存一个原始XML</c>

00:21:07.601 --> 00:21:10.971
<c.magenta>到新的</c>
<c.magenta>HKCDADocumentSample类型</c>

00:21:12.873 --> 00:21:16.243
<c.magenta>我们会验证创建</c>
<c.magenta>以保证它符合标准</c>

00:21:16.510 --> 00:21:18.779
<c.magenta>并且会在</c>
<c.magenta>失败的时候报错</c>

00:21:21.748 --> 00:21:26.954
<c.magenta>我们会自动提取</c>
<c.magenta>标题 病人 监护人和作者名字</c>

00:21:27.020 --> 00:21:29.089
<c.magenta>无论何时文件被</c>
<c.magenta>保存到HealthKit</c>

00:21:29.223 --> 00:21:32.159
<c.magenta>以便更快的查询这些区域</c>

00:21:32.392 --> 00:21:34.394
<c.magenta>而不需要读取整个文件</c>

00:21:35.996 --> 00:21:38.065
<c.magenta>我们来看看</c>
<c.magenta>这个例子的代码</c>

00:21:38.899 --> 00:21:42.135
<c.magenta>我们要用documentData</c>
<c.magenta>并转换为Data对象</c>

00:21:42.603 --> 00:21:44.371
<c.magenta>通常这个XML的来源</c>

00:21:44.438 --> 00:21:46.273
<c.magenta>是一个健康机构的服务器</c>

00:21:47.574 --> 00:21:50.677
<c.magenta>接着就要创建一个新的</c>
<c.magenta>HKCDADocumentSample</c>

00:21:50.744 --> 00:21:52.346
<c.magenta>传递到Data对象</c>

00:21:52.913 --> 00:21:54.581
<c.magenta>定义合适的日期</c>

00:21:55.048 --> 00:21:58.218
<c.magenta>和任何附加元数据</c>
<c.magenta>跟其他HKSample一样</c>

00:21:59.553 --> 00:22:02.122
<c.magenta>之后我们要保存这个文件</c>
<c.magenta>到healthStore</c>

00:21:59.553 --> 00:22:02.122
<c.magenta>之后我们要保存这个文件</c>
<c.magenta>到healthStore</c>

00:22:02.823 --> 00:22:03.657
<c.magenta>完成了</c>

00:22:03.924 --> 00:22:06.560
<c.magenta>现在你的健康文件</c>
<c.magenta>就保存到HealthKit里了</c>

00:22:06.627 --> 00:22:08.228
<c.magenta>并可以在其他应用上使用</c>

00:22:08.295 --> 00:22:10.564
<c.magenta>或者直接让用户</c>
<c.magenta>用Health应用浏览</c>

00:22:13.267 --> 00:22:16.069
<c.magenta>现在 我们来讲讲</c>
<c.magenta>如何在HealthKit里查询文件</c>

00:22:17.771 --> 00:22:21.542
<c.magenta>鉴于HKCDADocumentSample</c>
<c.magenta>是HKSample的子类</c>

00:22:22.376 --> 00:22:24.912
<c.magenta>现有的查询对象</c>
<c.magenta>对你来说已经很熟悉</c>

00:22:24.978 --> 00:22:26.947
<c.magenta>它们会继续运行</c>
<c.magenta>跟你想的一样</c>

00:22:28.215 --> 00:22:30.651
<c.magenta>但是 你要使用新的</c>
<c.magenta>HKDocumentQuery</c>

00:22:30.717 --> 00:22:32.419
<c.magenta>去获取原始的XML</c>

00:22:32.886 --> 00:22:34.454
<c.magenta>获取原始XML成本很高</c>

00:22:34.521 --> 00:22:37.057
<c.magenta>我们只在有明确要求时 才这么做</c>

00:22:39.793 --> 00:22:41.728
<c.magenta>我们提供predicate支持</c>

00:22:41.795 --> 00:22:44.431
<c.magenta>以便查询自动提取的域</c>

00:22:47.734 --> 00:22:49.369
<c.magenta>最后 要记住</c>

00:22:49.903 --> 00:22:52.206
<c.magenta>由于HKDocumentSamples</c>
<c.magenta>不可更改</c>

00:22:52.272 --> 00:22:56.443
<c.magenta>对之前样本的更改信息</c>
<c.magenta>被看作新的样本</c>

00:22:58.745 --> 00:23:00.113
<c.magenta>现在我们看个例子</c>

00:22:58.745 --> 00:23:00.113
<c.magenta>现在我们看个例子</c>

00:23:00.180 --> 00:23:02.449
<c.magenta>如何查询</c>
<c.magenta>HealthKit里的文件</c>

00:23:02.783 --> 00:23:05.252
<c.magenta>在这个例子里</c>
<c.magenta>我们要查询</c>

00:23:05.319 --> 00:23:06.420
<c.magenta>用户保存的所有文件</c>

00:23:07.821 --> 00:23:09.690
<c.magenta>首先我们要获得</c>
<c.magenta>documentType</c>

00:23:09.790 --> 00:23:12.159
<c.magenta>我们要传递</c>
<c.magenta>CDA identifier给</c>

00:23:12.226 --> 00:23:15.796
<c.magenta>HKObjectType上的</c>
<c.magenta>forIdentifier方法</c>

00:23:18.298 --> 00:23:20.501
<c.magenta>再创建</c>
<c.magenta>HKDocumentQuery</c>

00:23:21.268 --> 00:23:24.338
<c.magenta>你要留出额外字段</c>
<c.magenta>用来筛选和排列文件</c>

00:23:24.404 --> 00:23:26.707
<c.magenta>让它们按照你想要的顺序返回</c>

00:23:27.908 --> 00:23:29.443
<c.magenta>然后执行查询</c>

00:23:29.510 --> 00:23:32.045
<c.magenta>以便获取</c>
<c.magenta>HKCDADocumentSamples</c>

00:23:32.112 --> 00:23:33.080
<c.magenta>从HealthKit返回</c>

00:23:35.215 --> 00:23:37.584
<c.magenta>我要强调一点</c>
<c.magenta>在这个特定的例子里</c>

00:23:37.651 --> 00:23:40.020
<c.magenta>就是includeDocumentData定义为假</c>

00:23:40.254 --> 00:23:41.755
<c.magenta>要定义为真</c>

00:23:41.822 --> 00:23:44.491
<c.magenta>只能在你需要</c>
<c.magenta>完整原始XML文件数据的时候</c>

00:23:47.594 --> 00:23:49.596
<c.magenta>现在我们来讲一些</c>
<c.magenta>最佳的操作</c>

00:23:49.663 --> 00:23:52.232
<c.magenta>在处理HealthKit健康文件时</c>

00:23:53.433 --> 00:23:55.235
<c.magenta>首先 检查验证错误</c>

00:23:55.302 --> 00:23:58.105
<c.magenta>在每次创建KCDADocumentSample的时候</c>

00:23:59.439 --> 00:24:01.975
<c.magenta>这个报错告诉你</c>
<c.magenta>我们为何不能转换</c>

00:23:59.439 --> 00:24:01.975
<c.magenta>这个报错告诉你</c>
<c.magenta>我们为何不能转换</c>

00:24:02.042 --> 00:24:04.545
<c.magenta>原始XML到可用样本</c>

00:24:07.181 --> 00:24:09.149
<c.magenta>下面 你要用Health应用验证</c>

00:24:09.216 --> 00:24:12.619
<c.magenta>你导入的文件是否正确保存</c>

00:24:12.686 --> 00:24:14.955
<c.magenta>以及自动提取的域是否存在</c>

00:24:15.722 --> 00:24:16.723
<c.magenta>这样你就知道</c>

00:24:16.790 --> 00:24:19.293
<c.magenta>基于这些自动提取域的查询</c>

00:24:19.359 --> 00:24:21.395
<c.magenta>所返回的正确样本</c>
<c.magenta>是否符合你的预期</c>

00:24:23.330 --> 00:24:26.800
<c.magenta>最后请求原始XML数据</c>
<c.magenta>只能在必要的时候</c>

00:24:27.134 --> 00:24:30.204
<c.magenta>不发出请求的查询</c>
<c.magenta>包括文件数据</c>

00:24:30.871 --> 00:24:33.106
<c.magenta>会返回</c>
<c.magenta>自动提取的域</c>

00:24:33.173 --> 00:24:35.676
<c.magenta>这可能是所有你</c>
<c.magenta>和你用户所需要的</c>

00:24:35.742 --> 00:24:37.945
<c.magenta>用来唯一识别</c>
<c.magenta>HealthKit文件的工具</c>

00:24:40.347 --> 00:24:43.183
<c.magenta>要了解更多</c>
<c.magenta>HL-7 CDA标准的信息</c>

00:24:43.250 --> 00:24:44.618
<c.magenta>请访问屏幕上的这个链接</c>

00:24:48.689 --> 00:24:50.157
<c.magenta>现在我们来换个话题</c>

00:24:50.224 --> 00:24:52.459
<c.magenta>给大家一些处理数据的基本指南</c>

00:24:55.996 --> 00:24:58.665
<c.magenta>你知道 HealthKit实际上</c>
<c.magenta>是个中央存储库</c>

00:24:58.732 --> 00:25:01.702
<c.magenta>在这里你的应用和其他应用</c>
<c.magenta>可以帮助用户</c>

00:24:58.732 --> 00:25:01.702
<c.magenta>在这里你的应用和其他应用</c>
<c.magenta>可以帮助用户</c>

00:25:01.768 --> 00:25:03.570
<c.magenta>管理他的健康记录数据</c>

00:25:05.205 --> 00:25:06.540
<c.magenta>你在云服务上的应用</c>

00:25:06.607 --> 00:25:09.743
<c.magenta>也许能直接连接到</c>
<c.magenta>云服务上的其他应用</c>

00:25:10.110 --> 00:25:12.646
<c.magenta>这时就需要一些特别的考虑</c>

00:25:13.213 --> 00:25:16.016
<c.magenta>这里我主要探讨三点</c>

00:25:16.083 --> 00:25:17.618
<c.magenta>有关数据处理的问题</c>

00:25:18.652 --> 00:25:20.187
<c.magenta>第一 同步数据</c>

00:25:21.054 --> 00:25:23.123
<c.magenta>第二 追踪更改的数据</c>

00:25:23.891 --> 00:25:26.193
<c.magenta>第三 数据迁移</c>

00:25:27.427 --> 00:25:29.162
<c.magenta>先看第一点 数据同步</c>

00:25:30.163 --> 00:25:32.399
<c.magenta>你要一直使用</c>
<c.magenta>HKAnchoredObjectQuery</c>

00:25:32.466 --> 00:25:36.069
<c.magenta>以便用户处理</c>
<c.magenta>新样本和已删除的样本</c>

00:25:36.136 --> 00:25:38.038
<c.magenta>从而与HealthKit更新一致</c>

00:25:39.740 --> 00:25:41.875
<c.magenta>Anchor像一个书签</c>
<c.magenta>来标记</c>

00:25:41.942 --> 00:25:44.211
<c.magenta>最后一次请求查询</c>
<c.magenta>以获取数据</c>

00:25:44.778 --> 00:25:45.946
<c.magenta>你可以保存这个anchor</c>

00:25:46.013 --> 00:25:49.183
<c.magenta>方便下一次创建</c>
<c.magenta>新的HKAnchoredObjectQuery</c>

00:25:51.518 --> 00:25:53.520
<c.magenta>你可以给每个样本类型</c>
<c.magenta>开放一个查询</c>

00:25:53.587 --> 00:25:54.755
<c.magenta>只要你感兴趣</c>

00:25:55.822 --> 00:25:57.824
<c.magenta>然后传递一个备选的更新处理器</c>

00:25:57.891 --> 00:26:01.228
<c.magenta>以便持续处理</c>
<c.magenta>新样本和删除的样本</c>

00:25:57.891 --> 00:26:01.228
<c.magenta>以便持续处理</c>
<c.magenta>新样本和删除的样本</c>

00:26:01.295 --> 00:26:03.797
<c.magenta>不需要重复查询HealthKit</c>

00:26:05.299 --> 00:26:07.701
<c.magenta>但是 要是为了更好的用户体验</c>

00:26:07.868 --> 00:26:11.171
<c.magenta>为了在应用第一次启动时</c>
<c.magenta>能显示新的UI</c>

00:26:11.438 --> 00:26:13.974
<c.magenta>或者是为了让你的云数据保持同步</c>

00:26:14.575 --> 00:26:17.878
<c.magenta>那么应用必须也要处理</c>
<c.magenta>新样本和删除的样本</c>

00:26:17.945 --> 00:26:19.646
<c.magenta>即使当前不在运行状态</c>

00:26:20.447 --> 00:26:22.416
<c.magenta>这就是</c>
<c.magenta>HKObserverQuery</c>

00:26:22.482 --> 00:26:25.285
<c.magenta>和HKAnchoredObjectQuery</c>
<c.magenta>一起发挥作用的地方</c>

00:26:26.420 --> 00:26:28.322
<c.magenta>我们来看一个图表例子</c>

00:26:30.757 --> 00:26:32.793
<c.magenta>那么这里有四个主要步骤</c>

00:26:33.527 --> 00:26:35.229
<c.magenta>来处理后台更新</c>

00:26:35.295 --> 00:26:37.097
<c.magenta>分为两个阶段</c>

00:26:37.464 --> 00:26:38.966
<c.magenta>设置和执行</c>

00:26:39.700 --> 00:26:40.968
<c.magenta>第一步</c>

00:26:41.034 --> 00:26:43.203
<c.magenta>注册后台更新</c>

00:26:43.337 --> 00:26:46.306
<c.magenta>这要用于</c>
<c.magenta>每个你要操作的样本类型</c>

00:26:47.040 --> 00:26:50.177
<c.magenta>第二步</c>
<c.magenta>打开ObserverQuery</c>

00:26:51.078 --> 00:26:51.912
<c.magenta>设置完成后</c>

00:26:52.880 --> 00:26:54.381
<c.magenta>ObserverQuery同时监测</c>

00:26:54.448 --> 00:26:56.617
<c.magenta>HealthKit里的</c>
<c.magenta>新样本和删除的样本</c>

00:26:59.152 --> 00:27:02.222
<c.magenta>当新样本生成时</c>
<c.magenta>你就要开始第三步</c>

00:26:59.152 --> 00:27:02.222
<c.magenta>当新样本生成时</c>
<c.magenta>你就要开始第三步</c>

00:27:02.689 --> 00:27:04.691
<c.magenta>你会从observerQuery</c>
<c.magenta>收到一个回调</c>

00:27:04.758 --> 00:27:06.960
<c.magenta>然后执行</c>
<c.magenta>HKAnchoredObjectQuery</c>

00:27:07.027 --> 00:27:09.463
<c.magenta>来获取新样本</c>
<c.magenta>和已删除的样本</c>

00:27:11.298 --> 00:27:12.666
<c.magenta>那么第四步</c>

00:27:13.300 --> 00:27:15.402
<c.magenta>调出observerQuery的</c>
<c.magenta>完成处理器</c>

00:27:15.469 --> 00:27:16.637
<c.magenta>以便告诉HealthKit</c>

00:27:16.703 --> 00:27:19.406
<c.magenta>你已经完成对</c>
<c.magenta>后台更新的处理和传送</c>

00:27:20.407 --> 00:27:23.277
<c.magenta>接着你会继续循环</c>
<c.magenta>第三步和第四步</c>

00:27:23.343 --> 00:27:25.212
<c.magenta>以便与HealthKit保持更新</c>

00:27:28.849 --> 00:27:32.452
<c.magenta>现在 我们来一步一步看代码</c>

00:27:33.887 --> 00:27:37.257
<c.magenta>第一步</c>
<c.magenta>要注册后台更新</c>

00:27:37.558 --> 00:27:40.194
<c.magenta>每次启动应用的时候</c>
<c.magenta>都必须这么做</c>

00:27:40.260 --> 00:27:44.198
<c.magenta>所以我们建议你在应用中写</c>
<c.magenta>didFinishLaunchingWithOptions</c>

00:27:45.599 --> 00:27:48.702
<c.magenta>然后你从HKObjectType</c>
<c.magenta>获取step的quantityType</c>

00:27:49.703 --> 00:27:52.840
<c.magenta>然后传递给HK Health Store的</c>
<c.magenta>enableBackgroundDelivery</c>

00:27:52.906 --> 00:27:56.410
<c.magenta>以便传递stepsType</c>
<c.magenta>以及你想要更新的频率</c>

00:27:57.444 --> 00:28:00.514
<c.magenta>请注意</c>
<c.magenta>后台传输时间没有保证</c>

00:27:57.444 --> 00:28:00.514
<c.magenta>请注意</c>
<c.magenta>后台传输时间没有保证</c>

00:28:03.383 --> 00:28:06.954
<c.magenta>应用要选择</c>
<c.magenta>它能处理的最长频率</c>

00:28:07.120 --> 00:28:09.790
<c.magenta>以便保护</c>
<c.magenta>用户的电池寿命</c>

00:28:11.091 --> 00:28:14.061
<c.magenta>还要注意的是</c>
<c.magenta>这个API是iOS特定的</c>

00:28:14.428 --> 00:28:17.231
<c.magenta>后台更新</c>
<c.magenta>在watchOS上不可用</c>

00:28:19.766 --> 00:28:20.601
<c.magenta>第二步</c>

00:28:20.667 --> 00:28:22.436
<c.magenta>传递</c>
<c.magenta>step的quantityType</c>

00:28:22.503 --> 00:28:25.739
<c.magenta>创建HKObserverQuery</c>

00:28:27.407 --> 00:28:29.743
<c.magenta>这里有</c>
<c.magenta>自定义的updateSteps方法</c>

00:28:30.077 --> 00:28:32.412
<c.magenta>我们可以用它来获取</c>

00:28:32.679 --> 00:28:35.649
<c.magenta>HealthKit检测到的</c>
<c.magenta>新样本和删除的样本</c>

00:28:36.350 --> 00:28:38.218
<c.magenta>之后就要</c>
<c.magenta>执行这个查询</c>

00:28:39.052 --> 00:28:41.221
<c.magenta>就这样</c>
<c.magenta>设置阶段完成了</c>

00:28:41.288 --> 00:28:44.525
<c.magenta>HealthKit就可以监测</c>
<c.magenta>HealthKit中的新样本和已删除的样本</c>

00:28:45.425 --> 00:28:46.260
<c.magenta>那么...</c>

00:28:46.360 --> 00:28:49.062
<c.magenta>在我走过舞台</c>
<c.magenta>生成健康样本</c>

00:28:49.763 --> 00:28:50.764
<c.magenta>是步数样本的时候</c>

00:28:53.233 --> 00:28:55.669
<c.magenta>我们深入了解一下</c>
<c.magenta>updateSteps方法</c>

00:28:55.736 --> 00:28:57.171
<c.magenta>好让我们知道要如何做</c>

00:28:57.237 --> 00:28:59.139
<c.magenta>才能获取新样本和删除的样本</c>

00:28:59.573 --> 00:29:02.509
<c.magenta>首先来创建</c>
<c.magenta>一个HKAnchoredObjectQuery</c>

00:28:59.573 --> 00:29:02.509
<c.magenta>首先来创建</c>
<c.magenta>一个HKAnchoredObjectQuery</c>

00:29:02.943 --> 00:29:04.144
<c.magenta>传递给stepsType</c>

00:29:04.478 --> 00:29:07.481
<c.magenta>同样有一个predicate</c>
<c.magenta>是额外字段</c>

00:29:07.548 --> 00:29:10.784
<c.magenta>让你能筛选出</c>
<c.magenta>你想要的那个样本</c>

00:29:13.520 --> 00:29:15.255
<c.magenta>然后调出</c>
<c.magenta>handleSteps方法</c>

00:29:15.322 --> 00:29:17.658
<c.magenta>以处理</c>
<c.magenta>新样本和删除的样本</c>

00:29:21.395 --> 00:29:22.496
<c.magenta>更新anchor</c>

00:29:22.563 --> 00:29:25.499
<c.magenta>以便下一次创建</c>
<c.magenta>HKAnchoredObjectQuery</c>

00:29:27.434 --> 00:29:29.703
<c.magenta>然后调出</c>
<c.magenta>completionHandler</c>

00:29:29.770 --> 00:29:32.406
<c.magenta>宣布获取新数据进程已完成</c>

00:29:34.741 --> 00:29:36.076
<c.magenta>之后执行查询</c>

00:29:37.511 --> 00:29:39.246
<c.magenta>最后 第四步</c>

00:29:39.313 --> 00:29:42.783
<c.magenta>调出completionHandler</c>
<c.magenta>这是observerQuery给我们的</c>

00:29:43.617 --> 00:29:45.853
<c.magenta>是为了让HealthKit知道</c>
<c.magenta>我们已经收到</c>

00:29:45.919 --> 00:29:48.088
<c.magenta>并且处理了后台更新</c>

00:29:48.589 --> 00:29:49.423
<c.magenta>就是这样</c>

00:29:49.489 --> 00:29:52.092
<c.magenta>现在你的应用启动时</c>
<c.magenta>就会有新的UI</c>

00:29:52.192 --> 00:29:53.861
<c.magenta>然后同步云数据</c>

00:29:54.828 --> 00:29:56.296
<c.magenta>按照这些步骤</c>

00:29:58.899 --> 00:30:01.201
<c.magenta>下面来讲讲追踪更改数据</c>

00:29:58.899 --> 00:30:01.201
<c.magenta>下面来讲讲追踪更改数据</c>

00:30:02.002 --> 00:30:03.470
<c.magenta>你要使用UUID</c>

00:30:03.537 --> 00:30:06.039
<c.magenta>来追踪唯一的HKObjects</c>

00:30:10.410 --> 00:30:13.680
<c.magenta>独特的识别符要定义在</c>
<c.magenta>每次创建对象的时候</c>

00:30:13.747 --> 00:30:15.782
<c.magenta>而且要一直存在于</c>
<c.magenta>这个样本的生命周期</c>

00:30:17.951 --> 00:30:19.853
<c.magenta>将UUID记录到</c>
<c.magenta>你的个人数据库</c>

00:30:19.920 --> 00:30:20.754
<c.magenta>或者...</c>

00:30:21.221 --> 00:30:24.124
<c.magenta>同时存到本地设备</c>
<c.magenta>和云端</c>

00:30:24.191 --> 00:30:26.994
<c.magenta>这样你就能知道</c>
<c.magenta>哪个样本是一样的</c>

00:30:28.662 --> 00:30:33.166
<c.magenta>当样本被删除的时候</c>
<c.magenta>以Health应用的锻炼为例</c>

00:30:33.834 --> 00:30:36.470
<c.magenta>你要一直监测这些更改</c>

00:30:36.570 --> 00:30:38.172
<c.magenta>以确保那些相同样本</c>
<c.magenta>也会被删掉</c>

00:30:38.238 --> 00:30:41.008
<c.magenta>同样也是在本地设备</c>
<c.magenta>和远程云端</c>

00:30:43.911 --> 00:30:48.482
<c.magenta>还要保证以后的同步操作</c>
<c.magenta>不会重新添加这些已经删除的样本</c>

00:30:50.551 --> 00:30:53.287
<c.magenta>这可能会产生两个问题</c>
<c.magenta>我要重点讲一下</c>

00:30:53.353 --> 00:30:56.723
<c.magenta>关于如何避免重复</c>

00:30:57.391 --> 00:30:59.526
<c.magenta>第一个就是预填充数据</c>

00:30:59.860 --> 00:31:02.529
<c.magenta>预填充数据是</c>
<c.magenta>抱歉 加载</c>

00:30:59.860 --> 00:31:02.529
<c.magenta>预填充数据是</c>
<c.magenta>抱歉 加载</c>

00:31:03.030 --> 00:31:05.732
<c.magenta>预填充数据是一个好方法</c>
<c.magenta>让你在加载过程中</c>

00:31:05.799 --> 00:31:07.935
<c.magenta>节省用户的时间</c>
<c.magenta>通过拉取那些</c>

00:31:08.001 --> 00:31:09.837
<c.magenta>已存在HealthKit里的信息</c>

00:31:11.471 --> 00:31:13.473
<c.magenta>用户可以验证数据</c>

00:31:13.540 --> 00:31:16.243
<c.magenta>在HealthKit里</c>
<c.magenta>需要的话也可更改</c>

00:31:17.911 --> 00:31:20.681
<c.magenta>但是问题在于</c>
<c.magenta>如何保存未更改的值</c>

00:31:21.782 --> 00:31:25.152
<c.magenta>要保证再次保存数据</c>
<c.magenta>是用户的意愿</c>

00:31:28.856 --> 00:31:32.826
<c.magenta>另外一个潜在的问题</c>
<c.magenta>就是数据摄取</c>

00:31:32.893 --> 00:31:34.661
<c.magenta>无论从其他应用</c>
<c.magenta>还是HealthKit</c>

00:31:35.929 --> 00:31:38.398
<c.magenta>记住只能选择</c>
<c.magenta>同一个来源的信息</c>

00:31:38.465 --> 00:31:40.701
<c.magenta>并且最适合你的应用</c>

00:31:41.568 --> 00:31:45.239
<c.magenta>HealthKit有很棒的隐私性</c>
<c.magenta>这是我们的用户已经认可的</c>

00:31:45.305 --> 00:31:48.542
<c.magenta>但是只有你知道哪个来源</c>
<c.magenta>对你的应用最好</c>

00:31:50.978 --> 00:31:53.747
<c.magenta>一定不要保存</c>
<c.magenta>其他应用的数据</c>

00:31:53.814 --> 00:31:54.815
<c.magenta>以他们的名义</c>

00:31:56.183 --> 00:31:59.786
<c.magenta>只写一遍你自己的数据</c>
<c.magenta>避免重复数据</c>

00:31:59.853 --> 00:32:03.423
<c.magenta>通过明确</c>
<c.magenta>哪个应用有权编写</c>

00:31:59.853 --> 00:32:03.423
<c.magenta>通过明确</c>
<c.magenta>哪个应用有权编写</c>

00:32:03.991 --> 00:32:06.326
<c.magenta>这个规则有一个特别的例外</c>

00:32:06.393 --> 00:32:08.262
<c.magenta>有时候复制是有意的</c>

00:32:09.496 --> 00:32:12.065
<c.magenta>比如</c>
<c.magenta>数据来自多个来源的时候</c>

00:32:13.734 --> 00:32:17.271
<c.magenta>步数数据不仅</c>
<c.magenta>由用户的手机生成</c>

00:32:17.337 --> 00:32:18.705
<c.magenta>还会由Apple Watch生成</c>

00:32:20.974 --> 00:32:25.179
<c.magenta>你可以使用HKStatisticsQuery</c>
<c.magenta>和HKStatisticsCollectionQuery</c>

00:32:25.245 --> 00:32:28.115
<c.magenta>来自动消重</c>

00:32:28.182 --> 00:32:32.252
<c.magenta>按照Health应用中</c>
<c.magenta>首选数据来源排列</c>

00:32:32.586 --> 00:32:35.522
<c.magenta>这样的话</c>
<c.magenta>用户体验就会连贯流畅</c>

00:32:35.656 --> 00:32:38.292
<c.magenta>健康数据视图</c>
<c.magenta>在整个生态环境里都一致</c>

00:32:39.960 --> 00:32:42.062
<c.magenta>现在我来讲讲</c>
<c.magenta>数据迁移</c>

00:32:42.563 --> 00:32:45.933
<c.magenta>假设你发起了</c>
<c.magenta>一个新的Bluetooth体温计</c>

00:32:45.999 --> 00:32:47.501
<c.magenta>和可把数据写入HealthKit的应用</c>

00:32:48.268 --> 00:32:50.871
<c.magenta>你的应用上架App Store</c>
<c.magenta>已经几天了</c>

00:32:50.938 --> 00:32:52.673
<c.magenta>但是用户发现了一个问题</c>

00:32:53.340 --> 00:32:54.241
<c.magenta>在某些情况下</c>

00:32:54.675 --> 00:32:57.778
<c.magenta>本来要保存</c>
<c.magenta>98华氏度</c>

00:32:58.579 --> 00:33:01.315
<c.magenta>实际却存的是</c>
<c.magenta>98摄氏度</c>

00:32:58.579 --> 00:33:01.315
<c.magenta>实际却存的是</c>
<c.magenta>98摄氏度</c>

00:33:01.648 --> 00:33:03.050
<c.magenta>这温度有点高</c>

00:33:04.051 --> 00:33:04.885
<c.magenta>这种情况下</c>

00:33:04.952 --> 00:33:08.422
<c.magenta>我们就知道如何迁移数据</c>
<c.magenta>来解决这个问题</c>

00:33:08.822 --> 00:33:11.992
<c.magenta>我们首先要</c>
<c.magenta>找到旧的样本</c>

00:33:13.560 --> 00:33:14.761
<c.magenta>写一个新样本</c>

00:33:14.828 --> 00:33:17.197
<c.magenta>一定要更新</c>
<c.magenta>存在别处的UUID</c>

00:33:19.099 --> 00:33:20.834
<c.magenta>然后删除旧样本</c>

00:33:23.103 --> 00:33:25.606
<c.magenta>现在有几个新事项</c>
<c.magenta>关于数据流动</c>

00:33:25.672 --> 00:33:27.374
<c.magenta>在iPhone和</c>
<c.magenta>Apple Watch之间</c>

00:33:28.876 --> 00:33:32.880
<c.magenta>从iOS 9.3开始</c>
<c.magenta>用户手机产生的数据</c>

00:33:32.946 --> 00:33:35.382
<c.magenta>现在会同步于所有</c>
<c.magenta>与之匹配的Apple Watch</c>

00:33:35.516 --> 00:33:37.317
<c.magenta>Apple Watch现在反映的是</c>

00:33:37.384 --> 00:33:40.954
<c.magenta>存在HealthKit里的</c>
<c.magenta>最新的健康数据</c>

00:33:42.589 --> 00:33:43.991
<c.magenta>为了实现这个任务</c>

00:33:44.291 --> 00:33:46.260
<c.magenta>样本会定期修整</c>

00:33:46.326 --> 00:33:49.263
<c.magenta>基于其在Apple Watch上的</c>
<c.magenta>结束日期</c>

00:33:52.766 --> 00:33:54.201
<c.magenta>所以一定要保存样本</c>

00:33:54.268 --> 00:33:57.337
<c.magenta>特别是HKHealthStore</c>
<c.magenta>最早许可之后的样本数据</c>

00:33:57.871 --> 00:34:00.240
<c.magenta>这是为了保证</c>
<c.magenta>你的样本能正确地保存</c>

00:33:57.871 --> 00:34:00.240
<c.magenta>这是为了保证</c>
<c.magenta>你的样本能正确地保存</c>

00:34:00.641 --> 00:34:03.110
<c.magenta>并同步到用户的设备</c>

00:34:05.279 --> 00:34:07.714
<c.magenta>最后</c>
<c.magenta>同步的时间没有保证</c>

00:34:08.916 --> 00:34:12.819
<c.magenta>所以你的数据要保存在iPhone</c>
<c.magenta>或Apple Watch上</c>

00:34:13.387 --> 00:34:14.221
<c.magenta>不能两个都存</c>

00:34:18.292 --> 00:34:19.927
<c.magenta>我现在把舞台交还给Matt</c>

00:34:19.993 --> 00:34:21.995
<c.magenta>由他来最后</c>
<c.magenta>总结一下这场演讲</c>

00:34:22.129 --> 00:34:24.498
<c.magenta>谢谢大家</c>
<c.magenta>好好享受 WWDC 吧</c>

00:34:30.337 --> 00:34:31.170
<c.magenta>谢谢你 Jeff</c>

00:34:32.072 --> 00:34:32.906
<c.magenta>在总结之前</c>

00:34:33.106 --> 00:34:36.109
<c.magenta>我想再着重讲</c>
<c.magenta>一个很棒的辅助特性</c>

00:34:36.176 --> 00:34:38.745
<c.magenta>这是iOS 10和watchOS 3中</c>
<c.magenta>全新的特性</c>

00:34:40.614 --> 00:34:41.614
<c.magenta>轮椅辅助</c>

00:34:43.382 --> 00:34:46.553
<c.magenta>辅助功能是Apple</c>
<c.magenta>十分看重的部分</c>

00:34:47.254 --> 00:34:50.456
<c.magenta>所有的用户</c>
<c.magenta>都应当享受我们的产品</c>

00:34:50.524 --> 00:34:52.626
<c.magenta>和最极致的体验</c>

00:34:53.092 --> 00:34:57.063
<c.magenta>这样强大的活动追踪体验</c>
<c.magenta>在Apple Watch也不例外</c>

00:34:58.465 --> 00:35:02.836
<c.magenta>iOS 10和watchOS 3就</c>
<c.magenta>包括了这种强大的运动跟踪功能</c>

00:34:58.465 --> 00:35:02.836
<c.magenta>iOS 10和watchOS 3就</c>
<c.magenta>包括了这种强大的运动跟踪功能</c>

00:35:02.903 --> 00:35:06.139
<c.magenta>它可以自动记录数据</c>
<c.magenta>对轮椅使用者十分有用</c>

00:35:06.773 --> 00:35:09.676
<c.magenta>现在你就可以</c>
<c.magenta>使用并记录这些类型</c>

00:35:09.743 --> 00:35:11.612
<c.magenta>在与HealthKit互动的时候</c>

00:35:14.314 --> 00:35:16.517
<c.magenta>首先</c>
<c.magenta>这是个新的特性数据类型</c>

00:35:16.683 --> 00:35:17.885
<c.magenta>HKWheelchairUse</c>

00:35:17.951 --> 00:35:20.354
<c.magenta>它定义了</c>
<c.magenta>用户是否使用轮椅</c>

00:35:20.754 --> 00:35:23.857
<c.magenta>它的值可以是</c>
<c.magenta>是 否或不确定</c>

00:35:25.592 --> 00:35:28.629
<c.magenta>然后我们有一些新的数量类型</c>
<c.magenta>专门针对轮椅使用者</c>

00:35:28.762 --> 00:35:31.765
<c.magenta>其中包括</c>
<c.magenta>轮椅移动距离和推动次数</c>

00:35:31.832 --> 00:35:33.567
<c.magenta>你可想象成是步数</c>

00:35:35.369 --> 00:35:39.106
<c.magenta>最后我们具备对轮椅使用者十分有用的</c>
<c.magenta>新的锻炼类型</c>

00:35:39.306 --> 00:35:42.943
<c.magenta>这些包括</c>
<c.magenta>轮椅的步行速度和跑动速度</c>

00:35:47.047 --> 00:35:49.183
<c.magenta>当轮椅使用者</c>
<c.magenta>佩戴Apple Watch时</c>

00:35:49.249 --> 00:35:51.618
<c.magenta>watch会自动记录</c>
<c.magenta>推轮椅的次数</c>

00:35:51.685 --> 00:35:53.220
<c.magenta>并写入新的推动次数类型</c>

00:35:54.354 --> 00:35:55.189
<c.magenta>另外</c>

00:35:55.622 --> 00:35:58.392
<c.magenta>站立环形图中</c>
<c.magenta>对应站立小时数的数据类型</c>

00:35:58.458 --> 00:36:00.360
<c.magenta>变成了转动小时数</c>

00:35:58.458 --> 00:36:00.360
<c.magenta>变成了转动小时数</c>

00:36:01.662 --> 00:36:05.332
<c.magenta>要注意 轮椅走的距离只能在</c>

00:36:05.399 --> 00:36:06.800
<c.magenta>轮椅运动时 自动记录</c>

00:36:07.434 --> 00:36:08.569
<c.magenta>还要注意</c>

00:36:09.069 --> 00:36:12.005
<c.magenta>用户的轮椅状态</c>
<c.magenta>会随着时间改变</c>

00:36:12.539 --> 00:36:15.442
<c.magenta>这十分重要</c>
<c.magenta>尤其当你要查询历史数据的时候</c>

00:36:15.776 --> 00:36:18.011
<c.magenta>这种情况下</c>
<c.magenta>你要保证同时查询</c>

00:36:18.111 --> 00:36:21.281
<c.magenta>轮椅类型和非轮椅类型</c>

00:36:21.348 --> 00:36:23.383
<c.magenta>这样就不会遗漏大段的</c>

00:36:23.450 --> 00:36:25.252
<c.magenta>用户历史信息</c>

00:36:27.054 --> 00:36:29.857
<c.magenta>总的来说</c>
<c.magenta>我们一直努力保证</c>

00:36:29.923 --> 00:36:33.060
<c.magenta>我们所有的产品和体验</c>
<c.magenta>能为所有人服务</c>

00:36:33.393 --> 00:36:34.228
<c.magenta>你也是</c>

00:36:34.695 --> 00:36:35.929
<c.magenta>我们强烈建议你</c>

00:36:35.996 --> 00:36:38.131
<c.magenta>去考虑</c>
<c.magenta>这一十分重要的用户群</c>

00:36:38.432 --> 00:36:42.302
<c.magenta>通过在你的应用里支持并提供</c>
<c.magenta>这种轮椅数据类型</c>

00:36:46.573 --> 00:36:48.208
<c.magenta>我们今天讲了很多</c>

00:36:48.442 --> 00:36:49.276
<c.magenta>现在回顾一下</c>

00:36:51.178 --> 00:36:54.748
<c.magenta>授权十分重要</c>
<c.magenta>对保护用户隐私而言</c>

00:36:54.915 --> 00:36:58.051
<c.magenta>但是保证好的用户体验</c>
<c.magenta>绝对是重中之重</c>

00:36:59.152 --> 00:37:00.521
<c.magenta>时刻记得授权</c>

00:36:59.152 --> 00:37:00.521
<c.magenta>时刻记得授权</c>

00:37:00.587 --> 00:37:03.390
<c.magenta>在开发应用时</c>
<c.magenta>而且一定要经常测试</c>

00:37:05.225 --> 00:37:08.262
<c.magenta>然后我们讲了如何应用</c>
<c.magenta>Apple的健康与健身生态系统</c>

00:37:08.328 --> 00:37:10.931
<c.magenta>通过把活动环</c>
<c.magenta>带入你的应用</c>

00:37:10.998 --> 00:37:12.666
<c.magenta>通过Activity Rings API</c>

00:37:14.935 --> 00:37:18.438
<c.magenta>不管何时与HealthKit互动</c>
<c.magenta>都要仔细处理所有情况</c>

00:37:18.505 --> 00:37:22.042
<c.magenta>正确的同步</c>
<c.magenta>删除 复制这些数据</c>

00:37:22.242 --> 00:37:24.912
<c.magenta>以保证用户的数据</c>
<c.magenta>始终精确</c>

00:37:25.179 --> 00:37:26.647
<c.magenta>并始终符合你的预期</c>

00:37:28.815 --> 00:37:32.119
<c.magenta>最后不要忘了</c>
<c.magenta>好好利用这些新出的好功能</c>

00:37:32.186 --> 00:37:35.556
<c.magenta>就在今年发布的</c>
<c.magenta>iOS 10和watchOS 3中</c>

00:37:35.622 --> 00:37:37.291
<c.magenta>特别是轮椅辅助</c>

00:37:37.424 --> 00:37:39.526
<c.magenta>这是我们认为</c>
<c.magenta>十分有意义的功能</c>

00:37:42.930 --> 00:37:45.766
<c.magenta>如果要了解更多</c>
<c.magenta>关于我们今天所讲的话题</c>

00:37:45.832 --> 00:37:48.035
<c.magenta>又或者你有任何问题</c>
<c.magenta>请访问这个网站</c>

00:37:48.101 --> 00:37:50.337
<c.magenta>这里有更多资源可用</c>

00:37:52.506 --> 00:37:55.142
<c.magenta>也不要忘了</c>
<c.magenta>了解下其他相关的演讲</c>

00:37:55.909 --> 00:37:58.111
<c.magenta>还有往年的精彩演讲</c>

00:37:58.178 --> 00:38:00.047
<c.magenta>会让你更快了解HealthKit</c>

00:37:58.178 --> 00:38:00.047
<c.magenta>会让你更快了解HealthKit</c>

00:38:00.414 --> 00:38:02.115
<c.magenta>感谢你们</c>
<c.magenta>创造了这些出色的应用</c>

00:38:02.182 --> 00:38:03.951
<c.magenta>让我们的用户</c>
<c.magenta>生活更加健康</c>

00:38:04.017 --> 00:38:06.119
<c.magenta>希望你喜欢WWDC的其他演讲</c>
